{"ast":null,"code":"import { RegistererState, SessionState } from \"sip.js\";\nimport { Events } from \"./voice/types\";\nimport SIP from \"./voice/voicecommunicator\";\nexport default class SquadVoiceCommunicator {\n  constructor(settings, cb, constraints = {}) {\n    this.settings = settings;\n    this.constraints = constraints;\n\n    this.onMakeCall = (state, inviter) => {\n      console.log(`Session state changed to ${state}`);\n\n      switch (state) {\n        case SessionState.Initial:\n          this.notify(Events.MAKE_CALL, inviter);\n          break;\n\n        case SessionState.Establishing:\n          break;\n\n        case SessionState.Established:\n          const {\n            receivingVideo,\n            tagId\n          } = this.sip.setupRemoteMedia(inviter) || {};\n          this.notify(Events.CALL_ON_GOING, {\n            inviter,\n            receivingVideo,\n            tagId\n          });\n          break;\n\n        case SessionState.Terminating: // fall through\n\n        case SessionState.Terminated:\n          this.notify(Events.CALL_HANGUP, inviter);\n          this.sip.activeCalls.delete(inviter.id);\n          this.sip.cleanupMedia(inviter.id);\n          break;\n\n        default:\n          throw new Error(\"Unknown session state.\");\n      }\n    };\n\n    this.onReceiveCall = (state, invitation) => {\n      console.log(`Session state changed to ${state}`);\n\n      switch (state) {\n        case SessionState.Initial:\n          this.notify(Events.RECEIVED_CALL, invitation);\n          break;\n\n        case SessionState.Establishing:\n          break;\n\n        case SessionState.Established:\n          const {\n            receivingVideo,\n            tagId\n          } = this.sip.setupRemoteMedia(invitation) || {};\n          this.notify(Events.CALL_ON_GOING, {\n            invitation,\n            receivingVideo,\n            tagId\n          });\n          break;\n\n        case SessionState.Terminating: // fall through\n\n        case SessionState.Terminated:\n          this.notify(Events.CALL_HANGUP, invitation);\n          this.sip.activeCalls.delete(invitation.id);\n          this.sip.cleanupMedia(invitation.id);\n          break;\n\n        default:\n          break;\n      }\n    };\n\n    this.muteMic = callId => {\n      this.sip.muteMic(callId);\n    };\n\n    this.unMuteMic = callId => {\n      this.sip.unMuteMic(callId);\n    };\n\n    this.disableCam = callId => {\n      this.sip.disableCam(callId);\n    };\n\n    this.enableCam = callId => {\n      this.sip.enableCam(callId);\n    };\n\n    this.nextSubscriptionId = 0;\n    this.subscriptions = new Map();\n    this.makeSIP();\n  }\n\n  makeSIP() {\n    this.settings.get(settings => {\n      this.sip = new SIP({\n        user: settings.sipUser,\n        password: settings.sipPw,\n        domain: settings.sipDomain,\n        wsURL: \"\",\n        connectionCB: this.connectionListener.bind(this),\n        onMakeCall: this.onMakeCall.bind(this),\n        onReceiveCall: this.onReceiveCall.bind(this)\n      });\n    });\n  }\n\n  getConstraints() {\n    const newConstraints = {\n      video: this.constraints.useVideo && this.constraints.videoId ? {\n        deviceId: this.constraints.videoId\n      } : this.constraints.useVideo || false,\n      audio: this.constraints.audioId ? {\n        deviceId: this.constraints.audioId\n      } : true\n    };\n\n    if (this.constraints.speakerId) {\n      const mediaElement = document.getElementById(\"remote-stream\");\n      mediaElement.setSinkId(this.constraints.speakerId);\n    }\n\n    return newConstraints;\n  }\n\n  updateConstraintsParams(params) {\n    this.constraints = { ...this.constraints,\n      ...params\n    };\n  }\n\n  connectionListener(data) {\n    switch (data) {\n      case RegistererState.Initial:\n        break;\n\n      case RegistererState.Registered:\n        this.notify(Events.CONNECTED);\n        break;\n\n      case RegistererState.Terminated:\n        this.notify(Events.DISCONNECTED);\n        break;\n\n      case RegistererState.Unregistered:\n        this.notify(Events.UNREGISTERED);\n        break;\n    }\n  }\n\n  makeCall(number, constraints = this.constraints) {\n    this.updateConstraintsParams(constraints);\n    this.sip.invite(number, this.getConstraints());\n  }\n\n  // < -- Observer Pattern https://refactoring.guru/pt-br/design-patterns/observer\n  subscribe(subscribeCallback) {\n    var _this$subscriptions;\n\n    (_this$subscriptions = this.subscriptions) === null || _this$subscriptions === void 0 ? void 0 : _this$subscriptions.set(this.nextSubscriptionId || 0, subscribeCallback);\n    if (this.nextSubscriptionId) this.nextSubscriptionId += 1;\n  }\n\n  removeSubscription(id) {\n    var _this$subscriptions2;\n\n    (_this$subscriptions2 = this.subscriptions) === null || _this$subscriptions2 === void 0 ? void 0 : _this$subscriptions2.delete(id);\n  }\n\n  removeAllSubscription() {\n    this.subscriptions = new Map();\n  }\n\n  notify(event, data = null) {\n    if (this.subscriptions) {\n      this.subscriptions.forEach(subscribeCallback => {\n        if (subscribeCallback) subscribeCallback(event, data);\n      });\n    }\n  } // -- >\n\n\n}","map":{"version":3,"sources":["C:/Users/Digivox/dev/Digivox/Refatoracao/squad/src/services/SquadVoiceCommunicator.ts"],"names":["RegistererState","SessionState","Events","SIP","SquadVoiceCommunicator","constructor","settings","cb","constraints","onMakeCall","state","inviter","console","log","Initial","notify","MAKE_CALL","Establishing","Established","receivingVideo","tagId","sip","setupRemoteMedia","CALL_ON_GOING","Terminating","Terminated","CALL_HANGUP","activeCalls","delete","id","cleanupMedia","Error","onReceiveCall","invitation","RECEIVED_CALL","muteMic","callId","unMuteMic","disableCam","enableCam","nextSubscriptionId","subscriptions","Map","makeSIP","get","user","sipUser","password","sipPw","domain","sipDomain","wsURL","connectionCB","connectionListener","bind","getConstraints","newConstraints","video","useVideo","videoId","deviceId","audio","audioId","speakerId","mediaElement","document","getElementById","setSinkId","updateConstraintsParams","params","data","Registered","CONNECTED","DISCONNECTED","Unregistered","UNREGISTERED","makeCall","number","invite","subscribe","subscribeCallback","set","removeSubscription","removeAllSubscription","event","forEach"],"mappings":"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","sourcesContent":["import { Invitation, Inviter, RegistererState, SessionState } from \"sip.js\";\r\nimport SettingsBusiness from \"./business/Settings\";\r\nimport { Events, SubscriptionCallBack } from \"./voice/types\";\r\nimport SIP from \"./voice/voicecommunicator\";\r\nexport interface UpdateConstraintsParams {\r\n  useVideo?: boolean;\r\n  videoId?: string;\r\n  audioId?: string;\r\n  speakerId?: string;\r\n}\r\nexport default interface SquadVoiceCommunicator {\r\n  sip: SIP;\r\n  nextSubscriptionId?: number;\r\n  subscriptions?: Map<number, SubscriptionCallBack>;\r\n}\r\nexport default class SquadVoiceCommunicator {\r\n  constructor(\r\n    private settings: SettingsBusiness,\r\n    cb: SubscriptionCallBack,\r\n    private constraints: UpdateConstraintsParams = {}\r\n  ) {\r\n    this.nextSubscriptionId = 0;\r\n    this.subscriptions = new Map<number, SubscriptionCallBack>();\r\n    this.makeSIP();\r\n  }\r\n  makeSIP() {\r\n    this.settings.get((settings) => {\r\n      this.sip = new SIP({\r\n        user: settings.sipUser,\r\n        password: settings.sipPw,\r\n        domain: settings.sipDomain,\r\n        wsURL: \"\",\r\n        connectionCB: this.connectionListener.bind(this),\r\n        onMakeCall: this.onMakeCall.bind(this),\r\n        onReceiveCall: this.onReceiveCall.bind(this),\r\n      });\r\n    });\r\n  }\r\n  getConstraints() {\r\n    const newConstraints: MediaStreamConstraints = {\r\n      video:\r\n        this.constraints.useVideo && this.constraints.videoId\r\n          ? {\r\n              deviceId: this.constraints.videoId,\r\n            }\r\n          : this.constraints.useVideo || false,\r\n      audio: this.constraints.audioId\r\n        ? {\r\n            deviceId: this.constraints.audioId,\r\n          }\r\n        : true,\r\n    };\r\n    if (this.constraints.speakerId) {\r\n      const mediaElement: any = document.getElementById(\r\n        \"remote-stream\"\r\n      ) as HTMLVideoElement;\r\n      mediaElement.setSinkId(this.constraints.speakerId);\r\n    }\r\n    return newConstraints;\r\n  }\r\n  updateConstraintsParams(params: UpdateConstraintsParams) {\r\n    this.constraints = { ...this.constraints, ...params };\r\n  }\r\n  connectionListener(data: RegistererState) {\r\n    switch (data) {\r\n      case RegistererState.Initial:\r\n        break;\r\n      case RegistererState.Registered:\r\n        this.notify(Events.CONNECTED);\r\n        break;\r\n      case RegistererState.Terminated:\r\n        this.notify(Events.DISCONNECTED);\r\n        break;\r\n      case RegistererState.Unregistered:\r\n        this.notify(Events.UNREGISTERED);\r\n        break;\r\n    }\r\n  }\r\n  makeCall(\r\n    number: string,\r\n    constraints: UpdateConstraintsParams = this.constraints\r\n  ) {\r\n    this.updateConstraintsParams(constraints);\r\n    this.sip.invite(number, this.getConstraints());\r\n  }\r\n  onMakeCall = (state: SessionState, inviter: Inviter) => {\r\n    console.log(`Session state changed to ${state}`);\r\n    switch (state) {\r\n      case SessionState.Initial:\r\n        this.notify(Events.MAKE_CALL, inviter);\r\n        break;\r\n      case SessionState.Establishing:\r\n        break;\r\n      case SessionState.Established:\r\n        const { receivingVideo, tagId } =\r\n          this.sip.setupRemoteMedia(inviter) || {};\r\n        this.notify(Events.CALL_ON_GOING, { inviter, receivingVideo, tagId });\r\n        break;\r\n      case SessionState.Terminating:\r\n      // fall through\r\n      case SessionState.Terminated:\r\n        this.notify(Events.CALL_HANGUP, inviter);\r\n        this.sip.activeCalls.delete(inviter.id);\r\n        this.sip.cleanupMedia(inviter.id);\r\n        break;\r\n      default:\r\n        throw new Error(\"Unknown session state.\");\r\n    }\r\n  };\r\n  onReceiveCall = (state: SessionState, invitation: Invitation) => {\r\n    console.log(`Session state changed to ${state}`);\r\n    switch (state) {\r\n      case SessionState.Initial:\r\n        this.notify(Events.RECEIVED_CALL, invitation);\r\n        break;\r\n      case SessionState.Establishing:\r\n        break;\r\n      case SessionState.Established:\r\n        const { receivingVideo, tagId } =\r\n          this.sip.setupRemoteMedia(invitation) || {};\r\n        this.notify(Events.CALL_ON_GOING, {\r\n          invitation,\r\n          receivingVideo,\r\n          tagId,\r\n        });\r\n        break;\r\n      case SessionState.Terminating:\r\n      // fall through\r\n      case SessionState.Terminated:\r\n        this.notify(Events.CALL_HANGUP, invitation);\r\n        this.sip.activeCalls.delete(invitation.id);\r\n        this.sip.cleanupMedia(invitation.id);\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  };\r\n\r\n  muteMic = (callId: string) => {\r\n    this.sip.muteMic(callId);\r\n  };\r\n  unMuteMic = (callId: string) => {\r\n    this.sip.unMuteMic(callId);\r\n  };\r\n  disableCam = (callId: string) => {\r\n    this.sip.disableCam(callId);\r\n  };\r\n  enableCam = (callId: string) => {\r\n    this.sip.enableCam(callId);\r\n  };\r\n\r\n  // < -- Observer Pattern https://refactoring.guru/pt-br/design-patterns/observer\r\n  subscribe(subscribeCallback: SubscriptionCallBack) {\r\n    this.subscriptions?.set(this.nextSubscriptionId || 0, subscribeCallback);\r\n    if (this.nextSubscriptionId) this.nextSubscriptionId += 1;\r\n  }\r\n  removeSubscription(id: number) {\r\n    this.subscriptions?.delete(id);\r\n  }\r\n  removeAllSubscription() {\r\n    this.subscriptions = new Map<number, SubscriptionCallBack>();\r\n  }\r\n  notify(event: Events, data: any = null) {\r\n    if (this.subscriptions) {\r\n      this.subscriptions.forEach((subscribeCallback) => {\r\n        if (subscribeCallback) subscribeCallback(event, data);\r\n      });\r\n    }\r\n  }\r\n  // -- >\r\n}\r\n"]},"metadata":{},"sourceType":"module"}