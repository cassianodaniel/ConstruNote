{"ast":null,"code":"import Chat from \"./chat/chatcommunicator\";\nimport { Events } from \"./chat/types/types\";\nimport DeliverStatus from \"../enuns/DeliverStatus\";\nimport ReadStatus from \"../enuns/ReadStatus\";\nimport ChatType from \"../enuns/ChatType\";\nimport { ChatType as XMPPChatType } from \"./types\";\nimport short from \"short-uuid\";\nimport { isUrl } from \"./utils/parseUtils\";\nimport { getFileUrlStr } from \"./utils/formatUtils\";\nexport default class SquadChatCommunicator {\n  constructor(settings, contacts, groups, user, subscribeFunction) {\n    this.settings = settings;\n    this.contacts = contacts;\n    this.groups = groups;\n    this.user = user;\n\n    this.onGroupEvent = event => {\n      this.settings.get(settings => {\n        const isSentByMe = event.from.split(\"/\")[1] === settings.xmppUser || event.from.split(\"@\")[0] === settings.xmppUser;\n        const eventParsed = {\n          id: event.id,\n          userName: this.getMessageUserName(event) || \"\",\n          userProfilePicture: this.getMessageUserProfilePicture(event) || undefined,\n          message: \"\",\n          time: event.sent_at,\n          isFileMessage: false,\n          isImageMessage: false,\n          isVideoMessage: false,\n          isAudioMessage: false,\n          fileUrl: \"\",\n          toUser: isSentByMe && event.from.includes(\"@conference.\") ? event.from.split(\"/\")[0] : event.to,\n          fromUser: isSentByMe ? settings.xmppUser : event.from.split(\"/\")[0],\n          deliverStatus: DeliverStatus.DELIVERED,\n          readStatus: ReadStatus.UNREAD,\n          deliverTimestamp: new Date().toISOString(),\n          readTimestamp: \"\",\n          content: \"\",\n          contentType: event.fileUrl || \"text\",\n          isSentByMe: isSentByMe,\n          isReplyMessage: false,\n          isForwardMessage: false,\n          replyedMessage: \"\",\n          replyedMessageTo: \"\",\n          replyedMessageId: \"\",\n          eventId: event.eventId,\n          eventBody: event.eventBody\n        };\n        this.notify(Events.GROUP_EVENT, eventParsed);\n      });\n    };\n\n    this.onRemovingMember = event => {\n      this.settings.get(settings => {\n        const isSentByMe = event.from.split(\"/\")[1] === settings.xmppUser || event.from.split(\"@\")[0] === settings.xmppUser;\n        const eventParsed = {\n          id: event.id,\n          userName: this.getMessageUserName(event) || \"\",\n          userProfilePicture: this.getMessageUserProfilePicture(event) || undefined,\n          message: \"\",\n          time: event.sent_at,\n          isFileMessage: false,\n          isImageMessage: false,\n          isVideoMessage: false,\n          isAudioMessage: false,\n          fileUrl: \"\",\n          toUser: isSentByMe && event.from.includes(\"@conference.\") ? event.from.split(\"/\")[0] : event.to,\n          fromUser: isSentByMe ? settings.xmppUser : event.from.split(\"/\")[0],\n          deliverStatus: DeliverStatus.DELIVERED,\n          readStatus: ReadStatus.UNREAD,\n          deliverTimestamp: new Date().toISOString(),\n          readTimestamp: \"\",\n          content: \"\",\n          contentType: event.fileUrl || \"text\",\n          isSentByMe: isSentByMe,\n          isReplyMessage: false,\n          isForwardMessage: false,\n          replyedMessage: \"\",\n          replyedMessageTo: \"\",\n          replyedMessageId: \"\",\n          eventId: event.eventId,\n          eventBody: event.eventBody\n        };\n        this.notify(Events.REMOVE_MEMBER, eventParsed);\n      });\n    };\n\n    this.onMessage = msg => {\n      this.settings.get(settings => {\n        var _this$contacts$getCon, _msg$reply_to, _this$user$user, _msg$reply_to2, _this$user$user2;\n\n        const fileParams = {\n          isFile: \"fileUrl\" in msg ? true : false,\n          isImage: false,\n          isVideo: false,\n          isAudio: false\n        };\n\n        if (fileParams.isFile) {\n          fileParams.isImage = /\\.(jpe?g|png|gif|ico)$/i.test(msg.fileUrl);\n          fileParams.isVideo = /\\.(mp4|avi|mov)$/i.test(msg.fileUrl);\n          fileParams.isAudio = /\\.(ogg|mp3|wav|m4a|webm)$/i.test(msg.fileUrl);\n        }\n\n        if (isUrl(msg.message)) {\n          const splittedMsg = msg.message.split(\"/\");\n          const extension = splittedMsg[splittedMsg.length - 1];\n\n          if (extension.includes(\".\") && splittedMsg.length > 1) {\n            fileParams.isFile = true;\n            fileParams.isImage = /\\.(jpe?g|png|gif|ico)$/i.test(msg.message);\n            fileParams.isVideo = /\\.(mp4|avi|mov)$/i.test(msg.message);\n            fileParams.isAudio = /\\.(ogg|mp3|wav|m4a|webm)$/i.test(msg.message);\n          }\n        }\n\n        const isSentByMe = msg.from.split(\"/\")[1] === settings.xmppUser || msg.from.split(\"@\")[0] === settings.xmppUser;\n        const message = {\n          id: msg.id,\n          userName: this.getMessageUserName(msg) || \"\",\n          userProfilePicture: this.getMessageUserProfilePicture(msg) || undefined,\n          message: msg.message || msg.fileUrl,\n          time: msg.sent_at,\n          isFileMessage: fileParams.isFile && !fileParams.isImage && !fileParams.isVideo && !fileParams.isAudio,\n          isImageMessage: fileParams.isImage,\n          isVideoMessage: fileParams.isVideo,\n          isAudioMessage: fileParams.isAudio,\n          fileUrl: getFileUrlStr(fileParams, msg),\n          toUser: isSentByMe && msg.from.includes(\"@conference.\") ? msg.from.split(\"/\")[0] : msg.to,\n          fromUser: isSentByMe ? settings.xmppUser : msg.from.split(\"/\")[0],\n          deliverStatus: DeliverStatus.DELIVERED,\n          readStatus: ReadStatus.UNREAD,\n          deliverTimestamp: new Date().toISOString(),\n          readTimestamp: \"\",\n          content: JSON.stringify({\n            reply_msg: msg.reply_msg,\n            reply_msg_id: msg.reply_msg_id,\n            reply_to: msg.reply_to\n          }),\n          contentType: msg.fileUrl || \"text\",\n          isSentByMe: isSentByMe,\n          isReplyMessage: !!msg.reply_msg,\n          isForwardMessage: !!msg.reply_to && !msg.reply_msg,\n          replyedMessage: msg.reply_msg,\n          replyedMessageTo: ((_this$contacts$getCon = this.contacts.getContacts().get(((_msg$reply_to = msg.reply_to) === null || _msg$reply_to === void 0 ? void 0 : _msg$reply_to.split(\"@\")[0]) || \"\")) === null || _this$contacts$getCon === void 0 ? void 0 : _this$contacts$getCon.name) || ((_this$user$user = this.user.user) === null || _this$user$user === void 0 ? void 0 : _this$user$user.id) === ((_msg$reply_to2 = msg.reply_to) === null || _msg$reply_to2 === void 0 ? void 0 : _msg$reply_to2.split(\"@\")[0]) ? (_this$user$user2 = this.user.user) === null || _this$user$user2 === void 0 ? void 0 : _this$user$user2.name : \"Participant\",\n          replyedMessageId: msg.reply_msg_id\n        };\n        this.notify(Events.MESSAGE, message);\n      });\n    };\n\n    this.onPresence = presence => {\n      this.notify(Events.PRESENCE, presence);\n    };\n\n    this.forwardMessage = (chat, message, callback) => {\n      this.chat.forwardMsg(chat.jid, chat.jid.includes(\"@conference.\") ? XMPPChatType.GROUPCHAT : XMPPChatType.CHAT, message.fromUser, message.message, message.id, callback);\n    };\n\n    this.replyMsg = (chat, message, replyedMessage, cb) => {\n      this.chat.replyMsg(chat.jid, chat.jid.includes(\"@conference.\") ? XMPPChatType.GROUPCHAT : XMPPChatType.CHAT, message.message, replyedMessage.fromUser, replyedMessage.message, replyedMessage.id, cb);\n    };\n\n    this.sendMessage = (chat, text, callback) => {\n      this.chat.sendMessage(chat.jid, chat.chatType === ChatType.USER ? XMPPChatType.CHAT : XMPPChatType.GROUPCHAT, text, callback);\n    };\n\n    this.sendFiles = (chat, files, cb) => {\n      files.forEach(file => {\n        this.chat.sendFile(chat.jid, chat.jid.includes(\"@conference.\") ? XMPPChatType.GROUPCHAT : XMPPChatType.CHAT, file, cb);\n      });\n    };\n\n    this.getMessageUserName = msg => {\n      if (msg.from.includes(\"@conference.\")) {\n        const groups = this.groups.getGroups();\n        const group = groups.get(msg.from.split(\"@\")[0]);\n        const member = group === null || group === void 0 ? void 0 : group.members.filter(member => member.userId === msg.from.split(\"/\")[1])[0];\n        return member === null || member === void 0 ? void 0 : member.name;\n      } else {\n        var _this$contacts$getCon2;\n\n        return (_this$contacts$getCon2 = this.contacts.getContacts().get(msg.from.split(\"@\")[0])) === null || _this$contacts$getCon2 === void 0 ? void 0 : _this$contacts$getCon2.name;\n      }\n    };\n\n    this.getMessageUserProfilePicture = msg => {\n      if (msg.from.includes(\"@conference.\")) {\n        const groups = this.groups.getGroups();\n        const group = groups.get(msg.from.split(\"@\")[0]);\n        const member = group === null || group === void 0 ? void 0 : group.members.filter(member => member.userId === msg.from.split(\"/\")[1])[0];\n        return member === null || member === void 0 ? void 0 : member.profilePicture;\n      } else {\n        var _this$contacts$getCon3;\n\n        return (_this$contacts$getCon3 = this.contacts.getContacts().get(msg.from.split(\"@\")[0])) === null || _this$contacts$getCon3 === void 0 ? void 0 : _this$contacts$getCon3.profilePicture;\n      }\n    };\n\n    this.nextSubscriptionId = 0;\n    this.subscriptions = new Map();\n    this.makeChat(subscribeFunction);\n  }\n\n  makeChat(subscribeFunction) {\n    this.subscribe(subscribeFunction);\n    this.settings.get(settings => {\n      const options = {\n        service: `wss://${settings.xmppDomain}:5280/websocket`,\n        domain: settings.xmppDomain,\n        username: settings.xmppUser,\n        password: settings.xmppPw,\n        resource: `squad.web_${settings.xmppUser}_${short().generate()}`\n      };\n      const chat = new Chat(options);\n      this.chat = chat;\n      this.subscribeChatEvents(chat);\n      chat.client.start();\n    });\n  }\n\n  subscribeChatEvents(chat) {\n    chat.on(Events.MESSAGE, this.onMessage);\n    chat.on(Events.PRESENCE, this.onPresence);\n    chat.on(Events.ONLINE, () => this.notify(Events.ONLINE, null));\n    chat.on(Events.OFFLINE, () => this.notify(Events.OFFLINE, null));\n    chat.on(Events.ERROR, this.onError);\n    chat.on(Events.STANZA, this.onStanza);\n    chat.on(Events.RECEIVED, data => this.notify(Events.RECEIVED, data));\n    chat.on(Events.DISPLAYED, data => this.notify(Events.DISPLAYED, data));\n    chat.on(Events.COMPOSING, data => this.notify(Events.COMPOSING, data));\n    chat.on(Events.ACTIVE, data => this.notify(Events.ACTIVE, data));\n    chat.on(Events.GROUP_EVENT, this.onGroupEvent);\n    chat.on(Events.REMOVE_MEMBER, this.onRemovingMember);\n  }\n\n  onStanza(stanza) {}\n\n  onError(error) {}\n\n  joinGroup(to) {\n    this.chat.joinRoom(to);\n  }\n\n  joinGroups(groups) {\n    groups.forEach(jid => this.joinGroup(jid));\n  }\n\n  changeStatus(status) {\n    this.chat.sendPresence(status);\n  }\n\n  subscribe(subscribeCallback) {\n    this.subscriptions.set(this.nextSubscriptionId, subscribeCallback);\n    this.nextSubscriptionId += 1;\n  }\n\n  removeSubscription(id) {\n    this.subscriptions.delete(id);\n  }\n\n  removeAllSubscription() {\n    this.subscriptions = new Map();\n  }\n\n  notify(event, data) {\n    if (this.subscriptions) {\n      this.subscriptions.forEach(subscribeCallback => {\n        if (subscribeCallback) subscribeCallback(event, data);\n      });\n    }\n  }\n\n}","map":{"version":3,"sources":["C:/Users/Digivox/dev/Digivox/Refatoracao/squad/src/services/SquadChatCommunicator.ts"],"names":["Chat","Events","DeliverStatus","ReadStatus","ChatType","XMPPChatType","short","isUrl","getFileUrlStr","SquadChatCommunicator","constructor","settings","contacts","groups","user","subscribeFunction","onGroupEvent","event","get","isSentByMe","from","split","xmppUser","eventParsed","id","userName","getMessageUserName","userProfilePicture","getMessageUserProfilePicture","undefined","message","time","sent_at","isFileMessage","isImageMessage","isVideoMessage","isAudioMessage","fileUrl","toUser","includes","to","fromUser","deliverStatus","DELIVERED","readStatus","UNREAD","deliverTimestamp","Date","toISOString","readTimestamp","content","contentType","isReplyMessage","isForwardMessage","replyedMessage","replyedMessageTo","replyedMessageId","eventId","eventBody","notify","GROUP_EVENT","onRemovingMember","REMOVE_MEMBER","onMessage","msg","fileParams","isFile","isImage","isVideo","isAudio","test","splittedMsg","extension","length","JSON","stringify","reply_msg","reply_msg_id","reply_to","getContacts","name","MESSAGE","onPresence","presence","PRESENCE","forwardMessage","chat","callback","forwardMsg","jid","GROUPCHAT","CHAT","replyMsg","cb","sendMessage","text","chatType","USER","sendFiles","files","forEach","file","sendFile","getGroups","group","member","members","filter","userId","profilePicture","nextSubscriptionId","subscriptions","Map","makeChat","subscribe","options","service","xmppDomain","domain","username","password","xmppPw","resource","generate","subscribeChatEvents","client","start","on","ONLINE","OFFLINE","ERROR","onError","STANZA","onStanza","RECEIVED","data","DISPLAYED","COMPOSING","ACTIVE","stanza","error","joinGroup","joinRoom","joinGroups","changeStatus","status","sendPresence","subscribeCallback","set","removeSubscription","delete","removeAllSubscription"],"mappings":"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","sourcesContent":["import Chat from \"./chat/chatcommunicator\";\r\nimport { Events, FileMessage, Message, Presence } from \"./chat/types/types\";\r\nimport IMessage from \"../alias/IMessage\";\r\nimport DeliverStatus from \"../enuns/DeliverStatus\";\r\nimport ReadStatus from \"../enuns/ReadStatus\";\r\nimport { SendMessageCallback, SubscriptionCallBack } from \"./types\";\r\nimport IChat from \"../alias/IChat\";\r\nimport ChatType from \"../enuns/ChatType\";\r\nimport { ChatType as XMPPChatType } from \"./types\";\r\nimport SettingsBusiness from \"./business/Settings\";\r\nimport short from \"short-uuid\";\r\nimport ContactsBusiness from \"./business/Contacts\";\r\nimport GroupsBusiness from \"./business/Groups\";\r\nimport { isUrl } from \"./utils/parseUtils\";\r\nimport { getFileUrlStr } from \"./utils/formatUtils\";\r\nimport UserBusiness from \"./business/User\";\r\nimport { getFrom } from \"./chat/util/stanzaUtils\";\r\n\r\nexport default interface SquadChatCommunicator {\r\n  chat: Chat;\r\n  nextSubscriptionId: number;\r\n  subscriptions: Map<number, SubscriptionCallBack>;\r\n}\r\nexport default class SquadChatCommunicator {\r\n  constructor(\r\n    private settings: SettingsBusiness,\r\n    private contacts: ContactsBusiness,\r\n    private groups: GroupsBusiness,\r\n    private user: UserBusiness,\r\n    subscribeFunction: SubscriptionCallBack\r\n  ) {\r\n    this.nextSubscriptionId = 0;\r\n    this.subscriptions = new Map<number, SubscriptionCallBack>();\r\n    this.makeChat(subscribeFunction);\r\n  }\r\n  makeChat(subscribeFunction: SubscriptionCallBack) {\r\n    this.subscribe(subscribeFunction);\r\n    this.settings.get((settings) => {\r\n      const options = {\r\n        service: `wss://${settings.xmppDomain}:5280/websocket`,\r\n        domain: settings.xmppDomain,\r\n        username: settings.xmppUser,\r\n        password: settings.xmppPw,\r\n        resource: `squad.web_${settings.xmppUser}_${short().generate()}`,\r\n      };\r\n      const chat = new Chat(options);\r\n      this.chat = chat;\r\n      this.subscribeChatEvents(chat);\r\n      chat.client.start();\r\n    });\r\n  }\r\n  subscribeChatEvents(chat: Chat) {\r\n    chat.on(Events.MESSAGE, this.onMessage);\r\n    chat.on(Events.PRESENCE, this.onPresence);\r\n    chat.on(Events.ONLINE, () => this.notify(Events.ONLINE, null));\r\n    chat.on(Events.OFFLINE, () => this.notify(Events.OFFLINE, null));\r\n    chat.on(Events.ERROR, this.onError);\r\n    chat.on(Events.STANZA, this.onStanza);\r\n    chat.on(Events.RECEIVED, (data) => this.notify(Events.RECEIVED, data));\r\n    chat.on(Events.DISPLAYED, (data) => this.notify(Events.DISPLAYED, data));\r\n    chat.on(Events.COMPOSING, (data) => this.notify(Events.COMPOSING, data));\r\n    chat.on(Events.ACTIVE, (data) => this.notify(Events.ACTIVE, data));\r\n    chat.on(Events.GROUP_EVENT, this.onGroupEvent);\r\n    chat.on(Events.REMOVE_MEMBER, this.onRemovingMember);\r\n  }\r\n  onGroupEvent = (event: Message) => {\r\n    this.settings.get((settings) => {\r\n      const isSentByMe =\r\n        event.from.split(\"/\")[1] === settings.xmppUser ||\r\n        event.from.split(\"@\")[0] === settings.xmppUser;\r\n      const eventParsed: IMessage = {\r\n        id: event.id,\r\n        userName: this.getMessageUserName(event) || \"\",\r\n        userProfilePicture:\r\n          this.getMessageUserProfilePicture(event) || undefined,\r\n        message: \"\",\r\n        time: event.sent_at,\r\n        isFileMessage: false,\r\n        isImageMessage: false,\r\n        isVideoMessage: false,\r\n        isAudioMessage: false,\r\n        fileUrl: \"\",\r\n        toUser:\r\n          isSentByMe && event.from.includes(\"@conference.\")\r\n            ? event.from.split(\"/\")[0]\r\n            : event.to,\r\n        fromUser: isSentByMe ? settings.xmppUser : event.from.split(\"/\")[0],\r\n        deliverStatus: DeliverStatus.DELIVERED,\r\n        readStatus: ReadStatus.UNREAD,\r\n        deliverTimestamp: new Date().toISOString(),\r\n        readTimestamp: \"\",\r\n        content: \"\",\r\n        contentType: (event as FileMessage).fileUrl || \"text\",\r\n        isSentByMe: isSentByMe,\r\n        isReplyMessage: false,\r\n        isForwardMessage: false,\r\n        replyedMessage: \"\",\r\n        replyedMessageTo: \"\",\r\n        replyedMessageId: \"\",\r\n        eventId: event.eventId,\r\n        eventBody: event.eventBody,\r\n      };\r\n      this.notify(Events.GROUP_EVENT, eventParsed);\r\n    });\r\n  };\r\n  onRemovingMember = (event: Message) => {\r\n    this.settings.get((settings) => {\r\n      const isSentByMe =\r\n        event.from.split(\"/\")[1] === settings.xmppUser ||\r\n        event.from.split(\"@\")[0] === settings.xmppUser;\r\n      const eventParsed: IMessage = {\r\n        id: event.id,\r\n        userName: this.getMessageUserName(event) || \"\",\r\n        userProfilePicture:\r\n          this.getMessageUserProfilePicture(event) || undefined,\r\n        message: \"\",\r\n        time: event.sent_at,\r\n        isFileMessage: false,\r\n        isImageMessage: false,\r\n        isVideoMessage: false,\r\n        isAudioMessage: false,\r\n        fileUrl: \"\",\r\n        toUser:\r\n          isSentByMe && event.from.includes(\"@conference.\")\r\n            ? event.from.split(\"/\")[0]\r\n            : event.to,\r\n        fromUser: isSentByMe ? settings.xmppUser : event.from.split(\"/\")[0],\r\n        deliverStatus: DeliverStatus.DELIVERED,\r\n        readStatus: ReadStatus.UNREAD,\r\n        deliverTimestamp: new Date().toISOString(),\r\n        readTimestamp: \"\",\r\n        content: \"\",\r\n        contentType: (event as FileMessage).fileUrl || \"text\",\r\n        isSentByMe: isSentByMe,\r\n        isReplyMessage: false,\r\n        isForwardMessage: false,\r\n        replyedMessage: \"\",\r\n        replyedMessageTo: \"\",\r\n        replyedMessageId: \"\",\r\n        eventId: event.eventId,\r\n        eventBody: event.eventBody,\r\n      };\r\n      this.notify(Events.REMOVE_MEMBER, eventParsed);\r\n    });\r\n  };\r\n  onMessage = (msg: Message | FileMessage) => {\r\n    this.settings.get((settings) => {\r\n      const fileParams = {\r\n        isFile: \"fileUrl\" in msg ? true : false,\r\n        isImage: false,\r\n        isVideo: false,\r\n        isAudio: false,\r\n      };\r\n      if (fileParams.isFile) {\r\n        fileParams.isImage = /\\.(jpe?g|png|gif|ico)$/i.test(\r\n          (msg as FileMessage).fileUrl\r\n        );\r\n        fileParams.isVideo = /\\.(mp4|avi|mov)$/i.test(\r\n          (msg as FileMessage).fileUrl\r\n        );\r\n        fileParams.isAudio = /\\.(ogg|mp3|wav|m4a|webm)$/i.test(\r\n          (msg as FileMessage).fileUrl\r\n        );\r\n      }\r\n      if (isUrl(msg.message)) {\r\n        const splittedMsg = msg.message.split(\"/\");\r\n        const extension = splittedMsg[splittedMsg.length - 1];\r\n        if (extension.includes(\".\") && splittedMsg.length > 1) {\r\n          fileParams.isFile = true;\r\n          fileParams.isImage = /\\.(jpe?g|png|gif|ico)$/i.test(msg.message);\r\n          fileParams.isVideo = /\\.(mp4|avi|mov)$/i.test(msg.message);\r\n          fileParams.isAudio = /\\.(ogg|mp3|wav|m4a|webm)$/i.test(msg.message);\r\n        }\r\n      }\r\n      const isSentByMe =\r\n        msg.from.split(\"/\")[1] === settings.xmppUser ||\r\n        msg.from.split(\"@\")[0] === settings.xmppUser;\r\n      const message: IMessage = {\r\n        id: msg.id,\r\n        userName: this.getMessageUserName(msg) || \"\",\r\n        userProfilePicture: this.getMessageUserProfilePicture(msg) || undefined,\r\n        message: msg.message || (msg as FileMessage).fileUrl,\r\n        time: msg.sent_at,\r\n        isFileMessage:\r\n          fileParams.isFile &&\r\n          !fileParams.isImage &&\r\n          !fileParams.isVideo &&\r\n          !fileParams.isAudio,\r\n        isImageMessage: fileParams.isImage,\r\n        isVideoMessage: fileParams.isVideo,\r\n        isAudioMessage: fileParams.isAudio,\r\n        fileUrl: getFileUrlStr(fileParams, msg),\r\n        toUser:\r\n          isSentByMe && msg.from.includes(\"@conference.\")\r\n            ? msg.from.split(\"/\")[0]\r\n            : msg.to,\r\n        fromUser: isSentByMe ? settings.xmppUser : msg.from.split(\"/\")[0],\r\n        deliverStatus: DeliverStatus.DELIVERED,\r\n        readStatus: ReadStatus.UNREAD,\r\n        deliverTimestamp: new Date().toISOString(),\r\n        readTimestamp: \"\",\r\n        content: JSON.stringify({\r\n          reply_msg: msg.reply_msg,\r\n          reply_msg_id: msg.reply_msg_id,\r\n          reply_to: msg.reply_to,\r\n        }),\r\n        contentType: (msg as FileMessage).fileUrl || \"text\",\r\n        isSentByMe: isSentByMe,\r\n        isReplyMessage: !!msg.reply_msg,\r\n        isForwardMessage: !!msg.reply_to && !msg.reply_msg,\r\n        replyedMessage: msg.reply_msg,\r\n        replyedMessageTo:\r\n          this.contacts.getContacts().get(msg.reply_to?.split(\"@\")[0] || \"\")\r\n            ?.name || this.user.user?.id === msg.reply_to?.split(\"@\")[0]\r\n            ? this.user.user?.name\r\n            : \"Participant\",\r\n        replyedMessageId: msg.reply_msg_id,\r\n      };\r\n      this.notify(Events.MESSAGE, message);\r\n    });\r\n  };\r\n  onPresence = (presence: Presence) => {\r\n    this.notify(Events.PRESENCE, presence);\r\n  };\r\n  onStanza(stanza: any) {}\r\n  onError(error: any) {}\r\n  forwardMessage = (\r\n    chat: IChat,\r\n    message: IMessage,\r\n    callback: SendMessageCallback\r\n  ) => {\r\n    this.chat.forwardMsg(\r\n      chat.jid,\r\n      chat.jid.includes(\"@conference.\")\r\n        ? XMPPChatType.GROUPCHAT\r\n        : XMPPChatType.CHAT,\r\n      message.fromUser,\r\n      message.message,\r\n      message.id,\r\n      callback\r\n    );\r\n  };\r\n  replyMsg = (\r\n    chat: IChat,\r\n    message: IMessage,\r\n    replyedMessage: IMessage,\r\n    cb: SendMessageCallback\r\n  ) => {\r\n    this.chat.replyMsg(\r\n      chat.jid,\r\n      chat.jid.includes(\"@conference.\")\r\n        ? XMPPChatType.GROUPCHAT\r\n        : XMPPChatType.CHAT,\r\n      message.message,\r\n      replyedMessage.fromUser,\r\n      replyedMessage.message,\r\n      replyedMessage.id,\r\n      cb\r\n    );\r\n  };\r\n  sendMessage = (chat: IChat, text: string, callback: SendMessageCallback) => {\r\n    this.chat.sendMessage(\r\n      chat.jid,\r\n      chat.chatType === ChatType.USER\r\n        ? XMPPChatType.CHAT\r\n        : XMPPChatType.GROUPCHAT,\r\n      text,\r\n      callback\r\n    );\r\n  };\r\n  sendFiles = (chat: IChat, files: File[], cb: any) => {\r\n    files.forEach((file) => {\r\n      this.chat.sendFile(\r\n        chat.jid,\r\n        chat.jid.includes(\"@conference.\")\r\n          ? XMPPChatType.GROUPCHAT\r\n          : XMPPChatType.CHAT,\r\n        file,\r\n        cb\r\n      );\r\n    });\r\n  };\r\n  joinGroup(to: string) {\r\n    this.chat.joinRoom(to);\r\n  }\r\n  joinGroups(groups: string[]) {\r\n    groups.forEach((jid) => this.joinGroup(jid));\r\n  }\r\n  changeStatus(status: string) {\r\n    this.chat.sendPresence(status);\r\n  }\r\n  getMessageUserName = (msg: Message | FileMessage) => {\r\n    if (msg.from.includes(\"@conference.\")) {\r\n      const groups = this.groups.getGroups();\r\n      const group = groups.get(msg.from.split(\"@\")[0]);\r\n      const member = group?.members.filter(\r\n        (member) => member.userId === msg.from.split(\"/\")[1]\r\n      )[0];\r\n      return member?.name;\r\n    } else {\r\n      return this.contacts.getContacts().get(msg.from.split(\"@\")[0])?.name;\r\n    }\r\n  };\r\n  getMessageUserProfilePicture = (msg: Message | FileMessage) => {\r\n    if (msg.from.includes(\"@conference.\")) {\r\n      const groups = this.groups.getGroups();\r\n      const group = groups.get(msg.from.split(\"@\")[0]);\r\n      const member = group?.members.filter(\r\n        (member) => member.userId === msg.from.split(\"/\")[1]\r\n      )[0];\r\n      return member?.profilePicture;\r\n    } else {\r\n      return this.contacts.getContacts().get(msg.from.split(\"@\")[0])\r\n        ?.profilePicture;\r\n    }\r\n  };\r\n  subscribe(subscribeCallback: SubscriptionCallBack) {\r\n    this.subscriptions.set(this.nextSubscriptionId, subscribeCallback);\r\n    this.nextSubscriptionId += 1;\r\n  }\r\n  removeSubscription(id: number) {\r\n    this.subscriptions.delete(id);\r\n  }\r\n  removeAllSubscription() {\r\n    this.subscriptions = new Map<number, SubscriptionCallBack>();\r\n  }\r\n  notify(event: string, data: any) {\r\n    if (this.subscriptions) {\r\n      this.subscriptions.forEach((subscribeCallback) => {\r\n        if (subscribeCallback) subscribeCallback(event, data);\r\n      });\r\n    }\r\n  }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}