{"ast":null,"code":"import { client, xml } from \"@xmpp/client\";\nimport { v4 } from \"uuid\";\nimport { getFrom, getMessage, isTextMessage, getTo, getMessageId, isFileMessage, getMessageType, getMessagFileUrl, getReplyTo, getReplyMsg, getReplyMsgId } from \"./util/stanzaUtils\";\n\nconst events = require(\"events\");\n\nexport default class Chat extends events.EventEmitter {\n  constructor({\n    service: _service,\n    domain: _domain,\n    resource: _resource,\n    username: _username,\n    password: _password\n  }) {\n    super();\n\n    this.getJid = () => {\n      return `${this.username}@${this.getDomain()}`;\n    };\n\n    this.getDomain = () => {\n      return this.domain || this.service.replace(\"wss://\", \"\").replace(\"ws://\", \"\").split(\"/\")[0];\n    };\n\n    this.instanceMaker = ({\n      service,\n      domain,\n      resource,\n      username,\n      password\n    }) => {\n      const xmpp = client({\n        service: service,\n        domain: domain,\n        resource: resource,\n        username: username,\n        password: password\n      });\n      xmpp.on(\"status\", this.onStatus);\n      xmpp.on(\"stanza\", this.onStanza);\n      xmpp.on(\"online\", this.onOnline);\n      xmpp.on(\"error\", this.onError);\n      xmpp.on(\"offline\", this.onOffline);\n      return xmpp;\n    };\n\n    this.onStanza = stanza => {\n      this.emit(\"stanza\", stanza);\n      if (stanza.is(\"message\")) this.onMessage(stanza);else if (stanza.is(\"presence\")) this.onPresence(stanza);else if (stanza.is(\"iq\")) this.onIQ(stanza);else return;\n    };\n\n    this.onOnline = __ => {\n      this.client.send(xml(\"presence\"));\n      this.emit(\"online\");\n    };\n\n    this.onOffline = () => {\n      this.emit(\"offline\");\n    };\n\n    this.onError = e => {\n      this.emit(\"error\", e);\n    };\n\n    this.onStatus = status => {\n      this.emit(\"status\", status);\n    };\n\n    this.onMessage = stanza => {\n      if (isTextMessage(stanza)) {\n        const message = {\n          id: getMessageId(stanza),\n          to: getTo(stanza),\n          from: getFrom(stanza),\n          message: getMessage(stanza),\n          type: getMessageType(stanza),\n          sent_at: new Date().toISOString(),\n          reply_to: getReplyTo(stanza),\n          reply_msg: getReplyMsg(stanza),\n          reply_msg_id: getReplyMsgId(stanza)\n        };\n        this.sendReceipts(stanza);\n        this.emit(\"message\", message);\n      } else if (isFileMessage(stanza)) {\n        const fileMessage = {\n          id: getMessageId(stanza),\n          to: getTo(stanza),\n          from: getFrom(stanza),\n          message: \"\",\n          type: getMessageType(stanza),\n          sent_at: new Date().toISOString(),\n          reply_to: getReplyTo(stanza),\n          reply_msg: getReplyMsg(stanza),\n          reply_msg_id: getReplyMsgId(stanza),\n          fileUrl: getMessagFileUrl(stanza)\n        };\n        this.sendReceipts(stanza);\n        this.emit(\"message\", fileMessage);\n      }\n    };\n\n    this.onPresence = stanza => {\n      const presence = {\n        id: v4(),\n        from: stanza.attrs.from,\n        time: new Date().toISOString(),\n        status: stanza.getChild(\"show\") ? stanza.getChild(\"show\").children[0] : stanza.attrs.type || \"online\"\n      };\n      this.presences.set(stanza.attrs.from, presence);\n      this.emit(\"presence\", presence);\n    };\n\n    this.onIQ = stanza => {\n      if (stanza.attrs.type === \"result\") {\n        if (stanza.attrs.id) {\n          const file = this.filesQueue.get(stanza.attrs.id);\n          if (file) if (stanza.attrs.id === file.firstStepId) {\n            this.sendFileSecondStep(stanza);\n          } else if (stanza.attrs.id === file.secondStepId) {\n            this.sendFileThirdStep(stanza);\n          } else if (stanza.attrs.id === file.thirdStepId) {\n            this.sendFileFourthStep(stanza, file);\n          }\n        }\n      }\n    };\n\n    this.getPresence = from => {\n      const presence = this.presences.get(from);\n      if (presence) return presence;else return null;\n    };\n\n    this.sendMessage = (to, chatType, message, callback) => {\n      const msgId = v4();\n      this.client.send(xml(\"message\", {\n        id: msgId,\n        type: chatType,\n        to: to\n      }, xml(\"body\", {}, message), xml(\"request\", {\n        xmlns: \"urn:xmpp:receipts\"\n      }))).then(() => {\n        callback(msgId);\n      });\n    };\n\n    this.sendFile = (to, chatType, file, callback) => {\n      const fileId = v4();\n      this.filesQueue.set(fileId, {\n        firstStepId: fileId,\n        file: file,\n        to: to,\n        chatType: chatType,\n        callback: callback\n      });\n      this.sendServiceDiscoveryRequest(fileId);\n    };\n\n    this.sendImageMessage = (url, to, chatType, callback) => {\n      const msgId = v4();\n      const messagePacket = xml(\"message\", {\n        id: msgId,\n        type: chatType,\n        to: to\n      }, xml(\"body\", {}, url), xml(\"request\", {\n        xmlns: \"urn:xmpp:receipts\"\n      }), xml(\"x\", {\n        xmlns: \"jabber:x:oob\"\n      }, xml(\"url\", {}, url)));\n\n      if (this.client) {\n        callback({\n          url,\n          msgId\n        });\n        this.client.send(messagePacket);\n      }\n    };\n\n    this.sendFileSecondStep = stanza => {\n      if (stanza.children.length > 0) {\n        stanza.children[0].children.forEach(element => {\n          if (element.attrs.jid.includes(\"upload.\")) {\n            const secondStepId = v4();\n            const file = this.filesQueue.get(stanza.attrs.id);\n\n            if (file) {\n              this.filesQueue.set(secondStepId, {\n                firstStepId: file.firstStepId,\n                secondStepId: secondStepId,\n                file: file.file,\n                to: file.to,\n                chatType: file.chatType,\n                callback: file.callback\n              });\n              this.filesQueue.delete(stanza.attrs.id);\n            }\n\n            this.sendServiceDiscoveryRequestToUpload(element.attrs.jid, secondStepId);\n            return;\n          }\n        });\n      }\n    };\n\n    this.sendFileThirdStep = stanza => {\n      if (stanza.children.length > 0) {\n        const thirdStepId = v4();\n        const file = this.filesQueue.get(stanza.attrs.id);\n\n        if (file) {\n          this.filesQueue.set(thirdStepId, {\n            firstStepId: file.firstStepId,\n            secondStepId: file.secondStepId,\n            thirdStepId: thirdStepId,\n            file: file.file,\n            to: file.to,\n            chatType: file.chatType,\n            callback: file.callback\n          });\n          this.filesQueue.delete(stanza.attrs.id);\n        }\n\n        console.log(\"upload request xmlns\", stanza.children[0].children[2].attrs.var);\n        this.sendRequestSlotOnUpload(stanza.attrs.from, thirdStepId);\n      }\n    };\n\n    this.sendFileFourthStep = (stanza, file) => {\n      let getUrl = \"\";\n      let putUrl = \"\";\n      stanza.children[0].children.forEach(element => {\n        if (element.is(\"get\")) {\n          getUrl = element.attrs.url;\n        } else if (element.is(\"put\")) {\n          putUrl = element.attrs.url;\n        }\n      });\n      if (file === null || file === void 0 ? void 0 : file.thirdStepId) this.uploadFile(putUrl, getUrl, file.thirdStepId);\n    };\n\n    this.sendServiceDiscoveryRequest = fileId => {\n      const serviceDiscoveryRequest = xml(\"iq\", {\n        type: \"get\",\n        to: this.getDomain(),\n        id: fileId\n      }, xml(\"query\", {\n        xmlns: \"http://jabber.org/protocol/disco#items\"\n      }));\n\n      if (this.client) {\n        this.client.send(serviceDiscoveryRequest);\n      }\n    };\n\n    this.sendServiceDiscoveryRequestToUpload = (uploadJid, uploadId) => {\n      console.log(\"sendServiceDiscoveryRequestToUpload\", uploadJid);\n      const serviceDiscoveryRequest = xml(\"iq\", {\n        type: \"get\",\n        to: uploadJid,\n        id: uploadId\n      }, xml(\"query\", {\n        xmlns: \"http://jabber.org/protocol/disco#info\"\n      }));\n\n      if (this.client) {\n        this.client.send(serviceDiscoveryRequest);\n      }\n    };\n\n    this.sendRequestSlotOnUpload = (uploadJid, thirdStepId) => {\n      var _this$filesQueue$get;\n\n      console.log(\"sendRequestSlotOnUpload\", uploadJid);\n      const file = (_this$filesQueue$get = this.filesQueue.get(thirdStepId)) === null || _this$filesQueue$get === void 0 ? void 0 : _this$filesQueue$get.file;\n      const serviceDiscoveryRequest = xml(\"iq\", {\n        type: \"get\",\n        to: uploadJid,\n        id: thirdStepId\n      }, xml(\"request\", {\n        xmlns: \"urn:xmpp:http:upload:0\",\n        filename: file === null || file === void 0 ? void 0 : file.name,\n        size: file === null || file === void 0 ? void 0 : file.size,\n        \"content-type\": file === null || file === void 0 ? void 0 : file.type\n      }));\n\n      if (this.client) {\n        this.client.send(serviceDiscoveryRequest);\n      }\n    };\n\n    this.uploadFile = (putUrl, getUrl, id) => {\n      let xhr = new XMLHttpRequest();\n      const file = this.filesQueue.get(id);\n\n      if (file) {\n        xhr.onerror = () => {\n          if (xhr.responseText) {\n            file.callback(xhr.responseText, true);\n            console.log(\"upload error\");\n          }\n        };\n\n        xhr.onreadystatechange = e => {\n          if (xhr.readyState === XMLHttpRequest.DONE) {\n            console.log(\"file upload response\", e, xhr.status);\n\n            if (xhr.status === 200 || xhr.status === 201) {\n              console.log(\"file upload response success\");\n              this.sendImageMessage(getUrl, file.to, file.chatType, file === null || file === void 0 ? void 0 : file.callback);\n              this.filesQueue.delete(id);\n            }\n          }\n        };\n\n        xhr.upload.addEventListener(\"progress\", evt => {\n          console.log(\"progress\", evt); // if (file) file.file.size = evt.total\n        }, false);\n        xhr.open(\"PUT\", putUrl, true);\n        xhr.setRequestHeader(\"Content-Type\", file.file.type);\n        xhr.send(file.file);\n        console.log(\"URL\", putUrl);\n        console.log(\"fileSize\", file.file.size);\n      }\n    };\n\n    this.sendReceipts = stanza => {\n      const message = xml(\"message\", {\n        from: stanza.attrs.to,\n        id: v4(),\n        to: stanza.attrs.from.split(\"/\")[0]\n      }, xml(\"received\", {\n        xmlns: \"urn:xmpp:receipts\",\n        id: stanza.attrs.id\n      }));\n      console.log(message);\n      this.client.send(message);\n    };\n\n    this.replyMsg = (to, message, replyed_sender, replyed_msg, replyed_msg_id) => {\n      xml(\"message\", {\n        to: to\n      }, xml(\"body\", {}, message), xml(\"extraParams\", {}, xml(\"reply_to\", {}, replyed_sender), xml(\"reply_msg\", {}, replyed_msg), xml(\"reply_msg_id\", {}, replyed_msg_id)));\n    };\n\n    this.forwardMsg = (to, forwarded_msg_sender, forwarded_msg, forwarded_msg_id) => {\n      xml(\"message\", {\n        to: to\n      }, xml(\"body\", {}, forwarded_msg), xml(\"extraParams\", {}, xml(\"reply_to\", {}, forwarded_msg_sender), xml(\"reply_msg_id\", {}, forwarded_msg_id)));\n    };\n\n    this.joinRoom = to => {\n      const joinStanza = xml(\"presence\", {\n        to: to,\n        from: `${this.getJid()}/${this.resource}`\n      }, xml(\"x\", {\n        xmlns: \"http://jabber.org/protocol/muc\"\n      }));\n      this.client.send(joinStanza);\n    };\n\n    Object.setPrototypeOf(this, Chat.prototype);\n    this.service = _service;\n    this.domain = _domain;\n    this.resource = _resource;\n    this.username = _username;\n    this.password = _password;\n    this.client = this.instanceMaker({\n      service: _service,\n      domain: _domain,\n      resource: _resource,\n      username: _username,\n      password: _password\n    });\n    this.status = this.client.status;\n    this.connect = this.client.start;\n    this.filesQueue = new Map();\n    this.presences = new Map();\n  }\n\n}","map":{"version":3,"sources":["C:/Users/Digivox/dev/Digivox/Refatoracao/squad/src/services/chat/chatcommunicator.ts"],"names":["client","xml","v4","getFrom","getMessage","isTextMessage","getTo","getMessageId","isFileMessage","getMessageType","getMessagFileUrl","getReplyTo","getReplyMsg","getReplyMsgId","events","require","Chat","EventEmitter","constructor","service","domain","resource","username","password","getJid","getDomain","replace","split","instanceMaker","xmpp","on","onStatus","onStanza","onOnline","onError","onOffline","stanza","emit","is","onMessage","onPresence","onIQ","__","send","e","status","message","id","to","from","type","sent_at","Date","toISOString","reply_to","reply_msg","reply_msg_id","sendReceipts","fileMessage","fileUrl","presence","attrs","time","getChild","children","presences","set","file","filesQueue","get","firstStepId","sendFileSecondStep","secondStepId","sendFileThirdStep","thirdStepId","sendFileFourthStep","getPresence","sendMessage","chatType","callback","msgId","xmlns","then","sendFile","fileId","sendServiceDiscoveryRequest","sendImageMessage","url","messagePacket","length","forEach","element","jid","includes","delete","sendServiceDiscoveryRequestToUpload","console","log","var","sendRequestSlotOnUpload","getUrl","putUrl","uploadFile","serviceDiscoveryRequest","uploadJid","uploadId","filename","name","size","xhr","XMLHttpRequest","onerror","responseText","onreadystatechange","readyState","DONE","upload","addEventListener","evt","open","setRequestHeader","replyMsg","replyed_sender","replyed_msg","replyed_msg_id","forwardMsg","forwarded_msg_sender","forwarded_msg","forwarded_msg_id","joinRoom","joinStanza","Object","setPrototypeOf","prototype","connect","start","Map"],"mappings":"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","sourcesContent":["import { client, xml, XmppClient } from \"@xmpp/client\";\r\nimport { v4 } from \"uuid\";\r\nimport {\r\n  ChatType,\r\n  ConnectionOptions,\r\n  ErrorCallback,\r\n  Events,\r\n  FileMessage,\r\n  Message,\r\n  MessageCallback,\r\n  OfflineCallback,\r\n  OnlineCallback,\r\n  Presence,\r\n  PresenceCallback,\r\n  SendImageCallback,\r\n  SendingFile,\r\n  SendMessageCallback,\r\n  StanzaCallback,\r\n} from \"./types/types\";\r\nimport {\r\n  getFrom,\r\n  getMessage,\r\n  isTextMessage,\r\n  getTo,\r\n  getMessageId,\r\n  isFileMessage,\r\n  getMessageType,\r\n  getMessagFileUrl,\r\n  getReplyTo,\r\n  getReplyMsg,\r\n  getReplyMsgId,\r\n} from \"./util/stanzaUtils\";\r\nconst events = require(\"events\");\r\n\r\nexport default interface Chat {\r\n  service: string;\r\n  domain?: string;\r\n  resource: string;\r\n  username: string;\r\n  password?: string;\r\n  client: XmppClient;\r\n  status: string;\r\n  filesQueue: Map<string, SendingFile>;\r\n  presences: Map<string, Presence>;\r\n  connect(): Promise<any>;\r\n  on(event: Events.MESSAGE, cb: MessageCallback): this;\r\n  on(event: Events.PRESENCE, cb: PresenceCallback): this;\r\n  on(event: Events.ONLINE, cb: OnlineCallback): this;\r\n  on(event: Events.OFFLINE, cb: OfflineCallback): this;\r\n  on(event: Events.ERROR, cb: ErrorCallback): this;\r\n  on(event: Events.STANZA, cb: StanzaCallback): this;\r\n  getPresence(from: string): Presence | null;\r\n  sendMessage(\r\n    to: string,\r\n    chatType: ChatType,\r\n    message: string,\r\n    cb: SendMessageCallback\r\n  ): void;\r\n  sendFile(\r\n    to: string,\r\n    chatType: ChatType,\r\n    file: File,\r\n    callback: SendImageCallback\r\n  ): void;\r\n  getDomain(): string;\r\n  joinRoom(to: string): void;\r\n}\r\nexport default class Chat extends events.EventEmitter {\r\n  constructor({\r\n    service,\r\n    domain,\r\n    resource,\r\n    username,\r\n    password,\r\n  }: ConnectionOptions) {\r\n    super();\r\n    Object.setPrototypeOf(this, Chat.prototype);\r\n    this.service = service;\r\n    this.domain = domain;\r\n    this.resource = resource;\r\n    this.username = username;\r\n    this.password = password;\r\n    this.client = this.instanceMaker({\r\n      service: service,\r\n      domain: domain,\r\n      resource: resource,\r\n      username: username,\r\n      password: password,\r\n    });\r\n    this.status = this.client.status;\r\n    this.connect = this.client.start;\r\n    this.filesQueue = new Map<string, SendingFile>();\r\n    this.presences = new Map<string, Presence>();\r\n  }\r\n\r\n  getJid = () => {\r\n    return `${this.username}@${this.getDomain()}`;\r\n  };\r\n\r\n  getDomain = () => {\r\n    return (\r\n      this.domain ||\r\n      this.service.replace(\"wss://\", \"\").replace(\"ws://\", \"\").split(\"/\")[0]\r\n    );\r\n  };\r\n\r\n  instanceMaker = ({\r\n    service,\r\n    domain,\r\n    resource,\r\n    username,\r\n    password,\r\n  }: ConnectionOptions) => {\r\n    const xmpp = client({\r\n      service: service,\r\n      domain: domain,\r\n      resource: resource,\r\n      username: username,\r\n      password: password,\r\n    });\r\n    xmpp.on(\"status\", this.onStatus);\r\n    xmpp.on(\"stanza\", this.onStanza);\r\n    xmpp.on(\"online\", this.onOnline);\r\n    xmpp.on(\"error\", this.onError);\r\n    xmpp.on(\"offline\", this.onOffline);\r\n    return xmpp;\r\n  };\r\n\r\n  onStanza = (stanza: any) => {\r\n    this.emit(\"stanza\", stanza);\r\n    if (stanza.is(\"message\")) this.onMessage(stanza);\r\n    else if (stanza.is(\"presence\")) this.onPresence(stanza);\r\n    else if (stanza.is(\"iq\")) this.onIQ(stanza);\r\n    else return;\r\n  };\r\n\r\n  onOnline = (__: any) => {\r\n    this.client.send(xml(\"presence\"));\r\n    this.emit(\"online\");\r\n  };\r\n\r\n  onOffline = () => {\r\n    this.emit(\"offline\");\r\n  };\r\n\r\n  onError = (e: any) => {\r\n    this.emit(\"error\", e);\r\n  };\r\n\r\n  onStatus = (status: string) => {\r\n    this.emit(\"status\", status);\r\n  };\r\n\r\n  onMessage = (stanza: any) => {\r\n    if (isTextMessage(stanza)) {\r\n      const message: Message = {\r\n        id: getMessageId(stanza),\r\n        to: getTo(stanza),\r\n        from: getFrom(stanza),\r\n        message: getMessage(stanza),\r\n        type: getMessageType(stanza),\r\n        sent_at: new Date().toISOString(),\r\n        reply_to: getReplyTo(stanza),\r\n        reply_msg: getReplyMsg(stanza),\r\n        reply_msg_id: getReplyMsgId(stanza),\r\n      };\r\n      this.sendReceipts(stanza);\r\n      this.emit(\"message\", message);\r\n    } else if (isFileMessage(stanza)) {\r\n      const fileMessage: FileMessage = {\r\n        id: getMessageId(stanza),\r\n        to: getTo(stanza),\r\n        from: getFrom(stanza),\r\n        message: \"\",\r\n        type: getMessageType(stanza),\r\n        sent_at: new Date().toISOString(),\r\n        reply_to: getReplyTo(stanza),\r\n        reply_msg: getReplyMsg(stanza),\r\n        reply_msg_id: getReplyMsgId(stanza),\r\n        fileUrl: getMessagFileUrl(stanza),\r\n      };\r\n      this.sendReceipts(stanza);\r\n      this.emit(\"message\", fileMessage);\r\n    }\r\n  };\r\n\r\n  onPresence = (stanza: any) => {\r\n    const presence: Presence = {\r\n      id: v4(),\r\n      from: stanza.attrs.from,\r\n      time: new Date().toISOString(),\r\n      status: stanza.getChild(\"show\")\r\n        ? stanza.getChild(\"show\").children[0]\r\n        : stanza.attrs.type || \"online\",\r\n    };\r\n    this.presences.set(stanza.attrs.from, presence);\r\n    this.emit(\"presence\", presence);\r\n  };\r\n\r\n  onIQ = (stanza: any) => {\r\n    if (stanza.attrs.type === \"result\") {\r\n      if (stanza.attrs.id) {\r\n        const file = this.filesQueue.get(stanza.attrs.id);\r\n        if (file)\r\n          if (stanza.attrs.id === file.firstStepId) {\r\n            this.sendFileSecondStep(stanza);\r\n          } else if (stanza.attrs.id === file.secondStepId) {\r\n            this.sendFileThirdStep(stanza);\r\n          } else if (stanza.attrs.id === file.thirdStepId) {\r\n            this.sendFileFourthStep(stanza, file);\r\n          }\r\n      }\r\n    }\r\n  };\r\n  getPresence = (from: string) => {\r\n    const presence = this.presences.get(from);\r\n    if (presence) return presence;\r\n    else return null;\r\n  };\r\n  sendMessage = (\r\n    to: string,\r\n    chatType: ChatType,\r\n    message: string,\r\n    callback: SendMessageCallback\r\n  ) => {\r\n    const msgId = v4();\r\n    this.client.send(\r\n      xml(\r\n        \"message\",\r\n        {\r\n          id: msgId,\r\n          type: chatType,\r\n          to: to,\r\n        },\r\n        xml(\"body\", {}, message),\r\n        xml(\"request\", { xmlns: \"urn:xmpp:receipts\" })\r\n      )\r\n    ).then(() => {\r\n      callback(msgId);\r\n    });\r\n  };\r\n\r\n  sendFile = (\r\n    to: string,\r\n    chatType: ChatType,\r\n    file: File,\r\n    callback: SendImageCallback\r\n  ) => {\r\n    const fileId: string = v4();\r\n    this.filesQueue.set(fileId, {\r\n      firstStepId: fileId,\r\n      file: file,\r\n      to: to,\r\n      chatType: chatType,\r\n      callback: callback,\r\n    });\r\n    this.sendServiceDiscoveryRequest(fileId);\r\n  };\r\n\r\n  sendImageMessage = (url: string, to: string, chatType: ChatType, callback: SendImageCallback) => {\r\n    const msgId = v4()\r\n    const messagePacket = xml(\r\n      \"message\",\r\n      {\r\n        id: msgId,\r\n        type: chatType,\r\n        to: to,\r\n      },\r\n      xml(\"body\", {}, url),\r\n      xml(\"request\", { xmlns: \"urn:xmpp:receipts\" }),\r\n      xml(\"x\", { xmlns: \"jabber:x:oob\" }, xml(\"url\", {}, url))\r\n      );\r\n      if (this.client) {\r\n        callback({url, msgId});\r\n        this.client.send(messagePacket);\r\n    }\r\n  };\r\n\r\n  sendFileSecondStep = (stanza: any) => {\r\n    if (stanza.children.length > 0) {\r\n      stanza.children[0].children.forEach((element: any) => {\r\n        if (element.attrs.jid.includes(\"upload.\")) {\r\n          const secondStepId = v4();\r\n          const file = this.filesQueue.get(stanza.attrs.id);\r\n          if (file) {\r\n            this.filesQueue.set(secondStepId, {\r\n              firstStepId: file.firstStepId,\r\n              secondStepId: secondStepId,\r\n              file: file.file,\r\n              to: file.to,\r\n              chatType: file.chatType,\r\n              callback: file.callback,\r\n            });\r\n            this.filesQueue.delete(stanza.attrs.id);\r\n          }\r\n          this.sendServiceDiscoveryRequestToUpload(\r\n            element.attrs.jid,\r\n            secondStepId\r\n          );\r\n          return;\r\n        }\r\n      });\r\n    }\r\n  };\r\n\r\n  sendFileThirdStep = (stanza: any) => {\r\n    if (stanza.children.length > 0) {\r\n      const thirdStepId = v4();\r\n      const file = this.filesQueue.get(stanza.attrs.id);\r\n      if (file) {\r\n        this.filesQueue.set(thirdStepId, {\r\n          firstStepId: file.firstStepId,\r\n          secondStepId: file.secondStepId,\r\n          thirdStepId: thirdStepId,\r\n          file: file.file,\r\n          to: file.to,\r\n          chatType: file.chatType,\r\n          callback: file.callback,\r\n        });\r\n        this.filesQueue.delete(stanza.attrs.id);\r\n      }\r\n      console.log(\r\n        \"upload request xmlns\",\r\n        stanza.children[0].children[2].attrs.var\r\n      );\r\n      this.sendRequestSlotOnUpload(stanza.attrs.from, thirdStepId);\r\n    }\r\n  };\r\n\r\n  sendFileFourthStep = (stanza: any, file: SendingFile) => {\r\n    let getUrl = \"\";\r\n    let putUrl = \"\";\r\n    stanza.children[0].children.forEach((element: any) => {\r\n      if (element.is(\"get\")) {\r\n        getUrl = element.attrs.url;\r\n      } else if (element.is(\"put\")) {\r\n        putUrl = element.attrs.url;\r\n      }\r\n    });\r\n    if (file?.thirdStepId) this.uploadFile(putUrl, getUrl, file.thirdStepId);\r\n  };\r\n\r\n  sendServiceDiscoveryRequest = (fileId: string) => {\r\n    const serviceDiscoveryRequest = xml(\r\n      \"iq\",\r\n      {\r\n        type: \"get\",\r\n        to: this.getDomain(),\r\n        id: fileId,\r\n      },\r\n      xml(\"query\", { xmlns: \"http://jabber.org/protocol/disco#items\" })\r\n    );\r\n    if (this.client) {\r\n      this.client.send(serviceDiscoveryRequest);\r\n    }\r\n  };\r\n\r\n  sendServiceDiscoveryRequestToUpload = (\r\n    uploadJid: string,\r\n    uploadId: string\r\n  ) => {\r\n    console.log(\"sendServiceDiscoveryRequestToUpload\", uploadJid);\r\n    const serviceDiscoveryRequest = xml(\r\n      \"iq\",\r\n      {\r\n        type: \"get\",\r\n        to: uploadJid,\r\n        id: uploadId,\r\n      },\r\n      xml(\"query\", { xmlns: \"http://jabber.org/protocol/disco#info\" })\r\n    );\r\n    if (this.client) {\r\n      this.client.send(serviceDiscoveryRequest);\r\n    }\r\n  };\r\n\r\n  sendRequestSlotOnUpload = (uploadJid: string, thirdStepId: string) => {\r\n    console.log(\"sendRequestSlotOnUpload\", uploadJid);\r\n    const file = this.filesQueue.get(thirdStepId)?.file;\r\n    const serviceDiscoveryRequest = xml(\r\n      \"iq\",\r\n      {\r\n        type: \"get\",\r\n        to: uploadJid,\r\n        id: thirdStepId,\r\n      },\r\n      xml(\"request\", {\r\n        xmlns: \"urn:xmpp:http:upload:0\",\r\n        filename: file?.name,\r\n        size: file?.size,\r\n        \"content-type\": file?.type,\r\n      })\r\n    );\r\n    if (this.client) {\r\n      this.client.send(serviceDiscoveryRequest);\r\n    }\r\n  };\r\n\r\n  uploadFile = (putUrl: string, getUrl: string, id: string) => {\r\n    let xhr = new XMLHttpRequest();\r\n    const file = this.filesQueue.get(id);\r\n    if (file) {\r\n      xhr.onerror = () => {\r\n        if (xhr.responseText) {\r\n          file.callback(xhr.responseText, true);\r\n          console.log(\"upload error\");\r\n        }\r\n      };\r\n      xhr.onreadystatechange = (e) => {\r\n        if (xhr.readyState === XMLHttpRequest.DONE) {\r\n          console.log(\"file upload response\", e, xhr.status);\r\n          if (xhr.status === 200 || xhr.status === 201) {\r\n            console.log(\"file upload response success\");\r\n            this.sendImageMessage(getUrl, file.to, file.chatType, file?.callback);\r\n            this.filesQueue.delete(id);\r\n          }\r\n        }\r\n      };\r\n      xhr.upload.addEventListener(\r\n        \"progress\",\r\n        (evt) => {\r\n          console.log(\"progress\", evt);\r\n          // if (file) file.file.size = evt.total\r\n        },\r\n        false\r\n      );\r\n      xhr.open(\"PUT\", putUrl, true);\r\n      xhr.setRequestHeader(\"Content-Type\", file.file.type);\r\n\r\n      xhr.send(file.file);\r\n\r\n      console.log(\"URL\", putUrl);\r\n      console.log(\"fileSize\", file.file.size);\r\n    }\r\n  };\r\n  sendReceipts = (stanza: any) => {\r\n    const message = xml(\r\n      \"message\",\r\n      {\r\n        from: stanza.attrs.to,\r\n        id: v4(),\r\n        to: stanza.attrs.from.split(\"/\")[0],\r\n      },\r\n      xml(\"received\", { xmlns: \"urn:xmpp:receipts\", id: stanza.attrs.id })\r\n    );\r\n    console.log(message);\r\n    this.client.send(message);\r\n  };\r\n  replyMsg = (\r\n    to: string,\r\n    message: string,\r\n    replyed_sender: string,\r\n    replyed_msg: string,\r\n    replyed_msg_id: string\r\n  ) => {\r\n    xml(\r\n      \"message\",\r\n      { to: to },\r\n      xml(\"body\", {}, message),\r\n      xml(\r\n        \"extraParams\",\r\n        {},\r\n        xml(\"reply_to\", {}, replyed_sender),\r\n        xml(\"reply_msg\", {}, replyed_msg),\r\n        xml(\"reply_msg_id\", {}, replyed_msg_id)\r\n      )\r\n    );\r\n  };\r\n  forwardMsg = (\r\n    to: string,\r\n    forwarded_msg_sender: string,\r\n    forwarded_msg: string,\r\n    forwarded_msg_id: string\r\n  ) => {\r\n    xml(\r\n      \"message\",\r\n      { to: to },\r\n      xml(\"body\", {}, forwarded_msg),\r\n      xml(\r\n        \"extraParams\",\r\n        {},\r\n        xml(\"reply_to\", {}, forwarded_msg_sender),\r\n        xml(\"reply_msg_id\", {}, forwarded_msg_id)\r\n      )\r\n    );\r\n  };\r\n  joinRoom = (to: string) => {\r\n    const joinStanza = xml(\r\n      \"presence\",\r\n      {\r\n        to: to,\r\n        from: `${this.getJid()}/${this.resource}`,\r\n      },\r\n      xml(\"x\", { xmlns: \"http://jabber.org/protocol/muc\" })\r\n    );\r\n    this.client.send(joinStanza);\r\n  };\r\n}\r\n"]},"metadata":{},"sourceType":"module"}