{"ast":null,"code":"import _classCallCheck from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _assertThisInitialized from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/assertThisInitialized\";import _inherits from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/inherits\";import _createSuper from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createSuper\";import{client,xml}from\"@xmpp/client\";import{v4}from\"uuid\";import PresenceStatus from\"../../enuns/PresenceStatus\";import{Events}from\"./types/types\";import{getFrom,getMessage,isTextMessage,getTo,getMessageId,isFileMessage,getMessageType,getMessagFileUrl,getReplyTo,getReplyMsg,getReplyMsgId,isReceived,isDisplayed,getReceivedMessageId,getDisplayedMessageId,isComposing,isActive,isGroupEvent,getEventId,isNewGroup,getEventBody}from\"./util/stanzaUtils\";var events=require(\"events\");var Chat=/*#__PURE__*/function(_events$EventEmitter){_inherits(Chat,_events$EventEmitter);var _super=_createSuper(Chat);function Chat(_ref){var _this;var _service=_ref.service,_domain=_ref.domain,_resource=_ref.resource,_username=_ref.username,_password=_ref.password;_classCallCheck(this,Chat);_this=_super.call(this);_this.getJid=function(){return\"\".concat(_this.username,\"@\").concat(_this.getDomain());};_this.getDomain=function(){return _this.domain||_this.service.replace(\"wss://\",\"\").replace(\"ws://\",\"\").split(\"/\")[0];};_this.instanceMaker=function(_ref2){var service=_ref2.service,domain=_ref2.domain,resource=_ref2.resource,username=_ref2.username,password=_ref2.password;var xmpp=client({service:service,domain:domain,resource:resource,username:username,password:password});xmpp.on(\"status\",_this.onStatus);xmpp.on(\"stanza\",_this.onStanza);xmpp.on(\"online\",_this.onOnline);xmpp.on(\"error\",_this.onError);xmpp.on(\"offline\",_this.onOffline);return xmpp;};_this.onStanza=function(stanza){_this.emit(\"stanza\",stanza);if(stanza.is(\"message\"))_this.onMessage(stanza);else if(stanza.is(\"presence\"))_this.onPresence(stanza);else if(stanza.is(\"iq\"))_this.onIQ(stanza);else return;};_this.onOnline=function(__){_this.discoItensId=v4();// this.sendEnableCarbon();\n_this.sendServiceDiscoveryRequest(_this.discoItensId);_this.client.send(xml(\"presence\"));_this.emit(\"online\");};_this.onOffline=function(){_this.emit(\"offline\");};_this.onError=function(e){_this.emit(\"error\",e);};_this.onStatus=function(status){_this.emit(\"status\",status);};_this.onMessage=function(stanza){if(isGroupEvent(stanza)){if(isNewGroup(stanza)){var eventToNewGroup={to:getTo(stanza),from:getFrom(stanza),id:v4(),eventId:1,message:\"\",reply_msg:undefined,sent_at:new Date().toISOString(),type:\"groupchat\",reply_msg_id:undefined,reply_to:undefined};_this.emit(Events.SEND_EVENT,eventToNewGroup);}else{var _event={id:getMessageId(stanza),to:getTo(stanza),from:getFrom(stanza),message:\"\",type:\"groupchat\",sent_at:new Date().toISOString(),reply_to:undefined,reply_msg:undefined,reply_msg_id:undefined,eventId:getEventId(stanza),eventBody:getEventBody(stanza)};_this.emit(Events.SEND_EVENT,_event);}}else if(isTextMessage(stanza)){var _message={id:getMessageId(stanza),to:getTo(stanza),from:getFrom(stanza),message:getMessage(stanza),type:getMessageType(stanza),sent_at:new Date().toISOString(),reply_to:getReplyTo(stanza),reply_msg:getReplyMsg(stanza),reply_msg_id:getReplyMsgId(stanza)};_this.sendReceipts(stanza);_this.emit(Events.MESSAGE,_message);}else if(isFileMessage(stanza)){var fileMessage={id:getMessageId(stanza),to:getTo(stanza),from:getFrom(stanza),message:\"\",type:getMessageType(stanza),sent_at:new Date().toISOString(),reply_to:getReplyTo(stanza),reply_msg:getReplyMsg(stanza),reply_msg_id:getReplyMsgId(stanza),fileUrl:getMessagFileUrl(stanza)};_this.sendReceipts(stanza);_this.emit(Events.MESSAGE,fileMessage);}else if(isReceived(stanza)){var received={id:getReceivedMessageId(stanza)};_this.emit(Events.RECEIVED,received);}else if(isDisplayed(stanza)){var displayed={id:getDisplayedMessageId(stanza)};_this.emit(Events.DISPLAYED,displayed);}else if(isComposing(stanza)){_this.emit(Events.COMPOSING,getFrom(stanza));}else if(isActive(stanza)){_this.emit(Events.ACTIVE,getFrom(stanza));}};_this.onPresence=function(stanza){var presence={id:v4(),from:stanza.attrs.from,time:new Date().toISOString(),status:stanza.getChild(\"show\")?stanza.getChild(\"show\").children[0]:stanza.attrs.type||\"online\"};_this.presences.set(stanza.attrs.from,presence);_this.emit(\"presence\",presence);};_this.onIQ=function(stanza){if(stanza.attrs.type===\"result\"){if(stanza.attrs.id){var _file=_this.filesQueue.get(stanza.attrs.id);if(_file){if(stanza.attrs.id===_file.firstStepId){_this.sendFileSecondStep(stanza);}else if(stanza.attrs.id===_file.secondStepId){_this.sendFileThirdStep(stanza,_file);}}else if(stanza.attrs.id===_this.discoItensId){stanza.children[0].children.forEach(function(element){var key=element.attrs.jid.split(\".\")[0];_this.discoItems.set(key,element.attrs.jid);});}}}};_this.getPresence=function(from){var presence=_this.presences.get(from);if(presence)return presence;else return null;};_this.sendEnableCarbon=function(){var stanza=xml(\"iq\",{from:\"\".concat(_this.getJid(),\"/\").concat(_this.resource),type:\"set\",id:\"enable1\"},xml(\"enable\",{xmlns:\"urn:xmpp:carbons:2\"}));_this.client.send(stanza);};_this.sendPresence=function(status){var to=arguments.length>1&&arguments[1]!==undefined?arguments[1]:undefined;var show=xml(\"show\",{},status);if(status!==\"online\")_this.client.send(xml(\"presence\",{to:to},show));else _this.client.send(xml(\"presence\"));};_this.leaveGroup=function(to){var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:PresenceStatus.UNAVAILABLE;_this.client.send(xml(\"presence\",{to:to,type:type}));};_this.sendMessage=function(to,chatType,message,callback){var msgId=v4();_this.client.send(xml(\"message\",{id:msgId,type:chatType,to:to},xml(\"body\",{},message),xml(\"request\",{xmlns:\"urn:xmpp:receipts\"}))).then(function(){callback(msgId);});};_this.sendFile=function(to,chatType,file,callback){var fileId=v4();_this.filesQueue.set(fileId,{firstStepId:fileId,file:file,to:to,chatType:chatType,callback:callback});_this.sendFileFirstStep(fileId);};_this.sendImageMessage=function(url,to,chatType,callback){var msgId=v4();var messagePacket=xml(\"message\",{id:msgId,type:chatType,to:to},xml(\"body\",{},url),xml(\"request\",{xmlns:\"urn:xmpp:receipts\"}),xml(\"x\",{xmlns:\"jabber:x:oob\"},xml(\"url\",{},url)));if(_this.client){callback({url:url,msgId:msgId});_this.client.send(messagePacket);}};_this.sendFileFirstStep=function(fileId){var uploadJid=_this.discoItems.get(\"upload\");if(uploadJid){_this.sendServiceDiscoveryRequestToUpload(uploadJid,fileId);return;}};_this.sendFileSecondStep=function(stanza){if(stanza.children.length>0){var secondStepId=v4();var _file2=_this.filesQueue.get(stanza.attrs.id);if(_file2){_this.filesQueue.set(secondStepId,{firstStepId:_file2.firstStepId,secondStepId:secondStepId,file:_file2.file,to:_file2.to,chatType:_file2.chatType,callback:_file2.callback});_this.filesQueue.delete(stanza.attrs.id);}console.log(\"upload request xmlns\",stanza.children[0].children[2].attrs.var);_this.sendRequestSlotOnUpload(stanza.attrs.from,secondStepId);}};_this.sendFileThirdStep=function(stanza,file){var getUrl=\"\";var putUrl=\"\";stanza.children[0].children.forEach(function(element){if(element.is(\"get\")){getUrl=element.attrs.url;}else if(element.is(\"put\")){putUrl=element.attrs.url;}});if(file===null||file===void 0?void 0:file.secondStepId)_this.uploadFile(putUrl,getUrl,file.secondStepId);};_this.sendServiceDiscoveryRequest=function(fileId){var serviceDiscoveryRequest=xml(\"iq\",{type:\"get\",to:_this.getDomain(),id:fileId},xml(\"query\",{xmlns:\"http://jabber.org/protocol/disco#items\"}));if(_this.client){_this.client.send(serviceDiscoveryRequest);}};_this.sendServiceDiscoveryRequestToUpload=function(uploadJid,uploadId){console.log(\"sendServiceDiscoveryRequestToUpload\",uploadJid);var serviceDiscoveryRequest=xml(\"iq\",{type:\"get\",to:uploadJid,id:uploadId},xml(\"query\",{xmlns:\"http://jabber.org/protocol/disco#info\"}));if(_this.client){_this.client.send(serviceDiscoveryRequest);}};_this.sendRequestSlotOnUpload=function(uploadJid,thirdStepId){var _this$filesQueue$get;console.log(\"sendRequestSlotOnUpload\",uploadJid);var file=(_this$filesQueue$get=_this.filesQueue.get(thirdStepId))===null||_this$filesQueue$get===void 0?void 0:_this$filesQueue$get.file;var serviceDiscoveryRequest=xml(\"iq\",{type:\"get\",to:uploadJid,id:thirdStepId},xml(\"request\",{xmlns:\"urn:xmpp:http:upload:0\",filename:file===null||file===void 0?void 0:file.name,size:file===null||file===void 0?void 0:file.size,\"content-type\":file===null||file===void 0?void 0:file.type}));if(_this.client){_this.client.send(serviceDiscoveryRequest);}};_this.uploadFile=function(putUrl,getUrl,id){var xhr=new XMLHttpRequest();var file=_this.filesQueue.get(id);if(file){xhr.onerror=function(){if(xhr.responseText){file.callback(xhr.responseText,true);console.log(\"upload error\");}};xhr.onreadystatechange=function(e){if(xhr.readyState===XMLHttpRequest.DONE){console.log(\"file upload response\",e,xhr.status);if(xhr.status===200||xhr.status===201){console.log(\"file upload response success\");_this.sendImageMessage(getUrl,file.to,file.chatType,file===null||file===void 0?void 0:file.callback);_this.filesQueue.delete(id);}}};xhr.upload.addEventListener(\"progress\",function(evt){console.log(\"progress\",evt);// if (file) file.file.size = evt.total\n},false);xhr.open(\"PUT\",putUrl,true);xhr.setRequestHeader(\"Content-Type\",file.file.type);xhr.send(file.file);console.log(\"URL\",putUrl);console.log(\"fileSize\",file.file.size);}};_this.sendReceipts=function(stanza){var message=xml(\"message\",{from:stanza.attrs.to,id:v4(),to:stanza.attrs.from.split(\"/\")[0]},xml(\"received\",{xmlns:\"urn:xmpp:receipts\",id:stanza.attrs.id}));console.log(message);_this.client.send(message);};_this.sendTyping=function(to){var composing=xml(\"message\",{id:v4(),to:to,type:\"chat\"},xml(\"composing\",{xmlns:\"http://jabber.org/protocol/chatstates\"}));_this.client.send(composing);};_this.sendActive=function(to){var active=xml(\"message\",{id:v4(),to:to,type:\"chat\"},xml(\"active\",{xmlns:\"http://jabber.org/protocol/chatstates\"}));_this.client.send(active);};_this.replyMsg=function(to,chatType,message,replyed_sender,replyed_msg,replyed_msg_id,cb){var id=v4();var reply=xml(\"message\",{to:to,id:id,type:chatType},xml(\"body\",{},message),xml(\"extraParams\",{},xml(\"reply_to\",{},replyed_sender),xml(\"reply_msg\",{},replyed_msg),xml(\"reply_msg_id\",{},replyed_msg_id)));_this.client.send(reply).then(function(){cb(id);});};_this.sendEvent=function(to){var eventBody=arguments.length>1&&arguments[1]!==undefined?arguments[1]:undefined;var nbr=arguments.length>2&&arguments[2]!==undefined?arguments[2]:undefined;var cb=arguments.length>3&&arguments[3]!==undefined?arguments[3]:function(){};var id=v4();var stanza=xml(\"message\",{to:to,type:\"groupchat\",id:id},xml(\"subject\",{},\"KEY_ROOM_GENERAL\"),xml(\"body\",{}),xml(\"extraParams\",{xmlns:'jabber:client'},xml(\"key_room_event\",{},nbr),eventBody?xml(\"key_room_event_body\",{},eventBody):undefined));_this.client.send(stanza).then(function(){cb(id);});};_this.joinRoomEvent=function(to,eventBody,from){var cb=arguments.length>3&&arguments[3]!==undefined?arguments[3]:function(){};var id=v4();var stanza=xml(\"message\",{to:to,from:from,type:\"groupchat\",id:id},//from - UNNECESSARY?\nxml(\"extraParams\",{},xml(\"key_room_event\",{},\"2\"),eventBody?xml(\"key_room_event_body\",{},eventBody):undefined),xml(\"body\",{}),xml(\"subject\",{},\"KEY_ROOM_GENERAL\"));_this.client.send(stanza).then(function(){cb(id);});};_this.forwardMsg=function(to,chatType,forwarded_msg_sender,forwarded_msg,forwarded_msg_id,callback){var id=v4();var forward=xml(\"message\",{to:to,id:id,type:chatType},xml(\"body\",{},forwarded_msg),xml(\"extraParams\",{},xml(\"reply_to\",{},forwarded_msg_sender),xml(\"reply_msg_id\",{},forwarded_msg_id)),xml(\"request\",{xmlns:\"urn:xmpp:receipts\"}));_this.client.send(forward).then(function(){callback(id);});};_this.joinRoom=function(to){var joinStanza=xml(\"presence\",{to:\"\".concat(to,\"/\").concat(_this.username),from:\"\".concat(_this.getJid(),\"/\").concat(_this.resource)},xml(\"x\",{xmlns:\"http://jabber.org/protocol/muc\"},xml(\"history\",{maxstanzas:\"0\"})));_this.client.send(joinStanza);};Object.setPrototypeOf(_assertThisInitialized(_this),Chat.prototype);_this.service=_service;_this.domain=_domain;_this.resource=_resource;_this.username=_username;_this.password=_password;_this.client=_this.instanceMaker({service:_service,domain:_domain,resource:_resource,username:_username,password:_password});_this.status=_this.client.status;_this.connect=_this.client.start;_this.filesQueue=new Map();_this.presences=new Map();_this.discoItems=new Map();return _this;}return Chat;}(events.EventEmitter);export{Chat as default};","map":{"version":3,"sources":["C:/Users/Digivox/dev/Digivox/Refatoracao/squad/src/services/chat/chatcommunicator.ts"],"names":["client","xml","v4","PresenceStatus","Events","getFrom","getMessage","isTextMessage","getTo","getMessageId","isFileMessage","getMessageType","getMessagFileUrl","getReplyTo","getReplyMsg","getReplyMsgId","isReceived","isDisplayed","getReceivedMessageId","getDisplayedMessageId","isComposing","isActive","isGroupEvent","getEventId","isNewGroup","getEventBody","events","require","Chat","service","domain","resource","username","password","getJid","getDomain","replace","split","instanceMaker","xmpp","on","onStatus","onStanza","onOnline","onError","onOffline","stanza","emit","is","onMessage","onPresence","onIQ","__","discoItensId","sendServiceDiscoveryRequest","send","e","status","eventToNewGroup","to","from","id","eventId","message","reply_msg","undefined","sent_at","Date","toISOString","type","reply_msg_id","reply_to","SEND_EVENT","event","eventBody","sendReceipts","MESSAGE","fileMessage","fileUrl","received","RECEIVED","displayed","DISPLAYED","COMPOSING","ACTIVE","presence","attrs","time","getChild","children","presences","set","file","filesQueue","get","firstStepId","sendFileSecondStep","secondStepId","sendFileThirdStep","forEach","element","key","jid","discoItems","getPresence","sendEnableCarbon","xmlns","sendPresence","show","leaveGroup","UNAVAILABLE","sendMessage","chatType","callback","msgId","then","sendFile","fileId","sendFileFirstStep","sendImageMessage","url","messagePacket","uploadJid","sendServiceDiscoveryRequestToUpload","length","delete","console","log","var","sendRequestSlotOnUpload","getUrl","putUrl","uploadFile","serviceDiscoveryRequest","uploadId","thirdStepId","filename","name","size","xhr","XMLHttpRequest","onerror","responseText","onreadystatechange","readyState","DONE","upload","addEventListener","evt","open","setRequestHeader","sendTyping","composing","sendActive","active","replyMsg","replyed_sender","replyed_msg","replyed_msg_id","cb","reply","sendEvent","nbr","joinRoomEvent","forwardMsg","forwarded_msg_sender","forwarded_msg","forwarded_msg_id","forward","joinRoom","joinStanza","maxstanzas","Object","setPrototypeOf","prototype","connect","start","Map","EventEmitter"],"mappings":"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","sourcesContent":["import { client, xml, XmppClient } from \"@xmpp/client\";\r\nimport { v4 } from \"uuid\";\r\nimport PresenceStatus from \"../../enuns/PresenceStatus\";\r\nimport {\r\n  ActiveCallback,\r\n  ChatType,\r\n  ComposingCallback,\r\n  ConnectionOptions,\r\n  DisplayedCallback,\r\n  ErrorCallback,\r\n  EventCallback,\r\n  Events,\r\n  FileMessage,\r\n  Message,\r\n  MessageCallback,\r\n  OfflineCallback,\r\n  OnlineCallback,\r\n  Presence,\r\n  PresenceCallback,\r\n  ReceivedCallback,\r\n  SendImageCallback,\r\n  SendingFile,\r\n  SendMessageCallback,\r\n  StanzaCallback,\r\n} from \"./types/types\";\r\nimport {\r\n  getFrom,\r\n  getMessage,\r\n  isTextMessage,\r\n  getTo,\r\n  getMessageId,\r\n  isFileMessage,\r\n  getMessageType,\r\n  getMessagFileUrl,\r\n  getReplyTo,\r\n  getReplyMsg,\r\n  getReplyMsgId,\r\n  isReceived,\r\n  isDisplayed,\r\n  getReceivedMessageId,\r\n  getDisplayedMessageId,\r\n  isComposing,\r\n  isActive,\r\n  isGroupEvent,\r\n  getEventId,\r\n  isNewGroup,\r\n  getEventBody,\r\n} from \"./util/stanzaUtils\";\r\nconst events = require(\"events\");\r\n\r\nexport default interface Chat {\r\n  service: string;\r\n  domain?: string;\r\n  resource: string;\r\n  username: string;\r\n  password?: string;\r\n  client: XmppClient;\r\n  status: string;\r\n  filesQueue: Map<string, SendingFile>;\r\n  presences: Map<string, Presence>;\r\n  connect(): Promise<any>;\r\n  on(event: Events.MESSAGE, cb: MessageCallback): this;\r\n  on(event: Events.PRESENCE, cb: PresenceCallback): this;\r\n  on(event: Events.ONLINE, cb: OnlineCallback): this;\r\n  on(event: Events.OFFLINE, cb: OfflineCallback): this;\r\n  on(event: Events.ERROR, cb: ErrorCallback): this;\r\n  on(event: Events.STANZA, cb: StanzaCallback): this;\r\n  on(event: Events.RECEIVED, cb: ReceivedCallback): this;\r\n  on(event: Events.DISPLAYED, cb: DisplayedCallback): this;\r\n  on(event: Events.COMPOSING, cb: ComposingCallback): this;\r\n  on(event: Events.ACTIVE, cb: ActiveCallback): this;\r\n  on(event: Events.JOIN_ROOM, cb: EventCallback): this;\r\n  on(event: Events.SEND_EVENT, cb: EventCallback): this;\r\n  getPresence(from: string): Presence | null;\r\n  sendMessage(\r\n    to: string,\r\n    chatType: ChatType,\r\n    message: string,\r\n    cb: SendMessageCallback\r\n  ): void;\r\n  sendFile(\r\n    to: string,\r\n    chatType: ChatType,\r\n    file: File,\r\n    callback: SendImageCallback\r\n  ): void;\r\n  getDomain(): string;\r\n  joinRoom(to: string): void;\r\n}\r\nexport default class Chat extends events.EventEmitter {\r\n  constructor({\r\n    service,\r\n    domain,\r\n    resource,\r\n    username,\r\n    password,\r\n  }: ConnectionOptions) {\r\n    super();\r\n    Object.setPrototypeOf(this, Chat.prototype);\r\n    this.service = service;\r\n    this.domain = domain;\r\n    this.resource = resource;\r\n    this.username = username;\r\n    this.password = password;\r\n    this.client = this.instanceMaker({\r\n      service: service,\r\n      domain: domain,\r\n      resource: resource,\r\n      username: username,\r\n      password: password,\r\n    });\r\n    this.status = this.client.status;\r\n    this.connect = this.client.start;\r\n    this.filesQueue = new Map<string, SendingFile>();\r\n    this.presences = new Map<string, Presence>();\r\n    this.discoItems = new Map<string, string>();\r\n  }\r\n\r\n  getJid = () => {\r\n    return `${this.username}@${this.getDomain()}`;\r\n  };\r\n\r\n  getDomain = () => {\r\n    return (\r\n      this.domain ||\r\n      this.service.replace(\"wss://\", \"\").replace(\"ws://\", \"\").split(\"/\")[0]\r\n    );\r\n  };\r\n\r\n  instanceMaker = ({\r\n    service,\r\n    domain,\r\n    resource,\r\n    username,\r\n    password,\r\n  }: ConnectionOptions) => {\r\n    const xmpp = client({\r\n      service: service,\r\n      domain: domain,\r\n      resource: resource,\r\n      username: username,\r\n      password: password,\r\n    });\r\n    xmpp.on(\"status\", this.onStatus);\r\n    xmpp.on(\"stanza\", this.onStanza);\r\n    xmpp.on(\"online\", this.onOnline);\r\n    xmpp.on(\"error\", this.onError);\r\n    xmpp.on(\"offline\", this.onOffline);\r\n    return xmpp;\r\n  };\r\n\r\n  onStanza = (stanza: any) => {\r\n    this.emit(\"stanza\", stanza);\r\n    if (stanza.is(\"message\")) this.onMessage(stanza);\r\n    else if (stanza.is(\"presence\")) this.onPresence(stanza);\r\n    else if (stanza.is(\"iq\")) this.onIQ(stanza);\r\n    else return;\r\n  };\r\n\r\n  onOnline = (__: any) => {\r\n    this.discoItensId = v4();\r\n    // this.sendEnableCarbon();\r\n    this.sendServiceDiscoveryRequest(this.discoItensId);\r\n    this.client.send(xml(\"presence\"));\r\n    this.emit(\"online\");\r\n  };\r\n\r\n  onOffline = () => {\r\n    this.emit(\"offline\");\r\n  };\r\n\r\n  onError = (e: any) => {\r\n    this.emit(\"error\", e);\r\n  };\r\n\r\n  onStatus = (status: string) => {\r\n    this.emit(\"status\", status);\r\n  };\r\n\r\n  onMessage = (stanza: any) => {\r\n    if (isGroupEvent(stanza)) {\r\n      if(isNewGroup(stanza)){\r\n        const eventToNewGroup: Message = {\r\n          to: getTo(stanza),\r\n          from: getFrom(stanza),\r\n          id: v4(),\r\n          eventId: 1,\r\n          message: \"\",\r\n          reply_msg: undefined,\r\n          sent_at: new Date().toISOString(),\r\n          type: \"groupchat\",\r\n          reply_msg_id: undefined,\r\n          reply_to: undefined\r\n        };\r\n        this.emit(Events.SEND_EVENT, eventToNewGroup);\r\n      }else{\r\n          const event: Message = {\r\n            id: getMessageId(stanza),\r\n            to: getTo(stanza),\r\n            from: getFrom(stanza),\r\n            message: \"\",\r\n            type: \"groupchat\",\r\n            sent_at: new Date().toISOString(),\r\n            reply_to: undefined,\r\n            reply_msg: undefined,\r\n            reply_msg_id: undefined,\r\n            eventId: getEventId(stanza),\r\n            eventBody: getEventBody(stanza),\r\n          };\r\n          this.emit(Events.SEND_EVENT, event);\r\n        }\r\n      }else if (isTextMessage(stanza)) {\r\n      const message: Message = {\r\n        id: getMessageId(stanza),\r\n        to: getTo(stanza),\r\n        from: getFrom(stanza),\r\n        message: getMessage(stanza),\r\n        type: getMessageType(stanza),\r\n        sent_at: new Date().toISOString(),\r\n        reply_to: getReplyTo(stanza),\r\n        reply_msg: getReplyMsg(stanza),\r\n        reply_msg_id: getReplyMsgId(stanza),\r\n      };\r\n      this.sendReceipts(stanza);\r\n      this.emit(Events.MESSAGE, message);\r\n    } else if (isFileMessage(stanza)) {\r\n      const fileMessage: FileMessage = {\r\n        id: getMessageId(stanza),\r\n        to: getTo(stanza),\r\n        from: getFrom(stanza),\r\n        message: \"\",\r\n        type: getMessageType(stanza),\r\n        sent_at: new Date().toISOString(),\r\n        reply_to: getReplyTo(stanza),\r\n        reply_msg: getReplyMsg(stanza),\r\n        reply_msg_id: getReplyMsgId(stanza),\r\n        fileUrl: getMessagFileUrl(stanza),\r\n      };\r\n      this.sendReceipts(stanza);\r\n      this.emit(Events.MESSAGE, fileMessage);\r\n    } else if (isReceived(stanza)) {\r\n      const received = {\r\n        id: getReceivedMessageId(stanza),\r\n      };\r\n      this.emit(Events.RECEIVED, received);\r\n    } else if (isDisplayed(stanza)) {\r\n      const displayed = {\r\n        id: getDisplayedMessageId(stanza),\r\n      };\r\n      this.emit(Events.DISPLAYED, displayed);\r\n    } else if (isComposing(stanza)) {\r\n      this.emit(Events.COMPOSING, getFrom(stanza));\r\n    } else if (isActive(stanza)) {\r\n      this.emit(Events.ACTIVE, getFrom(stanza));\r\n    }\r\n  };\r\n\r\n  onPresence = (stanza: any) => {\r\n    const presence: Presence = {\r\n      id: v4(),\r\n      from: stanza.attrs.from,\r\n      time: new Date().toISOString(),\r\n      status: stanza.getChild(\"show\")\r\n        ? stanza.getChild(\"show\").children[0]\r\n        : stanza.attrs.type || \"online\",\r\n    };\r\n    this.presences.set(stanza.attrs.from, presence);\r\n    this.emit(\"presence\", presence);\r\n  };\r\n\r\n  onIQ = (stanza: any) => {\r\n    if (stanza.attrs.type === \"result\") {\r\n      if (stanza.attrs.id) {\r\n        const file = this.filesQueue.get(stanza.attrs.id);\r\n        if (file) {\r\n          if (stanza.attrs.id === file.firstStepId) {\r\n            this.sendFileSecondStep(stanza);\r\n          } else if (stanza.attrs.id === file.secondStepId) {\r\n            this.sendFileThirdStep(stanza, file);\r\n          }\r\n        } else if (stanza.attrs.id === this.discoItensId) {\r\n          stanza.children[0].children.forEach((element: any) => {\r\n            const key = element.attrs.jid.split(\".\")[0];\r\n            this.discoItems.set(key, element.attrs.jid);\r\n          });\r\n        }\r\n      }\r\n    }\r\n  };\r\n  getPresence = (from: string) => {\r\n    const presence = this.presences.get(from);\r\n    if (presence) return presence;\r\n    else return null;\r\n  };\r\n  sendEnableCarbon = () => {\r\n    const stanza = xml(\r\n      \"iq\",\r\n      { from: `${this.getJid()}/${this.resource}`, type: \"set\", id: \"enable1\" },\r\n      xml(\"enable\", { xmlns: \"urn:xmpp:carbons:2\" })\r\n    );\r\n    this.client.send(stanza);\r\n  };\r\n  sendPresence = (status: string, to: string | undefined = undefined) => {\r\n    const show = xml(\"show\", {}, status);\r\n    if (status !== \"online\") this.client.send(xml(\"presence\", {to}, show));\r\n    else this.client.send(xml(\"presence\"));\r\n  };\r\n  leaveGroup = (to: string, type: PresenceStatus = PresenceStatus.UNAVAILABLE) => {\r\n    this.client.send(xml(\"presence\", {to, type} ));\r\n  };\r\n  sendMessage = (\r\n    to: string,\r\n    chatType: ChatType,\r\n    message: string,\r\n    callback: SendMessageCallback\r\n  ) => {\r\n    const msgId = v4();\r\n    this.client\r\n      .send(\r\n        xml(\r\n          \"message\",\r\n          {\r\n            id: msgId,\r\n            type: chatType,\r\n            to: to,\r\n          },\r\n          xml(\"body\", {}, message),\r\n          xml(\"request\", { xmlns: \"urn:xmpp:receipts\" })\r\n        )\r\n      )\r\n      .then(() => {\r\n        callback(msgId);\r\n      });\r\n  };\r\n\r\n  sendFile = (\r\n    to: string,\r\n    chatType: ChatType,\r\n    file: File,\r\n    callback: SendImageCallback\r\n  ) => {\r\n    const fileId = v4();\r\n    this.filesQueue.set(fileId, {\r\n      firstStepId: fileId,\r\n      file: file,\r\n      to: to,\r\n      chatType: chatType,\r\n      callback: callback,\r\n    });\r\n    this.sendFileFirstStep(fileId);\r\n  };\r\n\r\n  sendImageMessage = (\r\n    url: string,\r\n    to: string,\r\n    chatType: ChatType,\r\n    callback: SendImageCallback\r\n  ) => {\r\n    const msgId = v4();\r\n    const messagePacket = xml(\r\n      \"message\",\r\n      {\r\n        id: msgId,\r\n        type: chatType,\r\n        to: to,\r\n      },\r\n      xml(\"body\", {}, url),\r\n      xml(\"request\", { xmlns: \"urn:xmpp:receipts\" }),\r\n      xml(\"x\", { xmlns: \"jabber:x:oob\" }, xml(\"url\", {}, url))\r\n    );\r\n    if (this.client) {\r\n      callback({ url, msgId });\r\n      this.client.send(messagePacket);\r\n    }\r\n  };\r\n\r\n  sendFileFirstStep = (fileId: string) => {\r\n    const uploadJid = this.discoItems.get(\"upload\");\r\n    if (uploadJid) {\r\n      this.sendServiceDiscoveryRequestToUpload(uploadJid, fileId);\r\n      return;\r\n    }\r\n  };\r\n\r\n  sendFileSecondStep = (stanza: any) => {\r\n    if (stanza.children.length > 0) {\r\n      const secondStepId = v4();\r\n      const file = this.filesQueue.get(stanza.attrs.id);\r\n      if (file) {\r\n        this.filesQueue.set(secondStepId, {\r\n          firstStepId: file.firstStepId,\r\n          secondStepId: secondStepId,\r\n          file: file.file,\r\n          to: file.to,\r\n          chatType: file.chatType,\r\n          callback: file.callback,\r\n        });\r\n        this.filesQueue.delete(stanza.attrs.id);\r\n      }\r\n      console.log(\r\n        \"upload request xmlns\",\r\n        stanza.children[0].children[2].attrs.var\r\n      );\r\n      this.sendRequestSlotOnUpload(stanza.attrs.from, secondStepId);\r\n    }\r\n  };\r\n\r\n  sendFileThirdStep = (stanza: any, file: SendingFile) => {\r\n    let getUrl = \"\";\r\n    let putUrl = \"\";\r\n    stanza.children[0].children.forEach((element: any) => {\r\n      if (element.is(\"get\")) {\r\n        getUrl = element.attrs.url;\r\n      } else if (element.is(\"put\")) {\r\n        putUrl = element.attrs.url;\r\n      }\r\n    });\r\n    if (file?.secondStepId) this.uploadFile(putUrl, getUrl, file.secondStepId);\r\n  };\r\n\r\n  sendServiceDiscoveryRequest = (fileId: string) => {\r\n    const serviceDiscoveryRequest = xml(\r\n      \"iq\",\r\n      {\r\n        type: \"get\",\r\n        to: this.getDomain(),\r\n        id: fileId,\r\n      },\r\n      xml(\"query\", { xmlns: \"http://jabber.org/protocol/disco#items\" })\r\n    );\r\n    if (this.client) {\r\n      this.client.send(serviceDiscoveryRequest);\r\n    }\r\n  };\r\n\r\n  sendServiceDiscoveryRequestToUpload = (\r\n    uploadJid: string,\r\n    uploadId: string\r\n  ) => {\r\n    console.log(\"sendServiceDiscoveryRequestToUpload\", uploadJid);\r\n    const serviceDiscoveryRequest = xml(\r\n      \"iq\",\r\n      {\r\n        type: \"get\",\r\n        to: uploadJid,\r\n        id: uploadId,\r\n      },\r\n      xml(\"query\", { xmlns: \"http://jabber.org/protocol/disco#info\" })\r\n    );\r\n    if (this.client) {\r\n      this.client.send(serviceDiscoveryRequest);\r\n    }\r\n  };\r\n\r\n  sendRequestSlotOnUpload = (uploadJid: string, thirdStepId: string) => {\r\n    console.log(\"sendRequestSlotOnUpload\", uploadJid);\r\n    const file = this.filesQueue.get(thirdStepId)?.file;\r\n    const serviceDiscoveryRequest = xml(\r\n      \"iq\",\r\n      {\r\n        type: \"get\",\r\n        to: uploadJid,\r\n        id: thirdStepId,\r\n      },\r\n      xml(\"request\", {\r\n        xmlns: \"urn:xmpp:http:upload:0\",\r\n        filename: file?.name,\r\n        size: file?.size,\r\n        \"content-type\": file?.type,\r\n      })\r\n    );\r\n    if (this.client) {\r\n      this.client.send(serviceDiscoveryRequest);\r\n    }\r\n  };\r\n\r\n  uploadFile = (putUrl: string, getUrl: string, id: string) => {\r\n    let xhr = new XMLHttpRequest();\r\n    const file = this.filesQueue.get(id);\r\n    if (file) {\r\n      xhr.onerror = () => {\r\n        if (xhr.responseText) {\r\n          file.callback(xhr.responseText, true);\r\n          console.log(\"upload error\");\r\n        }\r\n      };\r\n      xhr.onreadystatechange = (e) => {\r\n        if (xhr.readyState === XMLHttpRequest.DONE) {\r\n          console.log(\"file upload response\", e, xhr.status);\r\n          if (xhr.status === 200 || xhr.status === 201) {\r\n            console.log(\"file upload response success\");\r\n            this.sendImageMessage(\r\n              getUrl,\r\n              file.to,\r\n              file.chatType,\r\n              file?.callback\r\n            );\r\n            this.filesQueue.delete(id);\r\n          }\r\n        }\r\n      };\r\n      xhr.upload.addEventListener(\r\n        \"progress\",\r\n        (evt) => {\r\n          console.log(\"progress\", evt);\r\n          // if (file) file.file.size = evt.total\r\n        },\r\n        false\r\n      );\r\n      xhr.open(\"PUT\", putUrl, true);\r\n      xhr.setRequestHeader(\"Content-Type\", file.file.type);\r\n\r\n      xhr.send(file.file);\r\n\r\n      console.log(\"URL\", putUrl);\r\n      console.log(\"fileSize\", file.file.size);\r\n    }\r\n  };\r\n  sendReceipts = (stanza: any) => {\r\n    const message = xml(\r\n      \"message\",\r\n      {\r\n        from: stanza.attrs.to,\r\n        id: v4(),\r\n        to: stanza.attrs.from.split(\"/\")[0],\r\n      },\r\n      xml(\"received\", { xmlns: \"urn:xmpp:receipts\", id: stanza.attrs.id })\r\n    );\r\n    console.log(message);\r\n    this.client.send(message);\r\n  };\r\n  sendTyping = (to: string) => {\r\n    const composing = xml(\r\n      \"message\",\r\n      {\r\n        id: v4(),\r\n        to: to,\r\n        type: \"chat\",\r\n      },\r\n      xml(\"composing\", {\r\n        xmlns: \"http://jabber.org/protocol/chatstates\",\r\n      })\r\n    );\r\n    this.client.send(composing);\r\n  };\r\n  sendActive = (to: string) => {\r\n    const active = xml(\r\n      \"message\",\r\n      {\r\n        id: v4(),\r\n        to: to,\r\n        type: \"chat\",\r\n      },\r\n      xml(\"active\", {\r\n        xmlns: \"http://jabber.org/protocol/chatstates\",\r\n      })\r\n    );\r\n    this.client.send(active);\r\n  };\r\n  replyMsg = (\r\n    to: string,\r\n    chatType: string,\r\n    message: string,\r\n    replyed_sender: string,\r\n    replyed_msg: string,\r\n    replyed_msg_id: string,\r\n    cb: SendMessageCallback\r\n  ) => {\r\n    const id = v4();\r\n    const reply = xml(\r\n      \"message\",\r\n      { to: to, id, type: chatType },\r\n      xml(\"body\", {}, message),\r\n      xml(\r\n        \"extraParams\",\r\n        {},\r\n        xml(\"reply_to\", {}, replyed_sender),\r\n        xml(\"reply_msg\", {}, replyed_msg),\r\n        xml(\"reply_msg_id\", {}, replyed_msg_id)\r\n      )\r\n    );\r\n    this.client.send(reply).then(() => {\r\n      cb(id);\r\n    });\r\n  };\r\n  /* \r\n  unMarkRoomEvent = (\r\n    to: string,\r\n    eventBody: string | undefined = undefined,\r\n    cb: SendMessageCallback\r\n  ) => {\r\n    const id = v4();\r\n    const stanza = xml(\r\n      \"message\",\r\n      { to, type: \"groupchat\", id },\r\n      xml(\"body\", {}),\r\n      xml(\"subject\", {}, \"KEY_ROOM_GENERAL\"),\r\n      xml(\r\n        \"extraParams\",\r\n        { xmlns: \"jabber:client\" },\r\n        xml(\"key_room_event\", {}, \"9\"),\r\n        eventBody ? xml(\"key_room_event_body\", {}, eventBody) : undefined\r\n      )\r\n    );\r\n    this.client.send(stanza).then(() => {\r\n      cb(id);\r\n    });\r\n  };*/\r\n\r\n  sendEvent = (\r\n    to: string,\r\n    eventBody: string | undefined = undefined, //jid from user\r\n    nbr: string | undefined = undefined, \r\n    cb: SendMessageCallback = () => {},\r\n  ) => {\r\n    const id = v4();\r\n    const stanza = xml(\r\n      \"message\", {to, type: \"groupchat\", id},\r\n      xml(\"subject\", {}, \"KEY_ROOM_GENERAL\"),\r\n      xml(\"body\", {}),\r\n      xml(\"extraParams\", {xmlns:'jabber:client'},\r\n        xml(\"key_room_event\", {}, nbr),\r\n        eventBody ? xml(\"key_room_event_body\", {}, eventBody) : undefined,\r\n      )\r\n    );\r\n    this.client.send(stanza).then(() => {\r\n      cb(id);\r\n    });\r\n  };\r\n\r\n  joinRoomEvent = (\r\n    to: string,\r\n    eventBody: string | undefined, //jid of user who was added -> I ADDED\r\n    from: string,\r\n    cb: SendMessageCallback = () => {}\r\n  ) => {\r\n    const id = v4();\r\n    const stanza = xml(\r\n    \"message\",\r\n    { to, from, type: \"groupchat\", id}, //from - UNNECESSARY?\r\n    xml(\"extraParams\", {},\r\n      xml(\"key_room_event\", {}, \"2\"),\r\n      eventBody ? xml(\"key_room_event_body\", {}, eventBody) : undefined,\r\n      ),\r\n    xml(\"body\", {}),\r\n    xml(\"subject\", {}, \"KEY_ROOM_GENERAL\"),\r\n    );\r\n    this.client.send(stanza).then(() => {\r\n      cb(id);\r\n    });\r\n  };\r\n\r\n  /*\r\n  leaveRoomEvent = (\r\n    to: string,\r\n    from: string,\r\n    cb: SendMessageCallback\r\n  ) => {\r\n    const id = v4();\r\n    const stanza = xml(\r\n      \"message\", {\r\n        to, from, type: \"groupchat\", id\r\n      },\r\n      xml(\"extraParams\", {},\r\n        xml(\"key_room_event\", {}, \"3\")\r\n      ),\r\n      xml(\"body\", {}),\r\n      xml(\"subject\", {}, \"KEY_ROOM_GENERAL\"),\r\n    )\r\n    this.client.send(stanza).then(() => {\r\n      cb(id);\r\n    });\r\n  };\r\n */\r\n  forwardMsg = (\r\n    to: string,\r\n    chatType: ChatType,\r\n    forwarded_msg_sender: string,\r\n    forwarded_msg: string,\r\n    forwarded_msg_id: string,\r\n    callback: SendMessageCallback\r\n  ) => {\r\n    const id = v4();\r\n    const forward = xml(\r\n      \"message\",\r\n      { to: to, id, type: chatType },\r\n      xml(\"body\", {}, forwarded_msg),\r\n      xml(\r\n        \"extraParams\",\r\n        {},\r\n        xml(\"reply_to\", {}, forwarded_msg_sender),\r\n        xml(\"reply_msg_id\", {}, forwarded_msg_id)\r\n      ),\r\n      xml(\"request\", { xmlns: \"urn:xmpp:receipts\" })\r\n    );\r\n    this.client.send(forward).then(() => {\r\n      callback(id);\r\n    });\r\n  };\r\n  joinRoom = (to: string) => {\r\n    const joinStanza = xml(\r\n      \"presence\",\r\n      {\r\n        to: `${to}/${this.username}`,\r\n        from: `${this.getJid()}/${this.resource}`,\r\n      },\r\n      xml(\r\n        \"x\",\r\n        { xmlns: \"http://jabber.org/protocol/muc\" },\r\n        xml(\"history\", { maxstanzas: \"0\" })\r\n      )\r\n    );\r\n    this.client.send(joinStanza);\r\n  };\r\n}\r\n"]},"metadata":{},"sourceType":"module"}