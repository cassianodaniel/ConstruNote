{"ast":null,"code":"import _regeneratorRuntime from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/regenerator\";import _asyncToGenerator from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/asyncToGenerator\";import _createForOfIteratorHelper from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createForOfIteratorHelper\";import _classCallCheck from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import{Inviter,Registerer,SessionState,UserAgent,Web}from\"sip.js\";export var tagsRange=[0,1,2,3];var SIP=/*#__PURE__*/function(){function SIP(props){var _this=this;_classCallCheck(this,SIP);this.onInvite=function(invitation){if(_this.activeCalls.size<tagsRange.length){var cb=function cb(session){_this.activeCalls.set(invitation.id,invitation);_this.onReceiveCall(session,invitation);};invitation.stateChange.addListener(cb);_this.onReceiveCall(SessionState.Initial,invitation);}else{invitation.reject();}};this.remoteVideoEnabled=function(session){var _ref,_ref$peerConnection;var receivingVideo=false;(_ref=session.sessionDescriptionHandler)===null||_ref===void 0?void 0:(_ref$peerConnection=_ref.peerConnection)===null||_ref$peerConnection===void 0?void 0:_ref$peerConnection.getReceivers().forEach(function(receiver){if(receiver.track){if(receiver.track.kind===\"video\")receivingVideo=true;}});return receivingVideo;};this.localVideoEnabled=function(session){var _ref2,_ref3;return!!((_ref2=(_ref3=session)===null||_ref3===void 0?void 0:_ref3.sessionDescriptionHandlerOptions.constraints)===null||_ref2===void 0?void 0:_ref2.video);};this.muteMic=function(callID){var call=_this.activeCalls.get(callID);if(call){var _sdh$peerConnection;var sdh=call.sessionDescriptionHandler;sdh===null||sdh===void 0?void 0:(_sdh$peerConnection=sdh.peerConnection)===null||_sdh$peerConnection===void 0?void 0:_sdh$peerConnection.getSenders().forEach(function(stream){var _stream$track;if(((_stream$track=stream.track)===null||_stream$track===void 0?void 0:_stream$track.kind)===\"audio\")stream.track.enabled=false;});}};this.unMuteMic=function(callID){var call=_this.activeCalls.get(callID);if(call){var _sdh$peerConnection2;var sdh=call.sessionDescriptionHandler;sdh===null||sdh===void 0?void 0:(_sdh$peerConnection2=sdh.peerConnection)===null||_sdh$peerConnection2===void 0?void 0:_sdh$peerConnection2.getSenders().forEach(function(stream){var _stream$track2;if(((_stream$track2=stream.track)===null||_stream$track2===void 0?void 0:_stream$track2.kind)===\"audio\")stream.track.enabled=true;});}};this.disableCam=function(callID){var call=_this.activeCalls.get(callID);if(call){if(_this.localVideoEnabled(call)){var _sdh$peerConnection3;var sdh=call.sessionDescriptionHandler;sdh===null||sdh===void 0?void 0:(_sdh$peerConnection3=sdh.peerConnection)===null||_sdh$peerConnection3===void 0?void 0:_sdh$peerConnection3.getSenders().forEach(function(stream){var _stream$track3;if(((_stream$track3=stream.track)===null||_stream$track3===void 0?void 0:_stream$track3.kind)===\"video\")stream.track.enabled=false;});}else{// TODO\nconsole.log(\"re-invite\");}}};this.enableCam=function(callID){var call=_this.activeCalls.get(callID);if(call){if(_this.localVideoEnabled(call)){var _sdh$peerConnection4;var sdh=call.sessionDescriptionHandler;sdh===null||sdh===void 0?void 0:(_sdh$peerConnection4=sdh.peerConnection)===null||_sdh$peerConnection4===void 0?void 0:_sdh$peerConnection4.getSenders().forEach(function(stream){var _stream$track4;if(((_stream$track4=stream.track)===null||_stream$track4===void 0?void 0:_stream$track4.kind)===\"video\")stream.track.enabled=true;});}else{// TODO\nconsole.log(\"re-invite\");}}};this.holdCall=function(callID){var call=_this.activeCalls.get(callID);if(call){var options={sessionDescriptionHandlerModifiers:[Web.holdModifier]};return call.invite(options);}};this.unHoldCall=function(callID){var call=_this.activeCalls.get(callID);if(call){var options={sessionDescriptionHandlerModifiers:[]};if(call){call.invite(options);}}};Object.assign(this,props);this.makeSIP();this.activeCalls=new Map();this.usedTags=new Map();}_createClass(SIP,[{key:\"makeSIP\",value:function makeSIP(){var _this2=this;var transportOptions={//   server: this.wsURL,\nserver:\"wss://test.citrussquad.com:7443\"};var uri=UserAgent.makeURI(\"sip:\".concat(this.user,\"@\").concat(this.domain));var userAgentOptions={authorizationUsername:this.user,authorizationPassword:this.password,transportOptions:transportOptions,uri:uri,logBuiltinEnabled:false,delegate:{onInvite:this.onInvite}};this.userAgent=new UserAgent(userAgentOptions);this.registerer=new Registerer(this.userAgent);this.userAgent.start().then(function(){var _this2$registerer,_this2$registerer2;(_this2$registerer=_this2.registerer)===null||_this2$registerer===void 0?void 0:_this2$registerer.register();(_this2$registerer2=_this2.registerer)===null||_this2$registerer2===void 0?void 0:_this2$registerer2.stateChange.addListener(_this2.connectionCB);});}},{key:\"invite\",value:function invite(number){var _this3=this;var constraints=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{video:false,audio:true};if(!(this.activeCalls.size>=tagsRange.length)&&this.userAgent){var destination=UserAgent.makeURI(\"sip:\".concat(number,\"@\").concat(this.domain));var newCall;if(destination){newCall=new Inviter(this.userAgent,destination,{sessionDescriptionHandlerOptions:{constraints:constraints}});this.activeCalls.set(newCall.id,newCall);}var currentInvite=newCall&&this.activeCalls.get(newCall.id);if(currentInvite){currentInvite.stateChange.addListener(function(state){if(_this3.activeCalls)_this3.onMakeCall(state,currentInvite);});currentInvite.invite();this.onMakeCall(SessionState.Initial,currentInvite);}}}},{key:\"getAvailableTag\",value:function getAvailableTag(){var tagsUsing=Array.from(this.usedTags.values());var _iterator=_createForOfIteratorHelper(tagsRange),_step;try{var _loop=function _loop(){var tagId=_step.value;if(!tagsUsing.find(function(tgId){return tgId===\"remote-stream-\".concat(tagId);})){return{v:\"remote-stream-\".concat(tagId)};}};for(_iterator.s();!(_step=_iterator.n()).done;){var _ret=_loop();if(typeof _ret===\"object\")return _ret.v;}}catch(err){_iterator.e(err);}finally{_iterator.f();}}},{key:\"endCall\",value:function endCall(session){switch(session.state){case SessionState.Initial:case SessionState.Establishing:if(session instanceof Inviter){// An unestablished outgoing session\nsession.cancel();}else{// An unestablished incoming session\nsession.reject();}break;case SessionState.Established:// An established session\nsession.bye();break;case SessionState.Terminating:case SessionState.Terminated:// Cannot terminate a session that is already terminated\nbreak;}}},{key:\"setupRemoteMedia\",value:function setupRemoteMedia(session){var _ref5,_ref5$peerConnection;var speakerId=arguments.length>1&&arguments[1]!==undefined?arguments[1]:\"\";var tagId=this.getAvailableTag();if(!tagId){var _ref4;(_ref4=session)===null||_ref4===void 0?void 0:_ref4.reject();return;}var mediaElement=document.getElementById(tagId);this.usedTags.set(session.id,tagId);var remoteStream=new MediaStream();(_ref5=session.sessionDescriptionHandler)===null||_ref5===void 0?void 0:(_ref5$peerConnection=_ref5.peerConnection)===null||_ref5$peerConnection===void 0?void 0:_ref5$peerConnection.getReceivers().forEach(function(receiver){if(receiver.track){remoteStream.addTrack(receiver.track);}});var playAudio=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(mediaElement,remoteStream,speakerId){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!mediaElement){_context.next=11;break;}if(!speakerId){_context.next=9;break;}_context.prev=2;_context.next=5;return mediaElement.setSinkId(speakerId);case 5:_context.next=9;break;case 7:_context.prev=7;_context.t0=_context[\"catch\"](2);case 9:mediaElement.srcObject=remoteStream;mediaElement.play();case 11:case\"end\":return _context.stop();}}},_callee,null,[[2,7]]);}));return function playAudio(_x,_x2,_x3){return _ref6.apply(this,arguments);};}();playAudio(mediaElement,remoteStream,speakerId);return{receivingVideo:this.remoteVideoEnabled(session),tagId:tagId};}},{key:\"cleanupMedia\",value:function cleanupMedia(callId){var tag=this.usedTags.get(callId);if(!tag)return;var mediaElement=document.getElementById(tag);if(mediaElement){mediaElement.srcObject=null;mediaElement.pause();this.usedTags.delete(callId);}}}]);return SIP;}();export{SIP as default};","map":{"version":3,"sources":["C:/Users/Digivox/dev/Digivox/Refatoracao/squad/src/services/voice/voicecommunicator.ts"],"names":["Inviter","Registerer","SessionState","UserAgent","Web","tagsRange","SIP","props","onInvite","invitation","activeCalls","size","length","cb","session","set","id","onReceiveCall","stateChange","addListener","Initial","reject","remoteVideoEnabled","receivingVideo","sessionDescriptionHandler","peerConnection","getReceivers","forEach","receiver","track","kind","localVideoEnabled","sessionDescriptionHandlerOptions","constraints","video","muteMic","callID","call","get","sdh","getSenders","stream","enabled","unMuteMic","disableCam","console","log","enableCam","holdCall","options","sessionDescriptionHandlerModifiers","holdModifier","invite","unHoldCall","Object","assign","makeSIP","Map","usedTags","transportOptions","server","uri","makeURI","user","domain","userAgentOptions","authorizationUsername","authorizationPassword","password","logBuiltinEnabled","delegate","userAgent","registerer","start","then","register","connectionCB","number","audio","destination","newCall","currentInvite","state","onMakeCall","tagsUsing","Array","from","values","tagId","find","tgId","Establishing","cancel","Established","bye","Terminating","Terminated","speakerId","getAvailableTag","mediaElement","document","getElementById","remoteStream","MediaStream","addTrack","playAudio","setSinkId","srcObject","play","callId","tag","pause","delete"],"mappings":"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","sourcesContent":["import {\r\n  Invitation,\r\n  Inviter,\r\n  Registerer,\r\n  RegistererState,\r\n  Session,\r\n  SessionInviteOptions,\r\n  SessionState,\r\n  UserAgent,\r\n  UserAgentOptions,\r\n  Web,\r\n} from \"sip.js\";\r\ninterface ConnectionListenerCallback {\r\n  (data: RegistererState): void;\r\n}\r\ninterface MakeCallCallback {\r\n  (state: SessionState, inviter: Inviter): void;\r\n}\r\ninterface ReceiveCallCallback {\r\n  (state: SessionState, invitation: Invitation): void;\r\n}\r\ninterface SIPConstructorPropeties {\r\n  user: string;\r\n  password: string;\r\n  wsURL: string;\r\n  domain: string;\r\n  connectionCB: ConnectionListenerCallback;\r\n  onMakeCall: MakeCallCallback;\r\n  onReceiveCall: ReceiveCallCallback;\r\n}\r\nexport const tagsRange: number[] = [0, 1, 2, 3];\r\nexport default interface SIP {\r\n  user: string;\r\n  password: string;\r\n  wsURL: string;\r\n  domain: string;\r\n  connectionCB: ConnectionListenerCallback;\r\n  onMakeCall: MakeCallCallback;\r\n  onReceiveCall: ReceiveCallCallback;\r\n  userAgent?: UserAgent;\r\n  registerer?: Registerer;\r\n  activeCalls: Map<string, Session>;\r\n  usedTags: Map<string, string>;\r\n}\r\nexport default class SIP {\r\n  constructor(props: SIPConstructorPropeties) {\r\n    Object.assign(this, props);\r\n    this.makeSIP();\r\n    this.activeCalls = new Map<string, Session>();\r\n    this.usedTags = new Map<string, string>();\r\n  }\r\n  makeSIP() {\r\n    const transportOptions = {\r\n      //   server: this.wsURL,\r\n      server: \"wss://test.citrussquad.com:7443\",\r\n    };\r\n    const uri = UserAgent.makeURI(`sip:${this.user}@${this.domain}`);\r\n    const userAgentOptions: UserAgentOptions = {\r\n      authorizationUsername: this.user,\r\n      authorizationPassword: this.password,\r\n      transportOptions,\r\n      uri,\r\n      logBuiltinEnabled: false,\r\n      delegate: {\r\n        onInvite: this.onInvite,\r\n      },\r\n    };\r\n    this.userAgent = new UserAgent(userAgentOptions);\r\n    this.registerer = new Registerer(this.userAgent);\r\n    this.userAgent.start().then(() => {\r\n      this.registerer?.register();\r\n      this.registerer?.stateChange.addListener(this.connectionCB);\r\n    });\r\n  }\r\n  invite(\r\n    number: string,\r\n    constraints: MediaStreamConstraints = { video: false, audio: true }\r\n  ) {\r\n    if (!(this.activeCalls.size >= tagsRange.length) && this.userAgent) {\r\n      const destination = UserAgent.makeURI(`sip:${number}@${this.domain}`);\r\n      let newCall;\r\n      if (destination) {\r\n        newCall = new Inviter(this.userAgent, destination, {\r\n          sessionDescriptionHandlerOptions: {\r\n            constraints,\r\n          },\r\n        });\r\n        this.activeCalls.set(newCall.id, newCall);\r\n      }\r\n      const currentInvite =\r\n        newCall && (this.activeCalls.get(newCall.id) as Inviter);\r\n      if (currentInvite) {\r\n        currentInvite.stateChange.addListener((state) => {\r\n          if (this.activeCalls) this.onMakeCall(state, currentInvite);\r\n        });\r\n        currentInvite.invite();\r\n        this.onMakeCall(SessionState.Initial, currentInvite);\r\n      }\r\n    }\r\n  }\r\n  getAvailableTag() {\r\n    let tagsUsing = Array.from(this.usedTags.values());\r\n    for (const tagId of tagsRange) {\r\n      if (!tagsUsing.find((tgId) => tgId === `remote-stream-${tagId}`)) {\r\n        return `remote-stream-${tagId}`;\r\n      }\r\n    }\r\n  }\r\n  onInvite = (invitation: Invitation) => {\r\n    if (this.activeCalls.size < tagsRange.length) {\r\n      const cb = (session: SessionState) => {\r\n        this.activeCalls.set(invitation.id, invitation);\r\n        this.onReceiveCall(session, invitation);\r\n      };\r\n      invitation.stateChange.addListener(cb);\r\n      this.onReceiveCall(SessionState.Initial, invitation);\r\n    } else {\r\n      invitation.reject();\r\n    }\r\n  };\r\n  endCall(session: Session) {\r\n    switch (session.state) {\r\n      case SessionState.Initial:\r\n      case SessionState.Establishing:\r\n        if (session instanceof Inviter) {\r\n          // An unestablished outgoing session\r\n          session.cancel();\r\n        } else {\r\n          // An unestablished incoming session\r\n          (session as Invitation).reject();\r\n        }\r\n        break;\r\n      case SessionState.Established:\r\n        // An established session\r\n        session.bye();\r\n        break;\r\n      case SessionState.Terminating:\r\n      case SessionState.Terminated:\r\n        // Cannot terminate a session that is already terminated\r\n        break;\r\n    }\r\n  }\r\n  setupRemoteMedia(session: Session, speakerId: string = \"\") {\r\n    const tagId = this.getAvailableTag();\r\n    if (!tagId) {\r\n      (session as Invitation)?.reject();\r\n      return;\r\n    }\r\n    const mediaElement: HTMLVideoElement = document.getElementById(\r\n      tagId\r\n    ) as HTMLVideoElement;\r\n    this.usedTags.set(session.id, tagId);\r\n    const remoteStream = new MediaStream();\r\n\r\n    (session.sessionDescriptionHandler as Web.SessionDescriptionHandler)?.peerConnection\r\n      ?.getReceivers()\r\n      .forEach((receiver) => {\r\n        if (receiver.track) {\r\n          remoteStream.addTrack(receiver.track);\r\n        }\r\n      });\r\n    const playAudio = async (\r\n      mediaElement: HTMLVideoElement,\r\n      remoteStream: MediaStream,\r\n      speakerId: string\r\n    ) => {\r\n      if (mediaElement) {\r\n        if (speakerId) {\r\n          try {\r\n            await (mediaElement as any).setSinkId(speakerId);\r\n          } catch {}\r\n        }\r\n        mediaElement.srcObject = remoteStream;\r\n        mediaElement.play();\r\n      }\r\n    };\r\n    playAudio(mediaElement, remoteStream, speakerId);\r\n    return {\r\n      receivingVideo: this.remoteVideoEnabled(session),\r\n      tagId,\r\n    };\r\n  }\r\n  remoteVideoEnabled = (session: Session) => {\r\n    let receivingVideo = false;\r\n    (session.sessionDescriptionHandler as Web.SessionDescriptionHandler)?.peerConnection\r\n      ?.getReceivers()\r\n      .forEach((receiver) => {\r\n        if (receiver.track) {\r\n          if (receiver.track.kind === \"video\") receivingVideo = true;\r\n        }\r\n      });\r\n    return receivingVideo;\r\n  };\r\n  localVideoEnabled = (session: Session) => {\r\n    return !!((session as Inviter)?.sessionDescriptionHandlerOptions\r\n      .constraints as MediaStreamConstraints)?.video;\r\n  };\r\n  cleanupMedia(callId: string) {\r\n    const tag = this.usedTags.get(callId);\r\n    if (!tag) return;\r\n    const mediaElement: HTMLVideoElement = document.getElementById(\r\n      tag\r\n    ) as HTMLVideoElement;\r\n    if (mediaElement) {\r\n      mediaElement.srcObject = null;\r\n      mediaElement.pause();\r\n      this.usedTags.delete(callId);\r\n    }\r\n  }\r\n  muteMic = (callID: string) => {\r\n    const call = this.activeCalls.get(callID);\r\n    if (call) {\r\n      const sdh: Web.SessionDescriptionHandler = call.sessionDescriptionHandler as Web.SessionDescriptionHandler;\r\n      sdh?.peerConnection?.getSenders().forEach((stream: any) => {\r\n        if (stream.track?.kind === \"audio\") stream.track.enabled = false;\r\n      });\r\n    }\r\n  };\r\n  unMuteMic = (callID: string) => {\r\n    const call = this.activeCalls.get(callID);\r\n    if (call) {\r\n      const sdh: Web.SessionDescriptionHandler = call.sessionDescriptionHandler as Web.SessionDescriptionHandler;\r\n      sdh?.peerConnection?.getSenders().forEach((stream: any) => {\r\n        if (stream.track?.kind === \"audio\") stream.track.enabled = true;\r\n      });\r\n    }\r\n  };\r\n  disableCam = (callID: string) => {\r\n    const call = this.activeCalls.get(callID);\r\n    if (call) {\r\n      if (this.localVideoEnabled(call)) {\r\n        const sdh: Web.SessionDescriptionHandler = call.sessionDescriptionHandler as Web.SessionDescriptionHandler;\r\n        sdh?.peerConnection?.getSenders().forEach((stream) => {\r\n          if (stream.track?.kind === \"video\") stream.track.enabled = false;\r\n        });\r\n      } else {\r\n        // TODO\r\n        console.log(\"re-invite\");\r\n      }\r\n    }\r\n  };\r\n  enableCam = (callID: string) => {\r\n    const call = this.activeCalls.get(callID);\r\n    if (call) {\r\n      if (this.localVideoEnabled(call)) {\r\n        const sdh: Web.SessionDescriptionHandler = call.sessionDescriptionHandler as Web.SessionDescriptionHandler;\r\n        sdh?.peerConnection?.getSenders().forEach((stream: any) => {\r\n          if (stream.track?.kind === \"video\") stream.track.enabled = true;\r\n        });\r\n      } else {\r\n        // TODO\r\n        console.log(\"re-invite\");\r\n      }\r\n    }\r\n  };\r\n  holdCall = (callID: string) => {\r\n    const call = this.activeCalls.get(callID);\r\n    if (call) {\r\n      const options: SessionInviteOptions = {\r\n        sessionDescriptionHandlerModifiers: [Web.holdModifier],\r\n      };\r\n      return call.invite(options);\r\n    }\r\n  };\r\n  unHoldCall = (callID: string) => {\r\n    const call = this.activeCalls.get(callID);\r\n    if (call) {\r\n      const options: SessionInviteOptions = {\r\n        sessionDescriptionHandlerModifiers: [],\r\n      };\r\n\r\n      if (call) {\r\n        call.invite(options);\r\n      }\r\n    }\r\n  };\r\n}\r\n"]},"metadata":{},"sourceType":"module"}