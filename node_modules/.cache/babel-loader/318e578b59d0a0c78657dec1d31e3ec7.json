{"ast":null,"code":"import _objectSpread from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread2\";import React,{useEffect}from\"react\";import{SquadCommunicator as SquadService}from\"./SquadCommunicatorService\";import{useGroup}from\"../contexts/GroupContext\";import{useContact}from\"../contexts/ContactContext\";import{Events as VoiceEvents}from\"./voice/types/types\";import{useCall}from\"../contexts/CallContext\";import CallStatus from\"../enuns/CallStatus\";import{useConference}from\"../contexts/ConferenceContext\";import{ConferenceEvents}from\"./SquadEventsCommunicator\";//import { callbackify } from \"util\";\n// import IContact from \"../alias/IContact\";\n// Comentado para Evitar Warnings no console\n// interface CreateGroupCallback {\n//   (groupCreated: boolean): void;\n// }\nvar squadService;var SquadSipCommunicator=function SquadSipCommunicator(){var _useContact=useContact(),contacts=_useContact.contacts;var _useCall=useCall(),currentCalls=_useCall.currentCalls,setCurrentCalls=_useCall.setCurrentCalls,callNumber=_useCall.callNumber,setCallNumber=_useCall.setCallNumber,updateConstraints=_useCall.updateConstraints,setUpdateConstraints=_useCall.setUpdateConstraints,blindTransfer=_useCall.blindTransfer,setBlindTransfer=_useCall.setBlindTransfer,assistedTransfer=_useCall.assistedTransfer,setAssistedTransfer=_useCall.setAssistedTransfer,conferenceCommand=_useCall.conferenceCommand,setConferenceCommand=_useCall.setConferenceCommand;var _useGroup=useGroup(),groups=_useGroup.groups;var _useConference=useConference(),conferenceList=_useConference.conferenceList;var init=function init(){squadService=SquadService.getInstance({voiceCB:voiceCommuncatorSubscribe});};var setNewCall=function setNewCall(call){var cc=new Map(currentCalls);cc.set(call.callId,call);setCurrentCalls(cc);};var removeCall=function removeCall(call){if(call.interval)clearTimeout(call.interval);var cc=new Map(currentCalls);cc.delete(call.callId);setCurrentCalls(cc);};var onMakeCall=function onMakeCall(){if(callNumber===null||callNumber===void 0?void 0:callNumber.number){var _squadService,_squadService$sip;if(currentCalls){Array.from(currentCalls.values()).forEach(function(call){if(!call.hold){call.holdCall();}});}var constraints={useAudio:callNumber===null||callNumber===void 0?void 0:callNumber.useAudio,useVideo:callNumber===null||callNumber===void 0?void 0:callNumber.useVideo};(_squadService=squadService)===null||_squadService===void 0?void 0:(_squadService$sip=_squadService.sip)===null||_squadService$sip===void 0?void 0:_squadService$sip.makeCall(callNumber===null||callNumber===void 0?void 0:callNumber.number,constraints);setCallNumber(undefined);}};var onUpdateConstraints=function onUpdateConstraints(){if(updateConstraints){var _squadService2;(_squadService2=squadService)===null||_squadService2===void 0?void 0:_squadService2.sip.updateConstraintsParams(updateConstraints);setUpdateConstraints(undefined);}};var onBlindTransfer=function onBlindTransfer(){if(blindTransfer){var _squadService3;(_squadService3=squadService)===null||_squadService3===void 0?void 0:_squadService3.sip.sip.blindTransfer(blindTransfer.callId,blindTransfer.number);setBlindTransfer(undefined);}};var onAttendedTransfer=function onAttendedTransfer(){if(assistedTransfer){var _squadService4;(_squadService4=squadService)===null||_squadService4===void 0?void 0:_squadService4.sip.sip.attendedTransfer(assistedTransfer.firstCallId,assistedTransfer.secondCallId);setAssistedTransfer(undefined);}};var onCallHoldChange=function onCallHoldChange(callId,status){var currentCallsCopy=new Map(currentCalls);var cpc=currentCallsCopy.get(callId);if(cpc){cpc=_objectSpread({},cpc);cpc.hold=status;currentCallsCopy.set(cpc.callId,cpc);setCurrentCalls(currentCallsCopy);}};var onAcceptCall=function onAcceptCall(callId,useVideo){var currentCallsCopy=new Map(currentCalls);Array.from(currentCalls.values()).filter(function(cl){return cl.callId!==callId;}).forEach(function(cl){var _squadService5;(_squadService5=squadService)===null||_squadService5===void 0?void 0:_squadService5.sip.holdCall(cl.callId);cl.hold=true;currentCallsCopy.set(cl.callId,cl);});var callCopy=currentCallsCopy.get(callId);if(callCopy){callCopy=_objectSpread({},callCopy);callCopy.callStatus=CallStatus.CONNECTING;callCopy.sendingVideo=useVideo;currentCallsCopy.set(callCopy.callId,callCopy);setCurrentCalls(currentCallsCopy);}};var onSendConferenceCommand=function onSendConferenceCommand(){if(conferenceCommand){var _squadService6;(_squadService6=squadService)===null||_squadService6===void 0?void 0:_squadService6.events.sendCommand(conferenceCommand.conferenceId,conferenceCommand.command,conferenceCommand.extraParam);setConferenceCommand(undefined);}};var setConferenceParticipants=function setConferenceParticipants(data){var conferenceCall=Array.from(currentCalls.values()).find(function(c){var _ref,_data$members$,_ref2,_data$members$2;return((_ref=c.callerObject)===null||_ref===void 0?void 0:_ref.id)===((_data$members$=data.members[0])===null||_data$members$===void 0?void 0:_data$members$.Conference_Name)||((_ref2=c.callerObject)===null||_ref2===void 0?void 0:_ref2.groupId)===((_data$members$2=data.members[0])===null||_data$members$2===void 0?void 0:_data$members$2.Conference_Name);});if(conferenceCall){conferenceCall=_objectSpread({},conferenceCall);if(!conferenceCall.conferenceParticipants)conferenceCall.conferenceParticipants=[];conferenceCall.conferenceParticipants=data.members.map(function(m){var _conferenceCall;if(m.Caller_Name===((_conferenceCall=conferenceCall)===null||_conferenceCall===void 0?void 0:_conferenceCall.session.remoteIdentity.uri.aor.split(\"@\")[0])){conferenceCall.micMuted=!m.Speak;conferenceCall.videoMuted=!m.See;}return{memberId:m[\"Member-ID\"],callerName:m.Caller_Caller_ID_Name,conferenceName:m.Conference_Name,callName:m.Caller_Name,floor:m.Floor,hear:m.Hear,hold:m.Hold,memberGhost:m[\"Member-Ghost\"],memberType:m[\"Member-Type\"],mute:m.Speak,muteDetect:m[\"Mute-Detect\"],see:m.See,talking:m.Talking,video:m.See};});setNewCall(_objectSpread({},conferenceCall));}};var setConferenceEvents=function setConferenceEvents(call){var _squadService7;if(!call.callerObject.participantPin&&!call.callerObject.groupId)return;var callName=call.callerObject.id||call.callerObject.groupId;(_squadService7=squadService)===null||_squadService7===void 0?void 0:_squadService7.events.connect(callName,conferenceEventsSubscribe);};var hangupEvents=function hangupEvents(call){if(call.remoteIdentity.uri.aor.includes(\"citrus-conference-authenticated-\")||call.remoteIdentity.uri.aor.includes(\"citrus-conference_\")){var _squadService8;(_squadService8=squadService)===null||_squadService8===void 0?void 0:_squadService8.events.disconnect();}};function voiceCommuncatorSubscribe(event,data){var _invitation$remoteIde,_invitation$remoteIde2,_ref3,_ref4,_ref5,_inviter$sessionDescr,_inviter$remoteIdenti,_inviter$remoteIdenti2,_ref6,_ref7,_ref8,_data$invitation,_data$inviter;var endCall;switch(event){case VoiceEvents.CONNECTED:// squadService?.sip.sip.invite(\"2045\");\nconsole.log(\"connected\");break;case VoiceEvents.RECEIVED_CALL:var invitation=data;var invitation_caller_id_number=(_invitation$remoteIde=invitation.remoteIdentity.uri.aor)===null||_invitation$remoteIde===void 0?void 0:(_invitation$remoteIde2=_invitation$remoteIde.split(\"@\")[0])===null||_invitation$remoteIde2===void 0?void 0:_invitation$remoteIde2.replace(\"sip:\",\"\").replace(\"citrus-conference-authenticated-\",\"\").replace(\"citrus-conference_\",\"\").split(\"_\")[0];var invitation_ctct_of_number=contacts.find(function(ctc){return ctc.number===invitation_caller_id_number;})||groups.find(function(grp){return grp.groupId===invitation_caller_id_number;})||conferenceList.find(function(conf){return conf.id===invitation_caller_id_number;});var receivedCall;endCall=function endCall(){var _squadService9;(_squadService9=squadService)===null||_squadService9===void 0?void 0:_squadService9.sip.sip.endCall(invitation);};receivedCall={callId:invitation.id,callStatus:CallStatus.RINGING,callerNumber:invitation_caller_id_number,callerObject:invitation_ctct_of_number,callerId:((_ref3=invitation_ctct_of_number)===null||_ref3===void 0?void 0:_ref3.id)||((_ref4=invitation_ctct_of_number)===null||_ref4===void 0?void 0:_ref4.groupId),callerName:invitation_ctct_of_number===null||invitation_ctct_of_number===void 0?void 0:invitation_ctct_of_number.name,callerProfilePicture:invitation_ctct_of_number===null||invitation_ctct_of_number===void 0?void 0:invitation_ctct_of_number.profilePicture,session:invitation,isGroup:!!((_ref5=invitation_ctct_of_number)===null||_ref5===void 0?void 0:_ref5.groupId),accept:function accept(){var _squadService10;var useVideo=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;return(_squadService10=squadService)===null||_squadService10===void 0?void 0:_squadService10.sip.acceptCall(invitation,useVideo);},endCall:endCall,micMuted:false,videoMuted:false,hold:false,muteMic:function muteMic(){var _squadService11;return(_squadService11=squadService)===null||_squadService11===void 0?void 0:_squadService11.sip.muteMic(invitation.id);},unMuteMic:function unMuteMic(){var _squadService12;return(_squadService12=squadService)===null||_squadService12===void 0?void 0:_squadService12.sip.unMuteMic(invitation.id);},disableCam:function disableCam(){var _squadService13;return(_squadService13=squadService)===null||_squadService13===void 0?void 0:_squadService13.sip.disableCam(invitation.id);},enableCam:function enableCam(){var _squadService14;return(_squadService14=squadService)===null||_squadService14===void 0?void 0:_squadService14.sip.enableCam(invitation.id);},holdCall:function holdCall(){var _squadService15;return(_squadService15=squadService)===null||_squadService15===void 0?void 0:_squadService15.sip.holdCall(invitation.id);},unHoldCall:function unHoldCall(){var _squadService16;return(_squadService16=squadService)===null||_squadService16===void 0?void 0:_squadService16.sip.unHoldCall(invitation.id);}};setConferenceEvents(receivedCall);setNewCall(receivedCall);break;case VoiceEvents.MAKE_CALL:var inviter=data;var localConstraints=inviter===null||inviter===void 0?void 0:(_inviter$sessionDescr=inviter.sessionDescriptionHandlerOptions)===null||_inviter$sessionDescr===void 0?void 0:_inviter$sessionDescr.constraints;var inviter_caller_id_number=(_inviter$remoteIdenti=inviter.remoteIdentity.uri.aor)===null||_inviter$remoteIdenti===void 0?void 0:(_inviter$remoteIdenti2=_inviter$remoteIdenti.split(\"@\")[0])===null||_inviter$remoteIdenti2===void 0?void 0:_inviter$remoteIdenti2.replace(\"sip:\",\"\").replace(\"citrus-conference-authenticated-\",\"\").replace(\"citrus-conference_\",\"\").split(\"_\")[0];var inviter_ctct_of_number=contacts.find(function(ctc){return ctc.number===inviter_caller_id_number;})||groups.find(function(grp){return grp.groupId===inviter_caller_id_number;})||conferenceList.find(function(conf){return conf.id===inviter_caller_id_number;});endCall=function endCall(){var _squadService17;(_squadService17=squadService)===null||_squadService17===void 0?void 0:_squadService17.sip.sip.endCall(inviter);};var sendCall={callId:inviter.id,callStatus:CallStatus.CALLING,callerNumber:inviter_caller_id_number,callerObject:inviter_ctct_of_number,callerId:((_ref6=inviter_ctct_of_number)===null||_ref6===void 0?void 0:_ref6.id)||((_ref7=inviter_ctct_of_number)===null||_ref7===void 0?void 0:_ref7.groupId),callerName:inviter_ctct_of_number===null||inviter_ctct_of_number===void 0?void 0:inviter_ctct_of_number.name,callerProfilePicture:inviter_ctct_of_number===null||inviter_ctct_of_number===void 0?void 0:inviter_ctct_of_number.profilePicture,session:inviter,isGroup:!!((_ref8=inviter_ctct_of_number)===null||_ref8===void 0?void 0:_ref8.groupId),sendingVideo:(localConstraints===null||localConstraints===void 0?void 0:localConstraints.video)!==false,endCall:endCall,muteMic:function muteMic(){var _squadService18;return(_squadService18=squadService)===null||_squadService18===void 0?void 0:_squadService18.sip.muteMic(inviter.id);},unMuteMic:function unMuteMic(){var _squadService19;return(_squadService19=squadService)===null||_squadService19===void 0?void 0:_squadService19.sip.unMuteMic(inviter.id);},disableCam:function disableCam(){var _squadService20;return(_squadService20=squadService)===null||_squadService20===void 0?void 0:_squadService20.sip.disableCam(inviter.id);},enableCam:function enableCam(){var _squadService21;return(_squadService21=squadService)===null||_squadService21===void 0?void 0:_squadService21.sip.enableCam(inviter.id);},holdCall:function holdCall(){var _squadService22;return(_squadService22=squadService)===null||_squadService22===void 0?void 0:_squadService22.sip.holdCall(inviter.id);},unHoldCall:function unHoldCall(){var _squadService23;return(_squadService23=squadService)===null||_squadService23===void 0?void 0:_squadService23.sip.unHoldCall(inviter.id);}};setConferenceEvents(sendCall);setNewCall(sendCall);console.log(\"make_call\");break;case VoiceEvents.CALL_ON_GOING:var callOnGoing=currentCalls.get(data===null||data===void 0?void 0:(_data$invitation=data.invitation)===null||_data$invitation===void 0?void 0:_data$invitation.id)||currentCalls.get(data===null||data===void 0?void 0:(_data$inviter=data.inviter)===null||_data$inviter===void 0?void 0:_data$inviter.id);if(callOnGoing){var _cc=_objectSpread({},callOnGoing);_cc.callStatus=CallStatus.ON_GOING;_cc.receivingVideo=data.receivingVideo;_cc.tagId=data.tagId;setNewCall(_cc);}break;case VoiceEvents.CALL_HANGUP:var hangupCall=currentCalls.get(data.id);if(hangupCall){hangupEvents(hangupCall.session);removeCall(hangupCall);}break;case VoiceEvents.MUTE_MIC:var currentCallsCopy=new Map(currentCalls);var cc=currentCallsCopy.get(data.callId);if(cc){cc=_objectSpread({},cc);cc.micMuted=data.status;currentCallsCopy.set(cc.callId,cc);setCurrentCalls(currentCallsCopy);}break;case VoiceEvents.MUTE_CAM:var currentCallsCp=new Map(currentCalls);var ccp=currentCallsCp.get(data.callId);if(ccp){ccp=_objectSpread({},ccp);ccp.videoMuted=data.status;currentCallsCp.set(ccp.callId,ccp);setCurrentCalls(currentCallsCp);}break;case VoiceEvents.HOLD_CALL:onCallHoldChange(data.callId,data.status);break;case VoiceEvents.ACCEPTED_CALL:onAcceptCall(data.callId,data.useVideo);break;default:console.log(event);break;}}var conferenceEventsSubscribe=function conferenceEventsSubscribe(event,data){switch(event){case ConferenceEvents.UPDATE:setConferenceParticipants(data);break;default:console.error(\"EVENT NOT MAPPED\");console.log(event,data);break;}};var updateFunction=function updateFunction(){var _squadService24,_squadService25;(_squadService24=squadService)===null||_squadService24===void 0?void 0:_squadService24.updateVoiceSubscribeFunction(voiceCommuncatorSubscribe);(_squadService25=squadService)===null||_squadService25===void 0?void 0:_squadService25.updateEventsSubscribeFunction(conferenceEventsSubscribe);};useEffect(init,[]);useEffect(updateFunction,[contacts,groups,currentCalls,callNumber]);useEffect(onMakeCall,[callNumber]);useEffect(onUpdateConstraints,[updateConstraints]);useEffect(onBlindTransfer,[blindTransfer]);useEffect(onAttendedTransfer,[assistedTransfer]);useEffect(onSendConferenceCommand,[conferenceCommand]);return/*#__PURE__*/React.createElement(React.Fragment,null);};export default SquadSipCommunicator;","map":{"version":3,"sources":["C:/Users/Digivox/dev/Digivox/Refatoracao/squad/src/services/SquadSipCommunicator.tsx"],"names":["React","useEffect","SquadCommunicator","SquadService","useGroup","useContact","Events","VoiceEvents","useCall","CallStatus","useConference","ConferenceEvents","squadService","SquadSipCommunicator","contacts","currentCalls","setCurrentCalls","callNumber","setCallNumber","updateConstraints","setUpdateConstraints","blindTransfer","setBlindTransfer","assistedTransfer","setAssistedTransfer","conferenceCommand","setConferenceCommand","groups","conferenceList","init","getInstance","voiceCB","voiceCommuncatorSubscribe","setNewCall","call","cc","Map","set","callId","removeCall","interval","clearTimeout","delete","onMakeCall","number","Array","from","values","forEach","hold","holdCall","constraints","useAudio","useVideo","sip","makeCall","undefined","onUpdateConstraints","updateConstraintsParams","onBlindTransfer","onAttendedTransfer","attendedTransfer","firstCallId","secondCallId","onCallHoldChange","status","currentCallsCopy","cpc","get","onAcceptCall","filter","cl","callCopy","callStatus","CONNECTING","sendingVideo","onSendConferenceCommand","events","sendCommand","conferenceId","command","extraParam","setConferenceParticipants","data","conferenceCall","find","c","callerObject","id","members","Conference_Name","groupId","conferenceParticipants","map","m","Caller_Name","session","remoteIdentity","uri","aor","split","micMuted","Speak","videoMuted","See","memberId","callerName","Caller_Caller_ID_Name","conferenceName","callName","floor","Floor","hear","Hear","Hold","memberGhost","memberType","mute","muteDetect","see","talking","Talking","video","setConferenceEvents","participantPin","connect","conferenceEventsSubscribe","hangupEvents","includes","disconnect","event","endCall","CONNECTED","console","log","RECEIVED_CALL","invitation","invitation_caller_id_number","replace","invitation_ctct_of_number","ctc","grp","conf","receivedCall","RINGING","callerNumber","callerId","name","callerProfilePicture","profilePicture","isGroup","accept","acceptCall","muteMic","unMuteMic","disableCam","enableCam","unHoldCall","MAKE_CALL","inviter","localConstraints","sessionDescriptionHandlerOptions","inviter_caller_id_number","inviter_ctct_of_number","sendCall","CALLING","CALL_ON_GOING","callOnGoing","ON_GOING","receivingVideo","tagId","CALL_HANGUP","hangupCall","MUTE_MIC","MUTE_CAM","currentCallsCp","ccp","HOLD_CALL","ACCEPTED_CALL","UPDATE","error","updateFunction","updateVoiceSubscribeFunction","updateEventsSubscribeFunction"],"mappings":"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","sourcesContent":["import React, { useEffect } from \"react\";\r\nimport { SquadCommunicator as SquadService } from \"./SquadCommunicatorService\";\r\nimport { useGroup } from \"../contexts/GroupContext\";\r\nimport { useContact } from \"../contexts/ContactContext\";\r\nimport IContact from \"../alias/IContact\";\r\nimport IGroup from \"../alias/IGroup\";\r\nimport { Events as VoiceEvents } from \"./voice/types/types\";\r\nimport { useCall } from \"../contexts/CallContext\";\r\nimport ICall from \"../alias/ICall\";\r\nimport { Invitation, Inviter, Session } from \"sip.js\";\r\nimport CallStatus from \"../enuns/CallStatus\";\r\nimport { useConference } from \"../contexts/ConferenceContext\";\r\nimport { ConferenceEvent, ConferenceEvents } from \"./SquadEventsCommunicator\";\r\nimport { IConference } from \"../alias/IConference\";\r\n//import { callbackify } from \"util\";\r\n\r\n// import IContact from \"../alias/IContact\";\r\n// Comentado para Evitar Warnings no console\r\n// interface CreateGroupCallback {\r\n//   (groupCreated: boolean): void;\r\n// }\r\n\r\nlet squadService: SquadService | undefined;\r\n\r\nconst SquadSipCommunicator: React.FC = () => {\r\n  const { contacts } = useContact();\r\n  const {\r\n    currentCalls,\r\n    setCurrentCalls,\r\n    callNumber,\r\n    setCallNumber,\r\n    updateConstraints,\r\n    setUpdateConstraints,\r\n    blindTransfer,\r\n    setBlindTransfer,\r\n    assistedTransfer,\r\n    setAssistedTransfer,\r\n    conferenceCommand,\r\n    setConferenceCommand,\r\n  } = useCall();\r\n  const { groups } = useGroup();\r\n  const { conferenceList } = useConference();\r\n  const init = () => {\r\n    squadService = SquadService.getInstance({\r\n      voiceCB: voiceCommuncatorSubscribe,\r\n    });\r\n  };\r\n  const setNewCall = (call: ICall) => {\r\n    const cc = new Map<string, ICall>(currentCalls);\r\n    cc.set(call.callId, call);\r\n    setCurrentCalls(cc);\r\n  };\r\n  const removeCall = (call: ICall) => {\r\n    if (call.interval) clearTimeout(call.interval);\r\n    const cc = new Map<string, ICall>(currentCalls);\r\n    cc.delete(call.callId);\r\n    setCurrentCalls(cc);\r\n  };\r\n  const onMakeCall = () => {\r\n    if (callNumber?.number) {\r\n      if (currentCalls) {\r\n        Array.from(currentCalls.values()).forEach((call) => {\r\n          if (!call.hold) {\r\n            call.holdCall();\r\n          }\r\n        });\r\n      }\r\n      const constraints = {\r\n        useAudio: callNumber?.useAudio,\r\n        useVideo: callNumber?.useVideo,\r\n      };\r\n      squadService?.sip?.makeCall(callNumber?.number, constraints);\r\n      setCallNumber(undefined);\r\n    }\r\n  };\r\n  const onUpdateConstraints = () => {\r\n    if (updateConstraints) {\r\n      squadService?.sip.updateConstraintsParams(updateConstraints);\r\n      setUpdateConstraints(undefined);\r\n    }\r\n  };\r\n  const onBlindTransfer = () => {\r\n    if (blindTransfer) {\r\n      squadService?.sip.sip.blindTransfer(\r\n        blindTransfer.callId,\r\n        blindTransfer.number\r\n      );\r\n      setBlindTransfer(undefined);\r\n    }\r\n  };\r\n  const onAttendedTransfer = () => {\r\n    if (assistedTransfer) {\r\n      squadService?.sip.sip.attendedTransfer(\r\n        assistedTransfer.firstCallId,\r\n        assistedTransfer.secondCallId\r\n      );\r\n      setAssistedTransfer(undefined);\r\n    }\r\n  };\r\n  const onCallHoldChange = (callId: string, status: boolean) => {\r\n    const currentCallsCopy = new Map(currentCalls);\r\n    let cpc = currentCallsCopy.get(callId);\r\n    if (cpc) {\r\n      cpc = { ...cpc };\r\n      cpc.hold = status;\r\n      currentCallsCopy.set(cpc.callId, cpc);\r\n      setCurrentCalls(currentCallsCopy);\r\n    }\r\n  };\r\n  const onAcceptCall = (callId: string, useVideo: boolean) => {\r\n    const currentCallsCopy = new Map(currentCalls);\r\n    Array.from(currentCalls.values())\r\n      .filter((cl) => cl.callId !== callId)\r\n      .forEach((cl) => {\r\n        squadService?.sip.holdCall(cl.callId);\r\n        cl.hold = true;\r\n        currentCallsCopy.set(cl.callId, cl);\r\n      });\r\n    let callCopy = currentCallsCopy.get(callId);\r\n    if (callCopy) {\r\n      callCopy = { ...callCopy };\r\n      callCopy.callStatus = CallStatus.CONNECTING;\r\n      callCopy.sendingVideo = useVideo;\r\n      currentCallsCopy.set(callCopy.callId, callCopy);\r\n      setCurrentCalls(currentCallsCopy);\r\n    }\r\n  };\r\n  const onSendConferenceCommand = () => {\r\n    if (conferenceCommand) {\r\n      squadService?.events.sendCommand(\r\n        conferenceCommand.conferenceId,\r\n        conferenceCommand.command,\r\n        conferenceCommand.extraParam\r\n      );\r\n      setConferenceCommand(undefined);\r\n    }\r\n  };\r\n  const setConferenceParticipants = (data: ConferenceEvent) => {\r\n    let conferenceCall = Array.from(currentCalls.values()).find(\r\n      (c) =>\r\n        (c.callerObject as IConference)?.id ===\r\n          data.members[0]?.Conference_Name ||\r\n        (c.callerObject as IGroup)?.groupId === data.members[0]?.Conference_Name\r\n    );\r\n    if (conferenceCall) {\r\n      conferenceCall = { ...conferenceCall };\r\n      if (!conferenceCall.conferenceParticipants)\r\n        conferenceCall.conferenceParticipants = [];\r\n      conferenceCall.conferenceParticipants = data.members.map((m) => {\r\n        if (\r\n          m.Caller_Name ===\r\n          conferenceCall?.session.remoteIdentity.uri.aor.split(\"@\")[0]\r\n        ) {\r\n          conferenceCall.micMuted = !m.Speak;\r\n          conferenceCall.videoMuted = !m.See;\r\n        }\r\n        return {\r\n          memberId: m[\"Member-ID\"],\r\n          callerName: m.Caller_Caller_ID_Name,\r\n          conferenceName: m.Conference_Name,\r\n          callName: m.Caller_Name,\r\n          floor: m.Floor,\r\n          hear: m.Hear,\r\n          hold: m.Hold,\r\n          memberGhost: m[\"Member-Ghost\"],\r\n          memberType: m[\"Member-Type\"],\r\n          mute: m.Speak,\r\n          muteDetect: m[\"Mute-Detect\"],\r\n          see: m.See,\r\n          talking: m.Talking,\r\n          video: m.See,\r\n        };\r\n      });\r\n\r\n      setNewCall({ ...conferenceCall });\r\n    }\r\n  };\r\n  const setConferenceEvents = (call: ICall) => {\r\n    if (\r\n      !(call.callerObject as IConference).participantPin &&\r\n      !(call.callerObject as IGroup).groupId\r\n    )\r\n      return;\r\n    const callName =\r\n      (call.callerObject as IConference).id ||\r\n      (call.callerObject as IGroup).groupId;\r\n    squadService?.events.connect(callName, conferenceEventsSubscribe);\r\n  };\r\n  const hangupEvents = (call: Session) => {\r\n    if (\r\n      call.remoteIdentity.uri.aor.includes(\r\n        \"citrus-conference-authenticated-\"\r\n      ) ||\r\n      call.remoteIdentity.uri.aor.includes(\"citrus-conference_\")\r\n    ) {\r\n      squadService?.events.disconnect();\r\n    }\r\n  };\r\n  function voiceCommuncatorSubscribe(event: VoiceEvents, data: any) {\r\n    let endCall;\r\n    switch (event) {\r\n      case VoiceEvents.CONNECTED:\r\n        // squadService?.sip.sip.invite(\"2045\");\r\n        console.log(\"connected\");\r\n        break;\r\n      case VoiceEvents.RECEIVED_CALL:\r\n        const invitation = data as Invitation;\r\n        const invitation_caller_id_number = invitation.remoteIdentity.uri.aor\r\n          ?.split(\"@\")[0]\r\n          ?.replace(\"sip:\", \"\")\r\n          .replace(\"citrus-conference-authenticated-\", \"\")\r\n          .replace(\"citrus-conference_\", \"\")\r\n          .split(\"_\")[0];\r\n        const invitation_ctct_of_number =\r\n          contacts.find((ctc) => ctc.number === invitation_caller_id_number) ||\r\n          groups.find((grp) => grp.groupId === invitation_caller_id_number) ||\r\n          conferenceList.find(\r\n            (conf) => conf.id === invitation_caller_id_number\r\n          );\r\n        let receivedCall: ICall;\r\n        endCall = () => {\r\n          squadService?.sip.sip.endCall(invitation);\r\n        };\r\n        receivedCall = {\r\n          callId: invitation.id,\r\n          callStatus: CallStatus.RINGING,\r\n          callerNumber: invitation_caller_id_number,\r\n          callerObject: invitation_ctct_of_number,\r\n          callerId:\r\n            (invitation_ctct_of_number as IContact)?.id ||\r\n            (invitation_ctct_of_number as IGroup)?.groupId,\r\n          callerName: invitation_ctct_of_number?.name,\r\n          callerProfilePicture: invitation_ctct_of_number?.profilePicture,\r\n          session: invitation,\r\n          isGroup: !!(invitation_ctct_of_number as IGroup)?.groupId,\r\n          accept: (useVideo = false) =>\r\n            squadService?.sip.acceptCall(invitation, useVideo),\r\n          endCall,\r\n          micMuted: false,\r\n          videoMuted: false,\r\n          hold: false,\r\n          muteMic: () => squadService?.sip.muteMic(invitation.id),\r\n          unMuteMic: () => squadService?.sip.unMuteMic(invitation.id),\r\n          disableCam: () => squadService?.sip.disableCam(invitation.id),\r\n          enableCam: () => squadService?.sip.enableCam(invitation.id),\r\n          holdCall: () => squadService?.sip.holdCall(invitation.id),\r\n          unHoldCall: () => squadService?.sip.unHoldCall(invitation.id),\r\n        };\r\n        setConferenceEvents(receivedCall);\r\n        setNewCall(receivedCall);\r\n        break;\r\n      case VoiceEvents.MAKE_CALL:\r\n        const inviter = data as Inviter;\r\n        const localConstraints = inviter?.sessionDescriptionHandlerOptions\r\n          ?.constraints as MediaStreamConstraints;\r\n        const inviter_caller_id_number = inviter.remoteIdentity.uri.aor\r\n          ?.split(\"@\")[0]\r\n          ?.replace(\"sip:\", \"\")\r\n          .replace(\"citrus-conference-authenticated-\", \"\")\r\n          .replace(\"citrus-conference_\", \"\")\r\n          .split(\"_\")[0];\r\n        const inviter_ctct_of_number =\r\n          contacts.find((ctc) => ctc.number === inviter_caller_id_number) ||\r\n          groups.find((grp) => grp.groupId === inviter_caller_id_number) ||\r\n          conferenceList.find((conf) => conf.id === inviter_caller_id_number);\r\n\r\n        endCall = () => {\r\n          squadService?.sip.sip.endCall(inviter);\r\n        };\r\n        const sendCall: ICall = {\r\n          callId: inviter.id,\r\n          callStatus: CallStatus.CALLING,\r\n          callerNumber: inviter_caller_id_number,\r\n          callerObject: inviter_ctct_of_number,\r\n          callerId:\r\n            (inviter_ctct_of_number as IContact)?.id ||\r\n            (inviter_ctct_of_number as IGroup)?.groupId,\r\n          callerName: inviter_ctct_of_number?.name,\r\n          callerProfilePicture: inviter_ctct_of_number?.profilePicture,\r\n          session: inviter,\r\n          isGroup: !!(inviter_ctct_of_number as IGroup)?.groupId,\r\n          sendingVideo: localConstraints?.video !== false,\r\n          endCall,\r\n          muteMic: () => squadService?.sip.muteMic(inviter.id),\r\n          unMuteMic: () => squadService?.sip.unMuteMic(inviter.id),\r\n          disableCam: () => squadService?.sip.disableCam(inviter.id),\r\n          enableCam: () => squadService?.sip.enableCam(inviter.id),\r\n          holdCall: () => squadService?.sip.holdCall(inviter.id),\r\n          unHoldCall: () => squadService?.sip.unHoldCall(inviter.id),\r\n        };\r\n        setConferenceEvents(sendCall);\r\n        setNewCall(sendCall);\r\n        console.log(\"make_call\");\r\n        break;\r\n      case VoiceEvents.CALL_ON_GOING:\r\n        const callOnGoing =\r\n          currentCalls.get(data?.invitation?.id) ||\r\n          currentCalls.get(data?.inviter?.id);\r\n        if (callOnGoing) {\r\n          const cc = { ...callOnGoing };\r\n          cc.callStatus = CallStatus.ON_GOING;\r\n          cc.receivingVideo = data.receivingVideo;\r\n          cc.tagId = data.tagId;\r\n          setNewCall(cc);\r\n        }\r\n        break;\r\n      case VoiceEvents.CALL_HANGUP:\r\n        const hangupCall = currentCalls.get(data.id);\r\n        if (hangupCall) {\r\n          hangupEvents(hangupCall.session);\r\n          removeCall(hangupCall);\r\n        }\r\n        break;\r\n      case VoiceEvents.MUTE_MIC:\r\n        const currentCallsCopy = new Map(currentCalls);\r\n        let cc = currentCallsCopy.get(data.callId);\r\n        if (cc) {\r\n          cc = { ...cc };\r\n          cc.micMuted = data.status;\r\n          currentCallsCopy.set(cc.callId, cc);\r\n          setCurrentCalls(currentCallsCopy);\r\n        }\r\n        break;\r\n      case VoiceEvents.MUTE_CAM:\r\n        const currentCallsCp = new Map(currentCalls);\r\n        let ccp = currentCallsCp.get(data.callId);\r\n        if (ccp) {\r\n          ccp = { ...ccp };\r\n          ccp.videoMuted = data.status;\r\n          currentCallsCp.set(ccp.callId, ccp);\r\n          setCurrentCalls(currentCallsCp);\r\n        }\r\n        break;\r\n      case VoiceEvents.HOLD_CALL:\r\n        onCallHoldChange(data.callId, data.status);\r\n        break;\r\n      case VoiceEvents.ACCEPTED_CALL:\r\n        onAcceptCall(data.callId, data.useVideo);\r\n        break;\r\n      default:\r\n        console.log(event);\r\n        break;\r\n    }\r\n  }\r\n  const conferenceEventsSubscribe = (\r\n    event: ConferenceEvents,\r\n    data: ConferenceEvent\r\n  ) => {\r\n    switch (event) {\r\n      case ConferenceEvents.UPDATE:\r\n        setConferenceParticipants(data);\r\n        break;\r\n      default:\r\n        console.error(\"EVENT NOT MAPPED\");\r\n        console.log(event, data);\r\n        break;\r\n    }\r\n  };\r\n  const updateFunction = () => {\r\n    squadService?.updateVoiceSubscribeFunction(voiceCommuncatorSubscribe);\r\n    squadService?.updateEventsSubscribeFunction(conferenceEventsSubscribe);\r\n  };\r\n\r\n  useEffect(init, []);\r\n  useEffect(updateFunction, [contacts, groups, currentCalls, callNumber]);\r\n  useEffect(onMakeCall, [callNumber]);\r\n  useEffect(onUpdateConstraints, [updateConstraints]);\r\n  useEffect(onBlindTransfer, [blindTransfer]);\r\n  useEffect(onAttendedTransfer, [assistedTransfer]);\r\n  useEffect(onSendConferenceCommand, [conferenceCommand]);\r\n  return <></>;\r\n};\r\n\r\nexport default SquadSipCommunicator;\r\n"]},"metadata":{},"sourceType":"module"}