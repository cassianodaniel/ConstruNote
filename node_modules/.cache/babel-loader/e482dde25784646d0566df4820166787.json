{"ast":null,"code":"import _classCallCheck from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _assertThisInitialized from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/assertThisInitialized\";import _inherits from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/inherits\";import _createSuper from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createSuper\";import{client,xml}from\"@xmpp/client\";import{v4}from\"uuid\";import PresenceStatus from\"../../enuns/PresenceStatus\";import{Events}from\"./types/types\";import{getFrom,getMessage,isTextMessage,getTo,getMessageId,isFileMessage,getMessageType,getMessagFileUrl,getReplyTo,getReplyMsg,getReplyMsgId,isReceived,isDisplayed,getReceivedMessageId,getDisplayedMessageId,isComposing,isActive,isGroupEvent,getEventId,isNewGroup,getEventBody}from\"./util/stanzaUtils\";var events=require(\"events\");var Chat=/*#__PURE__*/function(_events$EventEmitter){_inherits(Chat,_events$EventEmitter);var _super=_createSuper(Chat);function Chat(_ref){var _this;var _service=_ref.service,_domain=_ref.domain,_resource=_ref.resource,_username=_ref.username,_password=_ref.password;_classCallCheck(this,Chat);_this=_super.call(this);_this.getJid=function(){return\"\".concat(_this.username,\"@\").concat(_this.getDomain());};_this.getDomain=function(){return _this.domain||_this.service.replace(\"wss://\",\"\").replace(\"ws://\",\"\").split(\"/\")[0];};_this.instanceMaker=function(_ref2){var service=_ref2.service,domain=_ref2.domain,resource=_ref2.resource,username=_ref2.username,password=_ref2.password;var xmpp=client({service:service,domain:domain,resource:resource,username:username,password:password});xmpp.on(\"status\",_this.onStatus);xmpp.on(\"stanza\",_this.onStanza);xmpp.on(\"online\",_this.onOnline);xmpp.on(\"error\",_this.onError);xmpp.on(\"offline\",_this.onOffline);xmpp.reconnect.on(\"reconnecting\",_this.onReconnecting);xmpp.reconnect.on(\"reconnected\",_this.onReconnected);return xmpp;};_this.onReconnecting=function(){// console.log(\"reconnecting\");\n_this.emit(\"reconnecting\");};_this.onReconnected=function(){// console.log(\"reconnected\");\n_this.emit(\"reconnected\");};_this.onStanza=function(stanza){_this.emit(\"stanza\",stanza);if(stanza.is(\"message\"))_this.onMessage(stanza);else if(stanza.is(\"presence\"))_this.onPresence(stanza);else if(stanza.is(\"iq\"))_this.onIQ(stanza);else return;};_this.onOnline=function(__){_this.discoItensId=v4();// this.sendEnableCarbon();\n_this.sendServiceDiscoveryRequest(_this.discoItensId);_this.client.send(xml(\"presence\"));_this.emit(\"online\");};_this.onOffline=function(){_this.emit(\"offline\");};_this.onError=function(e){_this.emit(\"error\",e);};_this.onStatus=function(status){_this.emit(\"status\",status);};_this.onMessage=function(stanza){if(isGroupEvent(stanza)){if(isNewGroup(stanza)){var eventToNewGroup={to:getTo(stanza),from:getFrom(stanza),id:v4(),eventId:1,message:\"\",reply_msg:undefined,sent_at:new Date().toISOString(),type:\"groupchat\",reply_msg_id:undefined,reply_to:undefined};_this.emit(Events.SEND_EVENT,eventToNewGroup);}else{var _event={id:getMessageId(stanza),to:getTo(stanza),from:getFrom(stanza),message:\"\",type:\"groupchat\",sent_at:new Date().toISOString(),reply_to:undefined,reply_msg:undefined,reply_msg_id:undefined,eventId:getEventId(stanza),eventBody:getEventBody(stanza)};_this.emit(Events.SEND_EVENT,_event);}}else if(isTextMessage(stanza)){var _message={id:getMessageId(stanza),to:getTo(stanza),from:getFrom(stanza),message:getMessage(stanza),type:getMessageType(stanza),sent_at:new Date().toISOString(),reply_to:getReplyTo(stanza),reply_msg:getReplyMsg(stanza),reply_msg_id:getReplyMsgId(stanza)};_this.sendReceipts(stanza);_this.emit(Events.MESSAGE,_message);}else if(isFileMessage(stanza)){var fileMessage={id:getMessageId(stanza),to:getTo(stanza),from:getFrom(stanza),message:\"\",type:getMessageType(stanza),sent_at:new Date().toISOString(),reply_to:getReplyTo(stanza),reply_msg:getReplyMsg(stanza),reply_msg_id:getReplyMsgId(stanza),fileUrl:getMessagFileUrl(stanza)};_this.sendReceipts(stanza);_this.emit(Events.MESSAGE,fileMessage);}else if(isReceived(stanza)){var received={id:getReceivedMessageId(stanza)};_this.emit(Events.RECEIVED,received);}else if(isDisplayed(stanza)){var displayed={id:getDisplayedMessageId(stanza)};_this.emit(Events.DISPLAYED,displayed);}else if(isComposing(stanza)){_this.emit(Events.COMPOSING,getFrom(stanza));}else if(isActive(stanza)){_this.emit(Events.ACTIVE,getFrom(stanza));}};_this.onPresence=function(stanza){var presence={id:v4(),from:stanza.attrs.from,time:new Date().toISOString(),status:stanza.getChild(\"show\")?stanza.getChild(\"show\").children[0]:stanza.attrs.type||\"online\"};var otherPresence=Array.from(_this.presences.values()).find(function(pres){return pres.from.split(\"/\")[0]===presence.from.split(\"/\")[0]&&pres.from!==presence.from;});if(otherPresence){_this.emit(\"presence\",otherPresence);}else{_this.emit(\"presence\",presence);}_this.presences.set(stanza.attrs.from,presence);};_this.onIQ=function(stanza){if(stanza.attrs.type===\"result\"){if(stanza.attrs.id){var _file=_this.filesQueue.get(stanza.attrs.id);if(_file){if(stanza.attrs.id===_file.firstStepId){_this.sendFileSecondStep(stanza);}else if(stanza.attrs.id===_file.secondStepId){_this.sendFileThirdStep(stanza,_file);}}else if(stanza.attrs.id===_this.discoItensId){stanza.children[0].children.forEach(function(element){var key=element.attrs.jid.split(\".\")[0];_this.discoItems.set(key,element.attrs.jid);});}}}};_this.getPresence=function(from){var presence=_this.presences.get(from);if(presence)return presence;else return null;};_this.sendEnableCarbon=function(){var stanza=xml(\"iq\",{from:\"\".concat(_this.getJid(),\"/\").concat(_this.resource),type:\"set\",id:\"enable1\"},xml(\"enable\",{xmlns:\"urn:xmpp:carbons:2\"}));_this.client.send(stanza);};_this.sendPresence=function(status){var to=arguments.length>1&&arguments[1]!==undefined?arguments[1]:undefined;var show=xml(\"show\",{},status);if(status!==\"online\")_this.client.send(xml(\"presence\",{to:to},show));else _this.client.send(xml(\"presence\"));};_this.leaveGroup=function(to){var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:PresenceStatus.UNAVAILABLE;_this.client.send(xml(\"presence\",{to:to,type:type}));};_this.sendMessage=function(to,chatType,message,callback){var msgId=v4();_this.client.send(xml(\"message\",{id:msgId,type:chatType,to:to},xml(\"body\",{},message),xml(\"request\",{xmlns:\"urn:xmpp:receipts\"}))).then(function(){callback(msgId);});};_this.sendFile=function(to,chatType,file,callback){var fileId=v4();_this.filesQueue.set(fileId,{firstStepId:fileId,file:file,to:to,chatType:chatType,callback:callback});_this.sendFileFirstStep(fileId);};_this.sendImageMessage=function(url,to,chatType,callback){var msgId=v4();var messagePacket=xml(\"message\",{id:msgId,type:chatType,to:to},xml(\"body\",{},url),xml(\"request\",{xmlns:\"urn:xmpp:receipts\"}),xml(\"x\",{xmlns:\"jabber:x:oob\"},xml(\"url\",{},url)));if(_this.client){callback({url:url,msgId:msgId});_this.client.send(messagePacket);}};_this.sendFileFirstStep=function(fileId){var uploadJid=_this.discoItems.get(\"upload\");if(uploadJid){_this.sendServiceDiscoveryRequestToUpload(uploadJid,fileId);return;}};_this.sendFileSecondStep=function(stanza){if(stanza.children.length>0){var secondStepId=v4();var _file2=_this.filesQueue.get(stanza.attrs.id);if(_file2){_this.filesQueue.set(secondStepId,{firstStepId:_file2.firstStepId,secondStepId:secondStepId,file:_file2.file,to:_file2.to,chatType:_file2.chatType,callback:_file2.callback});_this.filesQueue.delete(stanza.attrs.id);}console.log(\"upload request xmlns\",stanza.children[0].children[2].attrs.var);_this.sendRequestSlotOnUpload(stanza.attrs.from,secondStepId);}};_this.sendFileThirdStep=function(stanza,file){var getUrl=\"\";var putUrl=\"\";stanza.children[0].children.forEach(function(element){if(element.is(\"get\")){getUrl=element.attrs.url;}else if(element.is(\"put\")){putUrl=element.attrs.url;}});if(file===null||file===void 0?void 0:file.secondStepId)_this.uploadFile(putUrl,getUrl,file.secondStepId);};_this.sendServiceDiscoveryRequest=function(fileId){var serviceDiscoveryRequest=xml(\"iq\",{type:\"get\",to:_this.getDomain(),id:fileId},xml(\"query\",{xmlns:\"http://jabber.org/protocol/disco#items\"}));if(_this.client){_this.client.send(serviceDiscoveryRequest);}};_this.sendServiceDiscoveryRequestToUpload=function(uploadJid,uploadId){console.log(\"sendServiceDiscoveryRequestToUpload\",uploadJid);var serviceDiscoveryRequest=xml(\"iq\",{type:\"get\",to:uploadJid,id:uploadId},xml(\"query\",{xmlns:\"http://jabber.org/protocol/disco#info\"}));if(_this.client){_this.client.send(serviceDiscoveryRequest);}};_this.sendRequestSlotOnUpload=function(uploadJid,thirdStepId){var _this$filesQueue$get;console.log(\"sendRequestSlotOnUpload\",uploadJid);var file=(_this$filesQueue$get=_this.filesQueue.get(thirdStepId))===null||_this$filesQueue$get===void 0?void 0:_this$filesQueue$get.file;var serviceDiscoveryRequest=xml(\"iq\",{type:\"get\",to:uploadJid,id:thirdStepId},xml(\"request\",{xmlns:\"urn:xmpp:http:upload:0\",filename:file===null||file===void 0?void 0:file.name,size:file===null||file===void 0?void 0:file.size,\"content-type\":file===null||file===void 0?void 0:file.type}));if(_this.client){_this.client.send(serviceDiscoveryRequest);}};_this.uploadFile=function(putUrl,getUrl,id){var xhr=new XMLHttpRequest();var file=_this.filesQueue.get(id);if(file){xhr.onerror=function(){if(xhr.responseText){file.callback(xhr.responseText,true);console.log(\"upload error\");}};xhr.onreadystatechange=function(e){if(xhr.readyState===XMLHttpRequest.DONE){console.log(\"file upload response\",e,xhr.status);if(xhr.status===200||xhr.status===201){console.log(\"file upload response success\");_this.sendImageMessage(getUrl,file.to,file.chatType,file===null||file===void 0?void 0:file.callback);_this.filesQueue.delete(id);}}};xhr.upload.addEventListener(\"progress\",function(evt){console.log(\"progress\",evt);// if (file) file.file.size = evt.total\n},false);xhr.open(\"PUT\",putUrl,true);xhr.setRequestHeader(\"Content-Type\",file.file.type);xhr.send(file.file);console.log(\"URL\",putUrl);console.log(\"fileSize\",file.file.size);}};_this.sendReceipts=function(stanza){var message=xml(\"message\",{from:stanza.attrs.to,id:v4(),to:stanza.attrs.from.split(\"/\")[0]},xml(\"received\",{xmlns:\"urn:xmpp:receipts\",id:stanza.attrs.id}));console.log(message);_this.client.send(message);};_this.sendTyping=function(to){var composing=xml(\"message\",{id:v4(),to:to,type:\"chat\"},xml(\"composing\",{xmlns:\"http://jabber.org/protocol/chatstates\"}));_this.client.send(composing);};_this.sendActive=function(to){var active=xml(\"message\",{id:v4(),to:to,type:\"chat\"},xml(\"active\",{xmlns:\"http://jabber.org/protocol/chatstates\"}));_this.client.send(active);};_this.replyMsg=function(to,chatType,message,replyed_sender,replyed_msg,replyed_msg_id,cb){var id=v4();var reply=xml(\"message\",{to:to,id:id,type:chatType},xml(\"body\",{},message),xml(\"extraParams\",{},xml(\"reply_to\",{},replyed_sender),xml(\"reply_msg\",{},replyed_msg),xml(\"reply_msg_id\",{},replyed_msg_id)));_this.client.send(reply).then(function(){cb(id);});};_this.sendEvent=function(to){var eventBody=arguments.length>1&&arguments[1]!==undefined?arguments[1]:undefined;var nbr=arguments.length>2&&arguments[2]!==undefined?arguments[2]:undefined;var cb=arguments.length>3&&arguments[3]!==undefined?arguments[3]:function(){};var id=v4();var stanza=xml(\"message\",{to:to,type:\"groupchat\",id:id},xml(\"subject\",{},\"KEY_ROOM_GENERAL\"),xml(\"body\",{}),xml(\"extraParams\",{xmlns:\"jabber:client\"},xml(\"key_room_event\",{},nbr),eventBody?xml(\"key_room_event_body\",{},eventBody):undefined));_this.client.send(stanza).then(function(){cb(id);});};_this.joinRoomEvent=function(to,eventBody,from){var cb=arguments.length>3&&arguments[3]!==undefined?arguments[3]:function(){};var id=v4();var stanza=xml(\"message\",{to:to,from:from,type:\"groupchat\",id:id},//from - UNNECESSARY?\nxml(\"extraParams\",{},xml(\"key_room_event\",{},\"2\"),eventBody?xml(\"key_room_event_body\",{},eventBody):undefined),xml(\"body\",{}),xml(\"subject\",{},\"KEY_ROOM_GENERAL\"));_this.client.send(stanza).then(function(){cb(id);});};_this.forwardMsg=function(to,chatType,forwarded_msg_sender,forwarded_msg,forwarded_msg_id,callback){var id=v4();var forward=xml(\"message\",{to:to,id:id,type:chatType},xml(\"body\",{},forwarded_msg),xml(\"extraParams\",{},xml(\"reply_to\",{},forwarded_msg_sender),xml(\"reply_msg_id\",{},forwarded_msg_id)),xml(\"request\",{xmlns:\"urn:xmpp:receipts\"}));_this.client.send(forward).then(function(){callback(id);});};_this.joinRoom=function(to){var joinStanza=xml(\"presence\",{to:\"\".concat(to,\"/\").concat(_this.username),from:\"\".concat(_this.getJid(),\"/\").concat(_this.resource)},xml(\"x\",{xmlns:\"http://jabber.org/protocol/muc\"},xml(\"history\",{maxstanzas:\"0\"})));_this.client.send(joinStanza);};Object.setPrototypeOf(_assertThisInitialized(_this),Chat.prototype);_this.service=_service;_this.domain=_domain;_this.resource=_resource;_this.username=_username;_this.password=_password;_this.client=_this.instanceMaker({service:_service,domain:_domain,resource:_resource,username:_username,password:_password});_this.status=_this.client.status;_this.connect=_this.client.start;_this.filesQueue=new Map();_this.presences=new Map();_this.discoItems=new Map();return _this;}return Chat;}(events.EventEmitter);export{Chat as default};","map":{"version":3,"sources":["C:/Users/Digivox/dev/Digivox/Refatoracao/squad/src/services/chat/chatcommunicator.ts"],"names":["client","xml","v4","PresenceStatus","Events","getFrom","getMessage","isTextMessage","getTo","getMessageId","isFileMessage","getMessageType","getMessagFileUrl","getReplyTo","getReplyMsg","getReplyMsgId","isReceived","isDisplayed","getReceivedMessageId","getDisplayedMessageId","isComposing","isActive","isGroupEvent","getEventId","isNewGroup","getEventBody","events","require","Chat","service","domain","resource","username","password","getJid","getDomain","replace","split","instanceMaker","xmpp","on","onStatus","onStanza","onOnline","onError","onOffline","reconnect","onReconnecting","onReconnected","emit","stanza","is","onMessage","onPresence","onIQ","__","discoItensId","sendServiceDiscoveryRequest","send","e","status","eventToNewGroup","to","from","id","eventId","message","reply_msg","undefined","sent_at","Date","toISOString","type","reply_msg_id","reply_to","SEND_EVENT","event","eventBody","sendReceipts","MESSAGE","fileMessage","fileUrl","received","RECEIVED","displayed","DISPLAYED","COMPOSING","ACTIVE","presence","attrs","time","getChild","children","otherPresence","Array","presences","values","find","pres","set","file","filesQueue","get","firstStepId","sendFileSecondStep","secondStepId","sendFileThirdStep","forEach","element","key","jid","discoItems","getPresence","sendEnableCarbon","xmlns","sendPresence","show","leaveGroup","UNAVAILABLE","sendMessage","chatType","callback","msgId","then","sendFile","fileId","sendFileFirstStep","sendImageMessage","url","messagePacket","uploadJid","sendServiceDiscoveryRequestToUpload","length","delete","console","log","var","sendRequestSlotOnUpload","getUrl","putUrl","uploadFile","serviceDiscoveryRequest","uploadId","thirdStepId","filename","name","size","xhr","XMLHttpRequest","onerror","responseText","onreadystatechange","readyState","DONE","upload","addEventListener","evt","open","setRequestHeader","sendTyping","composing","sendActive","active","replyMsg","replyed_sender","replyed_msg","replyed_msg_id","cb","reply","sendEvent","nbr","joinRoomEvent","forwardMsg","forwarded_msg_sender","forwarded_msg","forwarded_msg_id","forward","joinRoom","joinStanza","maxstanzas","Object","setPrototypeOf","prototype","connect","start","Map","EventEmitter"],"mappings":"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","sourcesContent":["import { client, xml, XmppClient } from \"@xmpp/client\";\r\nimport { v4 } from \"uuid\";\r\nimport PresenceStatus from \"../../enuns/PresenceStatus\";\r\nimport {\r\n  ActiveCallback,\r\n  ChatType,\r\n  ComposingCallback,\r\n  ConnectionOptions,\r\n  DisplayedCallback,\r\n  ErrorCallback,\r\n  EventCallback,\r\n  Events,\r\n  FileMessage,\r\n  Message,\r\n  MessageCallback,\r\n  OfflineCallback,\r\n  OnlineCallback,\r\n  Presence,\r\n  PresenceCallback,\r\n  ReceivedCallback,\r\n  SendImageCallback,\r\n  SendingFile,\r\n  SendMessageCallback,\r\n  StanzaCallback,\r\n} from \"./types/types\";\r\nimport {\r\n  getFrom,\r\n  getMessage,\r\n  isTextMessage,\r\n  getTo,\r\n  getMessageId,\r\n  isFileMessage,\r\n  getMessageType,\r\n  getMessagFileUrl,\r\n  getReplyTo,\r\n  getReplyMsg,\r\n  getReplyMsgId,\r\n  isReceived,\r\n  isDisplayed,\r\n  getReceivedMessageId,\r\n  getDisplayedMessageId,\r\n  isComposing,\r\n  isActive,\r\n  isGroupEvent,\r\n  getEventId,\r\n  isNewGroup,\r\n  getEventBody,\r\n} from \"./util/stanzaUtils\";\r\nconst events = require(\"events\");\r\n\r\nexport default interface Chat {\r\n  service: string;\r\n  domain?: string;\r\n  resource: string;\r\n  username: string;\r\n  password?: string;\r\n  client: XmppClient;\r\n  status: string;\r\n  filesQueue: Map<string, SendingFile>;\r\n  presences: Map<string, Presence>;\r\n  connect(): Promise<any>;\r\n  on(event: Events.MESSAGE, cb: MessageCallback): this;\r\n  on(event: Events.PRESENCE, cb: PresenceCallback): this;\r\n  on(event: Events.ONLINE, cb: OnlineCallback): this;\r\n  on(event: Events.OFFLINE, cb: OfflineCallback): this;\r\n  on(event: Events.ERROR, cb: ErrorCallback): this;\r\n  on(event: Events.STANZA, cb: StanzaCallback): this;\r\n  on(event: Events.RECEIVED, cb: ReceivedCallback): this;\r\n  on(event: Events.DISPLAYED, cb: DisplayedCallback): this;\r\n  on(event: Events.COMPOSING, cb: ComposingCallback): this;\r\n  on(event: Events.ACTIVE, cb: ActiveCallback): this;\r\n  on(event: Events.JOIN_ROOM, cb: EventCallback): this;\r\n  on(event: Events.SEND_EVENT, cb: EventCallback): this;\r\n  on(event: Events.RECONNECTING, cb: EventCallback): this;\r\n  on(event: Events.RECONNECTED, cb: EventCallback): this;\r\n  getPresence(from: string): Presence | null;\r\n  sendMessage(\r\n    to: string,\r\n    chatType: ChatType,\r\n    message: string,\r\n    cb: SendMessageCallback\r\n  ): void;\r\n  sendFile(\r\n    to: string,\r\n    chatType: ChatType,\r\n    file: File,\r\n    callback: SendImageCallback\r\n  ): void;\r\n  getDomain(): string;\r\n  joinRoom(to: string): void;\r\n}\r\nexport default class Chat extends events.EventEmitter {\r\n  constructor({\r\n    service,\r\n    domain,\r\n    resource,\r\n    username,\r\n    password,\r\n  }: ConnectionOptions) {\r\n    super();\r\n    Object.setPrototypeOf(this, Chat.prototype);\r\n    this.service = service;\r\n    this.domain = domain;\r\n    this.resource = resource;\r\n    this.username = username;\r\n    this.password = password;\r\n    this.client = this.instanceMaker({\r\n      service: service,\r\n      domain: domain,\r\n      resource: resource,\r\n      username: username,\r\n      password: password,\r\n    });\r\n    this.status = this.client.status;\r\n    this.connect = this.client.start;\r\n    this.filesQueue = new Map<string, SendingFile>();\r\n    this.presences = new Map<string, Presence>();\r\n    this.discoItems = new Map<string, string>();\r\n  }\r\n\r\n  getJid = () => {\r\n    return `${this.username}@${this.getDomain()}`;\r\n  };\r\n\r\n  getDomain = () => {\r\n    return (\r\n      this.domain ||\r\n      this.service.replace(\"wss://\", \"\").replace(\"ws://\", \"\").split(\"/\")[0]\r\n    );\r\n  };\r\n\r\n  instanceMaker = ({\r\n    service,\r\n    domain,\r\n    resource,\r\n    username,\r\n    password,\r\n  }: ConnectionOptions) => {\r\n    const xmpp = client({\r\n      service: service,\r\n      domain: domain,\r\n      resource: resource,\r\n      username: username,\r\n      password: password,\r\n    });\r\n    xmpp.on(\"status\", this.onStatus);\r\n    xmpp.on(\"stanza\", this.onStanza);\r\n    xmpp.on(\"online\", this.onOnline);\r\n    xmpp.on(\"error\", this.onError);\r\n    xmpp.on(\"offline\", this.onOffline);\r\n    xmpp.reconnect.on(\"reconnecting\", this.onReconnecting);\r\n    xmpp.reconnect.on(\"reconnected\", this.onReconnected);\r\n    return xmpp;\r\n  };\r\n  onReconnecting = () => {\r\n    // console.log(\"reconnecting\");\r\n    this.emit(\"reconnecting\");\r\n  };\r\n  onReconnected = () => {\r\n    // console.log(\"reconnected\");\r\n    this.emit(\"reconnected\");\r\n  };\r\n  onStanza = (stanza: any) => {\r\n    this.emit(\"stanza\", stanza);\r\n    if (stanza.is(\"message\")) this.onMessage(stanza);\r\n    else if (stanza.is(\"presence\")) this.onPresence(stanza);\r\n    else if (stanza.is(\"iq\")) this.onIQ(stanza);\r\n    else return;\r\n  };\r\n\r\n  onOnline = (__: any) => {\r\n    this.discoItensId = v4();\r\n    // this.sendEnableCarbon();\r\n    this.sendServiceDiscoveryRequest(this.discoItensId);\r\n    this.client.send(xml(\"presence\"));\r\n    this.emit(\"online\");\r\n  };\r\n\r\n  onOffline = () => {\r\n    this.emit(\"offline\");\r\n  };\r\n\r\n  onError = (e: any) => {\r\n    this.emit(\"error\", e);\r\n  };\r\n\r\n  onStatus = (status: string) => {\r\n    this.emit(\"status\", status);\r\n  };\r\n\r\n  onMessage = (stanza: any) => {\r\n    if (isGroupEvent(stanza)) {\r\n      if (isNewGroup(stanza)) {\r\n        const eventToNewGroup: Message = {\r\n          to: getTo(stanza),\r\n          from: getFrom(stanza),\r\n          id: v4(),\r\n          eventId: 1,\r\n          message: \"\",\r\n          reply_msg: undefined,\r\n          sent_at: new Date().toISOString(),\r\n          type: \"groupchat\",\r\n          reply_msg_id: undefined,\r\n          reply_to: undefined,\r\n        };\r\n        this.emit(Events.SEND_EVENT, eventToNewGroup);\r\n      } else {\r\n        const event: Message = {\r\n          id: getMessageId(stanza),\r\n          to: getTo(stanza),\r\n          from: getFrom(stanza),\r\n          message: \"\",\r\n          type: \"groupchat\",\r\n          sent_at: new Date().toISOString(),\r\n          reply_to: undefined,\r\n          reply_msg: undefined,\r\n          reply_msg_id: undefined,\r\n          eventId: getEventId(stanza),\r\n          eventBody: getEventBody(stanza),\r\n        };\r\n        this.emit(Events.SEND_EVENT, event);\r\n      }\r\n    } else if (isTextMessage(stanza)) {\r\n      const message: Message = {\r\n        id: getMessageId(stanza),\r\n        to: getTo(stanza),\r\n        from: getFrom(stanza),\r\n        message: getMessage(stanza),\r\n        type: getMessageType(stanza),\r\n        sent_at: new Date().toISOString(),\r\n        reply_to: getReplyTo(stanza),\r\n        reply_msg: getReplyMsg(stanza),\r\n        reply_msg_id: getReplyMsgId(stanza),\r\n      };\r\n      this.sendReceipts(stanza);\r\n      this.emit(Events.MESSAGE, message);\r\n    } else if (isFileMessage(stanza)) {\r\n      const fileMessage: FileMessage = {\r\n        id: getMessageId(stanza),\r\n        to: getTo(stanza),\r\n        from: getFrom(stanza),\r\n        message: \"\",\r\n        type: getMessageType(stanza),\r\n        sent_at: new Date().toISOString(),\r\n        reply_to: getReplyTo(stanza),\r\n        reply_msg: getReplyMsg(stanza),\r\n        reply_msg_id: getReplyMsgId(stanza),\r\n        fileUrl: getMessagFileUrl(stanza),\r\n      };\r\n      this.sendReceipts(stanza);\r\n      this.emit(Events.MESSAGE, fileMessage);\r\n    } else if (isReceived(stanza)) {\r\n      const received = {\r\n        id: getReceivedMessageId(stanza),\r\n      };\r\n      this.emit(Events.RECEIVED, received);\r\n    } else if (isDisplayed(stanza)) {\r\n      const displayed = {\r\n        id: getDisplayedMessageId(stanza),\r\n      };\r\n      this.emit(Events.DISPLAYED, displayed);\r\n    } else if (isComposing(stanza)) {\r\n      this.emit(Events.COMPOSING, getFrom(stanza));\r\n    } else if (isActive(stanza)) {\r\n      this.emit(Events.ACTIVE, getFrom(stanza));\r\n    }\r\n  };\r\n\r\n  onPresence = (stanza: any) => {\r\n    const presence: Presence = {\r\n      id: v4(),\r\n      from: stanza.attrs.from,\r\n      time: new Date().toISOString(),\r\n      status: stanza.getChild(\"show\")\r\n        ? stanza.getChild(\"show\").children[0]\r\n        : stanza.attrs.type || \"online\",\r\n    };\r\n    const otherPresence = Array.from(this.presences.values()).find(\r\n      (pres) =>\r\n        pres.from.split(\"/\")[0] === presence.from.split(\"/\")[0] &&\r\n        pres.from !== presence.from\r\n    );\r\n    if (otherPresence) {\r\n      this.emit(\"presence\", otherPresence);\r\n    } else {\r\n      this.emit(\"presence\", presence);\r\n    }\r\n    this.presences.set(stanza.attrs.from, presence);\r\n  };\r\n\r\n  onIQ = (stanza: any) => {\r\n    if (stanza.attrs.type === \"result\") {\r\n      if (stanza.attrs.id) {\r\n        const file = this.filesQueue.get(stanza.attrs.id);\r\n        if (file) {\r\n          if (stanza.attrs.id === file.firstStepId) {\r\n            this.sendFileSecondStep(stanza);\r\n          } else if (stanza.attrs.id === file.secondStepId) {\r\n            this.sendFileThirdStep(stanza, file);\r\n          }\r\n        } else if (stanza.attrs.id === this.discoItensId) {\r\n          stanza.children[0].children.forEach((element: any) => {\r\n            const key = element.attrs.jid.split(\".\")[0];\r\n            this.discoItems.set(key, element.attrs.jid);\r\n          });\r\n        }\r\n      }\r\n    }\r\n  };\r\n  getPresence = (from: string) => {\r\n    const presence = this.presences.get(from);\r\n    if (presence) return presence;\r\n    else return null;\r\n  };\r\n  sendEnableCarbon = () => {\r\n    const stanza = xml(\r\n      \"iq\",\r\n      { from: `${this.getJid()}/${this.resource}`, type: \"set\", id: \"enable1\" },\r\n      xml(\"enable\", { xmlns: \"urn:xmpp:carbons:2\" })\r\n    );\r\n    this.client.send(stanza);\r\n  };\r\n  sendPresence = (status: string, to: string | undefined = undefined) => {\r\n    const show = xml(\"show\", {}, status);\r\n    if (status !== \"online\") this.client.send(xml(\"presence\", { to }, show));\r\n    else this.client.send(xml(\"presence\"));\r\n  };\r\n  leaveGroup = (\r\n    to: string,\r\n    type: PresenceStatus = PresenceStatus.UNAVAILABLE\r\n  ) => {\r\n    this.client.send(xml(\"presence\", { to, type }));\r\n  };\r\n  sendMessage = (\r\n    to: string,\r\n    chatType: ChatType,\r\n    message: string,\r\n    callback: SendMessageCallback\r\n  ) => {\r\n    const msgId = v4();\r\n    this.client\r\n      .send(\r\n        xml(\r\n          \"message\",\r\n          {\r\n            id: msgId,\r\n            type: chatType,\r\n            to: to,\r\n          },\r\n          xml(\"body\", {}, message),\r\n          xml(\"request\", { xmlns: \"urn:xmpp:receipts\" })\r\n        )\r\n      )\r\n      .then(() => {\r\n        callback(msgId);\r\n      });\r\n  };\r\n\r\n  sendFile = (\r\n    to: string,\r\n    chatType: ChatType,\r\n    file: File,\r\n    callback: SendImageCallback\r\n  ) => {\r\n    const fileId = v4();\r\n    this.filesQueue.set(fileId, {\r\n      firstStepId: fileId,\r\n      file: file,\r\n      to: to,\r\n      chatType: chatType,\r\n      callback: callback,\r\n    });\r\n    this.sendFileFirstStep(fileId);\r\n  };\r\n\r\n  sendImageMessage = (\r\n    url: string,\r\n    to: string,\r\n    chatType: ChatType,\r\n    callback: SendImageCallback\r\n  ) => {\r\n    const msgId = v4();\r\n    const messagePacket = xml(\r\n      \"message\",\r\n      {\r\n        id: msgId,\r\n        type: chatType,\r\n        to: to,\r\n      },\r\n      xml(\"body\", {}, url),\r\n      xml(\"request\", { xmlns: \"urn:xmpp:receipts\" }),\r\n      xml(\"x\", { xmlns: \"jabber:x:oob\" }, xml(\"url\", {}, url))\r\n    );\r\n    if (this.client) {\r\n      callback({ url, msgId });\r\n      this.client.send(messagePacket);\r\n    }\r\n  };\r\n\r\n  sendFileFirstStep = (fileId: string) => {\r\n    const uploadJid = this.discoItems.get(\"upload\");\r\n    if (uploadJid) {\r\n      this.sendServiceDiscoveryRequestToUpload(uploadJid, fileId);\r\n      return;\r\n    }\r\n  };\r\n\r\n  sendFileSecondStep = (stanza: any) => {\r\n    if (stanza.children.length > 0) {\r\n      const secondStepId = v4();\r\n      const file = this.filesQueue.get(stanza.attrs.id);\r\n      if (file) {\r\n        this.filesQueue.set(secondStepId, {\r\n          firstStepId: file.firstStepId,\r\n          secondStepId: secondStepId,\r\n          file: file.file,\r\n          to: file.to,\r\n          chatType: file.chatType,\r\n          callback: file.callback,\r\n        });\r\n        this.filesQueue.delete(stanza.attrs.id);\r\n      }\r\n      console.log(\r\n        \"upload request xmlns\",\r\n        stanza.children[0].children[2].attrs.var\r\n      );\r\n      this.sendRequestSlotOnUpload(stanza.attrs.from, secondStepId);\r\n    }\r\n  };\r\n\r\n  sendFileThirdStep = (stanza: any, file: SendingFile) => {\r\n    let getUrl = \"\";\r\n    let putUrl = \"\";\r\n    stanza.children[0].children.forEach((element: any) => {\r\n      if (element.is(\"get\")) {\r\n        getUrl = element.attrs.url;\r\n      } else if (element.is(\"put\")) {\r\n        putUrl = element.attrs.url;\r\n      }\r\n    });\r\n    if (file?.secondStepId) this.uploadFile(putUrl, getUrl, file.secondStepId);\r\n  };\r\n\r\n  sendServiceDiscoveryRequest = (fileId: string) => {\r\n    const serviceDiscoveryRequest = xml(\r\n      \"iq\",\r\n      {\r\n        type: \"get\",\r\n        to: this.getDomain(),\r\n        id: fileId,\r\n      },\r\n      xml(\"query\", { xmlns: \"http://jabber.org/protocol/disco#items\" })\r\n    );\r\n    if (this.client) {\r\n      this.client.send(serviceDiscoveryRequest);\r\n    }\r\n  };\r\n\r\n  sendServiceDiscoveryRequestToUpload = (\r\n    uploadJid: string,\r\n    uploadId: string\r\n  ) => {\r\n    console.log(\"sendServiceDiscoveryRequestToUpload\", uploadJid);\r\n    const serviceDiscoveryRequest = xml(\r\n      \"iq\",\r\n      {\r\n        type: \"get\",\r\n        to: uploadJid,\r\n        id: uploadId,\r\n      },\r\n      xml(\"query\", { xmlns: \"http://jabber.org/protocol/disco#info\" })\r\n    );\r\n    if (this.client) {\r\n      this.client.send(serviceDiscoveryRequest);\r\n    }\r\n  };\r\n\r\n  sendRequestSlotOnUpload = (uploadJid: string, thirdStepId: string) => {\r\n    console.log(\"sendRequestSlotOnUpload\", uploadJid);\r\n    const file = this.filesQueue.get(thirdStepId)?.file;\r\n    const serviceDiscoveryRequest = xml(\r\n      \"iq\",\r\n      {\r\n        type: \"get\",\r\n        to: uploadJid,\r\n        id: thirdStepId,\r\n      },\r\n      xml(\"request\", {\r\n        xmlns: \"urn:xmpp:http:upload:0\",\r\n        filename: file?.name,\r\n        size: file?.size,\r\n        \"content-type\": file?.type,\r\n      })\r\n    );\r\n    if (this.client) {\r\n      this.client.send(serviceDiscoveryRequest);\r\n    }\r\n  };\r\n\r\n  uploadFile = (putUrl: string, getUrl: string, id: string) => {\r\n    let xhr = new XMLHttpRequest();\r\n    const file = this.filesQueue.get(id);\r\n    if (file) {\r\n      xhr.onerror = () => {\r\n        if (xhr.responseText) {\r\n          file.callback(xhr.responseText, true);\r\n          console.log(\"upload error\");\r\n        }\r\n      };\r\n      xhr.onreadystatechange = (e) => {\r\n        if (xhr.readyState === XMLHttpRequest.DONE) {\r\n          console.log(\"file upload response\", e, xhr.status);\r\n          if (xhr.status === 200 || xhr.status === 201) {\r\n            console.log(\"file upload response success\");\r\n            this.sendImageMessage(\r\n              getUrl,\r\n              file.to,\r\n              file.chatType,\r\n              file?.callback\r\n            );\r\n            this.filesQueue.delete(id);\r\n          }\r\n        }\r\n      };\r\n      xhr.upload.addEventListener(\r\n        \"progress\",\r\n        (evt) => {\r\n          console.log(\"progress\", evt);\r\n          // if (file) file.file.size = evt.total\r\n        },\r\n        false\r\n      );\r\n      xhr.open(\"PUT\", putUrl, true);\r\n      xhr.setRequestHeader(\"Content-Type\", file.file.type);\r\n\r\n      xhr.send(file.file);\r\n\r\n      console.log(\"URL\", putUrl);\r\n      console.log(\"fileSize\", file.file.size);\r\n    }\r\n  };\r\n  sendReceipts = (stanza: any) => {\r\n    const message = xml(\r\n      \"message\",\r\n      {\r\n        from: stanza.attrs.to,\r\n        id: v4(),\r\n        to: stanza.attrs.from.split(\"/\")[0],\r\n      },\r\n      xml(\"received\", { xmlns: \"urn:xmpp:receipts\", id: stanza.attrs.id })\r\n    );\r\n    console.log(message);\r\n    this.client.send(message);\r\n  };\r\n  sendTyping = (to: string) => {\r\n    const composing = xml(\r\n      \"message\",\r\n      {\r\n        id: v4(),\r\n        to: to,\r\n        type: \"chat\",\r\n      },\r\n      xml(\"composing\", {\r\n        xmlns: \"http://jabber.org/protocol/chatstates\",\r\n      })\r\n    );\r\n    this.client.send(composing);\r\n  };\r\n  sendActive = (to: string) => {\r\n    const active = xml(\r\n      \"message\",\r\n      {\r\n        id: v4(),\r\n        to: to,\r\n        type: \"chat\",\r\n      },\r\n      xml(\"active\", {\r\n        xmlns: \"http://jabber.org/protocol/chatstates\",\r\n      })\r\n    );\r\n    this.client.send(active);\r\n  };\r\n  replyMsg = (\r\n    to: string,\r\n    chatType: string,\r\n    message: string,\r\n    replyed_sender: string,\r\n    replyed_msg: string,\r\n    replyed_msg_id: string,\r\n    cb: SendMessageCallback\r\n  ) => {\r\n    const id = v4();\r\n    const reply = xml(\r\n      \"message\",\r\n      { to: to, id, type: chatType },\r\n      xml(\"body\", {}, message),\r\n      xml(\r\n        \"extraParams\",\r\n        {},\r\n        xml(\"reply_to\", {}, replyed_sender),\r\n        xml(\"reply_msg\", {}, replyed_msg),\r\n        xml(\"reply_msg_id\", {}, replyed_msg_id)\r\n      )\r\n    );\r\n    this.client.send(reply).then(() => {\r\n      cb(id);\r\n    });\r\n  };\r\n  /* \r\n  unMarkRoomEvent = (\r\n    to: string,\r\n    eventBody: string | undefined = undefined,\r\n    cb: SendMessageCallback\r\n  ) => {\r\n    const id = v4();\r\n    const stanza = xml(\r\n      \"message\",\r\n      { to, type: \"groupchat\", id },\r\n      xml(\"body\", {}),\r\n      xml(\"subject\", {}, \"KEY_ROOM_GENERAL\"),\r\n      xml(\r\n        \"extraParams\",\r\n        { xmlns: \"jabber:client\" },\r\n        xml(\"key_room_event\", {}, \"9\"),\r\n        eventBody ? xml(\"key_room_event_body\", {}, eventBody) : undefined\r\n      )\r\n    );\r\n    this.client.send(stanza).then(() => {\r\n      cb(id);\r\n    });\r\n  };*/\r\n\r\n  sendEvent = (\r\n    to: string,\r\n    eventBody: string | undefined = undefined, //jid from user\r\n    nbr: string | undefined = undefined,\r\n    cb: SendMessageCallback = () => {}\r\n  ) => {\r\n    const id = v4();\r\n    const stanza = xml(\r\n      \"message\",\r\n      { to, type: \"groupchat\", id },\r\n      xml(\"subject\", {}, \"KEY_ROOM_GENERAL\"),\r\n      xml(\"body\", {}),\r\n      xml(\r\n        \"extraParams\",\r\n        { xmlns: \"jabber:client\" },\r\n        xml(\"key_room_event\", {}, nbr),\r\n        eventBody ? xml(\"key_room_event_body\", {}, eventBody) : undefined\r\n      )\r\n    );\r\n    this.client.send(stanza).then(() => {\r\n      cb(id);\r\n    });\r\n  };\r\n\r\n  joinRoomEvent = (\r\n    to: string,\r\n    eventBody: string | undefined, //jid of user who was added -> I ADDED\r\n    from: string,\r\n    cb: SendMessageCallback = () => {}\r\n  ) => {\r\n    const id = v4();\r\n    const stanza = xml(\r\n      \"message\",\r\n      { to, from, type: \"groupchat\", id }, //from - UNNECESSARY?\r\n      xml(\r\n        \"extraParams\",\r\n        {},\r\n        xml(\"key_room_event\", {}, \"2\"),\r\n        eventBody ? xml(\"key_room_event_body\", {}, eventBody) : undefined\r\n      ),\r\n      xml(\"body\", {}),\r\n      xml(\"subject\", {}, \"KEY_ROOM_GENERAL\")\r\n    );\r\n    this.client.send(stanza).then(() => {\r\n      cb(id);\r\n    });\r\n  };\r\n\r\n  /*\r\n  leaveRoomEvent = (\r\n    to: string,\r\n    from: string,\r\n    cb: SendMessageCallback\r\n  ) => {\r\n    const id = v4();\r\n    const stanza = xml(\r\n      \"message\", {\r\n        to, from, type: \"groupchat\", id\r\n      },\r\n      xml(\"extraParams\", {},\r\n        xml(\"key_room_event\", {}, \"3\")\r\n      ),\r\n      xml(\"body\", {}),\r\n      xml(\"subject\", {}, \"KEY_ROOM_GENERAL\"),\r\n    )\r\n    this.client.send(stanza).then(() => {\r\n      cb(id);\r\n    });\r\n  };\r\n */\r\n  forwardMsg = (\r\n    to: string,\r\n    chatType: ChatType,\r\n    forwarded_msg_sender: string,\r\n    forwarded_msg: string,\r\n    forwarded_msg_id: string,\r\n    callback: SendMessageCallback\r\n  ) => {\r\n    const id = v4();\r\n    const forward = xml(\r\n      \"message\",\r\n      { to: to, id, type: chatType },\r\n      xml(\"body\", {}, forwarded_msg),\r\n      xml(\r\n        \"extraParams\",\r\n        {},\r\n        xml(\"reply_to\", {}, forwarded_msg_sender),\r\n        xml(\"reply_msg_id\", {}, forwarded_msg_id)\r\n      ),\r\n      xml(\"request\", { xmlns: \"urn:xmpp:receipts\" })\r\n    );\r\n    this.client.send(forward).then(() => {\r\n      callback(id);\r\n    });\r\n  };\r\n  joinRoom = (to: string) => {\r\n    const joinStanza = xml(\r\n      \"presence\",\r\n      {\r\n        to: `${to}/${this.username}`,\r\n        from: `${this.getJid()}/${this.resource}`,\r\n      },\r\n      xml(\r\n        \"x\",\r\n        { xmlns: \"http://jabber.org/protocol/muc\" },\r\n        xml(\"history\", { maxstanzas: \"0\" })\r\n      )\r\n    );\r\n    this.client.send(joinStanza);\r\n  };\r\n}\r\n"]},"metadata":{},"sourceType":"module"}