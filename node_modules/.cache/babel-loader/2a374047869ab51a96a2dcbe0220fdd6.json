{"ast":null,"code":"import React, { useEffect } from \"react\";\nimport { SquadCommunicator as SquadService } from \"./SquadCommunicatorService\";\nimport { useChat } from \"../contexts/ChatContext\";\nimport { useAuth } from \"../contexts/AuthContext\";\nimport { Events } from \"./chat/types/types\";\nimport ChatType from \"./../enuns/ChatType\";\nimport DeliverStatus from \"../enuns/DeliverStatus\";\nimport { ChatType as XMPPChatType } from \"./chat/types/types\";\nimport { getFileName, getUrlBooleans, isUrl } from \"./utils/parseUtils\";\nimport ReadStatus from \"../enuns/ReadStatus\";\nimport { useGroup } from \"../contexts/GroupContext\";\nimport { useContact } from \"../contexts/ContactContext\";\nimport { useModal } from \"../contexts/ModalContext\";\nimport { Events as VoiceEvents } from \"./voice/types\";\nimport { useCall } from \"../contexts/CallContext\";\nimport CallStatus from \"../enuns/CallStatus\"; //import { callbackify } from \"util\";\n// import IContact from \"../alias/IContact\";\n//Comentar para Evitar Warnings no console\n\nlet squadService;\nlet typingTimeout = new Map();\n\nconst SquadCommunicator = ({\n  children\n}) => {\n  var _squadService49;\n\n  const {\n    chats,\n    setChats,\n    activeChat,\n    replyMsg,\n    setReplyMsg,\n    setActiveChat,\n    forwardMessageList,\n    setForwardMessageList,\n    setShowChat\n  } = useChat();\n  const {\n    contactsSearch,\n    setContactsSearched,\n    newFavorite,\n    setNewFavorite,\n    contacts,\n    setContacts,\n    setContactsOutsideUserContacts,\n    toggleAddingContacts,\n    setToggleAddingContacts,\n    checkedContacts,\n    setCheckedContacts,\n    removedContact,\n    setRemovedContact,\n    checkedMembers,\n    groupToInsertMember,\n    setGroupToInsertMember,\n    clickedContact,\n    setClickedContact\n  } = useContact();\n  const {\n    user,\n    setUser,\n    changedUserData,\n    changedUserPassword,\n    setChangedUserPassword\n  } = useAuth();\n  const {\n    showModalForwardMessageTo,\n    setShowModalForwardMessageTo,\n    showModalAddContact\n  } = useModal();\n  const {\n    currentCall,\n    setCurrentCall,\n    callNumber,\n    setCallNumber,\n    endCall,\n    setEndCall\n  } = useCall();\n  const {\n    setGroups,\n    groups,\n    memberQuit,\n    groupIdOfLeaveRequest,\n    setGroupIdOfLeaveRequest,\n    setMemberQuit,\n    groupToRemoveContact,\n    setGroupToRemoveContact,\n    removedMember,\n    setRemovedMember,\n    toggleMemberRole,\n    setToggleMemberRole,\n    changeGroupData,\n    setChangeGroupData,\n    groupToCreate,\n    setGroupToCreate\n  } = useGroup();\n\n  const init = () => {\n    var _squadService;\n\n    localStorage.setItem(\"authorization\", JSON.stringify({\n      access_token: \"b4c1fa651399a3eb63aee51777d3d508\",\n      user_id: \"11d3a709-8c53-0392-0149-3a3a0e0eeaae\",\n      email: \"romero2@digivox.com.br\",\n      user_name: \"ZZ Romero 2\",\n      expires_in: 2592000,\n      baseUrl: \"https://app.citrussquad.com/api/v1/\"\n    }));\n    squadService = SquadService.getInstance(chatCommunicatorSubscribe, voiceCommuncatorSubscribe);\n    (_squadService = squadService) === null || _squadService === void 0 ? void 0 : _squadService.user.get(user => {\n      setUser(user);\n    });\n  };\n\n  const clearSendFile = (chatId, messageId) => {\n    setChats(chats.map(chat => {\n      if (chat.id === chatId) {\n        chat.messages = chat.messages.map(message => {\n          if (message.id === messageId) {\n            message.deliverStatus = DeliverStatus.QUEUED;\n            message.sendFile = undefined;\n          }\n\n          return message;\n        });\n      }\n\n      return chat;\n    }));\n  };\n\n  const onChatsChange = () => {// chats.forEach((chat) => {\n    // });\n  };\n\n  const onActiveChatChange = () => {\n    checkSendMessage(activeChat);\n    checkAttachedFiles(activeChat);\n    checkNewContact(activeChat); // checkTyping(activeChat)\n  }; // const checkTyping = (chat: IChat) => {\n  //   const oldTimeoutData = typingTimeout.get(chat.jid)\n  //   if (chat.inputMessage !== \"\" && (!oldTimeoutData || (oldTimeoutData.msgStr !== chat.inputMessage))) {\n  //     if (oldTimeoutData)\n  //       clearTimeout(oldTimeoutData.timeout)\n  //     else\n  //       squadService?.chat?.chat.sendTyping(chat.jid)\n  //     const timeoutData = {\n  //       timeout: setTimeout(() => { squadService?.chat?.chat.sendActive(chat.jid); typingTimeout.delete(chat.jid) }, 3000),\n  //       msgStr: `${chat.inputMessage}`\n  //     }\n  //     typingTimeout.set(chat.jid, timeoutData)\n  //   }\n  // }\n\n\n  const checkNewContact = cht => {\n    if (!cht.added) {\n      var _squadService2;\n\n      (_squadService2 = squadService) === null || _squadService2 === void 0 ? void 0 : _squadService2.contacts.add(cht, success => {\n        if (success) {\n          var _squadService3;\n\n          setChats(chats.map(chat => {\n            if (chat.jid === cht.jid) {\n              chat.added = true;\n            }\n\n            if (activeChat.jid === chat.jid) setActiveChat(chat);\n            return chat;\n          }));\n          (_squadService3 = squadService) === null || _squadService3 === void 0 ? void 0 : _squadService3.contacts.list(ctcs => {\n            setContacts(ctcs);\n          });\n        }\n      });\n    }\n  };\n\n  const checkAttachedFiles = cht => {\n    if (cht.attachedFileList && !cht.attachedFileList[0]) {\n      var _squadService4;\n\n      (_squadService4 = squadService) === null || _squadService4 === void 0 ? void 0 : _squadService4.attachments.list(cht, attachments => {\n        if (attachments.length > 0) setActiveChat({ ...cht,\n          attachedFileList: attachments\n        });else setActiveChat({ ...cht,\n          attachedFileList: null\n        });\n      });\n    }\n  };\n  /* getMessageUserProfilePicture = (msg: Message | FileMessage) => {\r\n    if (msg.from.includes(\"@conference.\")) {\r\n      const groups = this.groups.getGroups();\r\n      const group = groups.get(msg.from.split(\"@\")[0]);\r\n      const member = group?.members.filter(\r\n        (member) => member.userId === msg.from.split(\"/\")[1]\r\n      )[0];\r\n      return member?.profilePicture;\r\n    } else {\r\n      return this.contacts.getContacts().get(msg.from.split(\"@\")[0])\r\n        ?.profilePicture;\r\n    }\r\n  }; */\n\n\n  const checkSearchMessages = () => {\n    if (activeChat.messageLoaded) {\n      var _squadService5;\n\n      (_squadService5 = squadService) === null || _squadService5 === void 0 ? void 0 : _squadService5.messages.list(activeChat, messages => {\n        if (messages.length) {\n          setChats(chats.map(cht => {\n            if (cht.id === activeChat.id) {\n              messages.forEach(msg => {\n                if (!activeChat.messages.find(m => m.id === msg.id)) cht.messages.unshift(msg);\n              });\n              cht.messageLoaded = false;\n              setActiveChat(cht);\n            }\n\n            return cht;\n          }));\n        } else {\n          const chat = { ...activeChat,\n            messageLoaded: false\n          };\n          setActiveChat(chat);\n        }\n      });\n    }\n  };\n\n  const checkSendMessage = chat => {\n    chat.messages.forEach(msg => {\n      if (msg.deliverStatus === DeliverStatus.SENDING) {\n        if (msg.sendFile && !replyMsg) {\n          var _squadService6, _squadService6$chat;\n\n          const files = [msg.sendFile];\n          clearSendFile(chat.id, msg.id);\n          (_squadService6 = squadService) === null || _squadService6 === void 0 ? void 0 : (_squadService6$chat = _squadService6.chat) === null || _squadService6$chat === void 0 ? void 0 : _squadService6$chat.sendFiles(chat, files, data => {\n            updateMessageFiles(data, chat, msg);\n          });\n        } else {\n          if (!msg.isForwardMessage && !replyMsg) {\n            sendMessage(chat, msg.message, msgId => updateMessage(msgId, chat, msg));\n          } else if (replyMsg) {\n            var _squadService7, _squadService7$chat;\n\n            const replyMsgCopy = { ...replyMsg\n            };\n            setReplyMsg(undefined);\n            (_squadService7 = squadService) === null || _squadService7 === void 0 ? void 0 : (_squadService7$chat = _squadService7.chat) === null || _squadService7$chat === void 0 ? void 0 : _squadService7$chat.replyMsg(chat, msg, replyMsgCopy, msgId => {\n              updateMessage(msgId, chat, msg, replyMsgCopy);\n            });\n          }\n        }\n      }\n    });\n  };\n\n  const updateMessageFiles = (data, chat, msg) => {\n    const newChat = { ...chat\n    };\n    newChat.messages = chat.messages.map(message => {\n      if (msg.id === message.id) {\n        const booleans = getUrlBooleans(data.url);\n        message.id = data.msgId;\n        message.fileUrl = data.url;\n        message.deliverStatus = DeliverStatus.QUEUED;\n        message.time = new Date().toISOString();\n        message.message = getFileName(data.url);\n        message.isFileMessage = booleans.isFileMessage;\n        message.isImageMessage = booleans.isImageMessage;\n        message.isVideoMessage = booleans.isVideoMessage;\n        message.isAudioMessage = booleans.isAudioMessage;\n      }\n\n      return message;\n    });\n    setActiveChat(newChat);\n\n    if (!chats.filter(cht => cht.id === chat.id)[0]) {\n      const newChats = [chat, ...chats];\n      setChats(newChats);\n    } else {\n      const newChats = [];\n      chats.forEach(cht => {\n        if (cht.id === chat.id) {\n          cht.messages = newChat.messages;\n          newChats.unshift(cht);\n        } else {\n          newChats.push(cht);\n        }\n      });\n      setChats(newChats);\n    }\n  };\n\n  const updateMessage = (msgId, chat, msg, replyedMsg = undefined) => {\n    const newChat = { ...chat\n    };\n    newChat.messages = chat.messages.map(message => {\n      if (msg.id === message.id) {\n        message.id = msgId;\n        message.deliverStatus = DeliverStatus.QUEUED;\n        message.time = new Date().toISOString();\n\n        if (replyedMsg) {\n          var _squadService8, _squadService8$contac, _squadService9, _squadService9$user, _squadService9$user$u, _squadService10, _squadService10$user, _squadService10$user$;\n\n          message.isReplyMessage = true;\n          message.replyedMessage = replyedMsg.message || replyedMsg.fileUrl;\n          message.replyedMessageId = replyedMsg.id;\n          message.replyedMessageTo = ((_squadService8 = squadService) === null || _squadService8 === void 0 ? void 0 : (_squadService8$contac = _squadService8.contacts.getContacts().get(replyedMsg.fromUser.split(\"@\")[0])) === null || _squadService8$contac === void 0 ? void 0 : _squadService8$contac.name) || ((_squadService9 = squadService) === null || _squadService9 === void 0 ? void 0 : (_squadService9$user = _squadService9.user) === null || _squadService9$user === void 0 ? void 0 : (_squadService9$user$u = _squadService9$user.user) === null || _squadService9$user$u === void 0 ? void 0 : _squadService9$user$u.id) === replyedMsg.fromUser.split(\"@\")[0] ? (_squadService10 = squadService) === null || _squadService10 === void 0 ? void 0 : (_squadService10$user = _squadService10.user) === null || _squadService10$user === void 0 ? void 0 : (_squadService10$user$ = _squadService10$user.user) === null || _squadService10$user$ === void 0 ? void 0 : _squadService10$user$.name : \"Participant\";\n        }\n\n        if (isUrl(message.message)) {\n          const booleans = getUrlBooleans(message.message);\n          message.isFileMessage = booleans.isFileMessage;\n          message.isImageMessage = booleans.isImageMessage;\n          message.isAudioMessage = booleans.isAudioMessage;\n          message.isVideoMessage = booleans.isVideoMessage;\n          message.fileUrl = message.message;\n        }\n      }\n\n      return message;\n    });\n    if (activeChat.jid === newChat.jid) setActiveChat(newChat);\n\n    if (!chats.filter(cht => cht.id === chat.id)[0]) {\n      const newChats = [chat, ...chats];\n      setChats(newChats);\n    } else {\n      const newChats = [];\n      chats.forEach(cht => {\n        if (cht.id === chat.id) {\n          cht.messages = newChat.messages;\n          newChats.unshift(cht);\n        } else {\n          newChats.push(cht);\n        }\n      });\n      setChats(newChats);\n    }\n  };\n\n  const forwardMessage = () => {\n    if (forwardMessageList && showModalForwardMessageTo) {\n      const ctcs = [...forwardMessageList];\n      const message = { ...showModalForwardMessageTo\n      };\n      setForwardMessageList(undefined);\n      setShowModalForwardMessageTo(undefined);\n      const chatsFinded = [];\n      const oldChats = [...chats.map(chat => {\n        return { ...chat\n        };\n      })];\n      ctcs === null || ctcs === void 0 ? void 0 : ctcs.forEach((ctc, i) => {\n        const cht = oldChats.find(cht => cht.jid === ctc.jid);\n\n        if (cht) {\n          var _squadService11, _squadService11$chat;\n\n          const msg = { ...message,\n            id: `${cht.messages.length + 1}`,\n            userName: user.name,\n            fromUser: user.id,\n            toUser: ctc.jid.split(\"@\")[0],\n            message: message.fileUrl || message.message,\n            deliverStatus: DeliverStatus.QUEUED,\n            isForwardMessage: true\n          };\n          (_squadService11 = squadService) === null || _squadService11 === void 0 ? void 0 : (_squadService11$chat = _squadService11.chat) === null || _squadService11$chat === void 0 ? void 0 : _squadService11$chat.forwardMessage(cht, msg, msgId => {\n            msg.id = msgId;\n            cht.messages.push(msg);\n            chatsFinded.push(cht);\n          });\n        }\n      });\n      const newChats = oldChats.map(chat => chatsFinded.find(cht => cht.id === chat.id) || chat);\n      const ctcsNotInChat = ctcs.filter(ctc => !newChats.find(cht => ctc.jid === cht.jid));\n      ctcsNotInChat.forEach((ctc, i) => {\n        var _squadService12, _squadService12$chat;\n\n        const chat = {\n          id: ctc.jid.split(\"@\")[0],\n          jid: ctc.jid,\n          name: ctc.name,\n          profilePicture: ctc.profilePicture,\n          status: ctc.status || undefined,\n          unRead: 0,\n          chatType: ctc.jid.includes(\"@conference.\") ? ChatType.GROUP : ChatType.USER,\n          inputMessage: \"\",\n          messageLoaded: false,\n          isTyping: false,\n          messages: [],\n          email: ctc.email || undefined,\n          favorite: ctc.favorite,\n          added: ctc.added\n        };\n        const newMessage = { ...message,\n          id: `${1}`,\n          userName: user.name,\n          fromUser: user.id,\n          toUser: ctc.jid.split(\"@\")[0],\n          deliverStatus: DeliverStatus.QUEUED,\n          isForwardMessage: true\n        };\n        (_squadService12 = squadService) === null || _squadService12 === void 0 ? void 0 : (_squadService12$chat = _squadService12.chat) === null || _squadService12$chat === void 0 ? void 0 : _squadService12$chat.forwardMessage(chat, newMessage, msgId => {\n          newMessage.id = msgId;\n          chat.messages.push(newMessage);\n          newChats.unshift(chat);\n        });\n      });\n      setChats(newChats);\n    }\n  };\n\n  const onChangeStatus = () => {\n    var _squadService13, _squadService13$chat;\n\n    if (((_squadService13 = squadService) === null || _squadService13 === void 0 ? void 0 : (_squadService13$chat = _squadService13.chat) === null || _squadService13$chat === void 0 ? void 0 : _squadService13$chat.chat.client.status) === \"online\") {\n      var _squadService14, _squadService14$chat;\n\n      (_squadService14 = squadService) === null || _squadService14 === void 0 ? void 0 : (_squadService14$chat = _squadService14.chat) === null || _squadService14$chat === void 0 ? void 0 : _squadService14$chat.changeStatus(user.status);\n    }\n  };\n\n  const onSearchContacts = () => {\n    if (contactsSearch.length > 2) {\n      var _squadService15;\n\n      (_squadService15 = squadService) === null || _squadService15 === void 0 ? void 0 : _squadService15.contacts.search(contactsSearch, searchList => {\n        setContactsSearched(searchList);\n      });\n    } else {\n      setContactsSearched(undefined);\n    }\n  };\n\n  const onSearchContactsOutsideUserContacts = () => {\n    var _squadService16;\n\n    (_squadService16 = squadService) === null || _squadService16 === void 0 ? void 0 : _squadService16.contacts.getContactsOutsideUserLists(contacts => {\n      if (contacts) {\n        setContactsOutsideUserContacts(contacts);\n      }\n    });\n  };\n\n  const onMakeCall = () => {\n    if (callNumber === null || callNumber === void 0 ? void 0 : callNumber.number) {\n      var _squadService17, _squadService17$sip;\n\n      const constraints = {\n        useAudio: callNumber === null || callNumber === void 0 ? void 0 : callNumber.useAudio,\n        useVideo: callNumber === null || callNumber === void 0 ? void 0 : callNumber.useVideo\n      };\n      (_squadService17 = squadService) === null || _squadService17 === void 0 ? void 0 : (_squadService17$sip = _squadService17.sip) === null || _squadService17$sip === void 0 ? void 0 : _squadService17$sip.makeCall(callNumber === null || callNumber === void 0 ? void 0 : callNumber.number, constraints);\n      setCallNumber(undefined);\n    }\n  };\n\n  const onEndCall = () => {\n    if (currentCall && currentCall.callId && endCall) {\n      var _squadService18, _squadService18$sip, _squadService18$sip$s;\n\n      if ((_squadService18 = squadService) === null || _squadService18 === void 0 ? void 0 : (_squadService18$sip = _squadService18.sip) === null || _squadService18$sip === void 0 ? void 0 : (_squadService18$sip$s = _squadService18$sip.sip) === null || _squadService18$sip$s === void 0 ? void 0 : _squadService18$sip$s.currentCall) {\n        var _squadService19, _squadService20, _squadService20$sip, _squadService20$sip$s;\n\n        (_squadService19 = squadService) === null || _squadService19 === void 0 ? void 0 : _squadService19.sip.sip.endCall((_squadService20 = squadService) === null || _squadService20 === void 0 ? void 0 : (_squadService20$sip = _squadService20.sip) === null || _squadService20$sip === void 0 ? void 0 : (_squadService20$sip$s = _squadService20$sip.sip) === null || _squadService20$sip$s === void 0 ? void 0 : _squadService20$sip$s.currentCall);\n      }\n\n      setEndCall(undefined);\n    }\n  };\n\n  const onRemovingGroupMember = () => {\n    if (removedMember && groupToRemoveContact) {\n      var _squadService21;\n\n      let group = groups.find(grp => grp.groupId === groupToRemoveContact);\n      if (group) (_squadService21 = squadService) === null || _squadService21 === void 0 ? void 0 : _squadService21.groups.removeMember(group.groupId, removedMember, success => {\n        if (success) {\n          var _squadService22;\n\n          (_squadService22 = squadService) === null || _squadService22 === void 0 ? void 0 : _squadService22.groups.list(grps => {\n            grps.map(grp => {\n              grp.members = grp.members.filter(mb => mb.userId !== removedMember.userId);\n              setGroups(grps);\n              setRemovedMember(undefined);\n              setGroupToRemoveContact(undefined);\n              return grp;\n            });\n          });\n        }\n      });\n    }\n  };\n\n  const onLeavingGroup = () => {\n    if (memberQuit && groupIdOfLeaveRequest) {\n      var _squadService23;\n\n      (_squadService23 = squadService) === null || _squadService23 === void 0 ? void 0 : _squadService23.groups.leftingGroup({\n        groupId: groupIdOfLeaveRequest,\n        memberId: memberQuit.userId\n      }, success => {\n        if (success) {\n          setChats(chats.filter(cht => cht.groupId !== groupIdOfLeaveRequest));\n          setGroups(groups.filter(grp => grp.groupId !== groupIdOfLeaveRequest));\n\n          if (activeChat.groupId === groupIdOfLeaveRequest) {\n            setShowChat(false);\n          }\n\n          setMemberQuit(undefined);\n          setGroupIdOfLeaveRequest(\"\");\n        }\n\n        ;\n      });\n    }\n\n    ;\n  };\n\n  const onAddingMembers = () => {\n    let asynchronousFlag = 0;\n\n    if (checkedMembers && groupToInsertMember) {\n      checkedMembers.forEach(ctt => {\n        var _squadService24;\n\n        (_squadService24 = squadService) === null || _squadService24 === void 0 ? void 0 : _squadService24.groups.addMember(groupToInsertMember, ctt, success => {\n          if (success) {\n            asynchronousFlag++;\n\n            if (checkedMembers.length === asynchronousFlag) {\n              var _squadService25;\n\n              (_squadService25 = squadService) === null || _squadService25 === void 0 ? void 0 : _squadService25.groups.list(grps => {\n                setGroups(grps);\n                setChats(chats.map(cht => {\n                  if (cht.groupId === groupToInsertMember.groupId) {\n                    let foundedGroup = grps.find(grp => grp.groupId === cht.groupId);\n                    cht.members = foundedGroup === null || foundedGroup === void 0 ? void 0 : foundedGroup.members;\n\n                    if (activeChat.groupId === cht.groupId) {\n                      activeChat.members = foundedGroup === null || foundedGroup === void 0 ? void 0 : foundedGroup.members;\n                      setActiveChat(activeChat);\n                    }\n                  }\n\n                  return cht;\n                }));\n              });\n              setCheckedContacts([]);\n              setToggleAddingContacts(false);\n              setGroupToInsertMember(undefined);\n            }\n          }\n        });\n      });\n    }\n  };\n\n  const onAddingContacts = () => {\n    let asynchronousFlag = 0;\n\n    if (checkedContacts && toggleAddingContacts) {\n      checkedContacts.forEach(ctt => {\n        if (!ctt.added) {\n          var _squadService26;\n\n          (_squadService26 = squadService) === null || _squadService26 === void 0 ? void 0 : _squadService26.contacts.addContacts(ctt, success => {\n            if (success) {\n              asynchronousFlag++;\n\n              if (checkedContacts.length === asynchronousFlag) {\n                var _squadService27;\n\n                (_squadService27 = squadService) === null || _squadService27 === void 0 ? void 0 : _squadService27.contacts.list(contacts => {\n                  setContacts(contacts);\n                  setCheckedContacts([]);\n                  setToggleAddingContacts(false);\n                });\n              }\n            }\n          });\n        }\n      });\n    }\n  };\n\n  const onAddingContactOnGroupList = () => {\n    if (clickedContact) {\n      if (!clickedContact.added) {\n        var _squadService28;\n\n        (_squadService28 = squadService) === null || _squadService28 === void 0 ? void 0 : _squadService28.contacts.addContacts(clickedContact, success => {\n          if (success) {\n            var _squadService29;\n\n            (_squadService29 = squadService) === null || _squadService29 === void 0 ? void 0 : _squadService29.contacts.list(contacts => {\n              setContacts(contacts);\n              setClickedContact(undefined);\n            });\n          }\n        });\n      }\n    }\n  };\n\n  const onToggleMemberRole = () => {\n    if (toggleMemberRole) {\n      var _squadService30;\n\n      (_squadService30 = squadService) === null || _squadService30 === void 0 ? void 0 : _squadService30.groups.list(grps => {\n        grps.forEach(gp => {\n          if (gp.groupId === toggleMemberRole.gpId) {\n            gp.members.forEach(mb => {\n              if (mb.userId === toggleMemberRole.mbId) {\n                var _squadService31;\n\n                (_squadService31 = squadService) === null || _squadService31 === void 0 ? void 0 : _squadService31.contacts.toggleMemberRole(toggleMemberRole.mbId, toggleMemberRole.gpId, toggleMemberRole.mbRole, success => {\n                  if (success) {\n                    setToggleMemberRole(undefined);\n                    setChats(chats.map(cht => {\n                      if (cht.groupId === toggleMemberRole.gpId) {\n                        var _cht$members;\n\n                        (_cht$members = cht.members) === null || _cht$members === void 0 ? void 0 : _cht$members.map(mb => {\n                          if (mb.userId === toggleMemberRole.mbId) {\n                            mb.role = toggleMemberRole.mbRole;\n                          }\n\n                          return mb;\n                        });\n                      }\n\n                      return cht;\n                    }));\n                  }\n                });\n              }\n            });\n          }\n        });\n      });\n    }\n  };\n\n  const onChangeGroupData = () => {\n    if (changeGroupData) {\n      var _squadService32;\n\n      (_squadService32 = squadService) === null || _squadService32 === void 0 ? void 0 : _squadService32.groups.list(grps => grps.forEach(gp => {\n        if (gp.groupId === changeGroupData.groupId) {\n          var _squadService33;\n\n          (_squadService33 = squadService) === null || _squadService33 === void 0 ? void 0 : _squadService33.groups.editGroupInfo({\n            groupId: changeGroupData.groupId,\n            groupName: changeGroupData.groupName,\n            members: changeGroupData.members,\n            description: changeGroupData.description\n          }, success => {\n            if (success) {\n              setGroups(groups);\n              setChangeGroupData(undefined);\n            }\n          });\n        }\n      }));\n    }\n  };\n\n  const createGroup = () => {\n    var _squadService34;\n\n    (_squadService34 = squadService) === null || _squadService34 === void 0 ? void 0 : _squadService34.groups.create(groupToCreate, parsedGroup => {\n      if (parsedGroup) {\n        var _squadService35;\n\n        (_squadService35 = squadService) === null || _squadService35 === void 0 ? void 0 : _squadService35.groups.list(groups => {\n          setGroups(groups);\n          setGroupToCreate(undefined);\n        });\n      }\n    });\n  };\n\n  useEffect(onChatsChange, [chats]);\n  useEffect(onNewFavorite, [newFavorite]);\n  useEffect(checkSearchMessages, [activeChat.messageLoaded]);\n  useEffect(onActiveChatChange, [activeChat]);\n  useEffect(onUserDataChange, [changedUserData]);\n  useEffect(onUserPasswordChange, [changedUserPassword]);\n  useEffect(onChangeStatus, [user.status]);\n  useEffect(forwardMessage, [forwardMessageList]);\n  useEffect(onSearchContacts, [contactsSearch]);\n  useEffect(onSearchContactsOutsideUserContacts, [showModalAddContact]);\n  useEffect(onAddingContacts, [toggleAddingContacts]);\n  useEffect(onMakeCall, [callNumber]);\n  useEffect(onEndCall, [endCall]);\n  useEffect(onRemovingGroupMember, [removedMember, groupToRemoveContact]);\n  useEffect(onLeavingGroup, [memberQuit, groupIdOfLeaveRequest]);\n  useEffect(onRemovingContact, [removedContact]);\n  useEffect(onAddingMembers, [groupToInsertMember, checkedMembers]);\n  useEffect(onToggleMemberRole, [toggleMemberRole]);\n  useEffect(onChangeGroupData, [changeGroupData]);\n  useEffect(onAddingContactOnGroupList, [clickedContact]);\n  useEffect(createGroup, [groupToCreate]);\n\n  function onRemovingContact() {\n    if (removedContact) {\n      contacts.forEach(ctc => {\n        if (ctc.id === removedContact.id) {\n          var _squadService36;\n\n          if (ctc.added) (_squadService36 = squadService) === null || _squadService36 === void 0 ? void 0 : _squadService36.contacts.remove(ctc, success => {\n            if (success) {\n              var _squadService37;\n\n              (_squadService37 = squadService) === null || _squadService37 === void 0 ? void 0 : _squadService37.contacts.list(ctcs => {\n                setContacts(ctcs);\n                setRemovedContact(undefined);\n              });\n            }\n          });\n        }\n      });\n    }\n  }\n\n  function onUserPasswordChange() {\n    if (changedUserPassword) {\n      var _squadService38;\n\n      (_squadService38 = squadService) === null || _squadService38 === void 0 ? void 0 : _squadService38.user.changePassword(changedUserPassword, password => {\n        if (password) {\n          setChangedUserPassword({\n            oldPassword: \"\",\n            newPassword: \"\"\n          });\n        }\n      });\n    }\n  }\n\n  function onUserDataChange() {\n    if (changedUserData) {\n      var _squadService39;\n\n      (_squadService39 = squadService) === null || _squadService39 === void 0 ? void 0 : _squadService39.user.changeUserData(changedUserData, chgd => {\n        if (chgd) {\n          setUser({ ...user,\n            email: changedUserData.email,\n            name: changedUserData.name\n          });\n        }\n      });\n    }\n  }\n\n  function onNewFavorite() {\n    if (newFavorite) {\n      var _squadService40;\n\n      const newFavoriteLoad = { ...newFavorite\n      };\n      (_squadService40 = squadService) === null || _squadService40 === void 0 ? void 0 : _squadService40.contacts.setFavorite(newFavorite, favorite => {\n        if (favorite) {\n          setChats(chats.map(cht => {\n            if (cht.jid === newFavoriteLoad.jid) {\n              cht.favorite = !newFavoriteLoad.favorite;\n            }\n\n            return cht;\n          }));\n          setGroups(groups.map(grp => {\n            if (grp.jid === newFavoriteLoad.jid) {\n              return { ...grp,\n                favorite: !newFavoriteLoad.favorite\n              };\n            }\n\n            return grp;\n          }));\n          setContacts(contacts.map(ctt => {\n            if (ctt.jid === newFavoriteLoad.jid) {\n              return { ...ctt,\n                favorite: !newFavoriteLoad.favorite\n              };\n            }\n\n            return ctt;\n          }));\n        }\n      });\n      setNewFavorite(undefined);\n    }\n  }\n\n  function voiceCommuncatorSubscribe(event, data) {\n    var _invitation$remoteIde, _invitation$remoteIde2, _ref, _ref2, _inviter$remoteIdenti, _inviter$remoteIdenti2, _ref3, _ref4;\n\n    switch (event) {\n      case VoiceEvents.CONNECTED:\n        // squadService?.sip.sip.invite(\"2045\");\n        console.log(\"connected\");\n        break;\n\n      case VoiceEvents.RECEIVED_CALL:\n        const invitation = data;\n        const invitation_caller_id_number = (_invitation$remoteIde = invitation.remoteIdentity.uri.aor) === null || _invitation$remoteIde === void 0 ? void 0 : (_invitation$remoteIde2 = _invitation$remoteIde.split(\"@\")[0]) === null || _invitation$remoteIde2 === void 0 ? void 0 : _invitation$remoteIde2.replace(\"sip:\", \"\");\n        const invitation_ctct_of_number = contacts.find(ctc => ctc.number === invitation_caller_id_number) || groups.find(grp => grp.groupId === inviter_caller_id_number);\n\n        const acceptCall = (useVideo = false) => {\n          var _squadService41, _squadService42;\n\n          (_squadService41 = squadService) === null || _squadService41 === void 0 ? void 0 : _squadService41.sip.updateConstraintsParams({\n            useVideo\n          });\n          invitation.accept({\n            sessionDescriptionHandlerOptions: {\n              constraints: (_squadService42 = squadService) === null || _squadService42 === void 0 ? void 0 : _squadService42.sip.getConstraints()\n            }\n          });\n        };\n\n        const rejectCall = () => {\n          invitation.reject();\n        };\n\n        const receivedCall = {\n          callId: invitation.id,\n          callStatus: CallStatus.RINGING,\n          callerNumber: invitation_caller_id_number,\n          callerObject: invitation_ctct_of_number,\n          callerId: ((_ref = invitation_ctct_of_number) === null || _ref === void 0 ? void 0 : _ref.id) || ((_ref2 = invitation_ctct_of_number) === null || _ref2 === void 0 ? void 0 : _ref2.groupId),\n          callerName: invitation_ctct_of_number === null || invitation_ctct_of_number === void 0 ? void 0 : invitation_ctct_of_number.name,\n          callerProfilePicture: invitation_ctct_of_number === null || invitation_ctct_of_number === void 0 ? void 0 : invitation_ctct_of_number.profilePicture,\n          session: invitation,\n          accept: acceptCall,\n          reject: rejectCall\n        };\n        setCurrentCall(receivedCall);\n        break;\n\n      case VoiceEvents.MAKE_CALL:\n        const inviter = data;\n        const inviter_caller_id_number = (_inviter$remoteIdenti = inviter.remoteIdentity.uri.aor) === null || _inviter$remoteIdenti === void 0 ? void 0 : (_inviter$remoteIdenti2 = _inviter$remoteIdenti.split(\"@\")[0]) === null || _inviter$remoteIdenti2 === void 0 ? void 0 : _inviter$remoteIdenti2.replace(\"sip:\", \"\");\n        const inviter_ctct_of_number = contacts.find(ctc => ctc.number === inviter_caller_id_number) || groups.find(grp => grp.groupId === inviter_caller_id_number);\n\n        const cancel = () => {\n          var _squadService43;\n\n          (_squadService43 = squadService) === null || _squadService43 === void 0 ? void 0 : _squadService43.sip.sip.endCall(inviter);\n        };\n\n        const sendCall = {\n          callId: inviter.id,\n          callStatus: CallStatus.CALLING,\n          callerNumber: inviter_caller_id_number,\n          callerObject: inviter_ctct_of_number,\n          callerId: ((_ref3 = inviter_ctct_of_number) === null || _ref3 === void 0 ? void 0 : _ref3.id) || ((_ref4 = inviter_ctct_of_number) === null || _ref4 === void 0 ? void 0 : _ref4.groupId),\n          callerName: inviter_ctct_of_number === null || inviter_ctct_of_number === void 0 ? void 0 : inviter_ctct_of_number.name,\n          callerProfilePicture: inviter_ctct_of_number === null || inviter_ctct_of_number === void 0 ? void 0 : inviter_ctct_of_number.profilePicture,\n          session: inviter,\n          cancel\n        };\n        setCurrentCall(sendCall);\n        console.log(\"make_call\");\n        break;\n\n      case VoiceEvents.CALL_ON_GOING:\n        const callOnGoing = currentCall;\n\n        if (callOnGoing) {\n          callOnGoing.callStatus = CallStatus.ON_GOING;\n          console.log(data);\n          setCurrentCall(callOnGoing);\n        }\n\n        console.log(\"call_on_going\");\n        break;\n\n      case VoiceEvents.CALL_HANGUP:\n        if (currentCall) {\n          setCurrentCall(undefined);\n        }\n\n        break;\n\n      default:\n        console.log(event);\n        break;\n    }\n  }\n\n  function chatCommunicatorSubscribe(event, data) {\n    var _squadService44;\n\n    switch (event) {\n      case Events.ONLINE:\n        (_squadService44 = squadService) === null || _squadService44 === void 0 ? void 0 : _squadService44.chats.list(receivedChats => {\n          var _squadService45, _squadService47;\n\n          const chats = [];\n          receivedChats.forEach(cht => {\n            if (!chats.find(chat => chat.id === cht.id)) {\n              chats.push(cht);\n            }\n          });\n          setChats(chats); //populating groups\n\n          (_squadService45 = squadService) === null || _squadService45 === void 0 ? void 0 : _squadService45.groups.list(groups => {\n            var _squadService46, _squadService46$chat;\n\n            setGroups(groups); //Joining Groups Rooms in XMPP\n\n            (_squadService46 = squadService) === null || _squadService46 === void 0 ? void 0 : (_squadService46$chat = _squadService46.chat) === null || _squadService46$chat === void 0 ? void 0 : _squadService46$chat.joinGroups(groups.map(group => group.jid));\n          }); //populating contacts\n\n          (_squadService47 = squadService) === null || _squadService47 === void 0 ? void 0 : _squadService47.contacts.list(contacts => setContacts(contacts)); //populating chat's with messages\n          // receivedChats.forEach((chat) => {\n          //   squadService?.messages.list(chat, (messages) => {\n          //     const chatWithMessages = { ...chat };\n          //     chatWithMessages.messages = chatWithMessages.messages.concat(\n          //       messages\n          //     );\n          //     setChats([\n          //       ...receivedChats.filter((cht) => chat.id !== cht.id),\n          //       chatWithMessages,\n          //     ]);\n          //   });\n          // });\n        });\n        break;\n\n      case Events.MESSAGE:\n        if (data.fromUser === user.jid) break;\n        let find = false;\n        let newChats = [];\n        chats.forEach(chat => {\n          if (data.fromUser.split(\"@\")[0] === chat.jid.split(\"@\")[0] || data.toUser.split(\"@\")[0] === chat.jid.split(\"@\")[0]) {\n            find = true;\n            if (!chat.messages.filter(msg => msg.id === data.id)[0]) chat.messages.push(data);\n\n            if (chat.id === activeChat.id) {\n              let chatTemporary = { ...chat\n              };\n              setActiveChat(chatTemporary);\n            } else {\n              chat.unRead++;\n            }\n\n            newChats.unshift(chat);\n          } else {\n            newChats.push(chat);\n          }\n        });\n\n        if (!find) {\n          var _squadService48;\n\n          let newChat = {};\n          (_squadService48 = squadService) === null || _squadService48 === void 0 ? void 0 : _squadService48.contacts.list(listContacts => {\n            listContacts.forEach(c => {\n              if (c.jid === data.fromUser) {\n                newChat = {\n                  id: c.id,\n                  jid: c.jid,\n                  name: c.name,\n                  profilePicture: c.profilePicture,\n                  status: c.status,\n                  unRead: 1,\n                  chatType: ChatType.USER,\n                  inputMessage: \"\",\n                  isTyping: false,\n                  messages: [],\n                  favorite: c.favorite,\n                  added: c.added\n                };\n                newChat.messages.push(data);\n                newChats.unshift(newChat);\n              }\n            });\n          });\n        }\n\n        setChats(newChats);\n        break;\n\n      case Events.RECEIVED:\n        setChats(chats.map(chat => {\n          if (chat.messages.find(msg => msg.id === data.id)) chat.messages = chat.messages.map(message => {\n            message.deliverStatus = DeliverStatus.DELIVERED;\n            return message;\n          });\n          return chat;\n        }));\n        break;\n\n      case Events.DISPLAYED:\n        setChats(chats.map(chat => {\n          if (chat.messages.find(msg => msg.id === data.id)) chat.messages = chat.messages.map(message => {\n            message.readStatus = ReadStatus.READ;\n            return message;\n          });\n          return chat;\n        }));\n        break;\n\n      case Events.COMPOSING:\n        setChats(chats.map(chat => {\n          if (chat.jid === data) {\n            chat.isTyping = true;\n            if (activeChat.jid === data) setActiveChat(chat);\n            deleteTypingTimeout(chat.jid);\n            setTypingTimeout(chat.jid);\n          }\n\n          return chat;\n        }));\n        break;\n\n      case Events.ACTIVE:\n        setChats(chats.map(chat => {\n          if (chat.jid === data) {\n            chat.isTyping = false;\n\n            if (activeChat.jid === data) {\n              let chatUpdate = { ...chat\n              };\n              setActiveChat(chatUpdate);\n            }\n\n            deleteTypingTimeout(chat.jid);\n          }\n\n          return chat;\n        }));\n        break;\n\n      case Events.PRESENCE:\n        setChats(chats.map(cht => {\n          if (cht.jid === data.from.split(\"/\")[0] && !cht.jid.includes(\"@conference.\")) {\n            cht.status = data.status;\n          }\n\n          return cht;\n        }));\n        setContacts(contacts.map(ctc => {\n          if (ctc.jid === data.from.split(\"/\")[0] && !ctc.jid.includes(\"@conference.\")) {\n            ctc.status = data.status;\n          }\n\n          return ctc;\n        }));\n        break;\n    }\n  }\n\n  const deleteTypingTimeout = jid => {\n    var _typingTimeout$get;\n\n    clearTimeout(((_typingTimeout$get = typingTimeout.get(jid)) === null || _typingTimeout$get === void 0 ? void 0 : _typingTimeout$get.timeout) || setTimeout(() => {}, 1));\n    typingTimeout.delete(jid);\n  };\n\n  const setTypingTimeout = jid => {\n    const timeoutData = {\n      msgStr: \"\",\n      timeout: setTimeout(() => {\n        setChats(chats.map(cht => {\n          if (cht.jid === jid) {\n            cht.isTyping = false;\n            if (activeChat.jid === jid) setActiveChat(cht);\n          }\n\n          return cht;\n        }));\n      }, 20000)\n    };\n    typingTimeout.set(jid, timeoutData);\n  };\n\n  (_squadService49 = squadService) === null || _squadService49 === void 0 ? void 0 : _squadService49.updateSubscribeFunction(chatCommunicatorSubscribe, voiceCommuncatorSubscribe);\n\n  function sendMessage(chat, message, callback) {\n    var _squadService50, _squadService50$chat;\n\n    (_squadService50 = squadService) === null || _squadService50 === void 0 ? void 0 : (_squadService50$chat = _squadService50.chat) === null || _squadService50$chat === void 0 ? void 0 : _squadService50$chat.chat.sendMessage(chat.jid, chat.jid.includes(\"@conference.\") ? XMPPChatType.GROUPCHAT : XMPPChatType.CHAT, message, callback);\n  }\n\n  useEffect(init, []);\n  return /*#__PURE__*/React.createElement(React.Fragment, null, children);\n};\n\nexport default SquadCommunicator;","map":{"version":3,"sources":["C:/Users/Digivox/dev/Digivox/Refatoracao/squad/src/services/SquadCommunicator.tsx"],"names":["React","useEffect","SquadCommunicator","SquadService","useChat","useAuth","Events","ChatType","DeliverStatus","XMPPChatType","getFileName","getUrlBooleans","isUrl","ReadStatus","useGroup","useContact","useModal","VoiceEvents","useCall","CallStatus","squadService","typingTimeout","Map","children","chats","setChats","activeChat","replyMsg","setReplyMsg","setActiveChat","forwardMessageList","setForwardMessageList","setShowChat","contactsSearch","setContactsSearched","newFavorite","setNewFavorite","contacts","setContacts","setContactsOutsideUserContacts","toggleAddingContacts","setToggleAddingContacts","checkedContacts","setCheckedContacts","removedContact","setRemovedContact","checkedMembers","groupToInsertMember","setGroupToInsertMember","clickedContact","setClickedContact","user","setUser","changedUserData","changedUserPassword","setChangedUserPassword","showModalForwardMessageTo","setShowModalForwardMessageTo","showModalAddContact","currentCall","setCurrentCall","callNumber","setCallNumber","endCall","setEndCall","setGroups","groups","memberQuit","groupIdOfLeaveRequest","setGroupIdOfLeaveRequest","setMemberQuit","groupToRemoveContact","setGroupToRemoveContact","removedMember","setRemovedMember","toggleMemberRole","setToggleMemberRole","changeGroupData","setChangeGroupData","groupToCreate","setGroupToCreate","init","localStorage","setItem","JSON","stringify","access_token","user_id","email","user_name","expires_in","baseUrl","getInstance","chatCommunicatorSubscribe","voiceCommuncatorSubscribe","get","clearSendFile","chatId","messageId","map","chat","id","messages","message","deliverStatus","QUEUED","sendFile","undefined","onChatsChange","onActiveChatChange","checkSendMessage","checkAttachedFiles","checkNewContact","cht","added","add","success","jid","list","ctcs","attachedFileList","attachments","length","checkSearchMessages","messageLoaded","forEach","msg","find","m","unshift","SENDING","files","sendFiles","data","updateMessageFiles","isForwardMessage","sendMessage","msgId","updateMessage","replyMsgCopy","newChat","booleans","url","fileUrl","time","Date","toISOString","isFileMessage","isImageMessage","isVideoMessage","isAudioMessage","filter","newChats","push","replyedMsg","isReplyMessage","replyedMessage","replyedMessageId","replyedMessageTo","getContacts","fromUser","split","name","forwardMessage","chatsFinded","oldChats","ctc","i","userName","toUser","ctcsNotInChat","profilePicture","status","unRead","chatType","includes","GROUP","USER","inputMessage","isTyping","favorite","newMessage","onChangeStatus","client","changeStatus","onSearchContacts","search","searchList","onSearchContactsOutsideUserContacts","getContactsOutsideUserLists","onMakeCall","number","constraints","useAudio","useVideo","sip","makeCall","onEndCall","callId","onRemovingGroupMember","group","grp","groupId","removeMember","grps","members","mb","userId","onLeavingGroup","leftingGroup","memberId","onAddingMembers","asynchronousFlag","ctt","addMember","foundedGroup","onAddingContacts","addContacts","onAddingContactOnGroupList","onToggleMemberRole","gp","gpId","mbId","mbRole","role","onChangeGroupData","editGroupInfo","groupName","description","createGroup","create","parsedGroup","onNewFavorite","onUserDataChange","onUserPasswordChange","onRemovingContact","remove","changePassword","password","oldPassword","newPassword","changeUserData","chgd","newFavoriteLoad","setFavorite","event","CONNECTED","console","log","RECEIVED_CALL","invitation","invitation_caller_id_number","remoteIdentity","uri","aor","replace","invitation_ctct_of_number","inviter_caller_id_number","acceptCall","updateConstraintsParams","accept","sessionDescriptionHandlerOptions","getConstraints","rejectCall","reject","receivedCall","callStatus","RINGING","callerNumber","callerObject","callerId","callerName","callerProfilePicture","session","MAKE_CALL","inviter","inviter_ctct_of_number","cancel","sendCall","CALLING","CALL_ON_GOING","callOnGoing","ON_GOING","CALL_HANGUP","ONLINE","receivedChats","joinGroups","MESSAGE","chatTemporary","listContacts","c","RECEIVED","DELIVERED","DISPLAYED","readStatus","READ","COMPOSING","deleteTypingTimeout","setTypingTimeout","ACTIVE","chatUpdate","PRESENCE","from","clearTimeout","timeout","setTimeout","delete","timeoutData","msgStr","set","updateSubscribeFunction","callback","GROUPCHAT","CHAT"],"mappings":"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","sourcesContent":["import React, { useEffect } from \"react\";\r\nimport { SquadCommunicator as SquadService } from \"./SquadCommunicatorService\";\r\nimport { useChat } from \"../contexts/ChatContext\";\r\nimport { useAuth } from \"../contexts/AuthContext\";\r\nimport IUser from \"../alias/IUser\";\r\nimport { Events, SendImageCallbackReturn } from \"./chat/types/types\";\r\nimport ChatType from \"./../enuns/ChatType\";\r\nimport IChat from \"../alias/IChat\";\r\nimport DeliverStatus from \"../enuns/DeliverStatus\";\r\nimport { ChatType as XMPPChatType } from \"./chat/types/types\";\r\nimport { SendMessageCallback } from \"./types\";\r\nimport IMessage from \"../alias/IMessage\";\r\nimport { getFileName, getUrlBooleans, isUrl } from \"./utils/parseUtils\";\r\nimport ReadStatus from \"../enuns/ReadStatus\";\r\nimport { useGroup } from \"../contexts/GroupContext\";\r\nimport { useContact } from \"../contexts/ContactContext\";\r\nimport { useModal } from \"../contexts/ModalContext\";\r\nimport IContact from \"../alias/IContact\";\r\nimport IGroup from \"../alias/IGroup\";\r\nimport { Events as VoiceEvents } from \"./voice/types\";\r\nimport { useCall } from \"../contexts/CallContext\";\r\nimport ICall from \"../alias/ICall\";\r\nimport { Invitation, Inviter } from \"sip.js\";\r\nimport CallStatus from \"../enuns/CallStatus\";\r\n//import { callbackify } from \"util\";\r\n\r\n// import IContact from \"../alias/IContact\";\r\n //Comentar para Evitar Warnings no console\r\n interface CreateGroupCallback {\r\n   (success: boolean): void;\r\n }\r\ninterface TypingTimeoutData {\r\n  timeout: NodeJS.Timeout;\r\n  msgStr: string;\r\n}\r\nlet squadService: SquadService | undefined;\r\nlet typingTimeout: Map<string, TypingTimeoutData> = new Map<\r\n  string,\r\n  TypingTimeoutData\r\n>();\r\n\r\nconst SquadCommunicator: React.FC = ({ children }) => {\r\n  const {\r\n    chats,\r\n    setChats,\r\n    activeChat,\r\n    replyMsg,\r\n    setReplyMsg,\r\n    setActiveChat,\r\n    forwardMessageList,\r\n    setForwardMessageList,\r\n    setShowChat,\r\n  } = useChat();\r\n  const {\r\n    contactsSearch,\r\n    setContactsSearched,\r\n    newFavorite,\r\n    setNewFavorite,\r\n    contacts,\r\n    setContacts,\r\n    setContactsOutsideUserContacts,\r\n    toggleAddingContacts,\r\n    setToggleAddingContacts,\r\n    checkedContacts,\r\n    setCheckedContacts,\r\n    removedContact,\r\n    setRemovedContact,\r\n    checkedMembers,\r\n    groupToInsertMember,\r\n    setGroupToInsertMember,\r\n    clickedContact,\r\n    setClickedContact\r\n  } = useContact();\r\n  const {\r\n    user,\r\n    setUser,\r\n    changedUserData,\r\n    changedUserPassword,\r\n    setChangedUserPassword,\r\n  } = useAuth();\r\n  const {\r\n    showModalForwardMessageTo,\r\n    setShowModalForwardMessageTo,\r\n    showModalAddContact,\r\n  } = useModal();\r\n  const {\r\n    currentCall,\r\n    setCurrentCall,\r\n    callNumber,\r\n    setCallNumber,\r\n    endCall,\r\n    setEndCall,\r\n  } = useCall();\r\n  const {\r\n    setGroups,\r\n    groups,\r\n    memberQuit,\r\n    groupIdOfLeaveRequest,\r\n    setGroupIdOfLeaveRequest,\r\n    setMemberQuit,\r\n    groupToRemoveContact,\r\n    setGroupToRemoveContact,\r\n    removedMember,\r\n    setRemovedMember,\r\n    toggleMemberRole,\r\n    setToggleMemberRole,\r\n    changeGroupData,\r\n    setChangeGroupData,\r\n    groupToCreate,\r\n    setGroupToCreate\r\n  } = useGroup();\r\n\r\n  const init = () => {\r\n    localStorage.setItem(\r\n      \"authorization\",\r\n      JSON.stringify({\r\n        access_token: \"b4c1fa651399a3eb63aee51777d3d508\",\r\n        user_id: \"11d3a709-8c53-0392-0149-3a3a0e0eeaae\",\r\n        email: \"romero2@digivox.com.br\",\r\n        user_name: \"ZZ Romero 2\",\r\n        expires_in: 2592000,\r\n        baseUrl: \"https://app.citrussquad.com/api/v1/\",\r\n      })\r\n    );\r\n    squadService = SquadService.getInstance(\r\n      chatCommunicatorSubscribe,\r\n      voiceCommuncatorSubscribe\r\n    );\r\n    squadService?.user.get((user: IUser) => {\r\n      setUser(user);\r\n    });\r\n  };\r\n\r\n  const clearSendFile = (chatId: string, messageId: string) => {\r\n    setChats(\r\n      chats.map((chat) => {\r\n        if (chat.id === chatId) {\r\n          chat.messages = chat.messages.map((message) => {\r\n            if (message.id === messageId) {\r\n              message.deliverStatus = DeliverStatus.QUEUED;\r\n              message.sendFile = undefined;\r\n            }\r\n            return message;\r\n          });\r\n        }\r\n        return chat;\r\n      })\r\n    );\r\n  };\r\n\r\n  const onChatsChange = () => {\r\n    // chats.forEach((chat) => {\r\n    // });\r\n  };\r\n  const onActiveChatChange = () => {\r\n    checkSendMessage(activeChat);\r\n    checkAttachedFiles(activeChat);\r\n    checkNewContact(activeChat);\r\n    // checkTyping(activeChat)\r\n  };\r\n  // const checkTyping = (chat: IChat) => {\r\n  //   const oldTimeoutData = typingTimeout.get(chat.jid)\r\n  //   if (chat.inputMessage !== \"\" && (!oldTimeoutData || (oldTimeoutData.msgStr !== chat.inputMessage))) {\r\n  //     if (oldTimeoutData)\r\n  //       clearTimeout(oldTimeoutData.timeout)\r\n  //     else\r\n  //       squadService?.chat?.chat.sendTyping(chat.jid)\r\n  //     const timeoutData = {\r\n  //       timeout: setTimeout(() => { squadService?.chat?.chat.sendActive(chat.jid); typingTimeout.delete(chat.jid) }, 3000),\r\n  //       msgStr: `${chat.inputMessage}`\r\n  //     }\r\n  //     typingTimeout.set(chat.jid, timeoutData)\r\n  //   }\r\n  // }\r\n  const checkNewContact = (cht: IChat) => {\r\n    if (!cht.added) {\r\n      squadService?.contacts.add(cht, (success: boolean) => {\r\n        if (success) {\r\n          setChats(\r\n            chats.map((chat) => {\r\n              if (chat.jid === cht.jid) {\r\n                chat.added = true;\r\n              }\r\n              if (activeChat.jid === chat.jid) setActiveChat(chat);\r\n              return chat;\r\n            })\r\n          );\r\n          squadService?.contacts.list((ctcs) => {\r\n            setContacts(ctcs);\r\n          });\r\n        }\r\n      });\r\n    }\r\n  };\r\n\r\n  const checkAttachedFiles = (cht: IChat) => {\r\n    if (cht.attachedFileList && !cht.attachedFileList[0]) {\r\n      squadService?.attachments.list(cht, (attachments) => {\r\n        if (attachments.length > 0)\r\n          setActiveChat({ ...cht, attachedFileList: attachments });\r\n        else setActiveChat({ ...cht, attachedFileList: null });\r\n      });\r\n    }\r\n  };\r\n\r\n  /* getMessageUserProfilePicture = (msg: Message | FileMessage) => {\r\n    if (msg.from.includes(\"@conference.\")) {\r\n      const groups = this.groups.getGroups();\r\n      const group = groups.get(msg.from.split(\"@\")[0]);\r\n      const member = group?.members.filter(\r\n        (member) => member.userId === msg.from.split(\"/\")[1]\r\n      )[0];\r\n      return member?.profilePicture;\r\n    } else {\r\n      return this.contacts.getContacts().get(msg.from.split(\"@\")[0])\r\n        ?.profilePicture;\r\n    }\r\n  }; */\r\n\r\n  const checkSearchMessages = () => {\r\n    if (activeChat.messageLoaded) {\r\n      squadService?.messages.list(activeChat, (messages) => {\r\n        if (messages.length) {\r\n          setChats(\r\n            chats.map((cht) => {\r\n              if (cht.id === activeChat.id) {\r\n                messages.forEach((msg) => {\r\n                  if (!activeChat.messages.find((m) => m.id === msg.id))\r\n                    cht.messages.unshift(msg);\r\n                });\r\n                cht.messageLoaded = false;\r\n                setActiveChat(cht);\r\n              }\r\n              return cht;\r\n            })\r\n          );\r\n        } else {\r\n          const chat = { ...activeChat, messageLoaded: false };\r\n          setActiveChat(chat);\r\n        }\r\n      });\r\n    }\r\n  };\r\n\r\n  const checkSendMessage = (chat: IChat) => {\r\n    chat.messages.forEach((msg) => {\r\n      if (msg.deliverStatus === DeliverStatus.SENDING) {\r\n        if (msg.sendFile && !replyMsg) {\r\n          const files = [msg.sendFile];\r\n          clearSendFile(chat.id, msg.id);\r\n          squadService?.chat?.sendFiles(\r\n            chat,\r\n            files,\r\n            (data: SendImageCallbackReturn) => {\r\n              updateMessageFiles(data, chat, msg);\r\n            }\r\n          );\r\n        } else {\r\n          if (!msg.isForwardMessage && !replyMsg) {\r\n            sendMessage(chat, msg.message, (msgId) =>\r\n              updateMessage(msgId, chat, msg)\r\n            );\r\n          } else if (replyMsg) {\r\n            const replyMsgCopy = { ...replyMsg };\r\n            setReplyMsg(undefined);\r\n            squadService?.chat?.replyMsg(chat, msg, replyMsgCopy, (msgId) => {\r\n              updateMessage(msgId, chat, msg, replyMsgCopy);\r\n            });\r\n          }\r\n        }\r\n      }\r\n    });\r\n  };\r\n  const updateMessageFiles = (\r\n    data: SendImageCallbackReturn,\r\n    chat: IChat,\r\n    msg: IMessage\r\n  ) => {\r\n    const newChat = { ...chat };\r\n    newChat.messages = chat.messages.map((message) => {\r\n      if (msg.id === message.id) {\r\n        const booleans = getUrlBooleans(data.url);\r\n        message.id = data.msgId;\r\n        message.fileUrl = data.url;\r\n        message.deliverStatus = DeliverStatus.QUEUED;\r\n        message.time = new Date().toISOString();\r\n        message.message = getFileName(data.url);\r\n        message.isFileMessage = booleans.isFileMessage;\r\n        message.isImageMessage = booleans.isImageMessage;\r\n        message.isVideoMessage = booleans.isVideoMessage;\r\n        message.isAudioMessage = booleans.isAudioMessage;\r\n      }\r\n      return message;\r\n    });\r\n    setActiveChat(newChat);\r\n    if (!chats.filter((cht) => cht.id === chat.id)[0]) {\r\n      const newChats = [chat, ...chats];\r\n      setChats(newChats);\r\n    } else {\r\n      const newChats: IChat[] = [];\r\n      chats.forEach((cht) => {\r\n        if (cht.id === chat.id) {\r\n          cht.messages = newChat.messages;\r\n          newChats.unshift(cht);\r\n        } else {\r\n          newChats.push(cht);\r\n        }\r\n      });\r\n      setChats(newChats);\r\n    }\r\n  };\r\n  const updateMessage = (\r\n    msgId: string,\r\n    chat: IChat,\r\n    msg: IMessage,\r\n    replyedMsg: IMessage | undefined = undefined\r\n  ) => {\r\n    const newChat = { ...chat };\r\n    newChat.messages = chat.messages.map((message) => {\r\n      if (msg.id === message.id) {\r\n        message.id = msgId;\r\n        message.deliverStatus = DeliverStatus.QUEUED;\r\n        message.time = new Date().toISOString();\r\n        if (replyedMsg) {\r\n          message.isReplyMessage = true;\r\n          message.replyedMessage = replyedMsg.message || replyedMsg.fileUrl;\r\n          message.replyedMessageId = replyedMsg.id;\r\n          message.replyedMessageTo =\r\n            squadService?.contacts\r\n              .getContacts()\r\n              .get(replyedMsg.fromUser.split(\"@\")[0])?.name ||\r\n            squadService?.user?.user?.id === replyedMsg.fromUser.split(\"@\")[0]\r\n              ? squadService?.user?.user?.name\r\n              : \"Participant\";\r\n        }\r\n        if (isUrl(message.message)) {\r\n          const booleans = getUrlBooleans(message.message);\r\n          message.isFileMessage = booleans.isFileMessage;\r\n          message.isImageMessage = booleans.isImageMessage;\r\n          message.isAudioMessage = booleans.isAudioMessage;\r\n          message.isVideoMessage = booleans.isVideoMessage;\r\n          message.fileUrl = message.message;\r\n        }\r\n      }\r\n      return message;\r\n    });\r\n    if (activeChat.jid === newChat.jid) setActiveChat(newChat);\r\n    if (!chats.filter((cht) => cht.id === chat.id)[0]) {\r\n      const newChats = [chat, ...chats];\r\n      setChats(newChats);\r\n    } else {\r\n      const newChats: IChat[] = [];\r\n      chats.forEach((cht) => {\r\n        if (cht.id === chat.id) {\r\n          cht.messages = newChat.messages;\r\n          newChats.unshift(cht);\r\n        } else {\r\n          newChats.push(cht);\r\n        }\r\n      });\r\n      setChats(newChats);\r\n    }\r\n  };\r\n  const forwardMessage = () => {\r\n    if (forwardMessageList && showModalForwardMessageTo) {\r\n      const ctcs = [...forwardMessageList];\r\n      const message = { ...showModalForwardMessageTo };\r\n      setForwardMessageList(undefined);\r\n      setShowModalForwardMessageTo(undefined);\r\n      const chatsFinded: IChat[] = [];\r\n      const oldChats = [\r\n        ...chats.map((chat) => {\r\n          return { ...chat };\r\n        }),\r\n      ];\r\n      ctcs?.forEach((ctc, i) => {\r\n        const cht = oldChats.find((cht) => cht.jid === ctc.jid);\r\n        if (cht) {\r\n          const msg = {\r\n            ...message,\r\n            id: `${cht.messages.length + 1}`,\r\n            userName: user.name,\r\n            fromUser: user.id,\r\n            toUser: ctc.jid.split(\"@\")[0],\r\n            message: message.fileUrl || message.message,\r\n            deliverStatus: DeliverStatus.QUEUED,\r\n            isForwardMessage: true,\r\n          };\r\n          squadService?.chat?.forwardMessage(cht, msg, (msgId) => {\r\n            msg.id = msgId;\r\n            cht.messages.push(msg);\r\n            chatsFinded.push(cht);\r\n          });\r\n        }\r\n      });\r\n      const newChats = oldChats.map(\r\n        (chat) => chatsFinded.find((cht) => cht.id === chat.id) || chat\r\n      );\r\n      const ctcsNotInChat: (IContact | IGroup)[] = ctcs.filter(\r\n        (ctc) => !newChats.find((cht) => ctc.jid === cht.jid)\r\n      );\r\n      ctcsNotInChat.forEach((ctc, i) => {\r\n        const chat = {\r\n          id: ctc.jid.split(\"@\")[0],\r\n          jid: ctc.jid,\r\n          name: ctc.name,\r\n          profilePicture: ctc.profilePicture,\r\n          status: (ctc as IContact).status || undefined,\r\n          unRead: 0,\r\n          chatType: ctc.jid.includes(\"@conference.\")\r\n            ? ChatType.GROUP\r\n            : ChatType.USER,\r\n          inputMessage: \"\",\r\n          messageLoaded: false,\r\n          isTyping: false,\r\n          messages: [] as IMessage[],\r\n          email: (ctc as IContact).email || undefined,\r\n          favorite: ctc.favorite,\r\n          added: ctc.added,\r\n        };\r\n        const newMessage: IMessage = {\r\n          ...message,\r\n          id: `${1}`,\r\n          userName: user.name,\r\n          fromUser: user.id,\r\n          toUser: ctc.jid.split(\"@\")[0],\r\n          deliverStatus: DeliverStatus.QUEUED,\r\n          isForwardMessage: true,\r\n        };\r\n        squadService?.chat?.forwardMessage(chat, newMessage, (msgId) => {\r\n          newMessage.id = msgId;\r\n          chat.messages.push(newMessage);\r\n          newChats.unshift(chat);\r\n        });\r\n      });\r\n      setChats(newChats);\r\n    }\r\n  };\r\n  const onChangeStatus = () => {\r\n    if (squadService?.chat?.chat.client.status === \"online\") {\r\n      squadService?.chat?.changeStatus(user.status);\r\n    }\r\n  };\r\n  const onSearchContacts = () => {\r\n    if (contactsSearch.length > 2) {\r\n      squadService?.contacts.search(contactsSearch, (searchList) => {\r\n        setContactsSearched(searchList);\r\n      });\r\n    } else {\r\n      setContactsSearched(undefined);\r\n    }\r\n  };\r\n\r\n  const onSearchContactsOutsideUserContacts = () => {\r\n    squadService?.contacts.getContactsOutsideUserLists((contacts) => {\r\n      if (contacts) {\r\n        setContactsOutsideUserContacts(contacts);\r\n      }\r\n    });\r\n  };\r\n  const onMakeCall = () => {\r\n    if (callNumber?.number) {\r\n      const constraints = {\r\n        useAudio: callNumber?.useAudio,\r\n        useVideo: callNumber?.useVideo,\r\n      };\r\n      squadService?.sip?.makeCall(callNumber?.number, constraints);\r\n      setCallNumber(undefined);\r\n    }\r\n  };\r\n  const onEndCall = () => {\r\n    if (currentCall && currentCall.callId && endCall) {\r\n      if (squadService?.sip?.sip?.currentCall) {\r\n        squadService?.sip.sip.endCall(squadService?.sip?.sip?.currentCall);\r\n      }\r\n      setEndCall(undefined);\r\n    }\r\n  };\r\n\r\n  const onRemovingGroupMember = () => {\r\n    if (removedMember && groupToRemoveContact) {\r\n      let group = groups.find((grp) => grp.groupId === groupToRemoveContact);\r\n      if (group)\r\n        squadService?.groups.removeMember(\r\n          group.groupId,\r\n          removedMember,\r\n          (success: boolean) => {\r\n            if (success) {\r\n              squadService?.groups.list((grps) => {\r\n                grps.map((grp) => {\r\n                  grp.members = grp.members.filter(\r\n                    (mb) => mb.userId !== removedMember.userId\r\n                  );\r\n                  setGroups(grps);\r\n                  setRemovedMember(undefined);\r\n                  setGroupToRemoveContact(undefined);\r\n                  return grp;\r\n                });\r\n              });\r\n            }\r\n          }\r\n        );\r\n    }\r\n  };\r\n\r\n  const onLeavingGroup = () => {\r\n    if (memberQuit && groupIdOfLeaveRequest) {\r\n      squadService?.groups.leftingGroup(\r\n        { groupId: groupIdOfLeaveRequest, memberId: memberQuit.userId },\r\n        (success: boolean) => {\r\n          if (success) {\r\n            setChats(chats.filter((cht) => \r\n              cht.groupId !== groupIdOfLeaveRequest)\r\n            );\r\n            setGroups(groups.filter((grp) => \r\n              grp.groupId !== groupIdOfLeaveRequest\r\n            ));\r\n            if (activeChat.groupId === groupIdOfLeaveRequest) {\r\n              setShowChat(false);\r\n            }\r\n            setMemberQuit(undefined);\r\n            setGroupIdOfLeaveRequest(\"\");\r\n        };\r\n      });\r\n    };\r\n  };\r\n\r\n  const onAddingMembers = () => {\r\n    let asynchronousFlag = 0;\r\n    if (checkedMembers && groupToInsertMember) {\r\n      checkedMembers.forEach((ctt) => {\r\n        squadService?.groups.addMember(\r\n          groupToInsertMember,\r\n          ctt,\r\n          (success: boolean) => {\r\n            if (success) {\r\n              asynchronousFlag++;\r\n              if (checkedMembers.length === asynchronousFlag) {\r\n                squadService?.groups.list((grps) => {\r\n                  setGroups(grps);\r\n                  setChats(chats.map((cht) => {\r\n                      if(cht.groupId === groupToInsertMember.groupId){\r\n                        let foundedGroup = grps.find((grp) => grp.groupId === cht.groupId);\r\n                        cht.members = foundedGroup?.members;\r\n                        if(activeChat.groupId === cht.groupId){\r\n                          activeChat.members = foundedGroup?.members;\r\n                          setActiveChat(activeChat);\r\n                        }\r\n                      }\r\n                      return cht;\r\n                    })\r\n                  );\r\n                });\r\n                setCheckedContacts([]);\r\n                setToggleAddingContacts(false);\r\n                setGroupToInsertMember(undefined);\r\n              }\r\n            }\r\n          }\r\n        );\r\n      });\r\n    }\r\n  };\r\n\r\n  const onAddingContacts = () => {\r\n    let asynchronousFlag = 0;\r\n    if (checkedContacts && toggleAddingContacts) {\r\n      checkedContacts.forEach((ctt) => {\r\n        if (!ctt.added) {\r\n          squadService?.contacts.addContacts(ctt, (success: boolean) => {\r\n            if (success) {\r\n              asynchronousFlag++;\r\n              if (checkedContacts.length === asynchronousFlag) {\r\n                squadService?.contacts.list((contacts) => {\r\n                  setContacts(contacts);\r\n                  setCheckedContacts([]);\r\n                  setToggleAddingContacts(false);\r\n                });\r\n              }\r\n            }\r\n          });\r\n        }\r\n      });\r\n    }\r\n  };\r\n\r\n  const onAddingContactOnGroupList = () => {\r\n    if (clickedContact) {\r\n      if (!clickedContact.added) {\r\n        squadService?.contacts.addContacts(clickedContact, (success: boolean) => {\r\n          if (success) {\r\n            squadService?.contacts.list((contacts) => {\r\n              setContacts(contacts);\r\n              setClickedContact(undefined);\r\n            });\r\n          }\r\n        });\r\n      }\r\n    }\r\n  };\r\n\r\n\r\n  const onToggleMemberRole = () => {\r\n    if (toggleMemberRole) {\r\n      squadService?.groups.list((grps) => {\r\n        grps.forEach((gp) => {\r\n          if(gp.groupId === toggleMemberRole.gpId){\r\n            gp.members.forEach((mb) => {\r\n              if(mb.userId === toggleMemberRole.mbId){\r\n                squadService?.contacts.toggleMemberRole(\r\n                  toggleMemberRole.mbId,\r\n                  toggleMemberRole.gpId,\r\n                  toggleMemberRole.mbRole,\r\n                  (success: boolean) => {\r\n                    if (success) {\r\n                      setToggleMemberRole(undefined);\r\n                      setChats(chats.map((cht) => {\r\n                        if(cht.groupId === toggleMemberRole.gpId){\r\n                          cht.members?.map((mb) => {\r\n                            if(mb.userId === toggleMemberRole.mbId){\r\n                              mb.role = toggleMemberRole.mbRole;\r\n                            }\r\n                            return mb;\r\n                          })\r\n                        }\r\n                        return cht;\r\n                      })\r\n                    )}\r\n                  }\r\n                );\r\n              }\r\n            });\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  const onChangeGroupData = () => {\r\n    if(changeGroupData){\r\n      squadService?.groups.list((grps) =>\r\n        grps.forEach((gp) => {\r\n          if(gp.groupId === changeGroupData.groupId){\r\n            squadService?.groups.editGroupInfo({\r\n              groupId: changeGroupData.groupId,\r\n              groupName: changeGroupData.groupName,\r\n              members: changeGroupData.members,\r\n              description: changeGroupData.description\r\n            }, (success: boolean) => {\r\n              if(success){\r\n                setGroups(groups);\r\n                setChangeGroupData(undefined);\r\n              }\r\n            })\r\n          }\r\n        })\r\n      )\r\n    }\r\n  }\r\n\r\n  const createGroup = () => {\r\n    squadService?.groups.create(groupToCreate, (parsedGroup) => {\r\n      if(parsedGroup){\r\n        squadService?.groups.list((groups) => {\r\n          setGroups(groups);\r\n          setGroupToCreate(undefined);\r\n        })\r\n      }\r\n    })\r\n  }\r\n \r\n  useEffect(onChatsChange, [chats]);\r\n  useEffect(onNewFavorite, [newFavorite]);\r\n  useEffect(checkSearchMessages, [activeChat.messageLoaded]);\r\n  useEffect(onActiveChatChange, [activeChat]);\r\n  useEffect(onUserDataChange, [changedUserData]);\r\n  useEffect(onUserPasswordChange, [changedUserPassword]);\r\n  useEffect(onChangeStatus, [user.status]);\r\n  useEffect(forwardMessage, [forwardMessageList]);\r\n  useEffect(onSearchContacts, [contactsSearch]);\r\n  useEffect(onSearchContactsOutsideUserContacts, [showModalAddContact]);\r\n  useEffect(onAddingContacts, [toggleAddingContacts]);\r\n  useEffect(onMakeCall, [callNumber]);\r\n  useEffect(onEndCall, [endCall]);\r\n  useEffect(onRemovingGroupMember, [removedMember, groupToRemoveContact]);\r\n  useEffect(onLeavingGroup, [memberQuit, groupIdOfLeaveRequest]);\r\n  useEffect(onRemovingContact, [removedContact]);\r\n  useEffect(onAddingMembers, [groupToInsertMember, checkedMembers]);\r\n  useEffect(onToggleMemberRole, [toggleMemberRole]);\r\n  useEffect(onChangeGroupData, [changeGroupData]);\r\n  useEffect(onAddingContactOnGroupList, [clickedContact])\r\n  useEffect(createGroup, [groupToCreate]);\r\n\r\n  function onRemovingContact(){\r\n    if(removedContact){\r\n      contacts.forEach((ctc) => {\r\n        if(ctc.id === removedContact.id){\r\n          if(ctc.added)\r\n            squadService?.contacts.remove(ctc, (success: boolean) => {\r\n              if (success) {\r\n                squadService?.contacts.list((ctcs) => {\r\n                  setContacts(ctcs);\r\n                  setRemovedContact(undefined);\r\n                });\r\n              }\r\n            });\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  function onUserPasswordChange() {\r\n    if (changedUserPassword) {\r\n      squadService?.user.changePassword(changedUserPassword, (password) => {\r\n        if (password) {\r\n          setChangedUserPassword({ oldPassword: \"\", newPassword: \"\" });\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  function onUserDataChange() {\r\n    if (changedUserData) {\r\n      squadService?.user.changeUserData(changedUserData, (chgd) => {\r\n        if (chgd) {\r\n          setUser({\r\n            ...user,\r\n            email: changedUserData.email,\r\n            name: changedUserData.name,\r\n          });\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  function onNewFavorite() {\r\n    if (newFavorite) {\r\n      const newFavoriteLoad = { ...newFavorite };\r\n      squadService?.contacts.setFavorite(newFavorite, (favorite) => {\r\n        if (favorite) {\r\n          setChats(\r\n            chats.map((cht) => {\r\n              if (cht.jid === newFavoriteLoad.jid) {\r\n                cht.favorite = !newFavoriteLoad.favorite;\r\n              }\r\n              return cht;\r\n            })\r\n          );\r\n          setGroups(\r\n            groups.map((grp) => {\r\n              if (grp.jid === newFavoriteLoad.jid) {\r\n                return {\r\n                  ...grp,\r\n                  favorite: !newFavoriteLoad.favorite,\r\n                };\r\n              }\r\n              return grp;\r\n            })\r\n          );\r\n          setContacts(\r\n            contacts.map((ctt) => {\r\n              if (ctt.jid === newFavoriteLoad.jid) {\r\n                return {\r\n                  ...ctt,\r\n                  favorite: !newFavoriteLoad.favorite,\r\n                };\r\n              }\r\n              return ctt;\r\n            })\r\n          );\r\n        }\r\n      });\r\n      setNewFavorite(undefined);\r\n    }\r\n  }\r\n  function voiceCommuncatorSubscribe(event: VoiceEvents, data: any) {\r\n    switch (event) {\r\n      case VoiceEvents.CONNECTED:\r\n        // squadService?.sip.sip.invite(\"2045\");\r\n        console.log(\"connected\");\r\n        break;\r\n      case VoiceEvents.RECEIVED_CALL:\r\n        const invitation = data as Invitation;\r\n        const invitation_caller_id_number = invitation.remoteIdentity.uri.aor\r\n          ?.split(\"@\")[0]\r\n          ?.replace(\"sip:\", \"\");\r\n        const invitation_ctct_of_number =\r\n          contacts.find((ctc) => ctc.number === invitation_caller_id_number) ||\r\n          groups.find((grp) => grp.groupId === inviter_caller_id_number);\r\n        const acceptCall = (useVideo: boolean = false) => {\r\n          squadService?.sip.updateConstraintsParams({ useVideo });\r\n          invitation.accept({\r\n            sessionDescriptionHandlerOptions: {\r\n              constraints: squadService?.sip.getConstraints(),\r\n            },\r\n          });\r\n        };\r\n        const rejectCall = () => {\r\n          invitation.reject();\r\n        };\r\n        const receivedCall: ICall = {\r\n          callId: invitation.id,\r\n          callStatus: CallStatus.RINGING,\r\n          callerNumber: invitation_caller_id_number,\r\n          callerObject: invitation_ctct_of_number,\r\n          callerId:\r\n            (invitation_ctct_of_number as IContact)?.id ||\r\n            (invitation_ctct_of_number as IGroup)?.groupId,\r\n          callerName: invitation_ctct_of_number?.name,\r\n          callerProfilePicture: invitation_ctct_of_number?.profilePicture,\r\n          session: invitation,\r\n          accept: acceptCall,\r\n          reject: rejectCall,\r\n        };\r\n        setCurrentCall(receivedCall);\r\n        break;\r\n      case VoiceEvents.MAKE_CALL:\r\n        const inviter = data as Inviter;\r\n        const inviter_caller_id_number = inviter.remoteIdentity.uri.aor\r\n          ?.split(\"@\")[0]\r\n          ?.replace(\"sip:\", \"\");\r\n        const inviter_ctct_of_number =\r\n          contacts.find((ctc) => ctc.number === inviter_caller_id_number) ||\r\n          groups.find((grp) => grp.groupId === inviter_caller_id_number);\r\n        const cancel = () => {\r\n          squadService?.sip.sip.endCall(inviter);\r\n        };\r\n        const sendCall: ICall = {\r\n          callId: inviter.id,\r\n          callStatus: CallStatus.CALLING,\r\n          callerNumber: inviter_caller_id_number,\r\n          callerObject: inviter_ctct_of_number,\r\n          callerId:\r\n            (inviter_ctct_of_number as IContact)?.id ||\r\n            (inviter_ctct_of_number as IGroup)?.groupId,\r\n          callerName: inviter_ctct_of_number?.name,\r\n          callerProfilePicture: inviter_ctct_of_number?.profilePicture,\r\n          session: inviter,\r\n          cancel,\r\n        };\r\n        setCurrentCall(sendCall);\r\n        console.log(\"make_call\");\r\n        break;\r\n      case VoiceEvents.CALL_ON_GOING:\r\n        const callOnGoing = currentCall;\r\n        if (callOnGoing) {\r\n          callOnGoing.callStatus = CallStatus.ON_GOING;\r\n          console.log(data);\r\n          setCurrentCall(callOnGoing);\r\n        }\r\n        console.log(\"call_on_going\");\r\n        break;\r\n      case VoiceEvents.CALL_HANGUP:\r\n        if (currentCall) {\r\n          setCurrentCall(undefined);\r\n        }\r\n        break;\r\n      default:\r\n        console.log(event);\r\n        break;\r\n    }\r\n  }\r\n  function chatCommunicatorSubscribe(event: string, data: any) {\r\n    switch (event) {\r\n      case Events.ONLINE:\r\n        squadService?.chats.list((receivedChats) => {\r\n          const chats: IChat[] = [];\r\n          receivedChats.forEach((cht) => {\r\n            if (!chats.find((chat) => chat.id === cht.id)) {\r\n              chats.push(cht);\r\n            }\r\n          });\r\n          setChats(chats);\r\n          //populating groups\r\n          squadService?.groups.list((groups) => {\r\n            setGroups(groups);\r\n            //Joining Groups Rooms in XMPP\r\n            squadService?.chat?.joinGroups(groups.map((group) => group.jid));\r\n          });\r\n          //populating contacts\r\n          squadService?.contacts.list((contacts) => setContacts(contacts));\r\n\r\n          //populating chat's with messages\r\n\r\n          // receivedChats.forEach((chat) => {\r\n          //   squadService?.messages.list(chat, (messages) => {\r\n          //     const chatWithMessages = { ...chat };\r\n          //     chatWithMessages.messages = chatWithMessages.messages.concat(\r\n          //       messages\r\n          //     );\r\n          //     setChats([\r\n          //       ...receivedChats.filter((cht) => chat.id !== cht.id),\r\n          //       chatWithMessages,\r\n          //     ]);\r\n          //   });\r\n          // });\r\n        });\r\n        break;\r\n      case Events.MESSAGE:\r\n        if (data.fromUser === user.jid) break;\r\n        let find = false;\r\n\r\n        let newChats: IChat[] = [];\r\n        chats.forEach((chat) => {\r\n          if (\r\n            data.fromUser.split(\"@\")[0] === chat.jid.split(\"@\")[0] ||\r\n            data.toUser.split(\"@\")[0] === chat.jid.split(\"@\")[0]\r\n          ) {\r\n            find = true;\r\n            if (!chat.messages.filter((msg) => msg.id === data.id)[0])\r\n              chat.messages.push(data);\r\n            if (chat.id === activeChat.id) {\r\n              let chatTemporary = { ...chat };\r\n              setActiveChat(chatTemporary);\r\n            } else {\r\n              chat.unRead++;\r\n            }\r\n            newChats.unshift(chat);\r\n          } else {\r\n            newChats.push(chat);\r\n          }\r\n        });\r\n\r\n        if (!find) {\r\n          let newChat: IChat = {} as IChat;\r\n\r\n          squadService?.contacts.list((listContacts) => {\r\n            listContacts.forEach((c) => {\r\n              if (c.jid === data.fromUser) {\r\n                newChat = {\r\n                  id: c.id,\r\n                  jid: c.jid,\r\n                  name: c.name,\r\n                  profilePicture: c.profilePicture,\r\n                  status: c.status,\r\n                  unRead: 1,\r\n                  chatType: ChatType.USER,\r\n                  inputMessage: \"\",\r\n                  isTyping: false,\r\n                  messages: [],\r\n                  favorite: c.favorite,\r\n                  added: c.added,\r\n                };\r\n                newChat.messages.push(data);\r\n                newChats.unshift(newChat);\r\n              }\r\n            });\r\n          });\r\n        }\r\n        setChats(newChats);\r\n\r\n        break;\r\n      case Events.RECEIVED:\r\n        setChats(\r\n          chats.map((chat) => {\r\n            if (chat.messages.find((msg) => msg.id === data.id))\r\n              chat.messages = chat.messages.map((message) => {\r\n                message.deliverStatus = DeliverStatus.DELIVERED;\r\n                return message;\r\n              });\r\n            return chat;\r\n          })\r\n        );\r\n        break;\r\n      case Events.DISPLAYED:\r\n        setChats(\r\n          chats.map((chat) => {\r\n            if (chat.messages.find((msg) => msg.id === data.id))\r\n              chat.messages = chat.messages.map((message) => {\r\n                message.readStatus = ReadStatus.READ;\r\n                return message;\r\n              });\r\n            return chat;\r\n          })\r\n        );\r\n        break;\r\n      case Events.COMPOSING:\r\n        setChats(\r\n          chats.map((chat) => {\r\n            if (chat.jid === data) {\r\n              chat.isTyping = true;\r\n              if (activeChat.jid === data) setActiveChat(chat);\r\n              deleteTypingTimeout(chat.jid);\r\n              setTypingTimeout(chat.jid);\r\n            }\r\n            return chat;\r\n          })\r\n        );\r\n        break;\r\n      case Events.ACTIVE:\r\n        setChats(\r\n          chats.map((chat) => {\r\n            if (chat.jid === data) {\r\n              chat.isTyping = false;\r\n              if (activeChat.jid === data) {\r\n                let chatUpdate = { ...chat };\r\n                setActiveChat(chatUpdate);\r\n              }\r\n              deleteTypingTimeout(chat.jid);\r\n            }\r\n            return chat;\r\n          })\r\n        );\r\n        break;\r\n      case Events.PRESENCE:\r\n        setChats(\r\n          chats.map((cht) => {\r\n            if (\r\n              cht.jid === data.from.split(\"/\")[0] &&\r\n              !cht.jid.includes(\"@conference.\")\r\n            ) {\r\n              cht.status = data.status;\r\n            }\r\n            return cht;\r\n          })\r\n        );\r\n        setContacts(\r\n          contacts.map((ctc) => {\r\n            if (\r\n              ctc.jid === data.from.split(\"/\")[0] &&\r\n              !ctc.jid.includes(\"@conference.\")\r\n            ) {\r\n              ctc.status = data.status;\r\n            }\r\n            return ctc;\r\n          })\r\n        );\r\n        break;\r\n    }\r\n  }\r\n  const deleteTypingTimeout = (jid: string) => {\r\n    clearTimeout(typingTimeout.get(jid)?.timeout || setTimeout(() => {}, 1));\r\n    typingTimeout.delete(jid);\r\n  };\r\n  const setTypingTimeout = (jid: string) => {\r\n    const timeoutData: TypingTimeoutData = {\r\n      msgStr: \"\",\r\n      timeout: setTimeout(() => {\r\n        setChats(\r\n          chats.map((cht) => {\r\n            if (cht.jid === jid) {\r\n              cht.isTyping = false;\r\n              if (activeChat.jid === jid) setActiveChat(cht);\r\n            }\r\n            return cht;\r\n          })\r\n        );\r\n      }, 20000),\r\n    };\r\n    typingTimeout.set(jid, timeoutData);\r\n  };\r\n\r\n  squadService?.updateSubscribeFunction(\r\n    chatCommunicatorSubscribe,\r\n    voiceCommuncatorSubscribe\r\n  );\r\n   \r\n\r\n  function sendMessage(\r\n    chat: IChat,\r\n    message: string,\r\n    callback: SendMessageCallback\r\n  ) {\r\n    squadService?.chat?.chat.sendMessage(\r\n      chat.jid,\r\n      chat.jid.includes(\"@conference.\")\r\n        ? XMPPChatType.GROUPCHAT\r\n        : XMPPChatType.CHAT,\r\n      message,\r\n      callback\r\n    );\r\n  }\r\n\r\n  useEffect(init, []);\r\n\r\n  return <>{children}</>;\r\n};\r\n\r\nexport default SquadCommunicator;\r\n"]},"metadata":{},"sourceType":"module"}