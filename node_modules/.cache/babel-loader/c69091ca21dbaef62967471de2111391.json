{"ast":null,"code":"import _objectSpread from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread2\";import React,{useEffect}from\"react\";import{SquadCommunicator as SquadService}from\"./SquadCommunicatorService\";import{useGroup}from\"../contexts/GroupContext\";import{useContact}from\"../contexts/ContactContext\";import{Events as VoiceEvents}from\"./voice/types\";import{useCall}from\"../contexts/CallContext\";import CallStatus from\"../enuns/CallStatus\";//import { callbackify } from \"util\";\n// import IContact from \"../alias/IContact\";\n// Comentado para Evitar Warnings no console\n// interface CreateGroupCallback {\n//   (groupCreated: boolean): void;\n// }\nvar squadService;var SquadSipCommunicator=function SquadSipCommunicator(){var _useContact=useContact(),contacts=_useContact.contacts;var _useCall=useCall(),currentCalls=_useCall.currentCalls,setCurrentCalls=_useCall.setCurrentCalls,callNumber=_useCall.callNumber,setCallNumber=_useCall.setCallNumber,updateConstraints=_useCall.updateConstraints,setUpdateConstraints=_useCall.setUpdateConstraints;var _useGroup=useGroup(),groups=_useGroup.groups;var init=function init(){squadService=SquadService.getInstance({voiceCB:voiceCommuncatorSubscribe});};var setNewCall=function setNewCall(call){var cc=new Map(currentCalls);cc.set(call.callId,call);setCurrentCalls(cc);};var removeCall=function removeCall(call){if(call.interval)clearTimeout(call.interval);var cc=new Map(currentCalls);cc.delete(call.callId);setCurrentCalls(cc);};var onMakeCall=function onMakeCall(){if(callNumber===null||callNumber===void 0?void 0:callNumber.number){var _squadService,_squadService$sip;var constraints={useAudio:callNumber===null||callNumber===void 0?void 0:callNumber.useAudio,useVideo:callNumber===null||callNumber===void 0?void 0:callNumber.useVideo};(_squadService=squadService)===null||_squadService===void 0?void 0:(_squadService$sip=_squadService.sip)===null||_squadService$sip===void 0?void 0:_squadService$sip.makeCall(callNumber===null||callNumber===void 0?void 0:callNumber.number,constraints);setCallNumber(undefined);}};var onUpdateConstraints=function onUpdateConstraints(){if(updateConstraints){var _squadService2;(_squadService2=squadService)===null||_squadService2===void 0?void 0:_squadService2.sip.updateConstraintsParams(updateConstraints);setUpdateConstraints(undefined);}};function voiceCommuncatorSubscribe(event,data){var _invitation$remoteIde,_invitation$remoteIde2,_ref,_ref2,_ref3,_inviter$sessionDescr,_inviter$remoteIdenti,_inviter$remoteIdenti2,_ref4,_ref5,_ref6,_data$invitation,_data$inviter;var endCall;switch(event){case VoiceEvents.CONNECTED:// squadService?.sip.sip.invite(\"2045\");\nconsole.log(\"connected\");break;case VoiceEvents.RECEIVED_CALL:var invitation=data;var invitation_caller_id_number=(_invitation$remoteIde=invitation.remoteIdentity.uri.aor)===null||_invitation$remoteIde===void 0?void 0:(_invitation$remoteIde2=_invitation$remoteIde.split(\"@\")[0])===null||_invitation$remoteIde2===void 0?void 0:_invitation$remoteIde2.replace(\"sip:\",\"\").replace(\"citrus-conference-authenticated-\",\"\");var invitation_ctct_of_number=contacts.find(function(ctc){return ctc.number===invitation_caller_id_number;})||groups.find(function(grp){return grp.groupId===inviter_caller_id_number;});var receivedCall;var acceptCall=function acceptCall(){var _squadService3,_squadService4;var useVideo=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;(_squadService3=squadService)===null||_squadService3===void 0?void 0:_squadService3.sip.updateConstraintsParams({useVideo:useVideo});invitation.accept({sessionDescriptionHandlerOptions:{constraints:(_squadService4=squadService)===null||_squadService4===void 0?void 0:_squadService4.sip.getConstraints()}});if(receivedCall){setNewCall(_objectSpread(_objectSpread({},receivedCall),{},{callStatus:CallStatus.CONNECTING,sendingVideo:useVideo}));}};endCall=function endCall(){var _squadService5;(_squadService5=squadService)===null||_squadService5===void 0?void 0:_squadService5.sip.sip.endCall(invitation);};receivedCall={callId:invitation.id,callStatus:CallStatus.RINGING,callerNumber:invitation_caller_id_number,callerObject:invitation_ctct_of_number,callerId:((_ref=invitation_ctct_of_number)===null||_ref===void 0?void 0:_ref.id)||((_ref2=invitation_ctct_of_number)===null||_ref2===void 0?void 0:_ref2.groupId),callerName:invitation_ctct_of_number===null||invitation_ctct_of_number===void 0?void 0:invitation_ctct_of_number.name,callerProfilePicture:invitation_ctct_of_number===null||invitation_ctct_of_number===void 0?void 0:invitation_ctct_of_number.profilePicture,session:invitation,isGroup:!!((_ref3=invitation_ctct_of_number)===null||_ref3===void 0?void 0:_ref3.groupId),accept:acceptCall,endCall:endCall,micMuted:false,videoMuted:false,hold:false,muteMic:function muteMic(){var _squadService6;return(_squadService6=squadService)===null||_squadService6===void 0?void 0:_squadService6.sip.muteMic(invitation.id);},unMuteMic:function unMuteMic(){var _squadService7;return(_squadService7=squadService)===null||_squadService7===void 0?void 0:_squadService7.sip.unMuteMic(invitation.id);},disableCam:function disableCam(){var _squadService8;return(_squadService8=squadService)===null||_squadService8===void 0?void 0:_squadService8.sip.disableCam(invitation.id);},enableCam:function enableCam(){var _squadService9;return(_squadService9=squadService)===null||_squadService9===void 0?void 0:_squadService9.sip.enableCam(invitation.id);},holdCall:function holdCall(){var _squadService10;return(_squadService10=squadService)===null||_squadService10===void 0?void 0:_squadService10.sip.holdCall(invitation.id);},unHoldCall:function unHoldCall(){var _squadService11;return(_squadService11=squadService)===null||_squadService11===void 0?void 0:_squadService11.sip.unHoldCall(invitation.id);}};setNewCall(receivedCall);break;case VoiceEvents.MAKE_CALL:var inviter=data;var localConstraints=inviter===null||inviter===void 0?void 0:(_inviter$sessionDescr=inviter.sessionDescriptionHandlerOptions)===null||_inviter$sessionDescr===void 0?void 0:_inviter$sessionDescr.constraints;var inviter_caller_id_number=(_inviter$remoteIdenti=inviter.remoteIdentity.uri.aor)===null||_inviter$remoteIdenti===void 0?void 0:(_inviter$remoteIdenti2=_inviter$remoteIdenti.split(\"@\")[0])===null||_inviter$remoteIdenti2===void 0?void 0:_inviter$remoteIdenti2.replace(\"sip:\",\"\").replace(\"citrus-conference-authenticated-\",\"\");var inviter_ctct_of_number=contacts.find(function(ctc){return ctc.number===inviter_caller_id_number;})||groups.find(function(grp){return grp.groupId===inviter_caller_id_number;});endCall=function endCall(){var _squadService12;(_squadService12=squadService)===null||_squadService12===void 0?void 0:_squadService12.sip.sip.endCall(inviter);};var sendCall={callId:inviter.id,callStatus:CallStatus.CALLING,callerNumber:inviter_caller_id_number,callerObject:inviter_ctct_of_number,callerId:((_ref4=inviter_ctct_of_number)===null||_ref4===void 0?void 0:_ref4.id)||((_ref5=inviter_ctct_of_number)===null||_ref5===void 0?void 0:_ref5.groupId),callerName:inviter_ctct_of_number===null||inviter_ctct_of_number===void 0?void 0:inviter_ctct_of_number.name,callerProfilePicture:inviter_ctct_of_number===null||inviter_ctct_of_number===void 0?void 0:inviter_ctct_of_number.profilePicture,session:inviter,isGroup:!!((_ref6=inviter_ctct_of_number)===null||_ref6===void 0?void 0:_ref6.groupId),sendingVideo:(localConstraints===null||localConstraints===void 0?void 0:localConstraints.video)!==false,endCall:endCall,muteMic:function muteMic(){var _squadService13;return(_squadService13=squadService)===null||_squadService13===void 0?void 0:_squadService13.sip.muteMic(inviter.id);},unMuteMic:function unMuteMic(){var _squadService14;return(_squadService14=squadService)===null||_squadService14===void 0?void 0:_squadService14.sip.unMuteMic(inviter.id);},disableCam:function disableCam(){var _squadService15;return(_squadService15=squadService)===null||_squadService15===void 0?void 0:_squadService15.sip.disableCam(inviter.id);},enableCam:function enableCam(){var _squadService16;return(_squadService16=squadService)===null||_squadService16===void 0?void 0:_squadService16.sip.enableCam(inviter.id);},holdCall:function holdCall(){var _squadService17;return(_squadService17=squadService)===null||_squadService17===void 0?void 0:_squadService17.sip.holdCall(invitation.id);},unHoldCall:function unHoldCall(){var _squadService18;return(_squadService18=squadService)===null||_squadService18===void 0?void 0:_squadService18.sip.unHoldCall(invitation.id);}};setNewCall(sendCall);console.log(\"make_call\");break;case VoiceEvents.CALL_ON_GOING:var callOnGoing=currentCalls.get(data===null||data===void 0?void 0:(_data$invitation=data.invitation)===null||_data$invitation===void 0?void 0:_data$invitation.id)||currentCalls.get(data===null||data===void 0?void 0:(_data$inviter=data.inviter)===null||_data$inviter===void 0?void 0:_data$inviter.id);if(callOnGoing){var _cc=_objectSpread({},callOnGoing);_cc.callStatus=CallStatus.ON_GOING;_cc.receivingVideo=data.receivingVideo;_cc.tagId=data.tagId;setNewCall(_cc);}break;case VoiceEvents.CALL_HANGUP:var hangupCall=currentCalls.get(data.id);if(hangupCall){removeCall(hangupCall);}break;case VoiceEvents.MUTE_MIC:var currentCallsCopy=new Map(currentCalls);var cc=currentCallsCopy.get(data.callId);if(cc){cc=_objectSpread({},cc);cc.micMuted=data.status;currentCallsCopy.set(cc.callId,cc);setCurrentCalls(currentCallsCopy);}break;case VoiceEvents.MUTE_CAM:var currentCallsCp=new Map(currentCalls);var ccp=currentCallsCp.get(data.callId);if(ccp){ccp=_objectSpread({},ccp);ccp.micMuted=data.status;currentCallsCp.set(ccp.callId,ccp);setCurrentCalls(currentCallsCp);}break;case VoiceEvents.HOLD_CALL:var currentCallsCc=new Map(currentCalls);var cpc=currentCallsCc.get(data.callId);if(cpc){cpc=_objectSpread({},cpc);cpc.hold=data.status;currentCallsCc.set(cpc.callId,cpc);setCurrentCalls(currentCallsCc);}break;default:console.log(event);break;}}var updateFunction=function updateFunction(){var _squadService19;(_squadService19=squadService)===null||_squadService19===void 0?void 0:_squadService19.updateVoiceSubscribeFunction(voiceCommuncatorSubscribe);};useEffect(init,[]);useEffect(updateFunction,[contacts,groups,currentCalls,callNumber]);useEffect(onMakeCall,[callNumber]);useEffect(onUpdateConstraints,[updateConstraints]);return/*#__PURE__*/React.createElement(React.Fragment,null);};export default SquadSipCommunicator;","map":{"version":3,"sources":["C:/Users/Digivox/dev/Digivox/Refatoracao/squad/src/services/SquadSipCommunicator.tsx"],"names":["React","useEffect","SquadCommunicator","SquadService","useGroup","useContact","Events","VoiceEvents","useCall","CallStatus","squadService","SquadSipCommunicator","contacts","currentCalls","setCurrentCalls","callNumber","setCallNumber","updateConstraints","setUpdateConstraints","groups","init","getInstance","voiceCB","voiceCommuncatorSubscribe","setNewCall","call","cc","Map","set","callId","removeCall","interval","clearTimeout","delete","onMakeCall","number","constraints","useAudio","useVideo","sip","makeCall","undefined","onUpdateConstraints","updateConstraintsParams","event","data","endCall","CONNECTED","console","log","RECEIVED_CALL","invitation","invitation_caller_id_number","remoteIdentity","uri","aor","split","replace","invitation_ctct_of_number","find","ctc","grp","groupId","inviter_caller_id_number","receivedCall","acceptCall","accept","sessionDescriptionHandlerOptions","getConstraints","callStatus","CONNECTING","sendingVideo","id","RINGING","callerNumber","callerObject","callerId","callerName","name","callerProfilePicture","profilePicture","session","isGroup","micMuted","videoMuted","hold","muteMic","unMuteMic","disableCam","enableCam","holdCall","unHoldCall","MAKE_CALL","inviter","localConstraints","inviter_ctct_of_number","sendCall","CALLING","video","CALL_ON_GOING","callOnGoing","get","ON_GOING","receivingVideo","tagId","CALL_HANGUP","hangupCall","MUTE_MIC","currentCallsCopy","status","MUTE_CAM","currentCallsCp","ccp","HOLD_CALL","currentCallsCc","cpc","updateFunction","updateVoiceSubscribeFunction"],"mappings":"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","sourcesContent":["import React, { useEffect } from \"react\";\r\nimport { SquadCommunicator as SquadService } from \"./SquadCommunicatorService\";\r\nimport { useGroup } from \"../contexts/GroupContext\";\r\nimport { useContact } from \"../contexts/ContactContext\";\r\nimport IContact from \"../alias/IContact\";\r\nimport IGroup from \"../alias/IGroup\";\r\nimport { Events as VoiceEvents } from \"./voice/types\";\r\nimport { useCall } from \"../contexts/CallContext\";\r\nimport ICall from \"../alias/ICall\";\r\nimport { Invitation, Inviter } from \"sip.js\";\r\nimport CallStatus from \"../enuns/CallStatus\";\r\n//import { callbackify } from \"util\";\r\n\r\n// import IContact from \"../alias/IContact\";\r\n// Comentado para Evitar Warnings no console\r\n// interface CreateGroupCallback {\r\n//   (groupCreated: boolean): void;\r\n// }\r\n\r\nlet squadService: SquadService | undefined;\r\n\r\nconst SquadSipCommunicator: React.FC = () => {\r\n  const { contacts } = useContact();\r\n  const {\r\n    currentCalls,\r\n    setCurrentCalls,\r\n    callNumber,\r\n    setCallNumber,\r\n    updateConstraints,\r\n    setUpdateConstraints,\r\n  } = useCall();\r\n  const { groups } = useGroup();\r\n\r\n  const init = () => {\r\n    squadService = SquadService.getInstance({\r\n      voiceCB: voiceCommuncatorSubscribe,\r\n    });\r\n  };\r\n  const setNewCall = (call: ICall) => {\r\n    const cc = new Map<string, ICall>(currentCalls);\r\n    cc.set(call.callId, call);\r\n    setCurrentCalls(cc);\r\n  };\r\n  const removeCall = (call: ICall) => {\r\n    if (call.interval) clearTimeout(call.interval);\r\n    const cc = new Map<string, ICall>(currentCalls);\r\n    cc.delete(call.callId);\r\n    setCurrentCalls(cc);\r\n  };\r\n  const onMakeCall = () => {\r\n    if (callNumber?.number) {\r\n      const constraints = {\r\n        useAudio: callNumber?.useAudio,\r\n        useVideo: callNumber?.useVideo,\r\n      };\r\n      squadService?.sip?.makeCall(callNumber?.number, constraints);\r\n      setCallNumber(undefined);\r\n    }\r\n  };\r\n  const onUpdateConstraints = () => {\r\n    if (updateConstraints) {\r\n      squadService?.sip.updateConstraintsParams(updateConstraints);\r\n      setUpdateConstraints(undefined);\r\n    }\r\n  };\r\n  function voiceCommuncatorSubscribe(event: VoiceEvents, data: any) {\r\n    let endCall;\r\n    switch (event) {\r\n      case VoiceEvents.CONNECTED:\r\n        // squadService?.sip.sip.invite(\"2045\");\r\n        console.log(\"connected\");\r\n        break;\r\n      case VoiceEvents.RECEIVED_CALL:\r\n        const invitation = data as Invitation;\r\n        const invitation_caller_id_number = invitation.remoteIdentity.uri.aor\r\n          ?.split(\"@\")[0]\r\n          ?.replace(\"sip:\", \"\")\r\n          .replace(\"citrus-conference-authenticated-\", \"\");\r\n        const invitation_ctct_of_number =\r\n          contacts.find((ctc) => ctc.number === invitation_caller_id_number) ||\r\n          groups.find((grp) => grp.groupId === inviter_caller_id_number);\r\n        let receivedCall: ICall;\r\n        const acceptCall = (useVideo: boolean = false) => {\r\n          squadService?.sip.updateConstraintsParams({ useVideo });\r\n          invitation.accept({\r\n            sessionDescriptionHandlerOptions: {\r\n              constraints: squadService?.sip.getConstraints(),\r\n            },\r\n          });\r\n          if (receivedCall) {\r\n            setNewCall({\r\n              ...receivedCall,\r\n              callStatus: CallStatus.CONNECTING,\r\n              sendingVideo: useVideo,\r\n            });\r\n          }\r\n        };\r\n        endCall = () => {\r\n          squadService?.sip.sip.endCall(invitation);\r\n        };\r\n        receivedCall = {\r\n          callId: invitation.id,\r\n          callStatus: CallStatus.RINGING,\r\n          callerNumber: invitation_caller_id_number,\r\n          callerObject: invitation_ctct_of_number,\r\n          callerId:\r\n            (invitation_ctct_of_number as IContact)?.id ||\r\n            (invitation_ctct_of_number as IGroup)?.groupId,\r\n          callerName: invitation_ctct_of_number?.name,\r\n          callerProfilePicture: invitation_ctct_of_number?.profilePicture,\r\n          session: invitation,\r\n          isGroup: !!(invitation_ctct_of_number as IGroup)?.groupId,\r\n          accept: acceptCall,\r\n          endCall,\r\n          micMuted: false,\r\n          videoMuted: false,\r\n          hold: false,\r\n          muteMic: () => squadService?.sip.muteMic(invitation.id),\r\n          unMuteMic: () => squadService?.sip.unMuteMic(invitation.id),\r\n          disableCam: () => squadService?.sip.disableCam(invitation.id),\r\n          enableCam: () => squadService?.sip.enableCam(invitation.id),\r\n          holdCall: () => squadService?.sip.holdCall(invitation.id),\r\n          unHoldCall: () => squadService?.sip.unHoldCall(invitation.id),\r\n        };\r\n        setNewCall(receivedCall);\r\n        break;\r\n      case VoiceEvents.MAKE_CALL:\r\n        const inviter = data as Inviter;\r\n        const localConstraints = inviter?.sessionDescriptionHandlerOptions\r\n          ?.constraints as MediaStreamConstraints;\r\n        const inviter_caller_id_number = inviter.remoteIdentity.uri.aor\r\n          ?.split(\"@\")[0]\r\n          ?.replace(\"sip:\", \"\")\r\n          .replace(\"citrus-conference-authenticated-\", \"\");\r\n        const inviter_ctct_of_number =\r\n          contacts.find((ctc) => ctc.number === inviter_caller_id_number) ||\r\n          groups.find((grp) => grp.groupId === inviter_caller_id_number);\r\n\r\n        endCall = () => {\r\n          squadService?.sip.sip.endCall(inviter);\r\n        };\r\n        const sendCall: ICall = {\r\n          callId: inviter.id,\r\n          callStatus: CallStatus.CALLING,\r\n          callerNumber: inviter_caller_id_number,\r\n          callerObject: inviter_ctct_of_number,\r\n          callerId:\r\n            (inviter_ctct_of_number as IContact)?.id ||\r\n            (inviter_ctct_of_number as IGroup)?.groupId,\r\n          callerName: inviter_ctct_of_number?.name,\r\n          callerProfilePicture: inviter_ctct_of_number?.profilePicture,\r\n          session: inviter,\r\n          isGroup: !!(inviter_ctct_of_number as IGroup)?.groupId,\r\n          sendingVideo: localConstraints?.video !== false,\r\n          endCall,\r\n          muteMic: () => squadService?.sip.muteMic(inviter.id),\r\n          unMuteMic: () => squadService?.sip.unMuteMic(inviter.id),\r\n          disableCam: () => squadService?.sip.disableCam(inviter.id),\r\n          enableCam: () => squadService?.sip.enableCam(inviter.id),\r\n          holdCall: () => squadService?.sip.holdCall(invitation.id),\r\n          unHoldCall: () => squadService?.sip.unHoldCall(invitation.id),\r\n        };\r\n        setNewCall(sendCall);\r\n        console.log(\"make_call\");\r\n        break;\r\n      case VoiceEvents.CALL_ON_GOING:\r\n        const callOnGoing =\r\n          currentCalls.get(data?.invitation?.id) ||\r\n          currentCalls.get(data?.inviter?.id);\r\n        if (callOnGoing) {\r\n          const cc = { ...callOnGoing };\r\n          cc.callStatus = CallStatus.ON_GOING;\r\n          cc.receivingVideo = data.receivingVideo;\r\n          cc.tagId = data.tagId;\r\n          setNewCall(cc);\r\n        }\r\n        break;\r\n      case VoiceEvents.CALL_HANGUP:\r\n        const hangupCall = currentCalls.get(data.id);\r\n        if (hangupCall) {\r\n          removeCall(hangupCall);\r\n        }\r\n        break;\r\n      case VoiceEvents.MUTE_MIC:\r\n        const currentCallsCopy = new Map(currentCalls);\r\n        let cc = currentCallsCopy.get(data.callId);\r\n        if (cc) {\r\n          cc = { ...cc };\r\n          cc.micMuted = data.status;\r\n          currentCallsCopy.set(cc.callId, cc);\r\n          setCurrentCalls(currentCallsCopy);\r\n        }\r\n        break;\r\n      case VoiceEvents.MUTE_CAM:\r\n        const currentCallsCp = new Map(currentCalls);\r\n        let ccp = currentCallsCp.get(data.callId);\r\n        if (ccp) {\r\n          ccp = { ...ccp };\r\n          ccp.micMuted = data.status;\r\n          currentCallsCp.set(ccp.callId, ccp);\r\n          setCurrentCalls(currentCallsCp);\r\n        }\r\n        break;\r\n      case VoiceEvents.HOLD_CALL:\r\n        const currentCallsCc = new Map(currentCalls);\r\n        let cpc = currentCallsCc.get(data.callId);\r\n        if (cpc) {\r\n          cpc = { ...cpc };\r\n          cpc.hold = data.status;\r\n          currentCallsCc.set(cpc.callId, cpc);\r\n          setCurrentCalls(currentCallsCc);\r\n        }\r\n        break;\r\n      default:\r\n        console.log(event);\r\n        break;\r\n    }\r\n  }\r\n\r\n  const updateFunction = () => {\r\n    squadService?.updateVoiceSubscribeFunction(voiceCommuncatorSubscribe);\r\n  };\r\n\r\n  useEffect(init, []);\r\n  useEffect(updateFunction, [contacts, groups, currentCalls, callNumber]);\r\n  useEffect(onMakeCall, [callNumber]);\r\n  useEffect(onUpdateConstraints, [updateConstraints]);\r\n\r\n  return <></>;\r\n};\r\n\r\nexport default SquadSipCommunicator;\r\n"]},"metadata":{},"sourceType":"module"}