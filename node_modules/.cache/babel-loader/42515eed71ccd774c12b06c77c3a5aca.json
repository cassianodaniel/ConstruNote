{"ast":null,"code":"import _regeneratorRuntime from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/regenerator\";import _asyncToGenerator from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/asyncToGenerator\";import _createForOfIteratorHelper from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createForOfIteratorHelper\";import _classCallCheck from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"C:\\\\Users\\\\Digivox\\\\dev\\\\Digivox\\\\Refatoracao\\\\squad\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import{Inviter,Registerer,SessionState// SIPExtension,\n,UserAgent,Web}from\"sip.js\";import MultiStreamsMixer from\"multistreamsmixer\";export var tagsRange=[0,1,2,3];var SIP=/*#__PURE__*/function(){function SIP(props){var _this=this;_classCallCheck(this,SIP);this.onInvite=function(invitation){if(_this.activeCalls.size<tagsRange.length){var cb=function cb(session){_this.activeCalls.set(invitation.id,invitation);_this.onReceiveCall(session,invitation);};invitation.stateChange.addListener(cb);_this.onReceiveCall(SessionState.Initial,invitation);}else{invitation.reject();}};this.remoteVideoEnabled=function(session){var _ref,_ref$peerConnection;var receivingVideo=false;(_ref=session.sessionDescriptionHandler)===null||_ref===void 0?void 0:(_ref$peerConnection=_ref.peerConnection)===null||_ref$peerConnection===void 0?void 0:_ref$peerConnection.getReceivers().forEach(function(receiver){if(receiver.track){if(receiver.track.kind===\"video\")receivingVideo=true;}});return receivingVideo;};this.localVideoEnabled=function(session){var _ref2,_ref3;return!!((_ref2=(_ref3=session)===null||_ref3===void 0?void 0:_ref3.sessionDescriptionHandlerOptions.constraints)===null||_ref2===void 0?void 0:_ref2.video);};this.muteMic=function(callID){var call=_this.activeCalls.get(callID);if(call){var _sdh$peerConnection;var sdh=call.sessionDescriptionHandler;sdh===null||sdh===void 0?void 0:(_sdh$peerConnection=sdh.peerConnection)===null||_sdh$peerConnection===void 0?void 0:_sdh$peerConnection.getSenders().forEach(function(stream){var _stream$track;if(((_stream$track=stream.track)===null||_stream$track===void 0?void 0:_stream$track.kind)===\"audio\")stream.track.enabled=false;});}};this.unMuteMic=function(callID){var call=_this.activeCalls.get(callID);if(call){var _sdh$peerConnection2;var sdh=call.sessionDescriptionHandler;sdh===null||sdh===void 0?void 0:(_sdh$peerConnection2=sdh.peerConnection)===null||_sdh$peerConnection2===void 0?void 0:_sdh$peerConnection2.getSenders().forEach(function(stream){var _stream$track2;if(((_stream$track2=stream.track)===null||_stream$track2===void 0?void 0:_stream$track2.kind)===\"audio\")stream.track.enabled=true;});}};this.disableCam=function(callID){var call=_this.activeCalls.get(callID);if(call){if(_this.localVideoEnabled(call)){var _sdh$peerConnection3;var sdh=call.sessionDescriptionHandler;sdh===null||sdh===void 0?void 0:(_sdh$peerConnection3=sdh.peerConnection)===null||_sdh$peerConnection3===void 0?void 0:_sdh$peerConnection3.getSenders().forEach(function(stream){var _stream$track3;if(((_stream$track3=stream.track)===null||_stream$track3===void 0?void 0:_stream$track3.kind)===\"video\")stream.track.enabled=false;});}else{// TODO\nconsole.log(\"re-invite\");}}};this.enableCam=function(callID){var call=_this.activeCalls.get(callID);if(call){if(_this.localVideoEnabled(call)){var _sdh$peerConnection4;var sdh=call.sessionDescriptionHandler;sdh===null||sdh===void 0?void 0:(_sdh$peerConnection4=sdh.peerConnection)===null||_sdh$peerConnection4===void 0?void 0:_sdh$peerConnection4.getSenders().forEach(function(stream){var _stream$track4;if(((_stream$track4=stream.track)===null||_stream$track4===void 0?void 0:_stream$track4.kind)===\"video\")stream.track.enabled=true;});}else{// TODO\nconsole.log(\"re-invite\");}}};this.holdCall=function(callID){var call=_this.activeCalls.get(callID);if(call){var options={sessionDescriptionHandlerModifiers:[Web.holdModifier]};return call.invite(options);}};this.unHoldCall=function(callID){var call=_this.activeCalls.get(callID);if(call){var options={sessionDescriptionHandlerModifiers:[]};if(call){call.invite(options);}}};this.mixAudios=function(firstStream,secondStream){return new MultiStreamsMixer([firstStream,secondStream]).getMixedStream();};this.mergeCalls=function(firstCallId,secondCallId){var firstCall=_this.activeCalls.get(firstCallId);var secondCall=_this.activeCalls.get(secondCallId);if(firstCall&&secondCall){var _ref4,_ref5;var firstPeer=(_ref4=firstCall.sessionDescriptionHandler)===null||_ref4===void 0?void 0:_ref4.peerConnection;var secondPeer=(_ref5=firstCall.sessionDescriptionHandler)===null||_ref5===void 0?void 0:_ref5.peerConnection;var firstSendedTrack=firstPeer===null||firstPeer===void 0?void 0:firstPeer.getSenders().filter(function(str){var _str$track;return((_str$track=str.track)===null||_str$track===void 0?void 0:_str$track.kind)===\"audio\";})[0].track;var secondSendedTrack=secondPeer===null||secondPeer===void 0?void 0:secondPeer.getSenders().filter(function(str){var _str$track2;return((_str$track2=str.track)===null||_str$track2===void 0?void 0:_str$track2.kind)===\"audio\";})[0].track;var firstReceivedStream=new MediaStream();var firstReceivedTrack=firstPeer===null||firstPeer===void 0?void 0:firstPeer.getReceivers().filter(function(str){return str.track.kind===\"audio\";})[0].track;firstReceivedTrack&&firstReceivedStream.addTrack(firstReceivedTrack);var secondReceivedStream=new MediaStream();var secondReceivedTrack=secondPeer===null||secondPeer===void 0?void 0:secondPeer.getReceivers().filter(function(str){return str.track.kind===\"audio\";})[0].track;secondReceivedTrack&&secondReceivedStream.addTrack(secondReceivedTrack);if(firstSendedTrack&&secondSendedTrack&&firstReceivedStream&&secondReceivedStream){var firtsLocalMediaStream=new MediaStream();var secondLocalMediaStream=new MediaStream();firtsLocalMediaStream.addTrack(firstSendedTrack);secondLocalMediaStream.addTrack(secondSendedTrack);firstPeer===null||firstPeer===void 0?void 0:firstPeer.getSenders().filter(function(str){var _str$track3;return((_str$track3=str.track)===null||_str$track3===void 0?void 0:_str$track3.kind)===\"audio\";})[0].replaceTrack(_this.mixAudios(firtsLocalMediaStream,secondReceivedStream).getAudioTracks()[0]);secondPeer===null||secondPeer===void 0?void 0:secondPeer.getSenders().filter(function(str){var _str$track4;return((_str$track4=str.track)===null||_str$track4===void 0?void 0:_str$track4.kind)===\"audio\";})[0].replaceTrack(_this.mixAudios(secondLocalMediaStream,firstReceivedStream).getAudioTracks()[0]);}}};Object.assign(this,props);this.makeSIP();this.activeCalls=new Map();this.usedTags=new Map();}_createClass(SIP,[{key:\"makeSIP\",value:function makeSIP(){var _this2=this;var transportOptions={//   server: this.wsURL,\nserver:\"wss://test.citrussquad.com:7443\"};var uri=UserAgent.makeURI(\"sip:\".concat(this.user,\"@\").concat(this.domain));var userAgentOptions={authorizationUsername:this.user,authorizationPassword:this.password,transportOptions:transportOptions,uri:uri,logBuiltinEnabled:true,delegate:{onInvite:this.onInvite}// sipExtension100rel: SIPExtension.Required,\n};this.userAgent=new UserAgent(userAgentOptions);this.registerer=new Registerer(this.userAgent);this.userAgent.start().then(function(){var _this2$registerer,_this2$registerer2;(_this2$registerer=_this2.registerer)===null||_this2$registerer===void 0?void 0:_this2$registerer.register();(_this2$registerer2=_this2.registerer)===null||_this2$registerer2===void 0?void 0:_this2$registerer2.stateChange.addListener(_this2.connectionCB);});}},{key:\"invite\",value:function invite(number){var _this3=this;var constraints=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{video:false,audio:true};if(!(this.activeCalls.size>=tagsRange.length)&&this.userAgent){var destination=UserAgent.makeURI(\"sip:\".concat(number,\"@\").concat(this.domain));var newCall;if(destination){newCall=new Inviter(this.userAgent,destination,{sessionDescriptionHandlerOptions:{constraints:constraints}// inviteWithoutSdp: true,\n});this.activeCalls.set(newCall.id,newCall);}var currentInvite=newCall&&this.activeCalls.get(newCall.id);if(currentInvite){currentInvite.stateChange.addListener(function(state){if(_this3.activeCalls)_this3.onMakeCall(state,currentInvite);});currentInvite.invite();this.onMakeCall(SessionState.Initial,currentInvite);}}}},{key:\"blindTransfer\",value:function blindTransfer(callId,number){var destination=UserAgent.makeURI(\"sip:\".concat(number,\"@\").concat(this.domain));var call=this.activeCalls.get(callId);if(call&&destination){call.refer(destination);// this.activeCalls.delete(callId);\n}}},{key:\"attendedTransfer\",value:function attendedTransfer(firstCallId,secondCallId){var firstCall=this.activeCalls.get(firstCallId);var secondCall=this.activeCalls.get(secondCallId);if(firstCall&&secondCall){firstCall.refer(secondCall);}}},{key:\"getAvailableTag\",value:function getAvailableTag(){var tagsUsing=Array.from(this.usedTags.values());var _iterator=_createForOfIteratorHelper(tagsRange),_step;try{var _loop=function _loop(){var tagId=_step.value;if(!tagsUsing.find(function(tgId){return tgId===\"remote-stream-\".concat(tagId);})){return{v:\"remote-stream-\".concat(tagId)};}};for(_iterator.s();!(_step=_iterator.n()).done;){var _ret=_loop();if(typeof _ret===\"object\")return _ret.v;}}catch(err){_iterator.e(err);}finally{_iterator.f();}}},{key:\"endCall\",value:function endCall(session){switch(session.state){case SessionState.Initial:case SessionState.Establishing:if(session instanceof Inviter){// An unestablished outgoing session\nsession.cancel();}else{// An unestablished incoming session\nsession.reject();}break;case SessionState.Established:// An established session\nsession.bye();break;case SessionState.Terminating:case SessionState.Terminated:// Cannot terminate a session that is already terminated\nbreak;}}},{key:\"setupRemoteMedia\",value:function setupRemoteMedia(session){var _ref7,_ref7$peerConnection;var speakerId=arguments.length>1&&arguments[1]!==undefined?arguments[1]:\"\";var tagId=this.getAvailableTag();if(!tagId){var _ref6;(_ref6=session)===null||_ref6===void 0?void 0:_ref6.reject();return;}var mediaElement=document.getElementById(tagId);this.usedTags.set(session.id,tagId);var remoteStream=new MediaStream();(_ref7=session.sessionDescriptionHandler)===null||_ref7===void 0?void 0:(_ref7$peerConnection=_ref7.peerConnection)===null||_ref7$peerConnection===void 0?void 0:_ref7$peerConnection.getReceivers().forEach(function(receiver){if(receiver.track){remoteStream.addTrack(receiver.track);}});var playAudio=/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(mediaElement,remoteStream,speakerId){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!mediaElement){_context.next=11;break;}if(!speakerId){_context.next=9;break;}_context.prev=2;_context.next=5;return mediaElement.setSinkId(speakerId);case 5:_context.next=9;break;case 7:_context.prev=7;_context.t0=_context[\"catch\"](2);case 9:mediaElement.srcObject=remoteStream;mediaElement.play();case 11:case\"end\":return _context.stop();}}},_callee,null,[[2,7]]);}));return function playAudio(_x,_x2,_x3){return _ref8.apply(this,arguments);};}();playAudio(mediaElement,remoteStream,speakerId);return{receivingVideo:this.remoteVideoEnabled(session),tagId:tagId};}},{key:\"cleanupMedia\",value:function cleanupMedia(callId){var tag=this.usedTags.get(callId);if(!tag)return;var mediaElement=document.getElementById(tag);if(mediaElement){mediaElement.srcObject=null;mediaElement.pause();this.usedTags.delete(callId);}}}]);return SIP;}();export{SIP as default};","map":{"version":3,"sources":["C:/Users/Digivox/dev/Digivox/Refatoracao/squad/src/services/voice/voicecommunicator.ts"],"names":["Inviter","Registerer","SessionState","UserAgent","Web","MultiStreamsMixer","tagsRange","SIP","props","onInvite","invitation","activeCalls","size","length","cb","session","set","id","onReceiveCall","stateChange","addListener","Initial","reject","remoteVideoEnabled","receivingVideo","sessionDescriptionHandler","peerConnection","getReceivers","forEach","receiver","track","kind","localVideoEnabled","sessionDescriptionHandlerOptions","constraints","video","muteMic","callID","call","get","sdh","getSenders","stream","enabled","unMuteMic","disableCam","console","log","enableCam","holdCall","options","sessionDescriptionHandlerModifiers","holdModifier","invite","unHoldCall","mixAudios","firstStream","secondStream","getMixedStream","mergeCalls","firstCallId","secondCallId","firstCall","secondCall","firstPeer","secondPeer","firstSendedTrack","filter","str","secondSendedTrack","firstReceivedStream","MediaStream","firstReceivedTrack","addTrack","secondReceivedStream","secondReceivedTrack","firtsLocalMediaStream","secondLocalMediaStream","replaceTrack","getAudioTracks","Object","assign","makeSIP","Map","usedTags","transportOptions","server","uri","makeURI","user","domain","userAgentOptions","authorizationUsername","authorizationPassword","password","logBuiltinEnabled","delegate","userAgent","registerer","start","then","register","connectionCB","number","audio","destination","newCall","currentInvite","state","onMakeCall","callId","refer","tagsUsing","Array","from","values","tagId","find","tgId","Establishing","cancel","Established","bye","Terminating","Terminated","speakerId","getAvailableTag","mediaElement","document","getElementById","remoteStream","playAudio","setSinkId","srcObject","play","tag","pause","delete"],"mappings":"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","sourcesContent":["import {\r\n  Invitation,\r\n  Inviter,\r\n  Registerer,\r\n  RegistererState,\r\n  Session,\r\n  SessionInviteOptions,\r\n  SessionState,\r\n  // SIPExtension,\r\n  UserAgent,\r\n  UserAgentOptions,\r\n  Web,\r\n} from \"sip.js\";\r\nimport MultiStreamsMixer from \"multistreamsmixer\";\r\ninterface ConnectionListenerCallback {\r\n  (data: RegistererState): void;\r\n}\r\ninterface MakeCallCallback {\r\n  (state: SessionState, inviter: Inviter): void;\r\n}\r\ninterface ReceiveCallCallback {\r\n  (state: SessionState, invitation: Invitation): void;\r\n}\r\ninterface SIPConstructorPropeties {\r\n  user: string;\r\n  password: string;\r\n  wsURL: string;\r\n  domain: string;\r\n  connectionCB: ConnectionListenerCallback;\r\n  onMakeCall: MakeCallCallback;\r\n  onReceiveCall: ReceiveCallCallback;\r\n}\r\nexport const tagsRange: number[] = [0, 1, 2, 3];\r\nexport default interface SIP {\r\n  user: string;\r\n  password: string;\r\n  wsURL: string;\r\n  domain: string;\r\n  connectionCB: ConnectionListenerCallback;\r\n  onMakeCall: MakeCallCallback;\r\n  onReceiveCall: ReceiveCallCallback;\r\n  userAgent?: UserAgent;\r\n  registerer?: Registerer;\r\n  activeCalls: Map<string, Session>;\r\n  usedTags: Map<string, string>;\r\n}\r\nexport default class SIP {\r\n  constructor(props: SIPConstructorPropeties) {\r\n    Object.assign(this, props);\r\n    this.makeSIP();\r\n    this.activeCalls = new Map<string, Session>();\r\n    this.usedTags = new Map<string, string>();\r\n  }\r\n  makeSIP() {\r\n    const transportOptions = {\r\n      //   server: this.wsURL,\r\n      server: \"wss://test.citrussquad.com:7443\",\r\n    };\r\n    const uri = UserAgent.makeURI(`sip:${this.user}@${this.domain}`);\r\n    const userAgentOptions: UserAgentOptions = {\r\n      authorizationUsername: this.user,\r\n      authorizationPassword: this.password,\r\n      transportOptions,\r\n      uri,\r\n      logBuiltinEnabled: true,\r\n      delegate: {\r\n        onInvite: this.onInvite,\r\n      },\r\n      // sipExtension100rel: SIPExtension.Required,\r\n    };\r\n    this.userAgent = new UserAgent(userAgentOptions);\r\n    this.registerer = new Registerer(this.userAgent);\r\n    this.userAgent.start().then(() => {\r\n      this.registerer?.register();\r\n      this.registerer?.stateChange.addListener(this.connectionCB);\r\n    });\r\n  }\r\n  invite(\r\n    number: string,\r\n    constraints: MediaStreamConstraints = { video: false, audio: true }\r\n  ) {\r\n    if (!(this.activeCalls.size >= tagsRange.length) && this.userAgent) {\r\n      const destination = UserAgent.makeURI(`sip:${number}@${this.domain}`);\r\n      let newCall;\r\n      if (destination) {\r\n        newCall = new Inviter(this.userAgent, destination, {\r\n          sessionDescriptionHandlerOptions: {\r\n            constraints,\r\n          },\r\n          // inviteWithoutSdp: true,\r\n        });\r\n        this.activeCalls.set(newCall.id, newCall);\r\n      }\r\n      const currentInvite =\r\n        newCall && (this.activeCalls.get(newCall.id) as Inviter);\r\n      if (currentInvite) {\r\n        currentInvite.stateChange.addListener((state) => {\r\n          if (this.activeCalls) this.onMakeCall(state, currentInvite);\r\n        });\r\n        currentInvite.invite();\r\n        this.onMakeCall(SessionState.Initial, currentInvite);\r\n      }\r\n    }\r\n  }\r\n  blindTransfer(callId: string, number: string) {\r\n    const destination = UserAgent.makeURI(`sip:${number}@${this.domain}`);\r\n    const call = this.activeCalls.get(callId);\r\n    if (call && destination) {\r\n      call.refer(destination);\r\n      // this.activeCalls.delete(callId);\r\n    }\r\n  }\r\n  attendedTransfer(firstCallId: string, secondCallId: string) {\r\n    const firstCall = this.activeCalls.get(firstCallId);\r\n    const secondCall = this.activeCalls.get(secondCallId);\r\n    if (firstCall && secondCall) {\r\n      firstCall.refer(secondCall);\r\n    }\r\n  }\r\n  getAvailableTag() {\r\n    let tagsUsing = Array.from(this.usedTags.values());\r\n    for (const tagId of tagsRange) {\r\n      if (!tagsUsing.find((tgId) => tgId === `remote-stream-${tagId}`)) {\r\n        return `remote-stream-${tagId}`;\r\n      }\r\n    }\r\n  }\r\n  onInvite = (invitation: Invitation) => {\r\n    if (this.activeCalls.size < tagsRange.length) {\r\n      const cb = (session: SessionState) => {\r\n        this.activeCalls.set(invitation.id, invitation);\r\n        this.onReceiveCall(session, invitation);\r\n      };\r\n      invitation.stateChange.addListener(cb);\r\n      this.onReceiveCall(SessionState.Initial, invitation);\r\n    } else {\r\n      invitation.reject();\r\n    }\r\n  };\r\n  endCall(session: Session) {\r\n    switch (session.state) {\r\n      case SessionState.Initial:\r\n      case SessionState.Establishing:\r\n        if (session instanceof Inviter) {\r\n          // An unestablished outgoing session\r\n          session.cancel();\r\n        } else {\r\n          // An unestablished incoming session\r\n          (session as Invitation).reject();\r\n        }\r\n        break;\r\n      case SessionState.Established:\r\n        // An established session\r\n        session.bye();\r\n        break;\r\n      case SessionState.Terminating:\r\n      case SessionState.Terminated:\r\n        // Cannot terminate a session that is already terminated\r\n        break;\r\n    }\r\n  }\r\n  setupRemoteMedia(session: Session, speakerId: string = \"\") {\r\n    const tagId = this.getAvailableTag();\r\n    if (!tagId) {\r\n      (session as Invitation)?.reject();\r\n      return;\r\n    }\r\n    const mediaElement: HTMLVideoElement = document.getElementById(\r\n      tagId\r\n    ) as HTMLVideoElement;\r\n    this.usedTags.set(session.id, tagId);\r\n    const remoteStream = new MediaStream();\r\n\r\n    (session.sessionDescriptionHandler as Web.SessionDescriptionHandler)?.peerConnection\r\n      ?.getReceivers()\r\n      .forEach((receiver) => {\r\n        if (receiver.track) {\r\n          remoteStream.addTrack(receiver.track);\r\n        }\r\n      });\r\n    const playAudio = async (\r\n      mediaElement: HTMLVideoElement,\r\n      remoteStream: MediaStream,\r\n      speakerId: string\r\n    ) => {\r\n      if (mediaElement) {\r\n        if (speakerId) {\r\n          try {\r\n            await (mediaElement as any).setSinkId(speakerId);\r\n          } catch {}\r\n        }\r\n        mediaElement.srcObject = remoteStream;\r\n        mediaElement.play();\r\n      }\r\n    };\r\n    playAudio(mediaElement, remoteStream, speakerId);\r\n    return {\r\n      receivingVideo: this.remoteVideoEnabled(session),\r\n      tagId,\r\n    };\r\n  }\r\n  remoteVideoEnabled = (session: Session) => {\r\n    let receivingVideo = false;\r\n    (session.sessionDescriptionHandler as Web.SessionDescriptionHandler)?.peerConnection\r\n      ?.getReceivers()\r\n      .forEach((receiver) => {\r\n        if (receiver.track) {\r\n          if (receiver.track.kind === \"video\") receivingVideo = true;\r\n        }\r\n      });\r\n    return receivingVideo;\r\n  };\r\n  localVideoEnabled = (session: Session) => {\r\n    return !!((session as Inviter)?.sessionDescriptionHandlerOptions\r\n      .constraints as MediaStreamConstraints)?.video;\r\n  };\r\n  cleanupMedia(callId: string) {\r\n    const tag = this.usedTags.get(callId);\r\n    if (!tag) return;\r\n    const mediaElement: HTMLVideoElement = document.getElementById(\r\n      tag\r\n    ) as HTMLVideoElement;\r\n    if (mediaElement) {\r\n      mediaElement.srcObject = null;\r\n      mediaElement.pause();\r\n      this.usedTags.delete(callId);\r\n    }\r\n  }\r\n  muteMic = (callID: string) => {\r\n    const call = this.activeCalls.get(callID);\r\n    if (call) {\r\n      const sdh: Web.SessionDescriptionHandler = call.sessionDescriptionHandler as Web.SessionDescriptionHandler;\r\n      sdh?.peerConnection?.getSenders().forEach((stream: any) => {\r\n        if (stream.track?.kind === \"audio\") stream.track.enabled = false;\r\n      });\r\n    }\r\n  };\r\n  unMuteMic = (callID: string) => {\r\n    const call = this.activeCalls.get(callID);\r\n    if (call) {\r\n      const sdh: Web.SessionDescriptionHandler = call.sessionDescriptionHandler as Web.SessionDescriptionHandler;\r\n      sdh?.peerConnection?.getSenders().forEach((stream: any) => {\r\n        if (stream.track?.kind === \"audio\") stream.track.enabled = true;\r\n      });\r\n    }\r\n  };\r\n  disableCam = (callID: string) => {\r\n    const call = this.activeCalls.get(callID);\r\n    if (call) {\r\n      if (this.localVideoEnabled(call)) {\r\n        const sdh: Web.SessionDescriptionHandler = call.sessionDescriptionHandler as Web.SessionDescriptionHandler;\r\n        sdh?.peerConnection?.getSenders().forEach((stream) => {\r\n          if (stream.track?.kind === \"video\") stream.track.enabled = false;\r\n        });\r\n      } else {\r\n        // TODO\r\n        console.log(\"re-invite\");\r\n      }\r\n    }\r\n  };\r\n  enableCam = (callID: string) => {\r\n    const call = this.activeCalls.get(callID);\r\n    if (call) {\r\n      if (this.localVideoEnabled(call)) {\r\n        const sdh: Web.SessionDescriptionHandler = call.sessionDescriptionHandler as Web.SessionDescriptionHandler;\r\n        sdh?.peerConnection?.getSenders().forEach((stream: any) => {\r\n          if (stream.track?.kind === \"video\") stream.track.enabled = true;\r\n        });\r\n      } else {\r\n        // TODO\r\n        console.log(\"re-invite\");\r\n      }\r\n    }\r\n  };\r\n  holdCall = (callID: string) => {\r\n    const call = this.activeCalls.get(callID);\r\n    if (call) {\r\n      const options: SessionInviteOptions = {\r\n        sessionDescriptionHandlerModifiers: [Web.holdModifier],\r\n      };\r\n      return call.invite(options);\r\n    }\r\n  };\r\n  unHoldCall = (callID: string) => {\r\n    const call = this.activeCalls.get(callID);\r\n    if (call) {\r\n      const options: SessionInviteOptions = {\r\n        sessionDescriptionHandlerModifiers: [],\r\n      };\r\n      if (call) {\r\n        call.invite(options);\r\n      }\r\n    }\r\n  };\r\n  mixAudios = (firstStream: MediaStream, secondStream: MediaStream) => {\r\n    return new MultiStreamsMixer([firstStream, secondStream]).getMixedStream();\r\n  };\r\n  mergeCalls = (firstCallId: string, secondCallId: string) => {\r\n    const firstCall = this.activeCalls.get(firstCallId);\r\n    const secondCall = this.activeCalls.get(secondCallId);\r\n    if (firstCall && secondCall) {\r\n      const firstPeer = (firstCall.sessionDescriptionHandler as Web.SessionDescriptionHandler)\r\n        ?.peerConnection;\r\n      const secondPeer = (firstCall.sessionDescriptionHandler as Web.SessionDescriptionHandler)\r\n        ?.peerConnection;\r\n      const firstSendedTrack = firstPeer\r\n        ?.getSenders()\r\n        .filter((str) => str.track?.kind === \"audio\")[0].track;\r\n      const secondSendedTrack = secondPeer\r\n        ?.getSenders()\r\n        .filter((str) => str.track?.kind === \"audio\")[0].track;\r\n      const firstReceivedStream = new MediaStream();\r\n      const firstReceivedTrack = firstPeer\r\n        ?.getReceivers()\r\n        .filter((str) => str.track.kind === \"audio\")[0].track;\r\n      firstReceivedTrack && firstReceivedStream.addTrack(firstReceivedTrack);\r\n      const secondReceivedStream = new MediaStream();\r\n      const secondReceivedTrack = secondPeer\r\n        ?.getReceivers()\r\n        .filter((str) => str.track.kind === \"audio\")[0].track;\r\n      secondReceivedTrack && secondReceivedStream.addTrack(secondReceivedTrack);\r\n      if (\r\n        firstSendedTrack &&\r\n        secondSendedTrack &&\r\n        firstReceivedStream &&\r\n        secondReceivedStream\r\n      ) {\r\n        const firtsLocalMediaStream = new MediaStream();\r\n        const secondLocalMediaStream = new MediaStream();\r\n        firtsLocalMediaStream.addTrack(firstSendedTrack);\r\n        secondLocalMediaStream.addTrack(secondSendedTrack);\r\n        firstPeer\r\n          ?.getSenders()\r\n          .filter((str) => str.track?.kind === \"audio\")[0]\r\n          .replaceTrack(\r\n            this.mixAudios(\r\n              firtsLocalMediaStream,\r\n              secondReceivedStream\r\n            ).getAudioTracks()[0]\r\n          );\r\n        secondPeer\r\n          ?.getSenders()\r\n          .filter((str) => str.track?.kind === \"audio\")[0]\r\n          .replaceTrack(\r\n            this.mixAudios(\r\n              secondLocalMediaStream,\r\n              firstReceivedStream\r\n            ).getAudioTracks()[0]\r\n          );\r\n      }\r\n    }\r\n  };\r\n}\r\n"]},"metadata":{},"sourceType":"module"}