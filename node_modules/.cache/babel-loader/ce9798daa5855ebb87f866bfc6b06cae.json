{"ast":null,"code":"// Last time updated: 2019-06-21 4:09:42 AM UTC\n// ________________________\n// MultiStreamsMixer v1.2.2\n// Open-Sourced: https://github.com/muaz-khan/MultiStreamsMixer\n// --------------------------------------------------\n// Muaz Khan     - www.MuazKhan.com\n// MIT License   - www.WebRTC-Experiment.com/licence\n// --------------------------------------------------\nfunction MultiStreamsMixer(arrayOfMediaStreams, elementClass) {\n  var browserFakeUserAgent = 'Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45';\n\n  (function (that) {\n    if (typeof RecordRTC !== 'undefined') {\n      return;\n    }\n\n    if (!that) {\n      return;\n    }\n\n    if (typeof window !== 'undefined') {\n      return;\n    }\n\n    if (typeof global === 'undefined') {\n      return;\n    }\n\n    global.navigator = {\n      userAgent: browserFakeUserAgent,\n      getUserMedia: function getUserMedia() {}\n    };\n\n    if (!global.console) {\n      global.console = {};\n    }\n\n    if (typeof global.console.log === 'undefined' || typeof global.console.error === 'undefined') {\n      global.console.error = global.console.log = global.console.log || function () {\n        console.log(arguments);\n      };\n    }\n\n    if (typeof document === 'undefined') {\n      /*global document:true */\n      that.document = {\n        documentElement: {\n          appendChild: function appendChild() {\n            return '';\n          }\n        }\n      };\n\n      document.createElement = document.captureStream = document.mozCaptureStream = function () {\n        var obj = {\n          getContext: function getContext() {\n            return obj;\n          },\n          play: function play() {},\n          pause: function pause() {},\n          drawImage: function drawImage() {},\n          toDataURL: function toDataURL() {\n            return '';\n          },\n          style: {}\n        };\n        return obj;\n      };\n\n      that.HTMLVideoElement = function () {};\n    }\n\n    if (typeof location === 'undefined') {\n      /*global location:true */\n      that.location = {\n        protocol: 'file:',\n        href: '',\n        hash: ''\n      };\n    }\n\n    if (typeof screen === 'undefined') {\n      /*global screen:true */\n      that.screen = {\n        width: 0,\n        height: 0\n      };\n    }\n\n    if (typeof URL === 'undefined') {\n      /*global screen:true */\n      that.URL = {\n        createObjectURL: function createObjectURL() {\n          return '';\n        },\n        revokeObjectURL: function revokeObjectURL() {\n          return '';\n        }\n      };\n    }\n    /*global window:true */\n\n\n    that.window = global;\n  })(typeof global !== 'undefined' ? global : null); // requires: chrome://flags/#enable-experimental-web-platform-features\n\n\n  elementClass = elementClass || 'multi-streams-mixer';\n  var videos = [];\n  var isStopDrawingFrames = false;\n  var canvas = document.createElement('canvas');\n  var context = canvas.getContext('2d');\n  canvas.style.opacity = 0;\n  canvas.style.position = 'absolute';\n  canvas.style.zIndex = -1;\n  canvas.style.top = '-1000em';\n  canvas.style.left = '-1000em';\n  canvas.className = elementClass;\n  (document.body || document.documentElement).appendChild(canvas);\n  this.disableLogs = false;\n  this.frameInterval = 10;\n  this.width = 360;\n  this.height = 240; // use gain node to prevent echo\n\n  this.useGainNode = true;\n  var self = this; // _____________________________\n  // Cross-Browser-Declarations.js\n  // WebAudio API representer\n\n  var AudioContext = window.AudioContext;\n\n  if (typeof AudioContext === 'undefined') {\n    if (typeof webkitAudioContext !== 'undefined') {\n      /*global AudioContext:true */\n      AudioContext = webkitAudioContext;\n    }\n\n    if (typeof mozAudioContext !== 'undefined') {\n      /*global AudioContext:true */\n      AudioContext = mozAudioContext;\n    }\n  }\n  /*jshint -W079 */\n\n\n  var URL = window.URL;\n\n  if (typeof URL === 'undefined' && typeof webkitURL !== 'undefined') {\n    /*global URL:true */\n    URL = webkitURL;\n  }\n\n  if (typeof navigator !== 'undefined' && typeof navigator.getUserMedia === 'undefined') {\n    // maybe window.navigator?\n    if (typeof navigator.webkitGetUserMedia !== 'undefined') {\n      navigator.getUserMedia = navigator.webkitGetUserMedia;\n    }\n\n    if (typeof navigator.mozGetUserMedia !== 'undefined') {\n      navigator.getUserMedia = navigator.mozGetUserMedia;\n    }\n  }\n\n  var MediaStream = window.MediaStream;\n\n  if (typeof MediaStream === 'undefined' && typeof webkitMediaStream !== 'undefined') {\n    MediaStream = webkitMediaStream;\n  }\n  /*global MediaStream:true */\n\n\n  if (typeof MediaStream !== 'undefined') {\n    // override \"stop\" method for all browsers\n    if (typeof MediaStream.prototype.stop === 'undefined') {\n      MediaStream.prototype.stop = function () {\n        this.getTracks().forEach(function (track) {\n          track.stop();\n        });\n      };\n    }\n  }\n\n  var Storage = {};\n\n  if (typeof AudioContext !== 'undefined') {\n    Storage.AudioContext = AudioContext;\n  } else if (typeof webkitAudioContext !== 'undefined') {\n    Storage.AudioContext = webkitAudioContext;\n  }\n\n  function setSrcObject(stream, element) {\n    if ('srcObject' in element) {\n      element.srcObject = stream;\n    } else if ('mozSrcObject' in element) {\n      element.mozSrcObject = stream;\n    } else {\n      element.srcObject = stream;\n    }\n  }\n\n  this.startDrawingFrames = function () {\n    drawVideosToCanvas();\n  };\n\n  function drawVideosToCanvas() {\n    if (isStopDrawingFrames) {\n      return;\n    }\n\n    var videosLength = videos.length;\n    var fullcanvas = false;\n    var remaining = [];\n    videos.forEach(function (video) {\n      if (!video.stream) {\n        video.stream = {};\n      }\n\n      if (video.stream.fullcanvas) {\n        fullcanvas = video;\n      } else {\n        // todo: video.stream.active or video.stream.live to fix blank frames issues?\n        remaining.push(video);\n      }\n    });\n\n    if (fullcanvas) {\n      canvas.width = fullcanvas.stream.width;\n      canvas.height = fullcanvas.stream.height;\n    } else if (remaining.length) {\n      canvas.width = videosLength > 1 ? remaining[0].width * 2 : remaining[0].width;\n      var height = 1;\n\n      if (videosLength === 3 || videosLength === 4) {\n        height = 2;\n      }\n\n      if (videosLength === 5 || videosLength === 6) {\n        height = 3;\n      }\n\n      if (videosLength === 7 || videosLength === 8) {\n        height = 4;\n      }\n\n      if (videosLength === 9 || videosLength === 10) {\n        height = 5;\n      }\n\n      canvas.height = remaining[0].height * height;\n    } else {\n      canvas.width = self.width || 360;\n      canvas.height = self.height || 240;\n    }\n\n    if (fullcanvas && fullcanvas instanceof HTMLVideoElement) {\n      drawImage(fullcanvas);\n    }\n\n    remaining.forEach(function (video, idx) {\n      drawImage(video, idx);\n    });\n    setTimeout(drawVideosToCanvas, self.frameInterval);\n  }\n\n  function drawImage(video, idx) {\n    if (isStopDrawingFrames) {\n      return;\n    }\n\n    var x = 0;\n    var y = 0;\n    var width = video.width;\n    var height = video.height;\n\n    if (idx === 1) {\n      x = video.width;\n    }\n\n    if (idx === 2) {\n      y = video.height;\n    }\n\n    if (idx === 3) {\n      x = video.width;\n      y = video.height;\n    }\n\n    if (idx === 4) {\n      y = video.height * 2;\n    }\n\n    if (idx === 5) {\n      x = video.width;\n      y = video.height * 2;\n    }\n\n    if (idx === 6) {\n      y = video.height * 3;\n    }\n\n    if (idx === 7) {\n      x = video.width;\n      y = video.height * 3;\n    }\n\n    if (typeof video.stream.left !== 'undefined') {\n      x = video.stream.left;\n    }\n\n    if (typeof video.stream.top !== 'undefined') {\n      y = video.stream.top;\n    }\n\n    if (typeof video.stream.width !== 'undefined') {\n      width = video.stream.width;\n    }\n\n    if (typeof video.stream.height !== 'undefined') {\n      height = video.stream.height;\n    }\n\n    context.drawImage(video, x, y, width, height);\n\n    if (typeof video.stream.onRender === 'function') {\n      video.stream.onRender(context, x, y, width, height, idx);\n    }\n  }\n\n  function getMixedStream() {\n    isStopDrawingFrames = false;\n    var mixedVideoStream = getMixedVideoStream();\n    var mixedAudioStream = getMixedAudioStream();\n\n    if (mixedAudioStream) {\n      mixedAudioStream.getTracks().filter(function (t) {\n        return t.kind === 'audio';\n      }).forEach(function (track) {\n        mixedVideoStream.addTrack(track);\n      });\n    }\n\n    var fullcanvas;\n    arrayOfMediaStreams.forEach(function (stream) {\n      if (stream.fullcanvas) {\n        fullcanvas = true;\n      }\n    }); // mixedVideoStream.prototype.appendStreams = appendStreams;\n    // mixedVideoStream.prototype.resetVideoStreams = resetVideoStreams;\n    // mixedVideoStream.prototype.clearRecordedData = clearRecordedData;\n\n    return mixedVideoStream;\n  }\n\n  function getMixedVideoStream() {\n    resetVideoStreams();\n    var capturedStream;\n\n    if ('captureStream' in canvas) {\n      capturedStream = canvas.captureStream();\n    } else if ('mozCaptureStream' in canvas) {\n      capturedStream = canvas.mozCaptureStream();\n    } else if (!self.disableLogs) {\n      console.error('Upgrade to latest Chrome or otherwise enable this flag: chrome://flags/#enable-experimental-web-platform-features');\n    }\n\n    var videoStream = new MediaStream();\n    capturedStream.getTracks().filter(function (t) {\n      return t.kind === 'video';\n    }).forEach(function (track) {\n      videoStream.addTrack(track);\n    });\n    canvas.stream = videoStream;\n    return videoStream;\n  }\n\n  function getMixedAudioStream() {\n    // via: @pehrsons\n    if (!Storage.AudioContextConstructor) {\n      Storage.AudioContextConstructor = new Storage.AudioContext();\n    }\n\n    self.audioContext = Storage.AudioContextConstructor;\n    self.audioSources = [];\n\n    if (self.useGainNode === true) {\n      self.gainNode = self.audioContext.createGain();\n      self.gainNode.connect(self.audioContext.destination);\n      self.gainNode.gain.value = 0; // don't hear self\n    }\n\n    var audioTracksLength = 0;\n    arrayOfMediaStreams.forEach(function (stream) {\n      if (!stream.getTracks().filter(function (t) {\n        return t.kind === 'audio';\n      }).length) {\n        return;\n      }\n\n      audioTracksLength++;\n      var audioSource = self.audioContext.createMediaStreamSource(stream);\n\n      if (self.useGainNode === true) {\n        audioSource.connect(self.gainNode);\n      }\n\n      self.audioSources.push(audioSource);\n    });\n\n    if (!audioTracksLength) {\n      // because \"self.audioContext\" is not initialized\n      // that's why we've to ignore rest of the code\n      return;\n    }\n\n    self.audioDestination = self.audioContext.createMediaStreamDestination();\n    self.audioSources.forEach(function (audioSource) {\n      audioSource.connect(self.audioDestination);\n    });\n    return self.audioDestination.stream;\n  }\n\n  function getVideo(stream) {\n    var video = document.createElement('video');\n    setSrcObject(stream, video);\n    video.className = elementClass;\n    video.muted = true;\n    video.volume = 0;\n    video.width = stream.width || self.width || 360;\n    video.height = stream.height || self.height || 240;\n    video.play();\n    return video;\n  }\n\n  this.appendStreams = function (streams) {\n    if (!streams) {\n      throw 'First parameter is required.';\n    }\n\n    if (!(streams instanceof Array)) {\n      streams = [streams];\n    }\n\n    streams.forEach(function (stream) {\n      var newStream = new MediaStream();\n\n      if (stream.getTracks().filter(function (t) {\n        return t.kind === 'video';\n      }).length) {\n        var video = getVideo(stream);\n        video.stream = stream;\n        videos.push(video);\n        newStream.addTrack(stream.getTracks().filter(function (t) {\n          return t.kind === 'video';\n        })[0]);\n      }\n\n      if (stream.getTracks().filter(function (t) {\n        return t.kind === 'audio';\n      }).length) {\n        var audioSource = self.audioContext.createMediaStreamSource(stream);\n        self.audioDestination = self.audioContext.createMediaStreamDestination();\n        audioSource.connect(self.audioDestination);\n        newStream.addTrack(self.audioDestination.stream.getTracks().filter(function (t) {\n          return t.kind === 'audio';\n        })[0]);\n      }\n\n      arrayOfMediaStreams.push(newStream);\n    });\n  };\n\n  this.releaseStreams = function () {\n    videos = [];\n    isStopDrawingFrames = true;\n\n    if (self.gainNode) {\n      self.gainNode.disconnect();\n      self.gainNode = null;\n    }\n\n    if (self.audioSources.length) {\n      self.audioSources.forEach(function (source) {\n        source.disconnect();\n      });\n      self.audioSources = [];\n    }\n\n    if (self.audioDestination) {\n      self.audioDestination.disconnect();\n      self.audioDestination = null;\n    }\n\n    if (self.audioContext) {\n      self.audioContext.close();\n    }\n\n    self.audioContext = null;\n    context.clearRect(0, 0, canvas.width, canvas.height);\n\n    if (canvas.stream) {\n      canvas.stream.stop();\n      canvas.stream = null;\n    }\n  };\n\n  this.resetVideoStreams = function (streams) {\n    if (streams && !(streams instanceof Array)) {\n      streams = [streams];\n    }\n\n    resetVideoStreams(streams);\n  };\n\n  function resetVideoStreams(streams) {\n    videos = [];\n    streams = streams || arrayOfMediaStreams; // via: @adrian-ber\n\n    streams.forEach(function (stream) {\n      if (!stream.getTracks().filter(function (t) {\n        return t.kind === 'video';\n      }).length) {\n        return;\n      }\n\n      var video = getVideo(stream);\n      video.stream = stream;\n      videos.push(video);\n    });\n  } // for debugging\n\n\n  this.name = 'MultiStreamsMixer';\n\n  this.toString = function () {\n    return this.name;\n  };\n\n  this.getMixedStream = getMixedStream;\n}\n\nif (typeof RecordRTC === 'undefined') {\n  if (typeof module !== 'undefined'\n  /* && !!module.exports*/\n  ) {\n      module.exports = MultiStreamsMixer;\n    }\n\n  if (typeof define === 'function' && define.amd) {\n    define('MultiStreamsMixer', [], function () {\n      return MultiStreamsMixer;\n    });\n  }\n}","map":{"version":3,"sources":["C:/Users/Digivox/dev/Digivox/Refatoracao/squad/node_modules/multistreamsmixer/MultiStreamsMixer.js"],"names":["MultiStreamsMixer","arrayOfMediaStreams","elementClass","browserFakeUserAgent","that","RecordRTC","window","global","navigator","userAgent","getUserMedia","console","log","error","arguments","document","documentElement","appendChild","createElement","captureStream","mozCaptureStream","obj","getContext","play","pause","drawImage","toDataURL","style","HTMLVideoElement","location","protocol","href","hash","screen","width","height","URL","createObjectURL","revokeObjectURL","videos","isStopDrawingFrames","canvas","context","opacity","position","zIndex","top","left","className","body","disableLogs","frameInterval","useGainNode","self","AudioContext","webkitAudioContext","mozAudioContext","webkitURL","webkitGetUserMedia","mozGetUserMedia","MediaStream","webkitMediaStream","prototype","stop","getTracks","forEach","track","Storage","setSrcObject","stream","element","srcObject","mozSrcObject","startDrawingFrames","drawVideosToCanvas","videosLength","length","fullcanvas","remaining","video","push","idx","setTimeout","x","y","onRender","getMixedStream","mixedVideoStream","getMixedVideoStream","mixedAudioStream","getMixedAudioStream","filter","t","kind","addTrack","resetVideoStreams","capturedStream","videoStream","AudioContextConstructor","audioContext","audioSources","gainNode","createGain","connect","destination","gain","value","audioTracksLength","audioSource","createMediaStreamSource","audioDestination","createMediaStreamDestination","getVideo","muted","volume","appendStreams","streams","Array","newStream","releaseStreams","disconnect","source","close","clearRect","name","toString","module","exports","define","amd"],"mappings":"AAAA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA,SAASA,iBAAT,CAA2BC,mBAA3B,EAAgDC,YAAhD,EAA8D;AAE1D,MAAIC,oBAAoB,GAAG,qFAA3B;;AAEA,GAAC,UAASC,IAAT,EAAe;AACZ,QAAI,OAAOC,SAAP,KAAqB,WAAzB,EAAsC;AAClC;AACH;;AAED,QAAI,CAACD,IAAL,EAAW;AACP;AACH;;AAED,QAAI,OAAOE,MAAP,KAAkB,WAAtB,EAAmC;AAC/B;AACH;;AAED,QAAI,OAAOC,MAAP,KAAkB,WAAtB,EAAmC;AAC/B;AACH;;AAEDA,IAAAA,MAAM,CAACC,SAAP,GAAmB;AACfC,MAAAA,SAAS,EAAEN,oBADI;AAEfO,MAAAA,YAAY,EAAE,wBAAW,CAAE;AAFZ,KAAnB;;AAKA,QAAI,CAACH,MAAM,CAACI,OAAZ,EAAqB;AACjBJ,MAAAA,MAAM,CAACI,OAAP,GAAiB,EAAjB;AACH;;AAED,QAAI,OAAOJ,MAAM,CAACI,OAAP,CAAeC,GAAtB,KAA8B,WAA9B,IAA6C,OAAOL,MAAM,CAACI,OAAP,CAAeE,KAAtB,KAAgC,WAAjF,EAA8F;AAC1FN,MAAAA,MAAM,CAACI,OAAP,CAAeE,KAAf,GAAuBN,MAAM,CAACI,OAAP,CAAeC,GAAf,GAAqBL,MAAM,CAACI,OAAP,CAAeC,GAAf,IAAsB,YAAW;AACzED,QAAAA,OAAO,CAACC,GAAR,CAAYE,SAAZ;AACH,OAFD;AAGH;;AAED,QAAI,OAAOC,QAAP,KAAoB,WAAxB,EAAqC;AACjC;AACAX,MAAAA,IAAI,CAACW,QAAL,GAAgB;AACZC,QAAAA,eAAe,EAAE;AACbC,UAAAA,WAAW,EAAE,uBAAW;AACpB,mBAAO,EAAP;AACH;AAHY;AADL,OAAhB;;AAQAF,MAAAA,QAAQ,CAACG,aAAT,GAAyBH,QAAQ,CAACI,aAAT,GAAyBJ,QAAQ,CAACK,gBAAT,GAA4B,YAAW;AACrF,YAAIC,GAAG,GAAG;AACNC,UAAAA,UAAU,EAAE,sBAAW;AACnB,mBAAOD,GAAP;AACH,WAHK;AAINE,UAAAA,IAAI,EAAE,gBAAW,CAAE,CAJb;AAKNC,UAAAA,KAAK,EAAE,iBAAW,CAAE,CALd;AAMNC,UAAAA,SAAS,EAAE,qBAAW,CAAE,CANlB;AAONC,UAAAA,SAAS,EAAE,qBAAW;AAClB,mBAAO,EAAP;AACH,WATK;AAUNC,UAAAA,KAAK,EAAE;AAVD,SAAV;AAYA,eAAON,GAAP;AACH,OAdD;;AAgBAjB,MAAAA,IAAI,CAACwB,gBAAL,GAAwB,YAAW,CAAE,CAArC;AACH;;AAED,QAAI,OAAOC,QAAP,KAAoB,WAAxB,EAAqC;AACjC;AACAzB,MAAAA,IAAI,CAACyB,QAAL,GAAgB;AACZC,QAAAA,QAAQ,EAAE,OADE;AAEZC,QAAAA,IAAI,EAAE,EAFM;AAGZC,QAAAA,IAAI,EAAE;AAHM,OAAhB;AAKH;;AAED,QAAI,OAAOC,MAAP,KAAkB,WAAtB,EAAmC;AAC/B;AACA7B,MAAAA,IAAI,CAAC6B,MAAL,GAAc;AACVC,QAAAA,KAAK,EAAE,CADG;AAEVC,QAAAA,MAAM,EAAE;AAFE,OAAd;AAIH;;AAED,QAAI,OAAOC,GAAP,KAAe,WAAnB,EAAgC;AAC5B;AACAhC,MAAAA,IAAI,CAACgC,GAAL,GAAW;AACPC,QAAAA,eAAe,EAAE,2BAAW;AACxB,iBAAO,EAAP;AACH,SAHM;AAIPC,QAAAA,eAAe,EAAE,2BAAW;AACxB,iBAAO,EAAP;AACH;AANM,OAAX;AAQH;AAED;;;AACAlC,IAAAA,IAAI,CAACE,MAAL,GAAcC,MAAd;AACH,GA5FD,EA4FG,OAAOA,MAAP,KAAkB,WAAlB,GAAgCA,MAAhC,GAAyC,IA5F5C,EAJ0D,CAkG1D;;;AAEAL,EAAAA,YAAY,GAAGA,YAAY,IAAI,qBAA/B;AAEA,MAAIqC,MAAM,GAAG,EAAb;AACA,MAAIC,mBAAmB,GAAG,KAA1B;AAEA,MAAIC,MAAM,GAAG1B,QAAQ,CAACG,aAAT,CAAuB,QAAvB,CAAb;AACA,MAAIwB,OAAO,GAAGD,MAAM,CAACnB,UAAP,CAAkB,IAAlB,CAAd;AACAmB,EAAAA,MAAM,CAACd,KAAP,CAAagB,OAAb,GAAuB,CAAvB;AACAF,EAAAA,MAAM,CAACd,KAAP,CAAaiB,QAAb,GAAwB,UAAxB;AACAH,EAAAA,MAAM,CAACd,KAAP,CAAakB,MAAb,GAAsB,CAAC,CAAvB;AACAJ,EAAAA,MAAM,CAACd,KAAP,CAAamB,GAAb,GAAmB,SAAnB;AACAL,EAAAA,MAAM,CAACd,KAAP,CAAaoB,IAAb,GAAoB,SAApB;AACAN,EAAAA,MAAM,CAACO,SAAP,GAAmB9C,YAAnB;AACA,GAACa,QAAQ,CAACkC,IAAT,IAAiBlC,QAAQ,CAACC,eAA3B,EAA4CC,WAA5C,CAAwDwB,MAAxD;AAEA,OAAKS,WAAL,GAAmB,KAAnB;AACA,OAAKC,aAAL,GAAqB,EAArB;AAEA,OAAKjB,KAAL,GAAa,GAAb;AACA,OAAKC,MAAL,GAAc,GAAd,CAvH0D,CAyH1D;;AACA,OAAKiB,WAAL,GAAmB,IAAnB;AAEA,MAAIC,IAAI,GAAG,IAAX,CA5H0D,CA8H1D;AACA;AAEA;;AACA,MAAIC,YAAY,GAAGhD,MAAM,CAACgD,YAA1B;;AAEA,MAAI,OAAOA,YAAP,KAAwB,WAA5B,EAAyC;AACrC,QAAI,OAAOC,kBAAP,KAA8B,WAAlC,EAA+C;AAC3C;AACAD,MAAAA,YAAY,GAAGC,kBAAf;AACH;;AAED,QAAI,OAAOC,eAAP,KAA2B,WAA/B,EAA4C;AACxC;AACAF,MAAAA,YAAY,GAAGE,eAAf;AACH;AACJ;AAED;;;AACA,MAAIpB,GAAG,GAAG9B,MAAM,CAAC8B,GAAjB;;AAEA,MAAI,OAAOA,GAAP,KAAe,WAAf,IAA8B,OAAOqB,SAAP,KAAqB,WAAvD,EAAoE;AAChE;AACArB,IAAAA,GAAG,GAAGqB,SAAN;AACH;;AAED,MAAI,OAAOjD,SAAP,KAAqB,WAArB,IAAoC,OAAOA,SAAS,CAACE,YAAjB,KAAkC,WAA1E,EAAuF;AAAE;AACrF,QAAI,OAAOF,SAAS,CAACkD,kBAAjB,KAAwC,WAA5C,EAAyD;AACrDlD,MAAAA,SAAS,CAACE,YAAV,GAAyBF,SAAS,CAACkD,kBAAnC;AACH;;AAED,QAAI,OAAOlD,SAAS,CAACmD,eAAjB,KAAqC,WAAzC,EAAsD;AAClDnD,MAAAA,SAAS,CAACE,YAAV,GAAyBF,SAAS,CAACmD,eAAnC;AACH;AACJ;;AAED,MAAIC,WAAW,GAAGtD,MAAM,CAACsD,WAAzB;;AAEA,MAAI,OAAOA,WAAP,KAAuB,WAAvB,IAAsC,OAAOC,iBAAP,KAA6B,WAAvE,EAAoF;AAChFD,IAAAA,WAAW,GAAGC,iBAAd;AACH;AAED;;;AACA,MAAI,OAAOD,WAAP,KAAuB,WAA3B,EAAwC;AACpC;AACA,QAAI,OAAOA,WAAW,CAACE,SAAZ,CAAsBC,IAA7B,KAAsC,WAA1C,EAAuD;AACnDH,MAAAA,WAAW,CAACE,SAAZ,CAAsBC,IAAtB,GAA6B,YAAW;AACpC,aAAKC,SAAL,GAAiBC,OAAjB,CAAyB,UAASC,KAAT,EAAgB;AACrCA,UAAAA,KAAK,CAACH,IAAN;AACH,SAFD;AAGH,OAJD;AAKH;AACJ;;AAED,MAAII,OAAO,GAAG,EAAd;;AAEA,MAAI,OAAOb,YAAP,KAAwB,WAA5B,EAAyC;AACrCa,IAAAA,OAAO,CAACb,YAAR,GAAuBA,YAAvB;AACH,GAFD,MAEO,IAAI,OAAOC,kBAAP,KAA8B,WAAlC,EAA+C;AAClDY,IAAAA,OAAO,CAACb,YAAR,GAAuBC,kBAAvB;AACH;;AAED,WAASa,YAAT,CAAsBC,MAAtB,EAA8BC,OAA9B,EAAuC;AACnC,QAAI,eAAeA,OAAnB,EAA4B;AACxBA,MAAAA,OAAO,CAACC,SAAR,GAAoBF,MAApB;AACH,KAFD,MAEO,IAAI,kBAAkBC,OAAtB,EAA+B;AAClCA,MAAAA,OAAO,CAACE,YAAR,GAAuBH,MAAvB;AACH,KAFM,MAEA;AACHC,MAAAA,OAAO,CAACC,SAAR,GAAoBF,MAApB;AACH;AACJ;;AAED,OAAKI,kBAAL,GAA0B,YAAW;AACjCC,IAAAA,kBAAkB;AACrB,GAFD;;AAIA,WAASA,kBAAT,GAA8B;AAC1B,QAAIlC,mBAAJ,EAAyB;AACrB;AACH;;AAED,QAAImC,YAAY,GAAGpC,MAAM,CAACqC,MAA1B;AAEA,QAAIC,UAAU,GAAG,KAAjB;AACA,QAAIC,SAAS,GAAG,EAAhB;AACAvC,IAAAA,MAAM,CAAC0B,OAAP,CAAe,UAASc,KAAT,EAAgB;AAC3B,UAAI,CAACA,KAAK,CAACV,MAAX,EAAmB;AACfU,QAAAA,KAAK,CAACV,MAAN,GAAe,EAAf;AACH;;AAED,UAAIU,KAAK,CAACV,MAAN,CAAaQ,UAAjB,EAA6B;AACzBA,QAAAA,UAAU,GAAGE,KAAb;AACH,OAFD,MAEO;AACH;AACAD,QAAAA,SAAS,CAACE,IAAV,CAAeD,KAAf;AACH;AACJ,KAXD;;AAaA,QAAIF,UAAJ,EAAgB;AACZpC,MAAAA,MAAM,CAACP,KAAP,GAAe2C,UAAU,CAACR,MAAX,CAAkBnC,KAAjC;AACAO,MAAAA,MAAM,CAACN,MAAP,GAAgB0C,UAAU,CAACR,MAAX,CAAkBlC,MAAlC;AACH,KAHD,MAGO,IAAI2C,SAAS,CAACF,MAAd,EAAsB;AACzBnC,MAAAA,MAAM,CAACP,KAAP,GAAeyC,YAAY,GAAG,CAAf,GAAmBG,SAAS,CAAC,CAAD,CAAT,CAAa5C,KAAb,GAAqB,CAAxC,GAA4C4C,SAAS,CAAC,CAAD,CAAT,CAAa5C,KAAxE;AAEA,UAAIC,MAAM,GAAG,CAAb;;AACA,UAAIwC,YAAY,KAAK,CAAjB,IAAsBA,YAAY,KAAK,CAA3C,EAA8C;AAC1CxC,QAAAA,MAAM,GAAG,CAAT;AACH;;AACD,UAAIwC,YAAY,KAAK,CAAjB,IAAsBA,YAAY,KAAK,CAA3C,EAA8C;AAC1CxC,QAAAA,MAAM,GAAG,CAAT;AACH;;AACD,UAAIwC,YAAY,KAAK,CAAjB,IAAsBA,YAAY,KAAK,CAA3C,EAA8C;AAC1CxC,QAAAA,MAAM,GAAG,CAAT;AACH;;AACD,UAAIwC,YAAY,KAAK,CAAjB,IAAsBA,YAAY,KAAK,EAA3C,EAA+C;AAC3CxC,QAAAA,MAAM,GAAG,CAAT;AACH;;AACDM,MAAAA,MAAM,CAACN,MAAP,GAAgB2C,SAAS,CAAC,CAAD,CAAT,CAAa3C,MAAb,GAAsBA,MAAtC;AACH,KAjBM,MAiBA;AACHM,MAAAA,MAAM,CAACP,KAAP,GAAemB,IAAI,CAACnB,KAAL,IAAc,GAA7B;AACAO,MAAAA,MAAM,CAACN,MAAP,GAAgBkB,IAAI,CAAClB,MAAL,IAAe,GAA/B;AACH;;AAED,QAAI0C,UAAU,IAAIA,UAAU,YAAYjD,gBAAxC,EAA0D;AACtDH,MAAAA,SAAS,CAACoD,UAAD,CAAT;AACH;;AAEDC,IAAAA,SAAS,CAACb,OAAV,CAAkB,UAASc,KAAT,EAAgBE,GAAhB,EAAqB;AACnCxD,MAAAA,SAAS,CAACsD,KAAD,EAAQE,GAAR,CAAT;AACH,KAFD;AAIAC,IAAAA,UAAU,CAACR,kBAAD,EAAqBrB,IAAI,CAACF,aAA1B,CAAV;AACH;;AAED,WAAS1B,SAAT,CAAmBsD,KAAnB,EAA0BE,GAA1B,EAA+B;AAC3B,QAAIzC,mBAAJ,EAAyB;AACrB;AACH;;AAED,QAAI2C,CAAC,GAAG,CAAR;AACA,QAAIC,CAAC,GAAG,CAAR;AACA,QAAIlD,KAAK,GAAG6C,KAAK,CAAC7C,KAAlB;AACA,QAAIC,MAAM,GAAG4C,KAAK,CAAC5C,MAAnB;;AAEA,QAAI8C,GAAG,KAAK,CAAZ,EAAe;AACXE,MAAAA,CAAC,GAAGJ,KAAK,CAAC7C,KAAV;AACH;;AAED,QAAI+C,GAAG,KAAK,CAAZ,EAAe;AACXG,MAAAA,CAAC,GAAGL,KAAK,CAAC5C,MAAV;AACH;;AAED,QAAI8C,GAAG,KAAK,CAAZ,EAAe;AACXE,MAAAA,CAAC,GAAGJ,KAAK,CAAC7C,KAAV;AACAkD,MAAAA,CAAC,GAAGL,KAAK,CAAC5C,MAAV;AACH;;AAED,QAAI8C,GAAG,KAAK,CAAZ,EAAe;AACXG,MAAAA,CAAC,GAAGL,KAAK,CAAC5C,MAAN,GAAe,CAAnB;AACH;;AAED,QAAI8C,GAAG,KAAK,CAAZ,EAAe;AACXE,MAAAA,CAAC,GAAGJ,KAAK,CAAC7C,KAAV;AACAkD,MAAAA,CAAC,GAAGL,KAAK,CAAC5C,MAAN,GAAe,CAAnB;AACH;;AAED,QAAI8C,GAAG,KAAK,CAAZ,EAAe;AACXG,MAAAA,CAAC,GAAGL,KAAK,CAAC5C,MAAN,GAAe,CAAnB;AACH;;AAED,QAAI8C,GAAG,KAAK,CAAZ,EAAe;AACXE,MAAAA,CAAC,GAAGJ,KAAK,CAAC7C,KAAV;AACAkD,MAAAA,CAAC,GAAGL,KAAK,CAAC5C,MAAN,GAAe,CAAnB;AACH;;AAED,QAAI,OAAO4C,KAAK,CAACV,MAAN,CAAatB,IAApB,KAA6B,WAAjC,EAA8C;AAC1CoC,MAAAA,CAAC,GAAGJ,KAAK,CAACV,MAAN,CAAatB,IAAjB;AACH;;AAED,QAAI,OAAOgC,KAAK,CAACV,MAAN,CAAavB,GAApB,KAA4B,WAAhC,EAA6C;AACzCsC,MAAAA,CAAC,GAAGL,KAAK,CAACV,MAAN,CAAavB,GAAjB;AACH;;AAED,QAAI,OAAOiC,KAAK,CAACV,MAAN,CAAanC,KAApB,KAA8B,WAAlC,EAA+C;AAC3CA,MAAAA,KAAK,GAAG6C,KAAK,CAACV,MAAN,CAAanC,KAArB;AACH;;AAED,QAAI,OAAO6C,KAAK,CAACV,MAAN,CAAalC,MAApB,KAA+B,WAAnC,EAAgD;AAC5CA,MAAAA,MAAM,GAAG4C,KAAK,CAACV,MAAN,CAAalC,MAAtB;AACH;;AAEDO,IAAAA,OAAO,CAACjB,SAAR,CAAkBsD,KAAlB,EAAyBI,CAAzB,EAA4BC,CAA5B,EAA+BlD,KAA/B,EAAsCC,MAAtC;;AAEA,QAAI,OAAO4C,KAAK,CAACV,MAAN,CAAagB,QAApB,KAAiC,UAArC,EAAiD;AAC7CN,MAAAA,KAAK,CAACV,MAAN,CAAagB,QAAb,CAAsB3C,OAAtB,EAA+ByC,CAA/B,EAAkCC,CAAlC,EAAqClD,KAArC,EAA4CC,MAA5C,EAAoD8C,GAApD;AACH;AACJ;;AAED,WAASK,cAAT,GAA0B;AACtB9C,IAAAA,mBAAmB,GAAG,KAAtB;AACA,QAAI+C,gBAAgB,GAAGC,mBAAmB,EAA1C;AAEA,QAAIC,gBAAgB,GAAGC,mBAAmB,EAA1C;;AACA,QAAID,gBAAJ,EAAsB;AAClBA,MAAAA,gBAAgB,CAACzB,SAAjB,GAA6B2B,MAA7B,CAAoC,UAASC,CAAT,EAAY;AAC5C,eAAOA,CAAC,CAACC,IAAF,KAAW,OAAlB;AACH,OAFD,EAEG5B,OAFH,CAEW,UAASC,KAAT,EAAgB;AACvBqB,QAAAA,gBAAgB,CAACO,QAAjB,CAA0B5B,KAA1B;AACH,OAJD;AAKH;;AAED,QAAIW,UAAJ;AACA5E,IAAAA,mBAAmB,CAACgE,OAApB,CAA4B,UAASI,MAAT,EAAiB;AACzC,UAAIA,MAAM,CAACQ,UAAX,EAAuB;AACnBA,QAAAA,UAAU,GAAG,IAAb;AACH;AACJ,KAJD,EAdsB,CAoBtB;AACA;AACA;;AAEA,WAAOU,gBAAP;AACH;;AAED,WAASC,mBAAT,GAA+B;AAC3BO,IAAAA,iBAAiB;AAEjB,QAAIC,cAAJ;;AAEA,QAAI,mBAAmBvD,MAAvB,EAA+B;AAC3BuD,MAAAA,cAAc,GAAGvD,MAAM,CAACtB,aAAP,EAAjB;AACH,KAFD,MAEO,IAAI,sBAAsBsB,MAA1B,EAAkC;AACrCuD,MAAAA,cAAc,GAAGvD,MAAM,CAACrB,gBAAP,EAAjB;AACH,KAFM,MAEA,IAAI,CAACiC,IAAI,CAACH,WAAV,EAAuB;AAC1BvC,MAAAA,OAAO,CAACE,KAAR,CAAc,mHAAd;AACH;;AAED,QAAIoF,WAAW,GAAG,IAAIrC,WAAJ,EAAlB;AAEAoC,IAAAA,cAAc,CAAChC,SAAf,GAA2B2B,MAA3B,CAAkC,UAASC,CAAT,EAAY;AAC1C,aAAOA,CAAC,CAACC,IAAF,KAAW,OAAlB;AACH,KAFD,EAEG5B,OAFH,CAEW,UAASC,KAAT,EAAgB;AACvB+B,MAAAA,WAAW,CAACH,QAAZ,CAAqB5B,KAArB;AACH,KAJD;AAMAzB,IAAAA,MAAM,CAAC4B,MAAP,GAAgB4B,WAAhB;AAEA,WAAOA,WAAP;AACH;;AAED,WAASP,mBAAT,GAA+B;AAC3B;AACA,QAAI,CAACvB,OAAO,CAAC+B,uBAAb,EAAsC;AAClC/B,MAAAA,OAAO,CAAC+B,uBAAR,GAAkC,IAAI/B,OAAO,CAACb,YAAZ,EAAlC;AACH;;AAEDD,IAAAA,IAAI,CAAC8C,YAAL,GAAoBhC,OAAO,CAAC+B,uBAA5B;AAEA7C,IAAAA,IAAI,CAAC+C,YAAL,GAAoB,EAApB;;AAEA,QAAI/C,IAAI,CAACD,WAAL,KAAqB,IAAzB,EAA+B;AAC3BC,MAAAA,IAAI,CAACgD,QAAL,GAAgBhD,IAAI,CAAC8C,YAAL,CAAkBG,UAAlB,EAAhB;AACAjD,MAAAA,IAAI,CAACgD,QAAL,CAAcE,OAAd,CAAsBlD,IAAI,CAAC8C,YAAL,CAAkBK,WAAxC;AACAnD,MAAAA,IAAI,CAACgD,QAAL,CAAcI,IAAd,CAAmBC,KAAnB,GAA2B,CAA3B,CAH2B,CAGG;AACjC;;AAED,QAAIC,iBAAiB,GAAG,CAAxB;AACA1G,IAAAA,mBAAmB,CAACgE,OAApB,CAA4B,UAASI,MAAT,EAAiB;AACzC,UAAI,CAACA,MAAM,CAACL,SAAP,GAAmB2B,MAAnB,CAA0B,UAASC,CAAT,EAAY;AACnC,eAAOA,CAAC,CAACC,IAAF,KAAW,OAAlB;AACH,OAFA,EAEEjB,MAFP,EAEe;AACX;AACH;;AAED+B,MAAAA,iBAAiB;AAEjB,UAAIC,WAAW,GAAGvD,IAAI,CAAC8C,YAAL,CAAkBU,uBAAlB,CAA0CxC,MAA1C,CAAlB;;AAEA,UAAIhB,IAAI,CAACD,WAAL,KAAqB,IAAzB,EAA+B;AAC3BwD,QAAAA,WAAW,CAACL,OAAZ,CAAoBlD,IAAI,CAACgD,QAAzB;AACH;;AAEDhD,MAAAA,IAAI,CAAC+C,YAAL,CAAkBpB,IAAlB,CAAuB4B,WAAvB;AACH,KAhBD;;AAkBA,QAAI,CAACD,iBAAL,EAAwB;AACpB;AACA;AACA;AACH;;AAEDtD,IAAAA,IAAI,CAACyD,gBAAL,GAAwBzD,IAAI,CAAC8C,YAAL,CAAkBY,4BAAlB,EAAxB;AACA1D,IAAAA,IAAI,CAAC+C,YAAL,CAAkBnC,OAAlB,CAA0B,UAAS2C,WAAT,EAAsB;AAC5CA,MAAAA,WAAW,CAACL,OAAZ,CAAoBlD,IAAI,CAACyD,gBAAzB;AACH,KAFD;AAGA,WAAOzD,IAAI,CAACyD,gBAAL,CAAsBzC,MAA7B;AACH;;AAED,WAAS2C,QAAT,CAAkB3C,MAAlB,EAA0B;AACtB,QAAIU,KAAK,GAAGhE,QAAQ,CAACG,aAAT,CAAuB,OAAvB,CAAZ;AAEAkD,IAAAA,YAAY,CAACC,MAAD,EAASU,KAAT,CAAZ;AAEAA,IAAAA,KAAK,CAAC/B,SAAN,GAAkB9C,YAAlB;AAEA6E,IAAAA,KAAK,CAACkC,KAAN,GAAc,IAAd;AACAlC,IAAAA,KAAK,CAACmC,MAAN,GAAe,CAAf;AAEAnC,IAAAA,KAAK,CAAC7C,KAAN,GAAcmC,MAAM,CAACnC,KAAP,IAAgBmB,IAAI,CAACnB,KAArB,IAA8B,GAA5C;AACA6C,IAAAA,KAAK,CAAC5C,MAAN,GAAekC,MAAM,CAAClC,MAAP,IAAiBkB,IAAI,CAAClB,MAAtB,IAAgC,GAA/C;AAEA4C,IAAAA,KAAK,CAACxD,IAAN;AAEA,WAAOwD,KAAP;AACH;;AAED,OAAKoC,aAAL,GAAqB,UAASC,OAAT,EAAkB;AACnC,QAAI,CAACA,OAAL,EAAc;AACV,YAAM,8BAAN;AACH;;AAED,QAAI,EAAEA,OAAO,YAAYC,KAArB,CAAJ,EAAiC;AAC7BD,MAAAA,OAAO,GAAG,CAACA,OAAD,CAAV;AACH;;AAEDA,IAAAA,OAAO,CAACnD,OAAR,CAAgB,UAASI,MAAT,EAAiB;AAC7B,UAAIiD,SAAS,GAAG,IAAI1D,WAAJ,EAAhB;;AAEA,UAAIS,MAAM,CAACL,SAAP,GAAmB2B,MAAnB,CAA0B,UAASC,CAAT,EAAY;AAClC,eAAOA,CAAC,CAACC,IAAF,KAAW,OAAlB;AACH,OAFD,EAEGjB,MAFP,EAEe;AACX,YAAIG,KAAK,GAAGiC,QAAQ,CAAC3C,MAAD,CAApB;AACAU,QAAAA,KAAK,CAACV,MAAN,GAAeA,MAAf;AACA9B,QAAAA,MAAM,CAACyC,IAAP,CAAYD,KAAZ;AAEAuC,QAAAA,SAAS,CAACxB,QAAV,CAAmBzB,MAAM,CAACL,SAAP,GAAmB2B,MAAnB,CAA0B,UAASC,CAAT,EAAY;AACrD,iBAAOA,CAAC,CAACC,IAAF,KAAW,OAAlB;AACH,SAFkB,EAEhB,CAFgB,CAAnB;AAGH;;AAED,UAAIxB,MAAM,CAACL,SAAP,GAAmB2B,MAAnB,CAA0B,UAASC,CAAT,EAAY;AAClC,eAAOA,CAAC,CAACC,IAAF,KAAW,OAAlB;AACH,OAFD,EAEGjB,MAFP,EAEe;AACX,YAAIgC,WAAW,GAAGvD,IAAI,CAAC8C,YAAL,CAAkBU,uBAAlB,CAA0CxC,MAA1C,CAAlB;AACAhB,QAAAA,IAAI,CAACyD,gBAAL,GAAwBzD,IAAI,CAAC8C,YAAL,CAAkBY,4BAAlB,EAAxB;AACAH,QAAAA,WAAW,CAACL,OAAZ,CAAoBlD,IAAI,CAACyD,gBAAzB;AAEAQ,QAAAA,SAAS,CAACxB,QAAV,CAAmBzC,IAAI,CAACyD,gBAAL,CAAsBzC,MAAtB,CAA6BL,SAA7B,GAAyC2B,MAAzC,CAAgD,UAASC,CAAT,EAAY;AAC3E,iBAAOA,CAAC,CAACC,IAAF,KAAW,OAAlB;AACH,SAFkB,EAEhB,CAFgB,CAAnB;AAGH;;AAED5F,MAAAA,mBAAmB,CAAC+E,IAApB,CAAyBsC,SAAzB;AACH,KA5BD;AA6BH,GAtCD;;AAwCA,OAAKC,cAAL,GAAsB,YAAW;AAC7BhF,IAAAA,MAAM,GAAG,EAAT;AACAC,IAAAA,mBAAmB,GAAG,IAAtB;;AAEA,QAAIa,IAAI,CAACgD,QAAT,EAAmB;AACfhD,MAAAA,IAAI,CAACgD,QAAL,CAAcmB,UAAd;AACAnE,MAAAA,IAAI,CAACgD,QAAL,GAAgB,IAAhB;AACH;;AAED,QAAIhD,IAAI,CAAC+C,YAAL,CAAkBxB,MAAtB,EAA8B;AAC1BvB,MAAAA,IAAI,CAAC+C,YAAL,CAAkBnC,OAAlB,CAA0B,UAASwD,MAAT,EAAiB;AACvCA,QAAAA,MAAM,CAACD,UAAP;AACH,OAFD;AAGAnE,MAAAA,IAAI,CAAC+C,YAAL,GAAoB,EAApB;AACH;;AAED,QAAI/C,IAAI,CAACyD,gBAAT,EAA2B;AACvBzD,MAAAA,IAAI,CAACyD,gBAAL,CAAsBU,UAAtB;AACAnE,MAAAA,IAAI,CAACyD,gBAAL,GAAwB,IAAxB;AACH;;AAED,QAAIzD,IAAI,CAAC8C,YAAT,EAAuB;AACnB9C,MAAAA,IAAI,CAAC8C,YAAL,CAAkBuB,KAAlB;AACH;;AAEDrE,IAAAA,IAAI,CAAC8C,YAAL,GAAoB,IAApB;AAEAzD,IAAAA,OAAO,CAACiF,SAAR,CAAkB,CAAlB,EAAqB,CAArB,EAAwBlF,MAAM,CAACP,KAA/B,EAAsCO,MAAM,CAACN,MAA7C;;AAEA,QAAIM,MAAM,CAAC4B,MAAX,EAAmB;AACf5B,MAAAA,MAAM,CAAC4B,MAAP,CAAcN,IAAd;AACAtB,MAAAA,MAAM,CAAC4B,MAAP,GAAgB,IAAhB;AACH;AACJ,GAjCD;;AAmCA,OAAK0B,iBAAL,GAAyB,UAASqB,OAAT,EAAkB;AACvC,QAAIA,OAAO,IAAI,EAAEA,OAAO,YAAYC,KAArB,CAAf,EAA4C;AACxCD,MAAAA,OAAO,GAAG,CAACA,OAAD,CAAV;AACH;;AAEDrB,IAAAA,iBAAiB,CAACqB,OAAD,CAAjB;AACH,GAND;;AAQA,WAASrB,iBAAT,CAA2BqB,OAA3B,EAAoC;AAChC7E,IAAAA,MAAM,GAAG,EAAT;AACA6E,IAAAA,OAAO,GAAGA,OAAO,IAAInH,mBAArB,CAFgC,CAIhC;;AACAmH,IAAAA,OAAO,CAACnD,OAAR,CAAgB,UAASI,MAAT,EAAiB;AAC7B,UAAI,CAACA,MAAM,CAACL,SAAP,GAAmB2B,MAAnB,CAA0B,UAASC,CAAT,EAAY;AACnC,eAAOA,CAAC,CAACC,IAAF,KAAW,OAAlB;AACH,OAFA,EAEEjB,MAFP,EAEe;AACX;AACH;;AAED,UAAIG,KAAK,GAAGiC,QAAQ,CAAC3C,MAAD,CAApB;AACAU,MAAAA,KAAK,CAACV,MAAN,GAAeA,MAAf;AACA9B,MAAAA,MAAM,CAACyC,IAAP,CAAYD,KAAZ;AACH,KAVD;AAWH,GA9hByD,CAgiB1D;;;AACA,OAAK6C,IAAL,GAAY,mBAAZ;;AACA,OAAKC,QAAL,GAAgB,YAAW;AACvB,WAAO,KAAKD,IAAZ;AACH,GAFD;;AAIA,OAAKtC,cAAL,GAAsBA,cAAtB;AAEH;;AAED,IAAI,OAAOjF,SAAP,KAAqB,WAAzB,EAAsC;AAClC,MAAI,OAAOyH,MAAP,KAAkB;AAAY;AAAlC,IAA6D;AACzDA,MAAAA,MAAM,CAACC,OAAP,GAAiB/H,iBAAjB;AACH;;AAED,MAAI,OAAOgI,MAAP,KAAkB,UAAlB,IAAgCA,MAAM,CAACC,GAA3C,EAAgD;AAC5CD,IAAAA,MAAM,CAAC,mBAAD,EAAsB,EAAtB,EAA0B,YAAW;AACvC,aAAOhI,iBAAP;AACH,KAFK,CAAN;AAGH;AACJ","sourcesContent":["// Last time updated: 2019-06-21 4:09:42 AM UTC\r\n\r\n// ________________________\r\n// MultiStreamsMixer v1.2.2\r\n\r\n// Open-Sourced: https://github.com/muaz-khan/MultiStreamsMixer\r\n\r\n// --------------------------------------------------\r\n// Muaz Khan     - www.MuazKhan.com\r\n// MIT License   - www.WebRTC-Experiment.com/licence\r\n// --------------------------------------------------\r\n\r\nfunction MultiStreamsMixer(arrayOfMediaStreams, elementClass) {\r\n\r\n    var browserFakeUserAgent = 'Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45';\r\n\r\n    (function(that) {\r\n        if (typeof RecordRTC !== 'undefined') {\r\n            return;\r\n        }\r\n\r\n        if (!that) {\r\n            return;\r\n        }\r\n\r\n        if (typeof window !== 'undefined') {\r\n            return;\r\n        }\r\n\r\n        if (typeof global === 'undefined') {\r\n            return;\r\n        }\r\n\r\n        global.navigator = {\r\n            userAgent: browserFakeUserAgent,\r\n            getUserMedia: function() {}\r\n        };\r\n\r\n        if (!global.console) {\r\n            global.console = {};\r\n        }\r\n\r\n        if (typeof global.console.log === 'undefined' || typeof global.console.error === 'undefined') {\r\n            global.console.error = global.console.log = global.console.log || function() {\r\n                console.log(arguments);\r\n            };\r\n        }\r\n\r\n        if (typeof document === 'undefined') {\r\n            /*global document:true */\r\n            that.document = {\r\n                documentElement: {\r\n                    appendChild: function() {\r\n                        return '';\r\n                    }\r\n                }\r\n            };\r\n\r\n            document.createElement = document.captureStream = document.mozCaptureStream = function() {\r\n                var obj = {\r\n                    getContext: function() {\r\n                        return obj;\r\n                    },\r\n                    play: function() {},\r\n                    pause: function() {},\r\n                    drawImage: function() {},\r\n                    toDataURL: function() {\r\n                        return '';\r\n                    },\r\n                    style: {}\r\n                };\r\n                return obj;\r\n            };\r\n\r\n            that.HTMLVideoElement = function() {};\r\n        }\r\n\r\n        if (typeof location === 'undefined') {\r\n            /*global location:true */\r\n            that.location = {\r\n                protocol: 'file:',\r\n                href: '',\r\n                hash: ''\r\n            };\r\n        }\r\n\r\n        if (typeof screen === 'undefined') {\r\n            /*global screen:true */\r\n            that.screen = {\r\n                width: 0,\r\n                height: 0\r\n            };\r\n        }\r\n\r\n        if (typeof URL === 'undefined') {\r\n            /*global screen:true */\r\n            that.URL = {\r\n                createObjectURL: function() {\r\n                    return '';\r\n                },\r\n                revokeObjectURL: function() {\r\n                    return '';\r\n                }\r\n            };\r\n        }\r\n\r\n        /*global window:true */\r\n        that.window = global;\r\n    })(typeof global !== 'undefined' ? global : null);\r\n\r\n    // requires: chrome://flags/#enable-experimental-web-platform-features\r\n\r\n    elementClass = elementClass || 'multi-streams-mixer';\r\n\r\n    var videos = [];\r\n    var isStopDrawingFrames = false;\r\n\r\n    var canvas = document.createElement('canvas');\r\n    var context = canvas.getContext('2d');\r\n    canvas.style.opacity = 0;\r\n    canvas.style.position = 'absolute';\r\n    canvas.style.zIndex = -1;\r\n    canvas.style.top = '-1000em';\r\n    canvas.style.left = '-1000em';\r\n    canvas.className = elementClass;\r\n    (document.body || document.documentElement).appendChild(canvas);\r\n\r\n    this.disableLogs = false;\r\n    this.frameInterval = 10;\r\n\r\n    this.width = 360;\r\n    this.height = 240;\r\n\r\n    // use gain node to prevent echo\r\n    this.useGainNode = true;\r\n\r\n    var self = this;\r\n\r\n    // _____________________________\r\n    // Cross-Browser-Declarations.js\r\n\r\n    // WebAudio API representer\r\n    var AudioContext = window.AudioContext;\r\n\r\n    if (typeof AudioContext === 'undefined') {\r\n        if (typeof webkitAudioContext !== 'undefined') {\r\n            /*global AudioContext:true */\r\n            AudioContext = webkitAudioContext;\r\n        }\r\n\r\n        if (typeof mozAudioContext !== 'undefined') {\r\n            /*global AudioContext:true */\r\n            AudioContext = mozAudioContext;\r\n        }\r\n    }\r\n\r\n    /*jshint -W079 */\r\n    var URL = window.URL;\r\n\r\n    if (typeof URL === 'undefined' && typeof webkitURL !== 'undefined') {\r\n        /*global URL:true */\r\n        URL = webkitURL;\r\n    }\r\n\r\n    if (typeof navigator !== 'undefined' && typeof navigator.getUserMedia === 'undefined') { // maybe window.navigator?\r\n        if (typeof navigator.webkitGetUserMedia !== 'undefined') {\r\n            navigator.getUserMedia = navigator.webkitGetUserMedia;\r\n        }\r\n\r\n        if (typeof navigator.mozGetUserMedia !== 'undefined') {\r\n            navigator.getUserMedia = navigator.mozGetUserMedia;\r\n        }\r\n    }\r\n\r\n    var MediaStream = window.MediaStream;\r\n\r\n    if (typeof MediaStream === 'undefined' && typeof webkitMediaStream !== 'undefined') {\r\n        MediaStream = webkitMediaStream;\r\n    }\r\n\r\n    /*global MediaStream:true */\r\n    if (typeof MediaStream !== 'undefined') {\r\n        // override \"stop\" method for all browsers\r\n        if (typeof MediaStream.prototype.stop === 'undefined') {\r\n            MediaStream.prototype.stop = function() {\r\n                this.getTracks().forEach(function(track) {\r\n                    track.stop();\r\n                });\r\n            };\r\n        }\r\n    }\r\n\r\n    var Storage = {};\r\n\r\n    if (typeof AudioContext !== 'undefined') {\r\n        Storage.AudioContext = AudioContext;\r\n    } else if (typeof webkitAudioContext !== 'undefined') {\r\n        Storage.AudioContext = webkitAudioContext;\r\n    }\r\n\r\n    function setSrcObject(stream, element) {\r\n        if ('srcObject' in element) {\r\n            element.srcObject = stream;\r\n        } else if ('mozSrcObject' in element) {\r\n            element.mozSrcObject = stream;\r\n        } else {\r\n            element.srcObject = stream;\r\n        }\r\n    }\r\n\r\n    this.startDrawingFrames = function() {\r\n        drawVideosToCanvas();\r\n    };\r\n\r\n    function drawVideosToCanvas() {\r\n        if (isStopDrawingFrames) {\r\n            return;\r\n        }\r\n\r\n        var videosLength = videos.length;\r\n\r\n        var fullcanvas = false;\r\n        var remaining = [];\r\n        videos.forEach(function(video) {\r\n            if (!video.stream) {\r\n                video.stream = {};\r\n            }\r\n\r\n            if (video.stream.fullcanvas) {\r\n                fullcanvas = video;\r\n            } else {\r\n                // todo: video.stream.active or video.stream.live to fix blank frames issues?\r\n                remaining.push(video);\r\n            }\r\n        });\r\n\r\n        if (fullcanvas) {\r\n            canvas.width = fullcanvas.stream.width;\r\n            canvas.height = fullcanvas.stream.height;\r\n        } else if (remaining.length) {\r\n            canvas.width = videosLength > 1 ? remaining[0].width * 2 : remaining[0].width;\r\n\r\n            var height = 1;\r\n            if (videosLength === 3 || videosLength === 4) {\r\n                height = 2;\r\n            }\r\n            if (videosLength === 5 || videosLength === 6) {\r\n                height = 3;\r\n            }\r\n            if (videosLength === 7 || videosLength === 8) {\r\n                height = 4;\r\n            }\r\n            if (videosLength === 9 || videosLength === 10) {\r\n                height = 5;\r\n            }\r\n            canvas.height = remaining[0].height * height;\r\n        } else {\r\n            canvas.width = self.width || 360;\r\n            canvas.height = self.height || 240;\r\n        }\r\n\r\n        if (fullcanvas && fullcanvas instanceof HTMLVideoElement) {\r\n            drawImage(fullcanvas);\r\n        }\r\n\r\n        remaining.forEach(function(video, idx) {\r\n            drawImage(video, idx);\r\n        });\r\n\r\n        setTimeout(drawVideosToCanvas, self.frameInterval);\r\n    }\r\n\r\n    function drawImage(video, idx) {\r\n        if (isStopDrawingFrames) {\r\n            return;\r\n        }\r\n\r\n        var x = 0;\r\n        var y = 0;\r\n        var width = video.width;\r\n        var height = video.height;\r\n\r\n        if (idx === 1) {\r\n            x = video.width;\r\n        }\r\n\r\n        if (idx === 2) {\r\n            y = video.height;\r\n        }\r\n\r\n        if (idx === 3) {\r\n            x = video.width;\r\n            y = video.height;\r\n        }\r\n\r\n        if (idx === 4) {\r\n            y = video.height * 2;\r\n        }\r\n\r\n        if (idx === 5) {\r\n            x = video.width;\r\n            y = video.height * 2;\r\n        }\r\n\r\n        if (idx === 6) {\r\n            y = video.height * 3;\r\n        }\r\n\r\n        if (idx === 7) {\r\n            x = video.width;\r\n            y = video.height * 3;\r\n        }\r\n\r\n        if (typeof video.stream.left !== 'undefined') {\r\n            x = video.stream.left;\r\n        }\r\n\r\n        if (typeof video.stream.top !== 'undefined') {\r\n            y = video.stream.top;\r\n        }\r\n\r\n        if (typeof video.stream.width !== 'undefined') {\r\n            width = video.stream.width;\r\n        }\r\n\r\n        if (typeof video.stream.height !== 'undefined') {\r\n            height = video.stream.height;\r\n        }\r\n\r\n        context.drawImage(video, x, y, width, height);\r\n\r\n        if (typeof video.stream.onRender === 'function') {\r\n            video.stream.onRender(context, x, y, width, height, idx);\r\n        }\r\n    }\r\n\r\n    function getMixedStream() {\r\n        isStopDrawingFrames = false;\r\n        var mixedVideoStream = getMixedVideoStream();\r\n\r\n        var mixedAudioStream = getMixedAudioStream();\r\n        if (mixedAudioStream) {\r\n            mixedAudioStream.getTracks().filter(function(t) {\r\n                return t.kind === 'audio';\r\n            }).forEach(function(track) {\r\n                mixedVideoStream.addTrack(track);\r\n            });\r\n        }\r\n\r\n        var fullcanvas;\r\n        arrayOfMediaStreams.forEach(function(stream) {\r\n            if (stream.fullcanvas) {\r\n                fullcanvas = true;\r\n            }\r\n        });\r\n\r\n        // mixedVideoStream.prototype.appendStreams = appendStreams;\r\n        // mixedVideoStream.prototype.resetVideoStreams = resetVideoStreams;\r\n        // mixedVideoStream.prototype.clearRecordedData = clearRecordedData;\r\n\r\n        return mixedVideoStream;\r\n    }\r\n\r\n    function getMixedVideoStream() {\r\n        resetVideoStreams();\r\n\r\n        var capturedStream;\r\n\r\n        if ('captureStream' in canvas) {\r\n            capturedStream = canvas.captureStream();\r\n        } else if ('mozCaptureStream' in canvas) {\r\n            capturedStream = canvas.mozCaptureStream();\r\n        } else if (!self.disableLogs) {\r\n            console.error('Upgrade to latest Chrome or otherwise enable this flag: chrome://flags/#enable-experimental-web-platform-features');\r\n        }\r\n\r\n        var videoStream = new MediaStream();\r\n\r\n        capturedStream.getTracks().filter(function(t) {\r\n            return t.kind === 'video';\r\n        }).forEach(function(track) {\r\n            videoStream.addTrack(track);\r\n        });\r\n\r\n        canvas.stream = videoStream;\r\n\r\n        return videoStream;\r\n    }\r\n\r\n    function getMixedAudioStream() {\r\n        // via: @pehrsons\r\n        if (!Storage.AudioContextConstructor) {\r\n            Storage.AudioContextConstructor = new Storage.AudioContext();\r\n        }\r\n\r\n        self.audioContext = Storage.AudioContextConstructor;\r\n\r\n        self.audioSources = [];\r\n\r\n        if (self.useGainNode === true) {\r\n            self.gainNode = self.audioContext.createGain();\r\n            self.gainNode.connect(self.audioContext.destination);\r\n            self.gainNode.gain.value = 0; // don't hear self\r\n        }\r\n\r\n        var audioTracksLength = 0;\r\n        arrayOfMediaStreams.forEach(function(stream) {\r\n            if (!stream.getTracks().filter(function(t) {\r\n                    return t.kind === 'audio';\r\n                }).length) {\r\n                return;\r\n            }\r\n\r\n            audioTracksLength++;\r\n\r\n            var audioSource = self.audioContext.createMediaStreamSource(stream);\r\n\r\n            if (self.useGainNode === true) {\r\n                audioSource.connect(self.gainNode);\r\n            }\r\n\r\n            self.audioSources.push(audioSource);\r\n        });\r\n\r\n        if (!audioTracksLength) {\r\n            // because \"self.audioContext\" is not initialized\r\n            // that's why we've to ignore rest of the code\r\n            return;\r\n        }\r\n\r\n        self.audioDestination = self.audioContext.createMediaStreamDestination();\r\n        self.audioSources.forEach(function(audioSource) {\r\n            audioSource.connect(self.audioDestination);\r\n        });\r\n        return self.audioDestination.stream;\r\n    }\r\n\r\n    function getVideo(stream) {\r\n        var video = document.createElement('video');\r\n\r\n        setSrcObject(stream, video);\r\n\r\n        video.className = elementClass;\r\n\r\n        video.muted = true;\r\n        video.volume = 0;\r\n\r\n        video.width = stream.width || self.width || 360;\r\n        video.height = stream.height || self.height || 240;\r\n\r\n        video.play();\r\n\r\n        return video;\r\n    }\r\n\r\n    this.appendStreams = function(streams) {\r\n        if (!streams) {\r\n            throw 'First parameter is required.';\r\n        }\r\n\r\n        if (!(streams instanceof Array)) {\r\n            streams = [streams];\r\n        }\r\n\r\n        streams.forEach(function(stream) {\r\n            var newStream = new MediaStream();\r\n\r\n            if (stream.getTracks().filter(function(t) {\r\n                    return t.kind === 'video';\r\n                }).length) {\r\n                var video = getVideo(stream);\r\n                video.stream = stream;\r\n                videos.push(video);\r\n\r\n                newStream.addTrack(stream.getTracks().filter(function(t) {\r\n                    return t.kind === 'video';\r\n                })[0]);\r\n            }\r\n\r\n            if (stream.getTracks().filter(function(t) {\r\n                    return t.kind === 'audio';\r\n                }).length) {\r\n                var audioSource = self.audioContext.createMediaStreamSource(stream);\r\n                self.audioDestination = self.audioContext.createMediaStreamDestination();\r\n                audioSource.connect(self.audioDestination);\r\n\r\n                newStream.addTrack(self.audioDestination.stream.getTracks().filter(function(t) {\r\n                    return t.kind === 'audio';\r\n                })[0]);\r\n            }\r\n\r\n            arrayOfMediaStreams.push(newStream);\r\n        });\r\n    };\r\n\r\n    this.releaseStreams = function() {\r\n        videos = [];\r\n        isStopDrawingFrames = true;\r\n\r\n        if (self.gainNode) {\r\n            self.gainNode.disconnect();\r\n            self.gainNode = null;\r\n        }\r\n\r\n        if (self.audioSources.length) {\r\n            self.audioSources.forEach(function(source) {\r\n                source.disconnect();\r\n            });\r\n            self.audioSources = [];\r\n        }\r\n\r\n        if (self.audioDestination) {\r\n            self.audioDestination.disconnect();\r\n            self.audioDestination = null;\r\n        }\r\n\r\n        if (self.audioContext) {\r\n            self.audioContext.close();\r\n        }\r\n\r\n        self.audioContext = null;\r\n\r\n        context.clearRect(0, 0, canvas.width, canvas.height);\r\n\r\n        if (canvas.stream) {\r\n            canvas.stream.stop();\r\n            canvas.stream = null;\r\n        }\r\n    };\r\n\r\n    this.resetVideoStreams = function(streams) {\r\n        if (streams && !(streams instanceof Array)) {\r\n            streams = [streams];\r\n        }\r\n\r\n        resetVideoStreams(streams);\r\n    };\r\n\r\n    function resetVideoStreams(streams) {\r\n        videos = [];\r\n        streams = streams || arrayOfMediaStreams;\r\n\r\n        // via: @adrian-ber\r\n        streams.forEach(function(stream) {\r\n            if (!stream.getTracks().filter(function(t) {\r\n                    return t.kind === 'video';\r\n                }).length) {\r\n                return;\r\n            }\r\n\r\n            var video = getVideo(stream);\r\n            video.stream = stream;\r\n            videos.push(video);\r\n        });\r\n    }\r\n\r\n    // for debugging\r\n    this.name = 'MultiStreamsMixer';\r\n    this.toString = function() {\r\n        return this.name;\r\n    };\r\n\r\n    this.getMixedStream = getMixedStream;\r\n\r\n}\r\n\r\nif (typeof RecordRTC === 'undefined') {\r\n    if (typeof module !== 'undefined' /* && !!module.exports*/ ) {\r\n        module.exports = MultiStreamsMixer;\r\n    }\r\n\r\n    if (typeof define === 'function' && define.amd) {\r\n        define('MultiStreamsMixer', [], function() {\r\n            return MultiStreamsMixer;\r\n        });\r\n    }\r\n}\n"]},"metadata":{},"sourceType":"script"}