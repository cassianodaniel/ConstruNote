{"ast":null,"code":"import { RegistererState, SessionState } from \"sip.js\";\nimport { Events } from \"./voice/types/types\";\nimport SIP from \"./voice/voicecommunicator\";\nexport default class SquadVoiceCommunicator {\n  constructor(settings, user, cb, constraints = {}) {\n    this.settings = settings;\n    this.user = user;\n    this.constraints = constraints;\n\n    this.attemptReconnect = () => {\n      setTimeout(() => {\n        var _this$sip$userAgent;\n\n        console.log(\"Attempting to reconnect ...\");\n        (_this$sip$userAgent = this.sip.userAgent) === null || _this$sip$userAgent === void 0 ? void 0 : _this$sip$userAgent.reconnect().then(() => {\n          var _this$sip$registerer;\n\n          (_this$sip$registerer = this.sip.registerer) === null || _this$sip$registerer === void 0 ? void 0 : _this$sip$registerer.register();\n        }).catch(() => {\n          console.log(\"Failed to Reconnect\");\n          this.attemptReconnect();\n        });\n      }, 4000);\n    };\n\n    this.onConnect = () => {\n      this.notify(Events.CONNECTED);\n    };\n\n    this.onDisconnect = e => {\n      this.attemptReconnect();\n      this.notify(Events.DISCONNECTED);\n    };\n\n    this.onMakeCall = (state, inviter) => {\n      console.log(`Session state changed to ${state}`);\n\n      switch (state) {\n        case SessionState.Initial:\n          this.notify(Events.MAKE_CALL, inviter);\n          break;\n\n        case SessionState.Establishing:\n          break;\n\n        case SessionState.Established:\n          const {\n            receivingVideo,\n            tagId\n          } = this.sip.setupRemoteMedia(inviter, this.getSpeakerId()) || {};\n          this.notify(Events.CALL_ON_GOING, {\n            inviter,\n            receivingVideo,\n            tagId\n          });\n          break;\n\n        case SessionState.Terminating: // fall through\n\n        case SessionState.Terminated:\n          this.notify(Events.CALL_HANGUP, inviter);\n          this.sip.activeCalls.delete(inviter.id);\n          this.sip.cleanupMedia(inviter.id);\n          break;\n\n        default:\n          throw new Error(\"Unknown session state.\");\n      }\n    };\n\n    this.acceptCall = (call, useVideo) => {\n      const acceptedCall = {\n        callId: call.id,\n        useVideo\n      };\n      this.updateConstraintsParams({\n        useVideo\n      });\n      call.accept({\n        sessionDescriptionHandlerOptions: {\n          constraints: this.getConstraints()\n        }\n      });\n      this.notify(Events.ACCEPTED_CALL, acceptedCall);\n    };\n\n    this.onReceiveCall = (state, invitation) => {\n      console.log(`Session state changed to ${state}`);\n\n      switch (state) {\n        case SessionState.Initial:\n          this.notify(Events.RECEIVED_CALL, invitation);\n          break;\n\n        case SessionState.Establishing:\n          break;\n\n        case SessionState.Established:\n          const {\n            receivingVideo,\n            tagId\n          } = this.sip.setupRemoteMedia(invitation, this.getSpeakerId()) || {};\n          this.notify(Events.CALL_ON_GOING, {\n            invitation,\n            receivingVideo,\n            tagId\n          });\n          break;\n\n        case SessionState.Terminating: // fall through\n\n        case SessionState.Terminated:\n          this.notify(Events.CALL_HANGUP, invitation);\n          this.sip.activeCalls.delete(invitation.id);\n          this.sip.cleanupMedia(invitation.id);\n          break;\n\n        default:\n          break;\n      }\n    };\n\n    this.muteMic = callId => {\n      this.notify(Events.MUTE_MIC, {\n        callId,\n        status: true\n      });\n      this.sip.muteMic(callId);\n    };\n\n    this.unMuteMic = callId => {\n      this.notify(Events.MUTE_MIC, {\n        callId,\n        status: false\n      });\n      this.sip.unMuteMic(callId);\n    };\n\n    this.disableCam = callId => {\n      this.notify(Events.MUTE_CAM, {\n        callId,\n        status: true\n      });\n      this.sip.disableCam(callId);\n    };\n\n    this.enableCam = callId => {\n      this.notify(Events.MUTE_CAM, {\n        callId,\n        status: false\n      });\n      this.sip.enableCam(callId);\n    };\n\n    this.holdCall = callId => {\n      this.notify(Events.HOLD_CALL, {\n        callId,\n        status: true\n      });\n      this.sip.holdCall(callId);\n    };\n\n    this.unHoldCall = callId => {\n      Array.from(this.sip.activeCalls.values()).filter(cl => cl.id !== callId).forEach(call => {\n        this.sip.holdCall(call.id);\n        this.notify(Events.HOLD_CALL, {\n          callId: call.id,\n          status: true\n        });\n      });\n      this.notify(Events.HOLD_CALL, {\n        callId,\n        status: false\n      });\n      this.sip.unHoldCall(callId);\n    };\n\n    this.nextSubscriptionId = 0;\n    this.subscriptions = new Map();\n    this.makeSIP();\n  }\n\n  makeSIP() {\n    this.settings.get(settings => {\n      this.user.get(user => {\n        this.sip = new SIP({\n          user: settings.sipUser,\n          password: settings.sipPw,\n          domain: settings.sipDomain,\n          displayName: user.name,\n          wsURL: settings.webrtcUrl2 || `wss://${settings.sipDomain}:7443`,\n          connectionCB: this.connectionListener.bind(this),\n          onConnect: this.onConnect,\n          onDisconnect: this.onDisconnect,\n          onMakeCall: this.onMakeCall.bind(this),\n          onReceiveCall: this.onReceiveCall.bind(this)\n        });\n      });\n    });\n  }\n\n  getConstraints() {\n    const newConstraints = {\n      video: this.constraints.useVideo && this.constraints.videoId ? {\n        deviceId: this.constraints.videoId\n      } : this.constraints.useVideo || false,\n      audio: this.constraints.audioId ? {\n        deviceId: this.constraints.audioId\n      } : true\n    };\n    return newConstraints;\n  }\n\n  getSpeakerId() {\n    return this.constraints.speakerId;\n  }\n\n  updateConstraintsParams(params) {\n    this.constraints = { ...this.constraints,\n      ...params\n    };\n  }\n\n  connectionListener(data) {\n    switch (data) {\n      case RegistererState.Initial:\n        break;\n\n      case RegistererState.Registered:\n        this.notify(Events.CONNECTED);\n        break;\n\n      case RegistererState.Terminated:\n        this.notify(Events.DISCONNECTED);\n        break;\n\n      case RegistererState.Unregistered:\n        this.notify(Events.UNREGISTERED);\n        break;\n    }\n  }\n\n  makeCall(number, constraints = this.constraints) {\n    this.updateConstraintsParams(constraints);\n    this.sip.invite(number, this.getConstraints());\n  }\n\n  // < -- Observer Pattern https://refactoring.guru/pt-br/design-patterns/observer\n  subscribe(subscribeCallback) {\n    var _this$subscriptions;\n\n    (_this$subscriptions = this.subscriptions) === null || _this$subscriptions === void 0 ? void 0 : _this$subscriptions.set(this.nextSubscriptionId || 0, subscribeCallback);\n    if (this.nextSubscriptionId) this.nextSubscriptionId += 1;\n  }\n\n  removeSubscription(id) {\n    var _this$subscriptions2;\n\n    (_this$subscriptions2 = this.subscriptions) === null || _this$subscriptions2 === void 0 ? void 0 : _this$subscriptions2.delete(id);\n  }\n\n  removeAllSubscription() {\n    this.subscriptions = new Map();\n  }\n\n  notify(event, data = null) {\n    if (this.subscriptions) {\n      this.subscriptions.forEach(subscribeCallback => {\n        if (subscribeCallback) subscribeCallback(event, data);\n      });\n    }\n  } // -- >\n\n\n}","map":{"version":3,"sources":["C:/Users/Digivox/dev/Digivox/Refatoracao/squad/src/services/SquadVoiceCommunicator.ts"],"names":["RegistererState","SessionState","Events","SIP","SquadVoiceCommunicator","constructor","settings","user","cb","constraints","attemptReconnect","setTimeout","console","log","sip","userAgent","reconnect","then","registerer","register","catch","onConnect","notify","CONNECTED","onDisconnect","e","DISCONNECTED","onMakeCall","state","inviter","Initial","MAKE_CALL","Establishing","Established","receivingVideo","tagId","setupRemoteMedia","getSpeakerId","CALL_ON_GOING","Terminating","Terminated","CALL_HANGUP","activeCalls","delete","id","cleanupMedia","Error","acceptCall","call","useVideo","acceptedCall","callId","updateConstraintsParams","accept","sessionDescriptionHandlerOptions","getConstraints","ACCEPTED_CALL","onReceiveCall","invitation","RECEIVED_CALL","muteMic","MUTE_MIC","status","unMuteMic","disableCam","MUTE_CAM","enableCam","holdCall","HOLD_CALL","unHoldCall","Array","from","values","filter","cl","forEach","nextSubscriptionId","subscriptions","Map","makeSIP","get","sipUser","password","sipPw","domain","sipDomain","displayName","name","wsURL","webrtcUrl2","connectionCB","connectionListener","bind","newConstraints","video","videoId","deviceId","audio","audioId","speakerId","params","data","Registered","Unregistered","UNREGISTERED","makeCall","number","invite","subscribe","subscribeCallback","set","removeSubscription","removeAllSubscription","event"],"mappings":"AAAA,SAGEA,eAHF,EAKEC,YALF,QAMO,QANP;AASA,SAASC,MAAT,QAA6C,qBAA7C;AACA,OAAOC,GAAP,MAAgB,2BAAhB;AAYA,eAAe,MAAMC,sBAAN,CAA6B;AAC1CC,EAAAA,WAAW,CACDC,QADC,EAEDC,IAFC,EAGTC,EAHS,EAIDC,WAAoC,GAAG,EAJtC,EAKT;AAAA,SAJQH,QAIR,GAJQA,QAIR;AAAA,SAHQC,IAGR,GAHQA,IAGR;AAAA,SADQE,WACR,GADQA,WACR;;AAAA,SAuBFC,gBAvBE,GAuBiB,MAAM;AACvBC,MAAAA,UAAU,CAAC,MAAM;AAAA;;AACfC,QAAAA,OAAO,CAACC,GAAR,CAAY,6BAAZ;AACA,oCAAKC,GAAL,CAASC,SAAT,4EACIC,SADJ,GAEGC,IAFH,CAEQ,MAAM;AAAA;;AACV,uCAAKH,GAAL,CAASI,UAAT,8EAAqBC,QAArB;AACD,SAJH,EAKGC,KALH,CAKS,MAAM;AACXR,UAAAA,OAAO,CAACC,GAAR,CAAY,qBAAZ;AACA,eAAKH,gBAAL;AACD,SARH;AASD,OAXS,EAWP,IAXO,CAAV;AAYD,KApCC;;AAAA,SAqCFW,SArCE,GAqCU,MAAM;AAChB,WAAKC,MAAL,CAAYpB,MAAM,CAACqB,SAAnB;AACD,KAvCC;;AAAA,SAwCFC,YAxCE,GAwCcC,CAAD,IAA0B;AACvC,WAAKf,gBAAL;AACA,WAAKY,MAAL,CAAYpB,MAAM,CAACwB,YAAnB;AACD,KA3CC;;AAAA,SAwFFC,UAxFE,GAwFW,CAACC,KAAD,EAAsBC,OAAtB,KAA2C;AACtDjB,MAAAA,OAAO,CAACC,GAAR,CAAa,4BAA2Be,KAAM,EAA9C;;AACA,cAAQA,KAAR;AACE,aAAK3B,YAAY,CAAC6B,OAAlB;AACE,eAAKR,MAAL,CAAYpB,MAAM,CAAC6B,SAAnB,EAA8BF,OAA9B;AACA;;AACF,aAAK5B,YAAY,CAAC+B,YAAlB;AACE;;AACF,aAAK/B,YAAY,CAACgC,WAAlB;AACE,gBAAM;AAAEC,YAAAA,cAAF;AAAkBC,YAAAA;AAAlB,cACJ,KAAKrB,GAAL,CAASsB,gBAAT,CAA0BP,OAA1B,EAAmC,KAAKQ,YAAL,EAAnC,KAA2D,EAD7D;AAEA,eAAKf,MAAL,CAAYpB,MAAM,CAACoC,aAAnB,EAAkC;AAAET,YAAAA,OAAF;AAAWK,YAAAA,cAAX;AAA2BC,YAAAA;AAA3B,WAAlC;AACA;;AACF,aAAKlC,YAAY,CAACsC,WAAlB,CAXF,CAYE;;AACA,aAAKtC,YAAY,CAACuC,UAAlB;AACE,eAAKlB,MAAL,CAAYpB,MAAM,CAACuC,WAAnB,EAAgCZ,OAAhC;AACA,eAAKf,GAAL,CAAS4B,WAAT,CAAqBC,MAArB,CAA4Bd,OAAO,CAACe,EAApC;AACA,eAAK9B,GAAL,CAAS+B,YAAT,CAAsBhB,OAAO,CAACe,EAA9B;AACA;;AACF;AACE,gBAAM,IAAIE,KAAJ,CAAU,wBAAV,CAAN;AAnBJ;AAqBD,KA/GC;;AAAA,SAgHFC,UAhHE,GAgHW,CAACC,IAAD,EAAgBC,QAAhB,KAAsC;AACjD,YAAMC,YAAY,GAAG;AAAEC,QAAAA,MAAM,EAAEH,IAAI,CAACJ,EAAf;AAAmBK,QAAAA;AAAnB,OAArB;AACA,WAAKG,uBAAL,CAA6B;AAAEH,QAAAA;AAAF,OAA7B;AACCD,MAAAA,IAAD,CAAqBK,MAArB,CAA4B;AAC1BC,QAAAA,gCAAgC,EAAE;AAChC7C,UAAAA,WAAW,EAAE,KAAK8C,cAAL;AADmB;AADR,OAA5B;AAKA,WAAKjC,MAAL,CAAYpB,MAAM,CAACsD,aAAnB,EAAkCN,YAAlC;AACD,KAzHC;;AAAA,SA0HFO,aA1HE,GA0Hc,CAAC7B,KAAD,EAAsB8B,UAAtB,KAAiD;AAC/D9C,MAAAA,OAAO,CAACC,GAAR,CAAa,4BAA2Be,KAAM,EAA9C;;AACA,cAAQA,KAAR;AACE,aAAK3B,YAAY,CAAC6B,OAAlB;AACE,eAAKR,MAAL,CAAYpB,MAAM,CAACyD,aAAnB,EAAkCD,UAAlC;AACA;;AACF,aAAKzD,YAAY,CAAC+B,YAAlB;AACE;;AACF,aAAK/B,YAAY,CAACgC,WAAlB;AACE,gBAAM;AAAEC,YAAAA,cAAF;AAAkBC,YAAAA;AAAlB,cACJ,KAAKrB,GAAL,CAASsB,gBAAT,CAA0BsB,UAA1B,EAAsC,KAAKrB,YAAL,EAAtC,KAA8D,EADhE;AAEA,eAAKf,MAAL,CAAYpB,MAAM,CAACoC,aAAnB,EAAkC;AAChCoB,YAAAA,UADgC;AAEhCxB,YAAAA,cAFgC;AAGhCC,YAAAA;AAHgC,WAAlC;AAKA;;AACF,aAAKlC,YAAY,CAACsC,WAAlB,CAfF,CAgBE;;AACA,aAAKtC,YAAY,CAACuC,UAAlB;AACE,eAAKlB,MAAL,CAAYpB,MAAM,CAACuC,WAAnB,EAAgCiB,UAAhC;AACA,eAAK5C,GAAL,CAAS4B,WAAT,CAAqBC,MAArB,CAA4Be,UAAU,CAACd,EAAvC;AACA,eAAK9B,GAAL,CAAS+B,YAAT,CAAsBa,UAAU,CAACd,EAAjC;AACA;;AACF;AACE;AAvBJ;AAyBD,KArJC;;AAAA,SAuJFgB,OAvJE,GAuJST,MAAD,IAAoB;AAC5B,WAAK7B,MAAL,CAAYpB,MAAM,CAAC2D,QAAnB,EAA6B;AAAEV,QAAAA,MAAF;AAAUW,QAAAA,MAAM,EAAE;AAAlB,OAA7B;AACA,WAAKhD,GAAL,CAAS8C,OAAT,CAAiBT,MAAjB;AACD,KA1JC;;AAAA,SA2JFY,SA3JE,GA2JWZ,MAAD,IAAoB;AAC9B,WAAK7B,MAAL,CAAYpB,MAAM,CAAC2D,QAAnB,EAA6B;AAAEV,QAAAA,MAAF;AAAUW,QAAAA,MAAM,EAAE;AAAlB,OAA7B;AACA,WAAKhD,GAAL,CAASiD,SAAT,CAAmBZ,MAAnB;AACD,KA9JC;;AAAA,SA+JFa,UA/JE,GA+JYb,MAAD,IAAoB;AAC/B,WAAK7B,MAAL,CAAYpB,MAAM,CAAC+D,QAAnB,EAA6B;AAAEd,QAAAA,MAAF;AAAUW,QAAAA,MAAM,EAAE;AAAlB,OAA7B;AACA,WAAKhD,GAAL,CAASkD,UAAT,CAAoBb,MAApB;AACD,KAlKC;;AAAA,SAmKFe,SAnKE,GAmKWf,MAAD,IAAoB;AAC9B,WAAK7B,MAAL,CAAYpB,MAAM,CAAC+D,QAAnB,EAA6B;AAAEd,QAAAA,MAAF;AAAUW,QAAAA,MAAM,EAAE;AAAlB,OAA7B;AACA,WAAKhD,GAAL,CAASoD,SAAT,CAAmBf,MAAnB;AACD,KAtKC;;AAAA,SAuKFgB,QAvKE,GAuKUhB,MAAD,IAAoB;AAC7B,WAAK7B,MAAL,CAAYpB,MAAM,CAACkE,SAAnB,EAA8B;AAAEjB,QAAAA,MAAF;AAAUW,QAAAA,MAAM,EAAE;AAAlB,OAA9B;AACA,WAAKhD,GAAL,CAASqD,QAAT,CAAkBhB,MAAlB;AACD,KA1KC;;AAAA,SA2KFkB,UA3KE,GA2KYlB,MAAD,IAAoB;AAC/BmB,MAAAA,KAAK,CAACC,IAAN,CAAW,KAAKzD,GAAL,CAAS4B,WAAT,CAAqB8B,MAArB,EAAX,EACGC,MADH,CACWC,EAAD,IAAQA,EAAE,CAAC9B,EAAH,KAAUO,MAD5B,EAEGwB,OAFH,CAEY3B,IAAD,IAAU;AACjB,aAAKlC,GAAL,CAASqD,QAAT,CAAkBnB,IAAI,CAACJ,EAAvB;AACA,aAAKtB,MAAL,CAAYpB,MAAM,CAACkE,SAAnB,EAA8B;AAAEjB,UAAAA,MAAM,EAAEH,IAAI,CAACJ,EAAf;AAAmBkB,UAAAA,MAAM,EAAE;AAA3B,SAA9B;AACD,OALH;AAMA,WAAKxC,MAAL,CAAYpB,MAAM,CAACkE,SAAnB,EAA8B;AAAEjB,QAAAA,MAAF;AAAUW,QAAAA,MAAM,EAAE;AAAlB,OAA9B;AACA,WAAKhD,GAAL,CAASuD,UAAT,CAAoBlB,MAApB;AACD,KApLC;;AACA,SAAKyB,kBAAL,GAA0B,CAA1B;AACA,SAAKC,aAAL,GAAqB,IAAIC,GAAJ,EAArB;AACA,SAAKC,OAAL;AACD;;AACDA,EAAAA,OAAO,GAAG;AACR,SAAKzE,QAAL,CAAc0E,GAAd,CAAmB1E,QAAD,IAAc;AAC9B,WAAKC,IAAL,CAAUyE,GAAV,CAAezE,IAAD,IAAU;AACtB,aAAKO,GAAL,GAAW,IAAIX,GAAJ,CAAQ;AACjBI,UAAAA,IAAI,EAAED,QAAQ,CAAC2E,OADE;AAEjBC,UAAAA,QAAQ,EAAE5E,QAAQ,CAAC6E,KAFF;AAGjBC,UAAAA,MAAM,EAAE9E,QAAQ,CAAC+E,SAHA;AAIjBC,UAAAA,WAAW,EAAE/E,IAAI,CAACgF,IAJD;AAKjBC,UAAAA,KAAK,EAAElF,QAAQ,CAACmF,UAAT,IAAwB,SAAQnF,QAAQ,CAAC+E,SAAU,OALzC;AAMjBK,UAAAA,YAAY,EAAE,KAAKC,kBAAL,CAAwBC,IAAxB,CAA6B,IAA7B,CANG;AAOjBvE,UAAAA,SAAS,EAAE,KAAKA,SAPC;AAQjBG,UAAAA,YAAY,EAAE,KAAKA,YARF;AASjBG,UAAAA,UAAU,EAAE,KAAKA,UAAL,CAAgBiE,IAAhB,CAAqB,IAArB,CATK;AAUjBnC,UAAAA,aAAa,EAAE,KAAKA,aAAL,CAAmBmC,IAAnB,CAAwB,IAAxB;AAVE,SAAR,CAAX;AAYD,OAbD;AAcD,KAfD;AAgBD;;AAsBDrC,EAAAA,cAAc,GAAG;AACf,UAAMsC,cAAsC,GAAG;AAC7CC,MAAAA,KAAK,EACH,KAAKrF,WAAL,CAAiBwC,QAAjB,IAA6B,KAAKxC,WAAL,CAAiBsF,OAA9C,GACI;AACEC,QAAAA,QAAQ,EAAE,KAAKvF,WAAL,CAAiBsF;AAD7B,OADJ,GAII,KAAKtF,WAAL,CAAiBwC,QAAjB,IAA6B,KANU;AAO7CgD,MAAAA,KAAK,EAAE,KAAKxF,WAAL,CAAiByF,OAAjB,GACH;AACEF,QAAAA,QAAQ,EAAE,KAAKvF,WAAL,CAAiByF;AAD7B,OADG,GAIH;AAXyC,KAA/C;AAaA,WAAOL,cAAP;AACD;;AACDxD,EAAAA,YAAY,GAAG;AACb,WAAO,KAAK5B,WAAL,CAAiB0F,SAAxB;AACD;;AACD/C,EAAAA,uBAAuB,CAACgD,MAAD,EAAkC;AACvD,SAAK3F,WAAL,GAAmB,EAAE,GAAG,KAAKA,WAAV;AAAuB,SAAG2F;AAA1B,KAAnB;AACD;;AACDT,EAAAA,kBAAkB,CAACU,IAAD,EAAwB;AACxC,YAAQA,IAAR;AACE,WAAKrG,eAAe,CAAC8B,OAArB;AACE;;AACF,WAAK9B,eAAe,CAACsG,UAArB;AACE,aAAKhF,MAAL,CAAYpB,MAAM,CAACqB,SAAnB;AACA;;AACF,WAAKvB,eAAe,CAACwC,UAArB;AACE,aAAKlB,MAAL,CAAYpB,MAAM,CAACwB,YAAnB;AACA;;AACF,WAAK1B,eAAe,CAACuG,YAArB;AACE,aAAKjF,MAAL,CAAYpB,MAAM,CAACsG,YAAnB;AACA;AAXJ;AAaD;;AACDC,EAAAA,QAAQ,CACNC,MADM,EAENjG,WAAoC,GAAG,KAAKA,WAFtC,EAGN;AACA,SAAK2C,uBAAL,CAA6B3C,WAA7B;AACA,SAAKK,GAAL,CAAS6F,MAAT,CAAgBD,MAAhB,EAAwB,KAAKnD,cAAL,EAAxB;AACD;;AA+FD;AACAqD,EAAAA,SAAS,CAACC,iBAAD,EAA0C;AAAA;;AACjD,gCAAKhC,aAAL,4EAAoBiC,GAApB,CAAwB,KAAKlC,kBAAL,IAA2B,CAAnD,EAAsDiC,iBAAtD;AACA,QAAI,KAAKjC,kBAAT,EAA6B,KAAKA,kBAAL,IAA2B,CAA3B;AAC9B;;AACDmC,EAAAA,kBAAkB,CAACnE,EAAD,EAAa;AAAA;;AAC7B,iCAAKiC,aAAL,8EAAoBlC,MAApB,CAA2BC,EAA3B;AACD;;AACDoE,EAAAA,qBAAqB,GAAG;AACtB,SAAKnC,aAAL,GAAqB,IAAIC,GAAJ,EAArB;AACD;;AACDxD,EAAAA,MAAM,CAAC2F,KAAD,EAAgBZ,IAAS,GAAG,IAA5B,EAAkC;AACtC,QAAI,KAAKxB,aAAT,EAAwB;AACtB,WAAKA,aAAL,CAAmBF,OAAnB,CAA4BkC,iBAAD,IAAuB;AAChD,YAAIA,iBAAJ,EAAuBA,iBAAiB,CAACI,KAAD,EAAQZ,IAAR,CAAjB;AACxB,OAFD;AAGD;AACF,GA7MyC,CA8M1C;;;AA9M0C","sourcesContent":["import {\r\n  Invitation,\r\n  Inviter,\r\n  RegistererState,\r\n  Session,\r\n  SessionState,\r\n} from \"sip.js\";\r\nimport SettingsBusiness from \"./business/Settings\";\r\nimport UserBusiness from \"./business/User\";\r\nimport { Events, SubscriptionCallBack } from \"./voice/types/types\";\r\nimport SIP from \"./voice/voicecommunicator\";\r\nexport interface UpdateConstraintsParams {\r\n  useVideo?: boolean;\r\n  videoId?: string;\r\n  audioId?: string;\r\n  speakerId?: string;\r\n}\r\nexport default interface SquadVoiceCommunicator {\r\n  sip: SIP;\r\n  nextSubscriptionId?: number;\r\n  subscriptions?: Map<number, SubscriptionCallBack>;\r\n}\r\nexport default class SquadVoiceCommunicator {\r\n  constructor(\r\n    private settings: SettingsBusiness,\r\n    private user: UserBusiness,\r\n    cb: SubscriptionCallBack,\r\n    private constraints: UpdateConstraintsParams = {}\r\n  ) {\r\n    this.nextSubscriptionId = 0;\r\n    this.subscriptions = new Map<number, SubscriptionCallBack>();\r\n    this.makeSIP();\r\n  }\r\n  makeSIP() {\r\n    this.settings.get((settings) => {\r\n      this.user.get((user) => {\r\n        this.sip = new SIP({\r\n          user: settings.sipUser,\r\n          password: settings.sipPw,\r\n          domain: settings.sipDomain,\r\n          displayName: user.name,\r\n          wsURL: settings.webrtcUrl2 || `wss://${settings.sipDomain}:7443`,\r\n          connectionCB: this.connectionListener.bind(this),\r\n          onConnect: this.onConnect,\r\n          onDisconnect: this.onDisconnect,\r\n          onMakeCall: this.onMakeCall.bind(this),\r\n          onReceiveCall: this.onReceiveCall.bind(this),\r\n        });\r\n      });\r\n    });\r\n  }\r\n  attemptReconnect = () => {\r\n    setTimeout(() => {\r\n      console.log(\"Attempting to reconnect ...\");\r\n      this.sip.userAgent\r\n        ?.reconnect()\r\n        .then(() => {\r\n          this.sip.registerer?.register();\r\n        })\r\n        .catch(() => {\r\n          console.log(\"Failed to Reconnect\");\r\n          this.attemptReconnect();\r\n        });\r\n    }, 4000);\r\n  };\r\n  onConnect = () => {\r\n    this.notify(Events.CONNECTED);\r\n  };\r\n  onDisconnect = (e: Error | undefined) => {\r\n    this.attemptReconnect();\r\n    this.notify(Events.DISCONNECTED);\r\n  };\r\n  getConstraints() {\r\n    const newConstraints: MediaStreamConstraints = {\r\n      video:\r\n        this.constraints.useVideo && this.constraints.videoId\r\n          ? {\r\n              deviceId: this.constraints.videoId,\r\n            }\r\n          : this.constraints.useVideo || false,\r\n      audio: this.constraints.audioId\r\n        ? {\r\n            deviceId: this.constraints.audioId,\r\n          }\r\n        : true,\r\n    };\r\n    return newConstraints;\r\n  }\r\n  getSpeakerId() {\r\n    return this.constraints.speakerId;\r\n  }\r\n  updateConstraintsParams(params: UpdateConstraintsParams) {\r\n    this.constraints = { ...this.constraints, ...params };\r\n  }\r\n  connectionListener(data: RegistererState) {\r\n    switch (data) {\r\n      case RegistererState.Initial:\r\n        break;\r\n      case RegistererState.Registered:\r\n        this.notify(Events.CONNECTED);\r\n        break;\r\n      case RegistererState.Terminated:\r\n        this.notify(Events.DISCONNECTED);\r\n        break;\r\n      case RegistererState.Unregistered:\r\n        this.notify(Events.UNREGISTERED);\r\n        break;\r\n    }\r\n  }\r\n  makeCall(\r\n    number: string,\r\n    constraints: UpdateConstraintsParams = this.constraints\r\n  ) {\r\n    this.updateConstraintsParams(constraints);\r\n    this.sip.invite(number, this.getConstraints());\r\n  }\r\n  onMakeCall = (state: SessionState, inviter: Inviter) => {\r\n    console.log(`Session state changed to ${state}`);\r\n    switch (state) {\r\n      case SessionState.Initial:\r\n        this.notify(Events.MAKE_CALL, inviter);\r\n        break;\r\n      case SessionState.Establishing:\r\n        break;\r\n      case SessionState.Established:\r\n        const { receivingVideo, tagId } =\r\n          this.sip.setupRemoteMedia(inviter, this.getSpeakerId()) || {};\r\n        this.notify(Events.CALL_ON_GOING, { inviter, receivingVideo, tagId });\r\n        break;\r\n      case SessionState.Terminating:\r\n      // fall through\r\n      case SessionState.Terminated:\r\n        this.notify(Events.CALL_HANGUP, inviter);\r\n        this.sip.activeCalls.delete(inviter.id);\r\n        this.sip.cleanupMedia(inviter.id);\r\n        break;\r\n      default:\r\n        throw new Error(\"Unknown session state.\");\r\n    }\r\n  };\r\n  acceptCall = (call: Session, useVideo: boolean) => {\r\n    const acceptedCall = { callId: call.id, useVideo };\r\n    this.updateConstraintsParams({ useVideo });\r\n    (call as Invitation).accept({\r\n      sessionDescriptionHandlerOptions: {\r\n        constraints: this.getConstraints(),\r\n      },\r\n    });\r\n    this.notify(Events.ACCEPTED_CALL, acceptedCall);\r\n  };\r\n  onReceiveCall = (state: SessionState, invitation: Invitation) => {\r\n    console.log(`Session state changed to ${state}`);\r\n    switch (state) {\r\n      case SessionState.Initial:\r\n        this.notify(Events.RECEIVED_CALL, invitation);\r\n        break;\r\n      case SessionState.Establishing:\r\n        break;\r\n      case SessionState.Established:\r\n        const { receivingVideo, tagId } =\r\n          this.sip.setupRemoteMedia(invitation, this.getSpeakerId()) || {};\r\n        this.notify(Events.CALL_ON_GOING, {\r\n          invitation,\r\n          receivingVideo,\r\n          tagId,\r\n        });\r\n        break;\r\n      case SessionState.Terminating:\r\n      // fall through\r\n      case SessionState.Terminated:\r\n        this.notify(Events.CALL_HANGUP, invitation);\r\n        this.sip.activeCalls.delete(invitation.id);\r\n        this.sip.cleanupMedia(invitation.id);\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  };\r\n\r\n  muteMic = (callId: string) => {\r\n    this.notify(Events.MUTE_MIC, { callId, status: true });\r\n    this.sip.muteMic(callId);\r\n  };\r\n  unMuteMic = (callId: string) => {\r\n    this.notify(Events.MUTE_MIC, { callId, status: false });\r\n    this.sip.unMuteMic(callId);\r\n  };\r\n  disableCam = (callId: string) => {\r\n    this.notify(Events.MUTE_CAM, { callId, status: true });\r\n    this.sip.disableCam(callId);\r\n  };\r\n  enableCam = (callId: string) => {\r\n    this.notify(Events.MUTE_CAM, { callId, status: false });\r\n    this.sip.enableCam(callId);\r\n  };\r\n  holdCall = (callId: string) => {\r\n    this.notify(Events.HOLD_CALL, { callId, status: true });\r\n    this.sip.holdCall(callId);\r\n  };\r\n  unHoldCall = (callId: string) => {\r\n    Array.from(this.sip.activeCalls.values())\r\n      .filter((cl) => cl.id !== callId)\r\n      .forEach((call) => {\r\n        this.sip.holdCall(call.id);\r\n        this.notify(Events.HOLD_CALL, { callId: call.id, status: true });\r\n      });\r\n    this.notify(Events.HOLD_CALL, { callId, status: false });\r\n    this.sip.unHoldCall(callId);\r\n  };\r\n\r\n  // < -- Observer Pattern https://refactoring.guru/pt-br/design-patterns/observer\r\n  subscribe(subscribeCallback: SubscriptionCallBack) {\r\n    this.subscriptions?.set(this.nextSubscriptionId || 0, subscribeCallback);\r\n    if (this.nextSubscriptionId) this.nextSubscriptionId += 1;\r\n  }\r\n  removeSubscription(id: number) {\r\n    this.subscriptions?.delete(id);\r\n  }\r\n  removeAllSubscription() {\r\n    this.subscriptions = new Map<number, SubscriptionCallBack>();\r\n  }\r\n  notify(event: Events, data: any = null) {\r\n    if (this.subscriptions) {\r\n      this.subscriptions.forEach((subscribeCallback) => {\r\n        if (subscribeCallback) subscribeCallback(event, data);\r\n      });\r\n    }\r\n  }\r\n  // -- >\r\n}\r\n"]},"metadata":{},"sourceType":"module"}