{"ast":null,"code":"import { client, xml } from \"@xmpp/client\";\nimport { v4 } from \"uuid\";\nimport PresenceStatus from \"../../enuns/PresenceStatus\";\nimport { Events } from \"./types/types\";\nimport { getFrom, getMessage, isTextMessage, getTo, getMessageId, isFileMessage, getMessageType, getMessagFileUrl, getReplyTo, getReplyMsg, getReplyMsgId, isReceived, isDisplayed, getReceivedMessageId, getDisplayedMessageId, isComposing, isActive, isGroupEvent, getEventId, isNewGroup, getEventBody } from \"./util/stanzaUtils\";\n\nconst events = require(\"events\");\n\nexport default class Chat extends events.EventEmitter {\n  constructor({\n    service: _service,\n    domain: _domain,\n    resource: _resource,\n    username: _username,\n    password: _password\n  }) {\n    super();\n\n    this.getJid = () => {\n      return `${this.username}@${this.getDomain()}`;\n    };\n\n    this.getDomain = () => {\n      return this.domain || this.service.replace(\"wss://\", \"\").replace(\"ws://\", \"\").split(\"/\")[0];\n    };\n\n    this.instanceMaker = ({\n      service,\n      domain,\n      resource,\n      username,\n      password\n    }) => {\n      const xmpp = client({\n        service: service,\n        domain: domain,\n        resource: resource,\n        username: username,\n        password: password\n      });\n      xmpp.on(\"status\", this.onStatus);\n      xmpp.on(\"stanza\", this.onStanza);\n      xmpp.on(\"online\", this.onOnline);\n      xmpp.on(\"error\", this.onError);\n      xmpp.on(\"offline\", this.onOffline);\n      xmpp.reconnect.on(\"reconnecting\", this.onReconnecting);\n      xmpp.reconnect.on(\"reconnected\", this.onReconnected);\n      return xmpp;\n    };\n\n    this.onReconnecting = () => {\n      // console.log(\"reconnecting\");\n      this.emit(\"reconnecting\");\n    };\n\n    this.onReconnected = () => {\n      // console.log(\"reconnected\");\n      this.emit(\"reconnected\");\n    };\n\n    this.onStanza = stanza => {\n      this.emit(\"stanza\", stanza);\n      if (stanza.is(\"message\")) this.onMessage(stanza);else if (stanza.is(\"presence\")) this.onPresence(stanza);else if (stanza.is(\"iq\")) this.onIQ(stanza);else return;\n    };\n\n    this.onOnline = __ => {\n      this.discoItensId = v4(); // this.sendEnableCarbon();\n\n      this.sendServiceDiscoveryRequest(this.discoItensId);\n      this.client.send(xml(\"presence\"));\n      this.emit(\"online\");\n    };\n\n    this.onOffline = () => {\n      this.emit(\"offline\");\n    };\n\n    this.onError = e => {\n      this.emit(\"error\", e);\n    };\n\n    this.onStatus = status => {\n      this.emit(\"status\", status);\n    };\n\n    this.onMessage = stanza => {\n      if (isGroupEvent(stanza)) {\n        if (isNewGroup(stanza)) {\n          const eventToNewGroup = {\n            to: getTo(stanza),\n            from: getFrom(stanza),\n            id: v4(),\n            eventId: 1,\n            message: \"\",\n            reply_msg: undefined,\n            sent_at: new Date().toISOString(),\n            type: \"groupchat\",\n            reply_msg_id: undefined,\n            reply_to: undefined\n          };\n          this.emit(Events.SEND_EVENT, eventToNewGroup);\n        } else {\n          const event = {\n            id: getMessageId(stanza),\n            to: getTo(stanza),\n            from: getFrom(stanza),\n            message: \"\",\n            type: \"groupchat\",\n            sent_at: new Date().toISOString(),\n            reply_to: undefined,\n            reply_msg: undefined,\n            reply_msg_id: undefined,\n            eventId: getEventId(stanza),\n            eventBody: getEventBody(stanza)\n          };\n          this.emit(Events.SEND_EVENT, event);\n        }\n      } else if (isTextMessage(stanza)) {\n        const message = {\n          id: getMessageId(stanza),\n          to: getTo(stanza),\n          from: getFrom(stanza),\n          message: getMessage(stanza),\n          type: getMessageType(stanza),\n          sent_at: new Date().toISOString(),\n          reply_to: getReplyTo(stanza),\n          reply_msg: getReplyMsg(stanza),\n          reply_msg_id: getReplyMsgId(stanza)\n        };\n        this.sendReceipts(stanza);\n        this.emit(Events.MESSAGE, message);\n      } else if (isFileMessage(stanza)) {\n        const fileMessage = {\n          id: getMessageId(stanza),\n          to: getTo(stanza),\n          from: getFrom(stanza),\n          message: \"\",\n          type: getMessageType(stanza),\n          sent_at: new Date().toISOString(),\n          reply_to: getReplyTo(stanza),\n          reply_msg: getReplyMsg(stanza),\n          reply_msg_id: getReplyMsgId(stanza),\n          fileUrl: getMessagFileUrl(stanza)\n        };\n        this.sendReceipts(stanza);\n        this.emit(Events.MESSAGE, fileMessage);\n      } else if (isReceived(stanza)) {\n        const received = {\n          id: getReceivedMessageId(stanza)\n        };\n        this.emit(Events.RECEIVED, received);\n      } else if (isDisplayed(stanza)) {\n        const displayed = {\n          id: getDisplayedMessageId(stanza)\n        };\n        this.emit(Events.DISPLAYED, displayed);\n      } else if (isComposing(stanza)) {\n        this.emit(Events.COMPOSING, getFrom(stanza));\n      } else if (isActive(stanza)) {\n        this.emit(Events.ACTIVE, getFrom(stanza));\n      }\n    };\n\n    this.onPresence = stanza => {\n      const presence = {\n        id: v4(),\n        from: stanza.attrs.from,\n        time: new Date().toISOString(),\n        status: stanza.getChild(\"show\") ? stanza.getChild(\"show\").children[0] : stanza.attrs.type || \"online\"\n      };\n      const otherPresence = Array.from(this.presences.values()).find(pres => pres.from.split(\"/\")[0] === presence.from.split(\"/\")[0] && pres.from !== presence.from);\n\n      if (otherPresence && presence.status === \"offline\") {\n        this.emit(\"presence\", otherPresence);\n      } else {\n        this.emit(\"presence\", presence);\n      }\n\n      this.presences.set(stanza.attrs.from, presence);\n    };\n\n    this.onIQ = stanza => {\n      if (stanza.attrs.type === \"result\") {\n        if (stanza.attrs.id) {\n          const file = this.filesQueue.get(stanza.attrs.id);\n\n          if (file) {\n            if (stanza.attrs.id === file.firstStepId) {\n              this.sendFileSecondStep(stanza);\n            } else if (stanza.attrs.id === file.secondStepId) {\n              this.sendFileThirdStep(stanza, file);\n            }\n          } else if (stanza.attrs.id === this.discoItensId) {\n            stanza.children[0].children.forEach(element => {\n              const key = element.attrs.jid.split(\".\")[0];\n              this.discoItems.set(key, element.attrs.jid);\n            });\n          }\n        }\n      }\n    };\n\n    this.getPresence = from => {\n      const presence = this.presences.get(from);\n      if (presence) return presence;else return null;\n    };\n\n    this.sendEnableCarbon = () => {\n      const stanza = xml(\"iq\", {\n        from: `${this.getJid()}/${this.resource}`,\n        type: \"set\",\n        id: \"enable1\"\n      }, xml(\"enable\", {\n        xmlns: \"urn:xmpp:carbons:2\"\n      }));\n      this.client.send(stanza);\n    };\n\n    this.sendPresence = (status, to = undefined) => {\n      const show = xml(\"show\", {}, status);\n      if (status !== \"online\") this.client.send(xml(\"presence\", {\n        to\n      }, show));else this.client.send(xml(\"presence\"));\n    };\n\n    this.leaveGroup = (to, type = PresenceStatus.UNAVAILABLE) => {\n      this.client.send(xml(\"presence\", {\n        to,\n        type\n      }));\n    };\n\n    this.sendMessage = (to, chatType, message, callback) => {\n      const msgId = v4();\n      this.client.send(xml(\"message\", {\n        id: msgId,\n        type: chatType,\n        to: to\n      }, xml(\"body\", {}, message), xml(\"request\", {\n        xmlns: \"urn:xmpp:receipts\"\n      }))).then(() => {\n        callback(msgId);\n      });\n    };\n\n    this.sendFile = (to, chatType, file, callback) => {\n      const fileId = v4();\n      this.filesQueue.set(fileId, {\n        firstStepId: fileId,\n        file: file,\n        to: to,\n        chatType: chatType,\n        callback: callback\n      });\n      this.sendFileFirstStep(fileId);\n    };\n\n    this.sendImageMessage = (url, to, chatType, callback) => {\n      const msgId = v4();\n      const messagePacket = xml(\"message\", {\n        id: msgId,\n        type: chatType,\n        to: to\n      }, xml(\"body\", {}, url), xml(\"request\", {\n        xmlns: \"urn:xmpp:receipts\"\n      }), xml(\"x\", {\n        xmlns: \"jabber:x:oob\"\n      }, xml(\"url\", {}, url)));\n\n      if (this.client) {\n        callback({\n          url,\n          msgId\n        });\n        this.client.send(messagePacket);\n      }\n    };\n\n    this.sendFileFirstStep = fileId => {\n      const uploadJid = this.discoItems.get(\"upload\");\n\n      if (uploadJid) {\n        this.sendServiceDiscoveryRequestToUpload(uploadJid, fileId);\n        return;\n      }\n    };\n\n    this.sendFileSecondStep = stanza => {\n      if (stanza.children.length > 0) {\n        const secondStepId = v4();\n        const file = this.filesQueue.get(stanza.attrs.id);\n\n        if (file) {\n          this.filesQueue.set(secondStepId, {\n            firstStepId: file.firstStepId,\n            secondStepId: secondStepId,\n            file: file.file,\n            to: file.to,\n            chatType: file.chatType,\n            callback: file.callback\n          });\n          this.filesQueue.delete(stanza.attrs.id);\n        }\n\n        console.log(\"upload request xmlns\", stanza.children[0].children[2].attrs.var);\n        this.sendRequestSlotOnUpload(stanza.attrs.from, secondStepId);\n      }\n    };\n\n    this.sendFileThirdStep = (stanza, file) => {\n      let getUrl = \"\";\n      let putUrl = \"\";\n      stanza.children[0].children.forEach(element => {\n        if (element.is(\"get\")) {\n          getUrl = element.attrs.url;\n        } else if (element.is(\"put\")) {\n          putUrl = element.attrs.url;\n        }\n      });\n      if (file === null || file === void 0 ? void 0 : file.secondStepId) this.uploadFile(putUrl, getUrl, file.secondStepId);\n    };\n\n    this.sendServiceDiscoveryRequest = fileId => {\n      const serviceDiscoveryRequest = xml(\"iq\", {\n        type: \"get\",\n        to: this.getDomain(),\n        id: fileId\n      }, xml(\"query\", {\n        xmlns: \"http://jabber.org/protocol/disco#items\"\n      }));\n\n      if (this.client) {\n        this.client.send(serviceDiscoveryRequest);\n      }\n    };\n\n    this.sendServiceDiscoveryRequestToUpload = (uploadJid, uploadId) => {\n      console.log(\"sendServiceDiscoveryRequestToUpload\", uploadJid);\n      const serviceDiscoveryRequest = xml(\"iq\", {\n        type: \"get\",\n        to: uploadJid,\n        id: uploadId\n      }, xml(\"query\", {\n        xmlns: \"http://jabber.org/protocol/disco#info\"\n      }));\n\n      if (this.client) {\n        this.client.send(serviceDiscoveryRequest);\n      }\n    };\n\n    this.sendRequestSlotOnUpload = (uploadJid, thirdStepId) => {\n      var _this$filesQueue$get;\n\n      console.log(\"sendRequestSlotOnUpload\", uploadJid);\n      const file = (_this$filesQueue$get = this.filesQueue.get(thirdStepId)) === null || _this$filesQueue$get === void 0 ? void 0 : _this$filesQueue$get.file;\n      const serviceDiscoveryRequest = xml(\"iq\", {\n        type: \"get\",\n        to: uploadJid,\n        id: thirdStepId\n      }, xml(\"request\", {\n        xmlns: \"urn:xmpp:http:upload:0\",\n        filename: file === null || file === void 0 ? void 0 : file.name,\n        size: file === null || file === void 0 ? void 0 : file.size,\n        \"content-type\": file === null || file === void 0 ? void 0 : file.type\n      }));\n\n      if (this.client) {\n        this.client.send(serviceDiscoveryRequest);\n      }\n    };\n\n    this.uploadFile = (putUrl, getUrl, id) => {\n      let xhr = new XMLHttpRequest();\n      const file = this.filesQueue.get(id);\n\n      if (file) {\n        xhr.onerror = () => {\n          if (xhr.responseText) {\n            file.callback(xhr.responseText, true);\n            console.log(\"upload error\");\n          }\n        };\n\n        xhr.onreadystatechange = e => {\n          if (xhr.readyState === XMLHttpRequest.DONE) {\n            console.log(\"file upload response\", e, xhr.status);\n\n            if (xhr.status === 200 || xhr.status === 201) {\n              console.log(\"file upload response success\");\n              this.sendImageMessage(getUrl, file.to, file.chatType, file === null || file === void 0 ? void 0 : file.callback);\n              this.filesQueue.delete(id);\n            }\n          }\n        };\n\n        xhr.upload.addEventListener(\"progress\", evt => {\n          console.log(\"progress\", evt); // if (file) file.file.size = evt.total\n        }, false);\n        xhr.open(\"PUT\", putUrl, true);\n        xhr.setRequestHeader(\"Content-Type\", file.file.type);\n        xhr.send(file.file);\n        console.log(\"URL\", putUrl);\n        console.log(\"fileSize\", file.file.size);\n      }\n    };\n\n    this.sendReceipts = stanza => {\n      const message = xml(\"message\", {\n        from: stanza.attrs.to,\n        id: v4(),\n        to: stanza.attrs.from.split(\"/\")[0]\n      }, xml(\"received\", {\n        xmlns: \"urn:xmpp:receipts\",\n        id: stanza.attrs.id\n      }));\n      console.log(message);\n      this.client.send(message);\n    };\n\n    this.sendTyping = to => {\n      const composing = xml(\"message\", {\n        id: v4(),\n        to: to,\n        type: \"chat\"\n      }, xml(\"composing\", {\n        xmlns: \"http://jabber.org/protocol/chatstates\"\n      }));\n      this.client.send(composing);\n    };\n\n    this.sendActive = to => {\n      const active = xml(\"message\", {\n        id: v4(),\n        to: to,\n        type: \"chat\"\n      }, xml(\"active\", {\n        xmlns: \"http://jabber.org/protocol/chatstates\"\n      }));\n      this.client.send(active);\n    };\n\n    this.replyMsg = (to, chatType, message, replyed_sender, replyed_msg, replyed_msg_id, cb) => {\n      const id = v4();\n      const reply = xml(\"message\", {\n        to: to,\n        id,\n        type: chatType\n      }, xml(\"body\", {}, message), xml(\"extraParams\", {}, xml(\"reply_to\", {}, replyed_sender), xml(\"reply_msg\", {}, replyed_msg), xml(\"reply_msg_id\", {}, replyed_msg_id)));\n      this.client.send(reply).then(() => {\n        cb(id);\n      });\n    };\n\n    this.sendEvent = (to, eventBody = undefined, //jid from user\n    nbr = undefined, cb = () => {}) => {\n      const id = v4();\n      const stanza = xml(\"message\", {\n        to,\n        type: \"groupchat\",\n        id\n      }, xml(\"subject\", {}, \"KEY_ROOM_GENERAL\"), xml(\"body\", {}), xml(\"extraParams\", {\n        xmlns: \"jabber:client\"\n      }, xml(\"key_room_event\", {}, nbr), eventBody ? xml(\"key_room_event_body\", {}, eventBody) : undefined));\n      this.client.send(stanza).then(() => {\n        cb(id);\n      });\n    };\n\n    this.joinRoomEvent = (to, eventBody, from, cb = () => {}) => {\n      const id = v4();\n      const stanza = xml(\"message\", {\n        to,\n        from,\n        type: \"groupchat\",\n        id\n      }, //from - UNNECESSARY?\n      xml(\"extraParams\", {}, xml(\"key_room_event\", {}, \"2\"), eventBody ? xml(\"key_room_event_body\", {}, eventBody) : undefined), xml(\"body\", {}), xml(\"subject\", {}, \"KEY_ROOM_GENERAL\"));\n      this.client.send(stanza).then(() => {\n        cb(id);\n      });\n    };\n\n    this.forwardMsg = (to, chatType, forwarded_msg_sender, forwarded_msg, forwarded_msg_id, callback) => {\n      const id = v4();\n      const forward = xml(\"message\", {\n        to: to,\n        id,\n        type: chatType\n      }, xml(\"body\", {}, forwarded_msg), xml(\"extraParams\", {}, xml(\"reply_to\", {}, forwarded_msg_sender), xml(\"reply_msg_id\", {}, forwarded_msg_id)), xml(\"request\", {\n        xmlns: \"urn:xmpp:receipts\"\n      }));\n      this.client.send(forward).then(() => {\n        callback(id);\n      });\n    };\n\n    this.joinRoom = to => {\n      const joinStanza = xml(\"presence\", {\n        to: `${to}/${this.username}`,\n        from: `${this.getJid()}/${this.resource}`\n      }, xml(\"x\", {\n        xmlns: \"http://jabber.org/protocol/muc\"\n      }, xml(\"history\", {\n        maxstanzas: \"0\"\n      })));\n      this.client.send(joinStanza);\n    };\n\n    Object.setPrototypeOf(this, Chat.prototype);\n    this.service = _service;\n    this.domain = _domain;\n    this.resource = _resource;\n    this.username = _username;\n    this.password = _password;\n    this.client = this.instanceMaker({\n      service: _service,\n      domain: _domain,\n      resource: _resource,\n      username: _username,\n      password: _password\n    });\n    this.status = this.client.status;\n    this.connect = this.client.start;\n    this.filesQueue = new Map();\n    this.presences = new Map();\n    this.discoItems = new Map();\n  }\n\n}","map":{"version":3,"sources":["C:/Users/Digivox/dev/Digivox/Refatoracao/squad/src/services/chat/chatcommunicator.ts"],"names":["client","xml","v4","PresenceStatus","Events","getFrom","getMessage","isTextMessage","getTo","getMessageId","isFileMessage","getMessageType","getMessagFileUrl","getReplyTo","getReplyMsg","getReplyMsgId","isReceived","isDisplayed","getReceivedMessageId","getDisplayedMessageId","isComposing","isActive","isGroupEvent","getEventId","isNewGroup","getEventBody","events","require","Chat","EventEmitter","constructor","service","domain","resource","username","password","getJid","getDomain","replace","split","instanceMaker","xmpp","on","onStatus","onStanza","onOnline","onError","onOffline","reconnect","onReconnecting","onReconnected","emit","stanza","is","onMessage","onPresence","onIQ","__","discoItensId","sendServiceDiscoveryRequest","send","e","status","eventToNewGroup","to","from","id","eventId","message","reply_msg","undefined","sent_at","Date","toISOString","type","reply_msg_id","reply_to","SEND_EVENT","event","eventBody","sendReceipts","MESSAGE","fileMessage","fileUrl","received","RECEIVED","displayed","DISPLAYED","COMPOSING","ACTIVE","presence","attrs","time","getChild","children","otherPresence","Array","presences","values","find","pres","set","file","filesQueue","get","firstStepId","sendFileSecondStep","secondStepId","sendFileThirdStep","forEach","element","key","jid","discoItems","getPresence","sendEnableCarbon","xmlns","sendPresence","show","leaveGroup","UNAVAILABLE","sendMessage","chatType","callback","msgId","then","sendFile","fileId","sendFileFirstStep","sendImageMessage","url","messagePacket","uploadJid","sendServiceDiscoveryRequestToUpload","length","delete","console","log","var","sendRequestSlotOnUpload","getUrl","putUrl","uploadFile","serviceDiscoveryRequest","uploadId","thirdStepId","filename","name","size","xhr","XMLHttpRequest","onerror","responseText","onreadystatechange","readyState","DONE","upload","addEventListener","evt","open","setRequestHeader","sendTyping","composing","sendActive","active","replyMsg","replyed_sender","replyed_msg","replyed_msg_id","cb","reply","sendEvent","nbr","joinRoomEvent","forwardMsg","forwarded_msg_sender","forwarded_msg","forwarded_msg_id","forward","joinRoom","joinStanza","maxstanzas","Object","setPrototypeOf","prototype","connect","start","Map"],"mappings":"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","sourcesContent":["import { client, xml, XmppClient } from \"@xmpp/client\";\r\nimport { v4 } from \"uuid\";\r\nimport PresenceStatus from \"../../enuns/PresenceStatus\";\r\nimport {\r\n  ActiveCallback,\r\n  ChatType,\r\n  ComposingCallback,\r\n  ConnectionOptions,\r\n  DisplayedCallback,\r\n  ErrorCallback,\r\n  EventCallback,\r\n  Events,\r\n  FileMessage,\r\n  Message,\r\n  MessageCallback,\r\n  OfflineCallback,\r\n  OnlineCallback,\r\n  Presence,\r\n  PresenceCallback,\r\n  ReceivedCallback,\r\n  SendImageCallback,\r\n  SendingFile,\r\n  SendMessageCallback,\r\n  StanzaCallback,\r\n} from \"./types/types\";\r\nimport {\r\n  getFrom,\r\n  getMessage,\r\n  isTextMessage,\r\n  getTo,\r\n  getMessageId,\r\n  isFileMessage,\r\n  getMessageType,\r\n  getMessagFileUrl,\r\n  getReplyTo,\r\n  getReplyMsg,\r\n  getReplyMsgId,\r\n  isReceived,\r\n  isDisplayed,\r\n  getReceivedMessageId,\r\n  getDisplayedMessageId,\r\n  isComposing,\r\n  isActive,\r\n  isGroupEvent,\r\n  getEventId,\r\n  isNewGroup,\r\n  getEventBody,\r\n} from \"./util/stanzaUtils\";\r\nconst events = require(\"events\");\r\n\r\nexport default interface Chat {\r\n  service: string;\r\n  domain?: string;\r\n  resource: string;\r\n  username: string;\r\n  password?: string;\r\n  client: XmppClient;\r\n  status: string;\r\n  filesQueue: Map<string, SendingFile>;\r\n  presences: Map<string, Presence>;\r\n  connect(): Promise<any>;\r\n  on(event: Events.MESSAGE, cb: MessageCallback): this;\r\n  on(event: Events.PRESENCE, cb: PresenceCallback): this;\r\n  on(event: Events.ONLINE, cb: OnlineCallback): this;\r\n  on(event: Events.OFFLINE, cb: OfflineCallback): this;\r\n  on(event: Events.ERROR, cb: ErrorCallback): this;\r\n  on(event: Events.STANZA, cb: StanzaCallback): this;\r\n  on(event: Events.RECEIVED, cb: ReceivedCallback): this;\r\n  on(event: Events.DISPLAYED, cb: DisplayedCallback): this;\r\n  on(event: Events.COMPOSING, cb: ComposingCallback): this;\r\n  on(event: Events.ACTIVE, cb: ActiveCallback): this;\r\n  on(event: Events.JOIN_ROOM, cb: EventCallback): this;\r\n  on(event: Events.SEND_EVENT, cb: EventCallback): this;\r\n  on(event: Events.RECONNECTING, cb: EventCallback): this;\r\n  on(event: Events.RECONNECTED, cb: EventCallback): this;\r\n  getPresence(from: string): Presence | null;\r\n  sendMessage(\r\n    to: string,\r\n    chatType: ChatType,\r\n    message: string,\r\n    cb: SendMessageCallback\r\n  ): void;\r\n  sendFile(\r\n    to: string,\r\n    chatType: ChatType,\r\n    file: File,\r\n    callback: SendImageCallback\r\n  ): void;\r\n  getDomain(): string;\r\n  joinRoom(to: string): void;\r\n}\r\nexport default class Chat extends events.EventEmitter {\r\n  constructor({\r\n    service,\r\n    domain,\r\n    resource,\r\n    username,\r\n    password,\r\n  }: ConnectionOptions) {\r\n    super();\r\n    Object.setPrototypeOf(this, Chat.prototype);\r\n    this.service = service;\r\n    this.domain = domain;\r\n    this.resource = resource;\r\n    this.username = username;\r\n    this.password = password;\r\n    this.client = this.instanceMaker({\r\n      service: service,\r\n      domain: domain,\r\n      resource: resource,\r\n      username: username,\r\n      password: password,\r\n    });\r\n    this.status = this.client.status;\r\n    this.connect = this.client.start;\r\n    this.filesQueue = new Map<string, SendingFile>();\r\n    this.presences = new Map<string, Presence>();\r\n    this.discoItems = new Map<string, string>();\r\n  }\r\n\r\n  getJid = () => {\r\n    return `${this.username}@${this.getDomain()}`;\r\n  };\r\n\r\n  getDomain = () => {\r\n    return (\r\n      this.domain ||\r\n      this.service.replace(\"wss://\", \"\").replace(\"ws://\", \"\").split(\"/\")[0]\r\n    );\r\n  };\r\n\r\n  instanceMaker = ({\r\n    service,\r\n    domain,\r\n    resource,\r\n    username,\r\n    password,\r\n  }: ConnectionOptions) => {\r\n    const xmpp = client({\r\n      service: service,\r\n      domain: domain,\r\n      resource: resource,\r\n      username: username,\r\n      password: password,\r\n    });\r\n    xmpp.on(\"status\", this.onStatus);\r\n    xmpp.on(\"stanza\", this.onStanza);\r\n    xmpp.on(\"online\", this.onOnline);\r\n    xmpp.on(\"error\", this.onError);\r\n    xmpp.on(\"offline\", this.onOffline);\r\n    xmpp.reconnect.on(\"reconnecting\", this.onReconnecting);\r\n    xmpp.reconnect.on(\"reconnected\", this.onReconnected);\r\n    return xmpp;\r\n  };\r\n  onReconnecting = () => {\r\n    // console.log(\"reconnecting\");\r\n    this.emit(\"reconnecting\");\r\n  };\r\n  onReconnected = () => {\r\n    // console.log(\"reconnected\");\r\n    this.emit(\"reconnected\");\r\n  };\r\n  onStanza = (stanza: any) => {\r\n    this.emit(\"stanza\", stanza);\r\n    if (stanza.is(\"message\")) this.onMessage(stanza);\r\n    else if (stanza.is(\"presence\")) this.onPresence(stanza);\r\n    else if (stanza.is(\"iq\")) this.onIQ(stanza);\r\n    else return;\r\n  };\r\n\r\n  onOnline = (__: any) => {\r\n    this.discoItensId = v4();\r\n    // this.sendEnableCarbon();\r\n    this.sendServiceDiscoveryRequest(this.discoItensId);\r\n    this.client.send(xml(\"presence\"));\r\n    this.emit(\"online\");\r\n  };\r\n\r\n  onOffline = () => {\r\n    this.emit(\"offline\");\r\n  };\r\n\r\n  onError = (e: any) => {\r\n    this.emit(\"error\", e);\r\n  };\r\n\r\n  onStatus = (status: string) => {\r\n    this.emit(\"status\", status);\r\n  };\r\n\r\n  onMessage = (stanza: any) => {\r\n    if (isGroupEvent(stanza)) {\r\n      if (isNewGroup(stanza)) {\r\n        const eventToNewGroup: Message = {\r\n          to: getTo(stanza),\r\n          from: getFrom(stanza),\r\n          id: v4(),\r\n          eventId: 1,\r\n          message: \"\",\r\n          reply_msg: undefined,\r\n          sent_at: new Date().toISOString(),\r\n          type: \"groupchat\",\r\n          reply_msg_id: undefined,\r\n          reply_to: undefined,\r\n        };\r\n        this.emit(Events.SEND_EVENT, eventToNewGroup);\r\n      } else {\r\n        const event: Message = {\r\n          id: getMessageId(stanza),\r\n          to: getTo(stanza),\r\n          from: getFrom(stanza),\r\n          message: \"\",\r\n          type: \"groupchat\",\r\n          sent_at: new Date().toISOString(),\r\n          reply_to: undefined,\r\n          reply_msg: undefined,\r\n          reply_msg_id: undefined,\r\n          eventId: getEventId(stanza),\r\n          eventBody: getEventBody(stanza),\r\n        };\r\n        this.emit(Events.SEND_EVENT, event);\r\n      }\r\n    } else if (isTextMessage(stanza)) {\r\n      const message: Message = {\r\n        id: getMessageId(stanza),\r\n        to: getTo(stanza),\r\n        from: getFrom(stanza),\r\n        message: getMessage(stanza),\r\n        type: getMessageType(stanza),\r\n        sent_at: new Date().toISOString(),\r\n        reply_to: getReplyTo(stanza),\r\n        reply_msg: getReplyMsg(stanza),\r\n        reply_msg_id: getReplyMsgId(stanza),\r\n      };\r\n      this.sendReceipts(stanza);\r\n      this.emit(Events.MESSAGE, message);\r\n    } else if (isFileMessage(stanza)) {\r\n      const fileMessage: FileMessage = {\r\n        id: getMessageId(stanza),\r\n        to: getTo(stanza),\r\n        from: getFrom(stanza),\r\n        message: \"\",\r\n        type: getMessageType(stanza),\r\n        sent_at: new Date().toISOString(),\r\n        reply_to: getReplyTo(stanza),\r\n        reply_msg: getReplyMsg(stanza),\r\n        reply_msg_id: getReplyMsgId(stanza),\r\n        fileUrl: getMessagFileUrl(stanza),\r\n      };\r\n      this.sendReceipts(stanza);\r\n      this.emit(Events.MESSAGE, fileMessage);\r\n    } else if (isReceived(stanza)) {\r\n      const received = {\r\n        id: getReceivedMessageId(stanza),\r\n      };\r\n      this.emit(Events.RECEIVED, received);\r\n    } else if (isDisplayed(stanza)) {\r\n      const displayed = {\r\n        id: getDisplayedMessageId(stanza),\r\n      };\r\n      this.emit(Events.DISPLAYED, displayed);\r\n    } else if (isComposing(stanza)) {\r\n      this.emit(Events.COMPOSING, getFrom(stanza));\r\n    } else if (isActive(stanza)) {\r\n      this.emit(Events.ACTIVE, getFrom(stanza));\r\n    }\r\n  };\r\n\r\n  onPresence = (stanza: any) => {\r\n    const presence: Presence = {\r\n      id: v4(),\r\n      from: stanza.attrs.from,\r\n      time: new Date().toISOString(),\r\n      status: stanza.getChild(\"show\")\r\n        ? stanza.getChild(\"show\").children[0]\r\n        : stanza.attrs.type || \"online\",\r\n    };\r\n    const otherPresence = Array.from(this.presences.values()).find(\r\n      (pres) =>\r\n        pres.from.split(\"/\")[0] === presence.from.split(\"/\")[0] &&\r\n        pres.from !== presence.from\r\n    );\r\n    if (otherPresence && presence.status === \"offline\") {\r\n      this.emit(\"presence\", otherPresence);\r\n    } else {\r\n      this.emit(\"presence\", presence);\r\n    }\r\n    this.presences.set(stanza.attrs.from, presence);\r\n  };\r\n\r\n  onIQ = (stanza: any) => {\r\n    if (stanza.attrs.type === \"result\") {\r\n      if (stanza.attrs.id) {\r\n        const file = this.filesQueue.get(stanza.attrs.id);\r\n        if (file) {\r\n          if (stanza.attrs.id === file.firstStepId) {\r\n            this.sendFileSecondStep(stanza);\r\n          } else if (stanza.attrs.id === file.secondStepId) {\r\n            this.sendFileThirdStep(stanza, file);\r\n          }\r\n        } else if (stanza.attrs.id === this.discoItensId) {\r\n          stanza.children[0].children.forEach((element: any) => {\r\n            const key = element.attrs.jid.split(\".\")[0];\r\n            this.discoItems.set(key, element.attrs.jid);\r\n          });\r\n        }\r\n      }\r\n    }\r\n  };\r\n  getPresence = (from: string) => {\r\n    const presence = this.presences.get(from);\r\n    if (presence) return presence;\r\n    else return null;\r\n  };\r\n  sendEnableCarbon = () => {\r\n    const stanza = xml(\r\n      \"iq\",\r\n      { from: `${this.getJid()}/${this.resource}`, type: \"set\", id: \"enable1\" },\r\n      xml(\"enable\", { xmlns: \"urn:xmpp:carbons:2\" })\r\n    );\r\n    this.client.send(stanza);\r\n  };\r\n  sendPresence = (status: string, to: string | undefined = undefined) => {\r\n    const show = xml(\"show\", {}, status);\r\n    if (status !== \"online\") this.client.send(xml(\"presence\", { to }, show));\r\n    else this.client.send(xml(\"presence\"));\r\n  };\r\n  leaveGroup = (\r\n    to: string,\r\n    type: PresenceStatus = PresenceStatus.UNAVAILABLE\r\n  ) => {\r\n    this.client.send(xml(\"presence\", { to, type }));\r\n  };\r\n  sendMessage = (\r\n    to: string,\r\n    chatType: ChatType,\r\n    message: string,\r\n    callback: SendMessageCallback\r\n  ) => {\r\n    const msgId = v4();\r\n    this.client\r\n      .send(\r\n        xml(\r\n          \"message\",\r\n          {\r\n            id: msgId,\r\n            type: chatType,\r\n            to: to,\r\n          },\r\n          xml(\"body\", {}, message),\r\n          xml(\"request\", { xmlns: \"urn:xmpp:receipts\" })\r\n        )\r\n      )\r\n      .then(() => {\r\n        callback(msgId);\r\n      });\r\n  };\r\n\r\n  sendFile = (\r\n    to: string,\r\n    chatType: ChatType,\r\n    file: File,\r\n    callback: SendImageCallback\r\n  ) => {\r\n    const fileId = v4();\r\n    this.filesQueue.set(fileId, {\r\n      firstStepId: fileId,\r\n      file: file,\r\n      to: to,\r\n      chatType: chatType,\r\n      callback: callback,\r\n    });\r\n    this.sendFileFirstStep(fileId);\r\n  };\r\n\r\n  sendImageMessage = (\r\n    url: string,\r\n    to: string,\r\n    chatType: ChatType,\r\n    callback: SendImageCallback\r\n  ) => {\r\n    const msgId = v4();\r\n    const messagePacket = xml(\r\n      \"message\",\r\n      {\r\n        id: msgId,\r\n        type: chatType,\r\n        to: to,\r\n      },\r\n      xml(\"body\", {}, url),\r\n      xml(\"request\", { xmlns: \"urn:xmpp:receipts\" }),\r\n      xml(\"x\", { xmlns: \"jabber:x:oob\" }, xml(\"url\", {}, url))\r\n    );\r\n    if (this.client) {\r\n      callback({ url, msgId });\r\n      this.client.send(messagePacket);\r\n    }\r\n  };\r\n\r\n  sendFileFirstStep = (fileId: string) => {\r\n    const uploadJid = this.discoItems.get(\"upload\");\r\n    if (uploadJid) {\r\n      this.sendServiceDiscoveryRequestToUpload(uploadJid, fileId);\r\n      return;\r\n    }\r\n  };\r\n\r\n  sendFileSecondStep = (stanza: any) => {\r\n    if (stanza.children.length > 0) {\r\n      const secondStepId = v4();\r\n      const file = this.filesQueue.get(stanza.attrs.id);\r\n      if (file) {\r\n        this.filesQueue.set(secondStepId, {\r\n          firstStepId: file.firstStepId,\r\n          secondStepId: secondStepId,\r\n          file: file.file,\r\n          to: file.to,\r\n          chatType: file.chatType,\r\n          callback: file.callback,\r\n        });\r\n        this.filesQueue.delete(stanza.attrs.id);\r\n      }\r\n      console.log(\r\n        \"upload request xmlns\",\r\n        stanza.children[0].children[2].attrs.var\r\n      );\r\n      this.sendRequestSlotOnUpload(stanza.attrs.from, secondStepId);\r\n    }\r\n  };\r\n\r\n  sendFileThirdStep = (stanza: any, file: SendingFile) => {\r\n    let getUrl = \"\";\r\n    let putUrl = \"\";\r\n    stanza.children[0].children.forEach((element: any) => {\r\n      if (element.is(\"get\")) {\r\n        getUrl = element.attrs.url;\r\n      } else if (element.is(\"put\")) {\r\n        putUrl = element.attrs.url;\r\n      }\r\n    });\r\n    if (file?.secondStepId) this.uploadFile(putUrl, getUrl, file.secondStepId);\r\n  };\r\n\r\n  sendServiceDiscoveryRequest = (fileId: string) => {\r\n    const serviceDiscoveryRequest = xml(\r\n      \"iq\",\r\n      {\r\n        type: \"get\",\r\n        to: this.getDomain(),\r\n        id: fileId,\r\n      },\r\n      xml(\"query\", { xmlns: \"http://jabber.org/protocol/disco#items\" })\r\n    );\r\n    if (this.client) {\r\n      this.client.send(serviceDiscoveryRequest);\r\n    }\r\n  };\r\n\r\n  sendServiceDiscoveryRequestToUpload = (\r\n    uploadJid: string,\r\n    uploadId: string\r\n  ) => {\r\n    console.log(\"sendServiceDiscoveryRequestToUpload\", uploadJid);\r\n    const serviceDiscoveryRequest = xml(\r\n      \"iq\",\r\n      {\r\n        type: \"get\",\r\n        to: uploadJid,\r\n        id: uploadId,\r\n      },\r\n      xml(\"query\", { xmlns: \"http://jabber.org/protocol/disco#info\" })\r\n    );\r\n    if (this.client) {\r\n      this.client.send(serviceDiscoveryRequest);\r\n    }\r\n  };\r\n\r\n  sendRequestSlotOnUpload = (uploadJid: string, thirdStepId: string) => {\r\n    console.log(\"sendRequestSlotOnUpload\", uploadJid);\r\n    const file = this.filesQueue.get(thirdStepId)?.file;\r\n    const serviceDiscoveryRequest = xml(\r\n      \"iq\",\r\n      {\r\n        type: \"get\",\r\n        to: uploadJid,\r\n        id: thirdStepId,\r\n      },\r\n      xml(\"request\", {\r\n        xmlns: \"urn:xmpp:http:upload:0\",\r\n        filename: file?.name,\r\n        size: file?.size,\r\n        \"content-type\": file?.type,\r\n      })\r\n    );\r\n    if (this.client) {\r\n      this.client.send(serviceDiscoveryRequest);\r\n    }\r\n  };\r\n\r\n  uploadFile = (putUrl: string, getUrl: string, id: string) => {\r\n    let xhr = new XMLHttpRequest();\r\n    const file = this.filesQueue.get(id);\r\n    if (file) {\r\n      xhr.onerror = () => {\r\n        if (xhr.responseText) {\r\n          file.callback(xhr.responseText, true);\r\n          console.log(\"upload error\");\r\n        }\r\n      };\r\n      xhr.onreadystatechange = (e) => {\r\n        if (xhr.readyState === XMLHttpRequest.DONE) {\r\n          console.log(\"file upload response\", e, xhr.status);\r\n          if (xhr.status === 200 || xhr.status === 201) {\r\n            console.log(\"file upload response success\");\r\n            this.sendImageMessage(\r\n              getUrl,\r\n              file.to,\r\n              file.chatType,\r\n              file?.callback\r\n            );\r\n            this.filesQueue.delete(id);\r\n          }\r\n        }\r\n      };\r\n      xhr.upload.addEventListener(\r\n        \"progress\",\r\n        (evt) => {\r\n          console.log(\"progress\", evt);\r\n          // if (file) file.file.size = evt.total\r\n        },\r\n        false\r\n      );\r\n      xhr.open(\"PUT\", putUrl, true);\r\n      xhr.setRequestHeader(\"Content-Type\", file.file.type);\r\n\r\n      xhr.send(file.file);\r\n\r\n      console.log(\"URL\", putUrl);\r\n      console.log(\"fileSize\", file.file.size);\r\n    }\r\n  };\r\n  sendReceipts = (stanza: any) => {\r\n    const message = xml(\r\n      \"message\",\r\n      {\r\n        from: stanza.attrs.to,\r\n        id: v4(),\r\n        to: stanza.attrs.from.split(\"/\")[0],\r\n      },\r\n      xml(\"received\", { xmlns: \"urn:xmpp:receipts\", id: stanza.attrs.id })\r\n    );\r\n    console.log(message);\r\n    this.client.send(message);\r\n  };\r\n  sendTyping = (to: string) => {\r\n    const composing = xml(\r\n      \"message\",\r\n      {\r\n        id: v4(),\r\n        to: to,\r\n        type: \"chat\",\r\n      },\r\n      xml(\"composing\", {\r\n        xmlns: \"http://jabber.org/protocol/chatstates\",\r\n      })\r\n    );\r\n    this.client.send(composing);\r\n  };\r\n  sendActive = (to: string) => {\r\n    const active = xml(\r\n      \"message\",\r\n      {\r\n        id: v4(),\r\n        to: to,\r\n        type: \"chat\",\r\n      },\r\n      xml(\"active\", {\r\n        xmlns: \"http://jabber.org/protocol/chatstates\",\r\n      })\r\n    );\r\n    this.client.send(active);\r\n  };\r\n  replyMsg = (\r\n    to: string,\r\n    chatType: string,\r\n    message: string,\r\n    replyed_sender: string,\r\n    replyed_msg: string,\r\n    replyed_msg_id: string,\r\n    cb: SendMessageCallback\r\n  ) => {\r\n    const id = v4();\r\n    const reply = xml(\r\n      \"message\",\r\n      { to: to, id, type: chatType },\r\n      xml(\"body\", {}, message),\r\n      xml(\r\n        \"extraParams\",\r\n        {},\r\n        xml(\"reply_to\", {}, replyed_sender),\r\n        xml(\"reply_msg\", {}, replyed_msg),\r\n        xml(\"reply_msg_id\", {}, replyed_msg_id)\r\n      )\r\n    );\r\n    this.client.send(reply).then(() => {\r\n      cb(id);\r\n    });\r\n  };\r\n  /* \r\n  unMarkRoomEvent = (\r\n    to: string,\r\n    eventBody: string | undefined = undefined,\r\n    cb: SendMessageCallback\r\n  ) => {\r\n    const id = v4();\r\n    const stanza = xml(\r\n      \"message\",\r\n      { to, type: \"groupchat\", id },\r\n      xml(\"body\", {}),\r\n      xml(\"subject\", {}, \"KEY_ROOM_GENERAL\"),\r\n      xml(\r\n        \"extraParams\",\r\n        { xmlns: \"jabber:client\" },\r\n        xml(\"key_room_event\", {}, \"9\"),\r\n        eventBody ? xml(\"key_room_event_body\", {}, eventBody) : undefined\r\n      )\r\n    );\r\n    this.client.send(stanza).then(() => {\r\n      cb(id);\r\n    });\r\n  };*/\r\n\r\n  sendEvent = (\r\n    to: string,\r\n    eventBody: string | undefined = undefined, //jid from user\r\n    nbr: string | undefined = undefined,\r\n    cb: SendMessageCallback = () => {}\r\n  ) => {\r\n    const id = v4();\r\n    const stanza = xml(\r\n      \"message\",\r\n      { to, type: \"groupchat\", id },\r\n      xml(\"subject\", {}, \"KEY_ROOM_GENERAL\"),\r\n      xml(\"body\", {}),\r\n      xml(\r\n        \"extraParams\",\r\n        { xmlns: \"jabber:client\" },\r\n        xml(\"key_room_event\", {}, nbr),\r\n        eventBody ? xml(\"key_room_event_body\", {}, eventBody) : undefined\r\n      )\r\n    );\r\n    this.client.send(stanza).then(() => {\r\n      cb(id);\r\n    });\r\n  };\r\n\r\n  joinRoomEvent = (\r\n    to: string,\r\n    eventBody: string | undefined, //jid of user who was added -> I ADDED\r\n    from: string,\r\n    cb: SendMessageCallback = () => {}\r\n  ) => {\r\n    const id = v4();\r\n    const stanza = xml(\r\n      \"message\",\r\n      { to, from, type: \"groupchat\", id }, //from - UNNECESSARY?\r\n      xml(\r\n        \"extraParams\",\r\n        {},\r\n        xml(\"key_room_event\", {}, \"2\"),\r\n        eventBody ? xml(\"key_room_event_body\", {}, eventBody) : undefined\r\n      ),\r\n      xml(\"body\", {}),\r\n      xml(\"subject\", {}, \"KEY_ROOM_GENERAL\")\r\n    );\r\n    this.client.send(stanza).then(() => {\r\n      cb(id);\r\n    });\r\n  };\r\n\r\n  /*\r\n  leaveRoomEvent = (\r\n    to: string,\r\n    from: string,\r\n    cb: SendMessageCallback\r\n  ) => {\r\n    const id = v4();\r\n    const stanza = xml(\r\n      \"message\", {\r\n        to, from, type: \"groupchat\", id\r\n      },\r\n      xml(\"extraParams\", {},\r\n        xml(\"key_room_event\", {}, \"3\")\r\n      ),\r\n      xml(\"body\", {}),\r\n      xml(\"subject\", {}, \"KEY_ROOM_GENERAL\"),\r\n    )\r\n    this.client.send(stanza).then(() => {\r\n      cb(id);\r\n    });\r\n  };\r\n */\r\n  forwardMsg = (\r\n    to: string,\r\n    chatType: ChatType,\r\n    forwarded_msg_sender: string,\r\n    forwarded_msg: string,\r\n    forwarded_msg_id: string,\r\n    callback: SendMessageCallback\r\n  ) => {\r\n    const id = v4();\r\n    const forward = xml(\r\n      \"message\",\r\n      { to: to, id, type: chatType },\r\n      xml(\"body\", {}, forwarded_msg),\r\n      xml(\r\n        \"extraParams\",\r\n        {},\r\n        xml(\"reply_to\", {}, forwarded_msg_sender),\r\n        xml(\"reply_msg_id\", {}, forwarded_msg_id)\r\n      ),\r\n      xml(\"request\", { xmlns: \"urn:xmpp:receipts\" })\r\n    );\r\n    this.client.send(forward).then(() => {\r\n      callback(id);\r\n    });\r\n  };\r\n  joinRoom = (to: string) => {\r\n    const joinStanza = xml(\r\n      \"presence\",\r\n      {\r\n        to: `${to}/${this.username}`,\r\n        from: `${this.getJid()}/${this.resource}`,\r\n      },\r\n      xml(\r\n        \"x\",\r\n        { xmlns: \"http://jabber.org/protocol/muc\" },\r\n        xml(\"history\", { maxstanzas: \"0\" })\r\n      )\r\n    );\r\n    this.client.send(joinStanza);\r\n  };\r\n}\r\n"]},"metadata":{},"sourceType":"module"}